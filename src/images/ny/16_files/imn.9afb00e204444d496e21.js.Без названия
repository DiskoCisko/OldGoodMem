!function(e){function t(t){for(var n,r,o=t[0],l=t[1],c=t[2],u=0,g=[];u<o.length;u++)r=o[u],Object.prototype.hasOwnProperty.call(i,r)&&i[r]&&g.push(i[r][0]),i[r]=0;for(n in l)Object.prototype.hasOwnProperty.call(l,n)&&(e[n]=l[n]);for(d&&d(t);g.length;)g.shift()();return s.push.apply(s,c||[]),a()}function a(){for(var e,t=0;t<s.length;t++){for(var a=s[t],n=!0,o=1;o<a.length;o++){var l=a[o];0!==i[l]&&(n=!1)}n&&(s.splice(t--,1),e=r(r.s=a[0]))}return e}var n={},i={"web/imn":0},s=[];function r(t){if(n[t])return n[t].exports;var a=n[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.e=function(){return Promise.resolve()},r.m=e,r.c=n,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/js/cmodules/";var o=window.webpackJsonp=window.webpackJsonp||[],l=o.push.bind(o);o.push=t,o=o.slice();for(var c=0;c<o.length;c++)t(o[c]);var d=l;s.push([193,"common","palette","1cac183b8851071aa94890b5b99ff74a","vendors","ce10c8a950c9293c31cd32e7ec389138","f20783a09d2796e9a168ceebf7d96f7b","97eb3afca142bb7a7187dda4654ffe58"]),a()}({"+tmx":function(e,t,a){"use strict";a.r(t),a.d(t,"MILLISECOND",(function(){return n})),a.d(t,"SECOND",(function(){return i})),a.d(t,"MINUTE",(function(){return s})),a.d(t,"HOUR",(function(){return r})),a.d(t,"DAY",(function(){return o})),a.d(t,"WEEK",(function(){return l})),a.d(t,"MONTH",(function(){return c})),a.d(t,"ruLocale",(function(){return d})),a.d(t,"EVENTS",(function(){return u}));var n=1,i=1e3*n,s=60*i,r=60*s,o=24*r,l=7*o,c=30*o,d="ru-RU",u={MOUSE_DOWN:"mousedown",KEY_DOWN:"keydown",SCROLL:"scroll",CLICK:"click"}},"/cSr":function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return s}));var n=a("q1tI"),i=(a("17x9"),a("ZxpX"));function s(e){return n.createElement("div",{className:Object(i.classNames)("ChatSettingsRoundedIcon","ChatSettingsRoundedIcon--"+e.type,"ChatSettingsRoundedIcon--"+e.backgroundColor)})}},193:function(e,t,a){e.exports=a("V1UX")},"8h6g":function(e,t,a){"use strict";a.r(t),a.d(t,"VIDEO_UPLOAD_EXTS",(function(){return n})),a.d(t,"VIDEO_UPLOAD_MAX_FILE_SIZE_IN_GB",(function(){return i})),a.d(t,"VIDEO_UPLOAD_CHUNK_SIZE",(function(){return s}));a("KKXr");var n="avi mp4 3gp mpeg mov flv f4v wmv mkv webm vob rm rmvb m4v mpg ogv ts m2ts mts mxf".split(" "),i=5,s=4194304},LYnS:function(e,t,a){"use strict";a.r(t);a("pIFo");var n=a("86+7"),i=a("rHUl"),s=a("6krn").default.getLang;t.default=()=>[{id:"user name",label:s("mail_community_templates_hint_name"),process:e=>Object(n.oCacheGet)(e,Object(i.getPeer)(e)).first_name},{id:"user surname",label:s("mail_community_templates_hint_last_name"),process(e){var t=Object(n.oCacheGet)(e,Object(i.getPeer)(e));return t.name.replace(t.first_name,"").trim()}},{id:"admin name",label:s("mail_community_templates_hint_your_name"),process:e=>Object(n.oCacheGet)(e,vk.id).first_name},{id:"admin surname",label:s("mail_community_templates_hint_your_last_name"),process(e){var t=Object(n.oCacheGet)(e,vk.id);return t.name.replace(t.first_name,"").trim()}},{id:"community",label:s("mail_community_templates_hint_community"),process:e=>Object(n.oCacheGet)(e,e.get().id).name},{id:"greeting",label:s("mail_community_templates_hint_greeting"),process(e){var t=(new Date).getHours();return s(t>=3&&t<12?"mail_greeting_good_morning":t>=12&&t<17?"mail_greeting_good_afternoon":t>=17&&t<=23?"mail_greeting_good_evening":"mail_greeting_good_night")}}]},MCfn:function(e,t,a){"use strict";a.r(t),a.d(t,"connect",(function(){return l}));a("91GP");var n=a("q1tI");function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}var s=n.createContext(),r=s.Provider,o=s.Consumer;function l(e){return class extends n.Component{constructor(){super(...arguments),this.onUpdate=()=>{this.setState({})}}componentDidMount(){this.store.subscribe(this.onUpdate)}componentWillUnmount(){this.store.unsubscribe(this.onUpdate)}render(){return n.createElement(o,null,t=>(this.store||(this.store=t),n.createElement(e,i({},this.props,{store:t}))))}}}t.default=r},R5GP:function(e,t,a){"use strict";a.r(t);var n=a("BJj/"),i=a("ERyv"),s=a("Xrg9"),r=a("t7n3");function o(e,t){if(!t)return s.default.get(e);s.default.set(e,t)}t.default=function(e,t){void 0===e&&(e={}),void 0===t&&(t={});var a=Object(n.debounce)(o,300),l=Object(r.extend)({},e),c=[],d=[];return t.store&&(l=s.default.get(t.key)||l),{get:function(){return l},set:function(e){var n=this,s=Object(i.isWeirdLogging)()?function(e){try{var t={};return Error.captureStackTrace(t,e),t.stack}catch(e){return""}}(this.set):null;return e(l).then((function(e){return l=e,t.store&&a(t.key,e),n.emit(),n})).catch((function(e){return Object(i.imWeirdCatch)("store_set_catch",e,{stack:s})}))},setState:function(e){var t=this;return this.set((function(a){return a=Object(r.extend)(a,e),t.emit(),Promise.resolve(a)}))},stash:function(){c.push(l),l=Object(r.extend)({},e),this.emit()},reset:function(){l=Object(r.extend)({},e),this.emit()},unmount:function(){l={},e=!1,d=[]},pop:function(){c.length>0&&(l=c.pop(),this.emit())},emit:function(){var e=this;d.length>0&&d.forEach((function(t){return t(e)}))},subscribe:function(e){d.includes(e)||d.push(e)},unsubscribe:function(e){d=d.filter((function(t){return t!==e}))},mutate:function(e){e(l),t.store&&a(t.key,l),this.emit()}}}},RQ7Z:function(e,t,a){"use strict";a.r(t),a.d(t,"screenfull",(function(){return n}));var n=function(){var e=function(){for(var e,t,a=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],n=0,i=a.length,s={};n<i;n++)if((e=a[n])&&e[1]in document){for(n=0,t=e.length;n<t;n++)s[a[0][n]]=e[n];return s}return!1}(),t={request:function(t){var a=e.requestFullscreen;(t=t||document.documentElement)[a]()},exit:function(){document[e.exitFullscreen]()},toggle:function(e){this.isFullscreen?this.exit():this.request(e)},raw:e};return!!e&&(Object.defineProperties(t,{isFullscreen:{get:function(){return Boolean(document[e.fullscreenElement])}},element:{enumerable:!0,get:function(){return document[e.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return Boolean(document[e.fullscreenEnabled])}}}),t)}()},RdBX:function(e,t,a){"use strict";a.r(t),a.d(t,"vkIndexer",(function(){return n}));a("Vd3H"),a("OG14"),a("a1Th"),a("Btvt"),a("KKXr"),a("Oyvg");function n(e,t,a){this.list=e,this.iterCur=0,this.iterEnd=e?e.length:0,this.index={},this.callback=a||function(){},this.prepareFunc=t||function(e){return e},setTimeout(this.indexIteration.bind(this),10)}n.prototype.delimiter=n.delimiter=new RegExp("[\\s\\-\\.,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\#\\+\\?\\\\]+","g"),n.prototype.trimmer=new RegExp("^[\\s\\-\\.,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\+\\?\\\\]+|[\\s\\-,\\\"\\'\\«\\(\\)\\[\\]\\{\\}\\\\]+$","g"),n.prototype.toTranslit={1072:"a",1073:"b",1074:"v",1075:"g",1076:"d",1077:"e",1078:"zh",1079:"z",1080:"i",1081:"y",1082:"k",1083:"l",1084:"m",1085:"n",1086:"o",1087:"p",1088:"r",1089:"s",1090:"t",1091:"u",1092:"f",1093:"h",1094:"ts",1095:"ch",1096:"sh",1097:"sh",1099:"y",1101:"e",1102:"yu",1103:"ya",1105:"e",1098:"",1100:""},n.prototype.toLocalCase={f:"a",",":"b","<":"b",d:"v",u:"g",l:"d",t:"e",";":"zh",":":"zh",p:"z",b:"i",q:"y",r:"k",k:"l",v:"m",y:"n",j:"o",g:"p",h:"r",c:"s",n:"t",e:"u",a:"f","[":"h","{":"kh",w:"ts",x:"ch",i:"sh",o:"sh",s:"y","'":"e",'"':"e",".":"yu",">":"yu",z:"ya","`":"e","~":"e",m:"","]":"","}":""},n.prototype.toLocalTranslit={1072:"f",1074:"d",1075:"u",1076:"l",1077:"t",1079:"p",1080:"b",1081:"q",1082:"r",1083:"k",1084:"v",1085:"y",1086:"j",1087:"g",1088:"h",1089:"c",1090:"n",1091:"e",1092:"a",1094:"w",1095:"x",1096:"i",1097:"o",1099:"s",1103:"z",1098:"m"},n.prototype.indexIteration=function(){for(var e=Math.min(this.iterEnd,this.iterCur+200),t=this.iterCur;t<e;t++){var a=this.list[t];try{a._order=t}catch(e){}this.add(a)}this.iterCur=t,t>=this.iterEnd?this.callback(this):setTimeout(this.indexIteration.bind(this),10)},n.prototype.strToPrefixes=function(e){for(var t={},a=winToUtf(e).toLowerCase().split(this.delimiter),n=a.length;n--;){var i=a[n],s="";if(i){for(var r=0;r<6;r++){var o=i.charCodeAt(r);if(o){var l=this.toTranslit[o],c=i.substr(r,1);s+=null!=l?l:c}}t[s]=1}}return t},n.prototype.strToSearchPrefixes=function(e){for(var t=[],a=e.toLowerCase().split(this.delimiter),n=a.length;n--;){var i={},s=a[n],r="",o="",l="",c=s.length>1;if(s){for(var d=0;d<6;d++){var u=s.charCodeAt(d);if(u){var g=this.toTranslit[u],m=s.substr(d,1);if(r+=null!=g?g:m,c){var _=this.toLocalCase[m],p=this.toLocalTranslit[u];o+=null!=_?_:m,l+=null!=p?p:m}}}i[r]=1,c&&(i[o]=2,i[l]=3),t.push(i)}}return t},n.prototype.toIndexTree=function(e,t){for(var a=this.index,n=0;n<6;n++){var i=e.substr(n,1)||-1;a=a[i]?a[i]:a[i]=5==n?[]:{}}a.push(t)},n.prototype.remove=function(e){var t=this.prepareFunc(e),a=this.strToPrefixes(t);for(var n in a)if(a.hasOwnProperty(n)){for(var i=this.index,s=0;s<6;s++){var r=n.substr(s,1)||-1;if(!i[r])break;i=i[r]}if(i.length)for(var o in i)if(this.equals(i[o],e)){i.splice(o,1);break}}},n.prototype.equals=function(e,t){for(var a in e)if(e.hasOwnProperty(a))switch(typeof e[a]){case"object":if(!this.equals(e[a],t[a]))return!1;break;case"function":if(void 0===e[a]||e[a].toString()!=t[a].toString())return!1;break;default:if(e[a]!=t[a])return!1}for(var n in t)if(void 0===t[n])return!1;return!0},n.prototype.intersect=function(e,t){var a=[];if(isNumeric(e[0])||isNumeric(t[0]))return e.filter((function(e){return-1!==t.indexOf(e)}));for(;e.length>0&&t.length>0;)e[0]._order<t[0]._order?e.shift():(e[0]._order>t[0]._order||this.equals(e[0],t[0])&&a.push(e.shift()),t.shift());return a},n.prototype.add=function(e){var t=this.prepareFunc(e),a=this.strToPrefixes(t);for(var n in a)a.hasOwnProperty(n)&&this.toIndexTree(n,e)},n.prototype.search=function(e){var t=this.index,a=this.strToSearchPrefixes(e),n=[],i=!1;for(var s in a)if(a.hasOwnProperty(s)){if(i&&!n)break;var r=this.localSearch(a[s],0,t);r.sort((function(e,t){return e._order-t._order})),n=i?this.intersect(n,r):r,i=!0}for(var o=n[0],l=n.length+1,c=[],d=1;d<l;d++){var u=n[d];u!=o&&(c.push(o),o=u)}return c},n.prototype.localSearch=function(e,t,a){if(!a)return[];var n={};for(var i in e)if(e.hasOwnProperty(i)){var s=i.substr(t,1)||-1;n[s]||(n[s]={}),n[s][i]=1}if(6==t++||!a)return a;var r=[];for(var o in n)if(-1==o)for(var l in a)a.hasOwnProperty(l)&&r.push.apply(r,this.localSearch(n[o],t,a[l]));else{var c=this.localSearch(n[o],t,a[o]);r.push.apply(r,c)}return r}},UlUB:function(e,t,a){"use strict";function n(e,t){var a,n,i=!1;return function s(){if(i)return a=arguments,void(n=this);e.apply(this,arguments),i=!0,setTimeout((function(){i=!1,a&&(s.apply(n,a),a=n=null)}),t)}}a.r(t),a.d(t,"throttle",(function(){return n}))},V1Nw:function(e,t,a){"use strict";function n(e,t,a){var n=0,i=e,s=[],r=!1;function o(){!s.length||n>0||r||(t(s),s=[])}return{pause:function(){n++},resume:function(){n>0&&(n--,o())},onLp:function(e,t,n){r||(i>=e?(i=t,s.push.apply(s,n),o()):a&&(r=!0,a(i).then((function(e){var t=e[1],a=e[2];i=t,r=!1,s.push.apply(s,a),o()}))))}}}a.r(t),a.d(t,"createLongpollEventsQueue",(function(){return n}))},V1UX:function(e,t,a){"use strict";a.r(t);a("HEwt"),a("a1Th"),a("rE2o"),a("ioFf"),a("91GP"),a("VRzm"),a("Vd3H"),a("pIFo"),a("OEbY"),a("SRfc"),a("rGqo"),a("Btvt"),a("OG14");var n=a("vT4u"),i=a("P13b"),s=a("rHUl"),r=a("MhhX"),o=a("4+be"),l=a("FWc3"),c=a("nAFc");function d(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return u(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return u(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function g(e,t){var a=0,n=[],i=[],s=!1;return e.forEach(e=>{e.width=e.width?e.width:function(e){return 12+9*Object(c.decodeHTMLEntities)(e.name).length}(e),e.width+(s?0:69)>=t-a?(i.push(e),s||(a+=69,s=!0)):(n.push(e),a+=e.width)}),[n,i]}function m(e,t){var a=t.peer_tags&&t.peer_tags.length?e.peer_profile_tags.filter(e=>t.peer_tags.includes(e.id)):[];return t.ad_id&&a.unshift(function(e){var t,a;return e.is_easy_promoted_market?(t=Object(o.getLang)("mail_ad_tag_easy_promoted_market"),a=145):(t=e.has_ad_access?`${Object(o.getLang)("mail_ad_tag_text_prefix")} ${e.ad_id}`:Object(o.getLang)("mail_ad_tag_no_access_text"),a=e.has_ad_access?104:97),{isAdTag:!0,adTagText:t,width:a,name:t,color:"#e5ebf1"}}(t)),a}var _=a("aong"),p=a("ofcU"),h=a("f01n");function b(e,t,a){var s=intval(domData(a,"msgid"));if(!Object(_.getSelectionText)()&&!Object(i.checkSelectClick)(t)){var r=intval(domData(a,"peer"));return e.set(n.cancelSearch.bind(null,r)),e.get().longpoll.push([Object(h.changePeer)(r,s)]),!1}}function v(e,t){return{isAll:e=>Object(n.isSearchAllLoaded)(e.get().peer,e.get()),loadMore:e=>function(e){return Object(n.isSearchAllLoaded)(e.get().peer,e.get())?Promise.resolve(""):Object(n.searchMessagesInplace)(e.get().peer,e.get())}(e),unmount(){Object(p.destroyModule)(t)}}}function f(e){return e.findIndex(e=>"number"==typeof e.peerId&&e.href)>-1}function O(e,t){var a=b.bind(null,t);return v(0,Object(p.createModule)({handlers:(t,n)=>{n(e,"click","_im_mess",a)}}))}var y=a("h++7"),C=a("R5GP"),j=a("+/AQ");function S(e,t){return Object(_.toArray)(e).find(e=>domData(e,"list-id")===t)}function E(e,t){return Object(_.toArray)(e).findIndex(e=>domData(e,"list-id")===t)}function w(e,t,a,n){if(a){T(e,t,n);var i=domData(a,"list-id"),s=i&&S(t.children,i);s&&n.forEach(e=>addClass(s,e)),e.setState({hoveredListItemId:i})}}function T(e,t,a){var n=domQuery("."+a.join("."),t);n&&Object(_.toArray)(n).forEach(e=>{a.forEach(t=>removeClass(e,t))}),e.setState({hoveredListItemId:null})}function I(e,t){var a=t&&domQuery("."+t.join("."),e)[0];return a?domData(a,"list-id"):null}function M(e,t,a){return e.map(t).reduce((e,t)=>(e[t]=!0,e),a)}function A(e,t,a){return{ids:M(a.get().elements,e,{}),scrolls:t,activated:!0}}function L(e,t,a){return a.elements=a.elements.filter(a=>t(a)!==e),delete a.ids[e],Promise.resolve(a)}function k(e,t,a){var n=[];a.elements=a.elements.map(a=>{var i=t(a),s=e.filter(e=>t(e)===i)[0];return n.push(i),s||a});var i=e.filter(e=>!inArray(t(e),n));return a.elements=a.elements.concat(i),Promise.resolve(a)}function P(e){var t={};return e.forEach(e=>{"r"===e[0]&&t["a,"+e[1]]?delete t["a,"+e[1]]:t[`${e[0]},${e[1]}`]=e}),Object.keys(t).map(e=>t[e])}function N(e,t,a,n,i,s,r){for(var o=0;o<n;o++)e=domNS(e);var l=se(i(t));return domData(l,"list-id",a),e?s.insertBefore(l,e):s.appendChild(l),r&&r(l),e}function D(e,t,a,n,i){var s=n.get(),r=s.limit,o=s.offset,l=function(e,t){var a=t.get();return!a._sortedEls&&e&&t.setState({elements:a.elements.sort(e),_sortedEls:!0}),t.get().elements}(a().sortFn,n).slice(0,o+r),c=function(e,t){for(var a=[],n=Math.max(e.length,t.length),i=0;i<n;i++){var s=e[i],r=t[i];!s&&r?a.push(["a",r,i]):s&&!r?a.push(["r",s,i]):s!==r&&(a.push(["r",s,i]),a.push(["a",r,i]))}var o=P(a),l=P(a.reverse());return o.length>l.length?l:o}(Object(_.toArray)(e.children).map(e=>domData(e,"list-id")).filter(e=>!!e),l.map(e=>a().idFn(e).toString()));if(function(e,t,a,n,i){if(0!==t.length){var s=(t=t.sort((e,t)=>e[2]-t[2])).filter(e=>"a"===e[0]);if(t.filter(e=>"r"===e[0]).map(t=>e.children[t[2]]).forEach(e=>re(e)),0!==s.length)for(var r=s.shift(),o=r[2],l=(N(e.children[o],a[r[2]],r[1],0,n,e,i),0);l<s.length;l++)r=s[l],N(e.children[o],a[r[2]],r[1],r[2]-o,n,e,i),o=r[2]}}(e,c,l,a().renderFn,a().onRenderFn),function(e,t){e.get().loading?t.update(!1,!0):(e.get().loading=!0,t.update(!1,!0),e.get().loading=!1)}(n,t),i)return c.filter(e=>"a"==e[0]).map(e=>parseInt(e[1]))}function x(e,t,a,n){var i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,o=e.get(),l=t.getContainer().children,c=E(l,n||o.hoveredListItemId);c<0||(o.limit+o.offset<c?e.setState({offset:c-o.limit+1}).then(D.bind(null,t.getContainer(),t,a)):Promise.resolve()).then(()=>{var e=l[c],a=t.scrollTop(),n=t.getScrollHeight(),o=e.offsetHeight;s="center"===s?-.5*t.getScrollHeight():s,r="center"===r?n/2:r;var d=i?function(e){t.smoothScroll(e-t.scrollTop())}:t.scrollTop.bind(t),u=a+s>e.offsetTop,g=o+e.offsetTop>a+n-r;u?d(e.offsetTop-s):g&&d(e.offsetTop-n+o+r)})}function B(e,t){if(e.get().loading||e.get().stop||!e.get().activated)return Promise.resolve([]);e.get().loading=!0;for(var a=arguments.length,n=new Array(a>2?a-2:0),i=2;i<a;i++)n[i-2]=arguments[i];return t(...n).then(()=>{e.get().loading=!1})}function R(e,t,a){return a.scrolls||(a.scrolls={}),a.scrolls[e]&&!t||(a.scrolls[e]={scrolled:a.scrolled||0,scrollItem:a.scrollItem}),Promise.resolve(a)}function F(e,t,a,n){var s=e.get(),r=s.elements,o=n.getContainer(),l=e.setState({offset:s.offset+s.limit}).then(()=>{var a,i=s.offset,l=s.limit;return l+i>r.length?a=t().more(i,l).then(t=>!1===t?[]:(0===t.length&&e.setState({stop:!0}),t)).then(U.bind(null,e,o,n,t,s.pipeId)):(a=Promise.resolve(),D(o,n,t,e)),a});if(!a){var c=r.length>0?"im-preloader_fixed-bottom":"im-preloader_fixed-center";Object(i.wrapLoading)(o)(l,"bottom",c)}return l}function H(e,t){var a=e.get().pipeId;return!(void 0!==a&&void 0!==t&&a!==t)}function U(e,t,a,n,i,s){return!!H(e,i)&&e.setState(function(e,t,a){var n=e.filter(e=>!a.ids[t(e)]);return{_sortedEls:!1,els:n,ids:M(n,t,a.ids),elements:a.elements.concat(n)}}(s,n().idFn,e.get())).then(D.bind(null,t,a,n))}function G(e,t,a){var n=B.bind(null,t,F.bind(null,t,a)),i=(e,n)=>{(t.get().activated||e)&&(void 0!==n&&t.get().elements.length>0&&t.setState({scrolled:n}),a().onScroll&&a().onScroll())},s=Object(j.createScroll)(e,{noScroll:t.get().noScroll,nativeScroll:t.get().nativeScroll,scrollChange:i.bind(null,!1),more:!!a().more&&n.bind(null,!1)}),r=Object(p.createModule)({handlers:(n,i)=>{i(e,"click",t.get().elCls,a().onClick)}});return t.setState(A(a().idFn,{},t)),{pipe:(e,n)=>(t.setState({pipeId:n}),e.then(U.bind(null,t,s.getContainer(),s,a,n))),replacePreserveOrder:e=>t.set(k.bind(null,e,a().idFn)).then(D.bind(null,s.getContainer(),s,a)),pipeReplace(e,n){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return t.setState({pipeId:n,stop:!1}),e.then(e=>{if(H(t,n))return t.setState({elements:e,_sortedEls:!1,ids:M(e,a().idFn,{})}).then(D.bind(null,s.getContainer(),s,a,t,i))})},wipe(){s.getContainer().innerHTML=""},deactivate(){t.setState({activated:!1})},activate(){t.setState({activated:!0})},saveScroll:(e,a)=>t.set(R.bind(null,e,a)),updateScroll(){s.update(!1,!0)},toTop(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?s.smoothScroll(-s.scrollTop()):s.scrollTop(0),e&&i(e,0)},scrollTop:e=>s.scrollTop(e),restoreScroll(e){var a=t.get().scrolls,n=a[e];return n&&(t.setState({scrolls:extend({},a,{[e]:null})}),s.scrollTop(n.scrolled)),!!n},unsetScroll(e){t.setState({scrolls:extend({},t.get().scrolls,{[e]:null})})},scrollPage(e,t){var a=s.scroll.scroller,n=s.scrollTop(),i=n+("up"===e?-1:1)*a.clientHeight;t?s.smoothScroll(i-n):s.scrollTop(i)},scrollToElement(e,n,i,r){x(t,s,a,e,n,i,r)},getScroller:()=>s.getScroller(),checkMore:e=>t.get().elements.length<t.get().limit?n(e,s):Promise.resolve([]),add:(e,n)=>U(t,s.getContainer(),s,a,n,e),hoverNextElement(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=s.getContainer(),o=r.children,l=E(o,t.get().hoveredListItemId||I(r,n)),c=Object(_.toArray)(o).slice(l+1).find(a().hoverableFn);w(t,r,c,e),x(t,s,a,null,!1,i.top,i.bottom)},hoverPrevElement(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=s.getContainer(),o=r.children,l=E(o,t.get().hoveredListItemId||I(r,n)),c=l>=0&&Object(_.toArray)(o).slice(0,l).reverse().find(a().hoverableFn);w(t,r,c,e),x(t,s,a,null,!1,i.top,i.bottom)},hoverFirstElement(e,n){var i=s.getContainer(),r=i.children,o=Object(_.toArray)(r).findIndex(a().hoverableFn),l=r[o];!t.get().hoveredListItemId&&l&&(w(t,i,l,e),x(t,s,a,o,!1,n.top,n.bottom))},hoverElement(e,n,i){var r=s.getContainer(),o=r.children,l=E(o,e),c=o[l];c&&(w(t,r,c,n),x(t,s,a,l,!1,i.top,i.bottom))},unhoverElements(e){T(t,s.getContainer(),e)},reset(){var e=t.get().scrolls;t.reset(),t.setState(A(a().idFn,e,t))},getHoveredElement:()=>S(s.getContainer().children,t.get().hoveredListItemId),getCurrentElements:()=>t.get().elements,isLoading:()=>t.get().loading,isEmpty:()=>0===t.get().elements.length,remove(e){t.set(L.bind(null,e,a().idFn)).then(D.bind(null,s.getContainer(),s,a))},unmount(){Object(p.destroyModule)(r),s.destroy()}}}var q=a("1y80"),W=a("86+7"),K=a("lJdi");function V(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Y(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Y(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Y(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var z=["_im_dialog_selected","nim-dialog_selected"],$=["_im_dialog_hovered","nim-dialog_hovered"];function X(e,t,a){removeClass(t.parentNode,"im-page--dialogs_with-mess");var n=a.getCurrentElements().filter(e=>e.message);a.toTop(),a.reset(),Object(q.statlogsProbValueEvent)(.01,"im_search_stat",1,"search_messages_only"),n.length>0?(n=[{type:"sep_messages"}].concat(n),e.setState({searchOnlyMessages:!0})):n=[Se()],a.pipeReplace(Promise.resolve(n))}function Q(e){return hasClass(e,"_im_search")}function J(e,t,a,r){if(Object(s.isSearching)(e)&&e.get().searchAllLoaded||Object(s.isRecentSearchesActive)(e))return Promise.resolve([]);if(e.get().dialog_search_going||Object(i.isClassicInterface)(e)&&0!==e.get().peer)return Promise.resolve(!1);if(Object(s.isSearching)(e))return Object(n.searchMessages)(Object(s.getSearchText)(e),e.get()).then(e=>{var t=V(e,2),a=t[0];return je(t[1],a)});var o=e.get().active_tab,l=e.get().dialog_tabs_all;return o!==y.FOLDER_MESSAGE_REQUEST&&l[y.FOLDER_ALL]&&!Object(i.isReversedDialogs)(e)||l[o]?0===He(e).length?Object(s.isMessageRequestFolder)(e)?Promise.resolve([{type:"message_request_notice"},{type:"empty_message_requests"}]):Promise.resolve([{type:"empty_dialogs"}]):Promise.resolve([]):e.set(n.loadDialogs).then(t=>{var a=He(e);return 0===a.length?Object(s.isMessageRequestFolder)(e)?Promise.resolve([{type:"message_request_notice"},{type:"empty_message_requests"}]):[{type:"empty_dialogs"}]:a})}function Z(e,t,a,r,o,l){var c=gpeByClass("_im_peer_target",o.target)&&checkEvent(o),d=Object(i.isCommunityInterface)(a)&&gpeByClass("_im_dialog_peer_tags",o.target);if(!c&&!d){var u=a.get(),g=Q(l),m=parseInt(domData(l,"peer"),10),_=parseInt(domData(l,"msgid"),10),p=Object(s.getTab)(a,m);if(function(e,t){return e.get().active_tab===y.FOLDER_MESSAGE_REQUEST&&Object(s.tabIsMessageRequestToChat)(t)}(a,p))return t().showInvitationBox(a,m),cancelEvent(o);var b="";if(Object(s.isSearching)(a)&&(b="conversations_search"),Object(s.isRecentSearchesActive)(a)&&(b="recent_searches"),hasClass(l,"_im_sugg_"+m)&&(b="popular_suggestions"),g&&(b="message_search"),checkEvent(o))return window.open(function(e,t,a){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=Object(i.getBaseLink)(e),r=()=>`${s}?sel=${Object(i.convertPeerToUrl)(t.peerId)}${n&&a?"&msgid="+a:""}`;if(n)return r();if(Object(i.isUserPeer)(t.peerId)||Object(i.isCommunityPeer)(t.peerId))return Object(i.isClassicInterface)(e)?r():t.href;return r()}(a,p,_,g));if(r.saveScroll("list"),g&&u.msgid!==_)u.longpoll.push([h.changePeer(m,_,!1,!1,b)]);else if(m!==u.peer){u.longpoll.push([h.changePeer(m,!1,!0,!0,b)]);var v=Object(s.isSearching)(a);v&&!hasClass(l,"_dont_add_recent")&&Object(n.saveRecentSearchPeer)(m,cur.imDb),v&&p&&!Object(i.isClassicInterface)(a)&&setTimeout(()=>{var e=p.message?p.message.messageId:p.peerId;r.scrollToElement(e.toString(),!0,0,"center")},100)}else m===u.peer&&e().goToHistoryEnd();cancelEvent(o)}}function ee(e,t,a,n){var r,o="string"==typeof a.photo&&""!==a.photo,l=Object(i.isContactPeer)(t),c=a.tab||a.name,d=l?Object(i.prepareContactName)(c):c;if(Object(i.isChatPeer)(t)&&!o)r=Object(i.renderPhotosFromTab)(e,a,!n);else{if(l){var u=Object(i.getUserInitials)(c);r=`<div class="nim-peer--contact-avatar nim-peer--contact-avatar_${Object(s.isSearching)(e)&&!a.message?34:n?50:46}">${u}</div>`}else r=`<img src="${a.photo}" alt="">`;n&&(r=getTemplate("im_dialogs_link_img",{href:a.href||a.link,photo:r}))}return{photo:r,userLink:`<span class="_im_dialog_link">${d}</span>`}}function te(e){return!Object(i.isPendingForward)(e)}function ae(e,t,a,n){return a?"":n?getTemplate("im_img_prebody",{photo:t}):e+":"}function ne(e,t,a,n,r,o,l,c,d,u){var g="",m=Object(s.isChannelPeer)(Object(s.getTab)(e,a));return t&h.FLAG_OUTBOUND?g=ae(getLang("mail_by_you"),u,m,d):Object(i.isChatPeer)(a)&&0!==n&&(g=ae(Object(W.oCacheGet)(e,n).first_name,Object(W.oCacheGet)(e,n).photo,m,d)),l=Object(i.renderShortText)(a,c,l,r,o),g?getTemplate("im_drow_prebody",{prebody:g,body:l}):l}function ie(e,t,a,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},o=[];return Object(i.isClassicInterface)(n)&&o.push("nim-dialog_classic"),Object(s.isRecentSearchesActive)(n)&&o.push("nim-dialog_recent"),o.push("nim-dialog_empty"),r.search&&o.push("_im_search"),getTemplate("im_drow",{peer:e.peerId,msg_id:"",photo:t,user_link:a,date:"",body:"",unread:"",more:o.join(" "),is_star:"",unread_message_string:"",is_online:onlinePlatformClass(e.online),is_unread:"",is_unread_out:"",is_selected:e.peerId==n.get().peer?"nim-dialog_selected _im_dialog_selected":""})}function oe(e,t,a){return!!(a&h.FLAG_OUTBOUND)&&(!Object(i.isSelfMessage)(t.peerId,e.get().gid)&&(!(Object(i.isChatPeer)(t.peerId)&&t.data&&t.data.closed)&&(!t.unread&&!(!t.lastmsg||t.lastmsg<=t.out_up_to))))}function le(e){var t=be(e);return!!(e.unread>0&&t)||!!Object(s.isTabMarkedUnread)(e)}function de(e){return!(!e.mentions||!e.mentions.length)}function ue(e){return function(e){return!(!e.expiring_messages||!e.expiring_messages.length)}(e)&&!de(e)}function me(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=a||be(t),l=ee(e,t.peerId,t,Object(i.isClassicInterface)(e)),c=l.photo,d=l.userLink;if(!o)return ie(t,c,d,e,n);var u=o.flags,g=Object(i.isFvkcomgroup)(e,t.peerId),m=Object(s.tabIsMessageRequestToChat)(t),_=Object(s.isCasperChat)(e,t.peerId),p=Object(i.isContactPeer)(t.peerId),b=he(t,e,a),v=Object(s.isCommunityChat)(e,t.peerId),f=[];n.search&&f.push("_im_search","nim-dialog_search"),inArray(t.peerId,e.get().mutedPeers)&&f.push("nim-dialog_muted"),t.verified&&f.push("nim-dialog_verified"),_&&f.push("nim-dialog_casper"),Object(s.isRecentSearchesActive)(e)&&f.push("nim-dialog_recent"),Object(r.isMessageEmpty)(o)&&!_&&f.push("nim-dialog_empty"),Object(i.isClassicInterface)(e)&&f.push("nim-dialog_classic"),t.folders&h.FOLDER_IMPORTANT&&f.push("nim-dialog_starred"),!n.search&&Object(i.isUnrespond)(e,t.peerId,t)&&f.push("nim-dialog_unrespond"),(g||v)&&e.get().gid&&f.push("nim-dialog_deny-remove"),de(t)&&f.push("nim-dialog_unread-mentions"),ue(t)&&f.push("nim-dialog_unread-expiring"),t.callInProgress&&f.push("nim-dialog_active-call"),t.callInProgress&&t.callInProgress.participants.count<1&&f.push("nim-dialog_active-call-empty");var O=Object(s.tabIsMessageRequestToChat)(t)?t.mr&&t.mr.request_date:o.date,y=e.get().timeshift,C=O?getShortDateOrTime(O,y,!0,getLang("months_sm_of","raw")):"",j=!oe(e,t,u)||m||Object(s.isSearching)(e)?"":"nim-dialog_unread-out",S=t.unread>0?getLang("mail_im_new_messages",t.unread):"",E=p?Object(i.prepareContactName)(t.tab):t.tab;return getTemplate("im_drow",{peer:t.peerId,msg_id:o.messageId,photo:c,user_link:d,date:C,body:b,unread_message_string:S,tab_name:stripHTML(E),unread:Object(i.simplifyCounter)(t.unread),more:f.join(" "),is_online:onlinePlatformClass(t.online),is_unread:le(t)?"nim-dialog_unread":"",is_unread_out:j,is_selected:n.noselect||m||t.peerId!=e.get().peer?"":"nim-dialog_selected _im_dialog_selected"})}function _e(e,t,a,n,o){if(!t.deletedDialog)if(hasClass(e,"nim-conversation-search-row"))pe(e,t,a);else{var l=a.get(),c=be(t),d=c.flags,u=he(t,a),g=ee(a,t.peerId,t,Object(i.isClassicInterface)(a)),m=g.photo,p=g.userLink,b=a.get().timeshift,v=c.date?getShortDateOrTime(c.date,b,!0,getLang("months_sm_of","raw")):"";Me(e,t),val(geByClass1("_dialog_body",e),u),val(geByClass1("_im_dialog_date",e),v),val(geByClass1("_im_dialog_unread_ct",e),Object(i.simplifyCounter)(t.unread));var f=geByClass1("_im_dialog_link",e);f&&val(f.parentNode,p);var O=geByClass1("_im_dialog_photo",e);O.innerHTML!==m&&val(O,m),l.is_peer_profile_enabled&&(l.peer||xe(e,a));var y=Object(s.isCasperChat)(a,t.peerId);toggleClass(e,"nim-dialog_verified",!!t.verified),toggleClass(e,"nim-dialog_casper",y),toggleClass(e,"nim-dialog_muted",inArray(t.peerId,a.get().mutedPeers)),toggleClass(e,"nim-dialog_unrespond",Object(i.isUnrespond)(a,t.peerId,t)),toggleClass(e,"nim-dialog_classic",Object(i.isClassicInterface)(a)),toggleClass(e,"nim-dialog_unread",le(t)),toggleClass(e,"nim-dialog_unread-mentions",de(t)),toggleClass(e,"nim-dialog_unread-expiring",ue(t)),toggleClass(e,"nim-dialog_active-call",!!t.callInProgress),toggleClass(e,"nim-dialog_active-call-empty",!!t.callInProgress&&t.callInProgress.participants.count<1),toggleClass(e,"nim-dialog_deny-remove",a.get().gid>0&&(Object(i.isFvkcomgroup)(a,t.peerId)||Object(s.isCommunityChat)(a,t.peerId))),removeClass(e,"nim-dialog_failed"),removeClass(e,"nim-dialog_deleted"),addClass(e,"_im_dialog"),Object(_.toggleOnline)(geByClass1("_im_peer_online",e),t.online),toggleClass(e,"nim-dialog_recent",Object(s.isRecentSearchesActive)(a)),toggleClass(e,"nim-dialog_empty",Object(r.isMessageEmpty)(c)&&!y),toggleClass(e,"nim-dialog_unread-out",oe(a,t,d)&&!Object(s.isSearching)(a)),De(e),toggleClass(e,"nim-dialog_starred",t.folders&h.FOLDER_IMPORTANT),o&&setTimeout((function(){addClass(geByClass1("_im_dialog_"+t.peerId,n),"nim-dialog_injected")}),100)}}function pe(e,t,a){Me(e,t),toggleClass(e,"nim-dialog_recent",Object(s.isRecentSearchesActive)(a)),val(geByClass1("_im_dialog_unread_ct",e),Object(i.simplifyCounter)(t.unread)),toggleClass(e,"nim-dialog_unread",le(t)),toggleClass(e,"nim-dialog_unread-expiring",ue(t)),toggleClass(e,"nim-dialog_unread-mentions",de(t));var n=ee(a,t.peerId,t,Object(i.isClassicInterface)(a)).photo,r=geByClass1("_im_dialog_photo",e);r.innerHTML!==n&&val(r,n),Object(_.toggleOnline)(geByClass1("_im_peer_online",e),t.online)}function he(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=a||be(e),o=Object(s.tabIsMessageRequestToChat)(e),l=Object(s.isCasperChat)(t,e.peerId);if(o){var c=Object(i.isClassicInterface)(t),d=e.mr&&e.mr.inviter_id,u=Object(W.oCacheGet)(t,d),g=c?u.name:u.short_name,m=c?getTemplate("im_img_prebody",{photo:u.photo}):"",_=getLang("mail_mr_service_message").replace(/{user}/,g);return m+_}if(Object(i.isPeerBlocked)(e.peerId,t)){var p=t.get().block_states[e.peerId].name,h=getLang("mail_community_answering").replace("{username}",p);return getTemplate("im_drow_prebody",{prebody:h,body:""})}return Object(r.isServiceMsg)(n)&&!o?Object(i.renderServiceMsg)(t,n,e,!1):l&&Object(r.isMessageEmpty)(n)?getLang("mail_empty_casper_message"):Object(r.isExpiredCasperMessage)(n)?getLang("mail_expired_message"):ne(t,n.flags,e.peerId,n.userId,!0,n.attaches,n.text,n.subject,Object(i.isClassicInterface)(t),Object(W.oCacheGet)(t,t.get().id).photo)}function be(e){var t=e.lastmsg_meta;return isArray(t)&&(t=h.addMessageEvent([4].concat(t))),t||h.addMessageEvent([4,-1,0,e.peer,0,"",{},{},-1,-1,0])}function ve(e,t,a){var r=Object(s.getTab)(e,t),o=Object(s.tabIsMessageRequestToChat)(r),l=Object(i.showLeaveDialog)(e,t,s=>{a().updateMenu(e);var r=Promise.resolve();Object(i.isChatPeer)(t)&&(r=o?e.set(n.rejectMessageRequest.bind(null,t)):e.set(n.leaveChat.bind(null,t))),s&&r.then(()=>Object(i.cleanHistory)(e,l,a,n.flushHistory,t)),l.hide()})}function fe(e,t,a,s,r,o){var l=gpeByClass("_im_dialog",o,a);if(cancelEvent(r),!l)return!1;var c=intval(domData(l,"peer")),d=t.get(),u=Object(i.isCommunityPeer)(c)||Object(i.isUserPeer)(c);if(d.recentSearch){var g=Object(n.removeFromRecentSearch)(c,cur.imDb);re(l),0===g.length&&Ne(t,s,e)}else Object(i.isClassicInterface)(t)&&u?Object(n.deleteDialog)(c,d).then(a=>{var n=V(a,2),i=n[0],s=n[1];i?(!function(e,t,a,n,i){var s=geByClass1("_dialog_body",t);addClass(t,"nim-dialog_deleted"),removeClass(t,"_im_dialog"),val(s,getTemplate("im_delete_actions",{text:langNumeric(a,getLang("mail_im_X_message_deleted","raw")),peer:e,spam_id:n}))}(c,l,i,s),e().updateMenu(t)):ve(t,c,e)}):ve(t,c,e);return!1}function Oe(e,t){Object(i.toggleMessageRequestsTab)(e,t,n.changeDialogsTab)}function ye(e,t){switch(t.type){case"sep_btn_search_msg":return Object(i.renderBtnSearchOnlyMessages)(e);case"sep_messages":return Object(i.renderMessagesSep)();case"sep_conversations":return Object(i.renderConversationsSep)();case"sep_popular":return Object(i.renderPopularSuggSep)();case"popular_sugg":return Object(i.renderPopularSuggestions)(e);case"clear_recent":return Object(i.renderClearRecent)();case"empty_dialogs":return getTemplate("im_dialogs_none",{msg:getLang("mail_dialogs_list_empty")});case"empty_message_requests":return getTemplate("im_dialogs_none",{msg:getLang("mail_dialogs_mr_empty")});case"empty":return getTemplate("im_dialogs_none",{msg:getLang("mail_im_search_empty")});case"message_request_notice":return getTemplate("im_dialogs_message_requests_notice",{msg:getLang("mail_message_request_tab_notice")});case"message_request_button_go":return getTemplate("im_dialogs_message_requests_button",{msg:getLang("mail_tab_mr")});case"message_request_button_return":return getTemplate("im_dialogs_message_requests_button",{msg:getLang("mail_go_to_all_tab")});default:return t.message?me(e,t,t.message,{noselect:!0,search:!0}):t.local_index||Object(s.isSearching)(e)?function(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=ee(e,t.peerId,t,Object(i.isClassicInterface)(e)),r=n.photo,o=n.userLink,l=te(e),c=""===a?[]:[a];return Object(s.isRecentSearchesActive)(e)&&c.push("nim-dialog_recent"),Object(i.isClassicInterface)(e)&&c.push("nim-csr_classic"),inArray(t.peerId,e.get().mutedPeers)&&c.push("nim-dialog_muted"),Object(s.isCasperChatTab)(t)&&c.push("nim-dialog_casper"),de(t)&&c.push("nim-dialog_unread-mentions"),ue(t)&&c.push("nim-dialog_unread_expiring"),getTemplate("im_conversation_search_row",{peer:t.peerId,msg_id:t.lastmsg||"",photo:r,user_link:o,unread:Object(i.simplifyCounter)(t.unread),tab_name:stripHTML(name),is_unread:le(t)?"nim-dialog_unread":"",is_online:onlinePlatformClass(t.online),is_selected:t.peerId==e.get().peer&&l?"nim-dialog_selected _im_dialog_selected":"",more:c.join(" ")})}(e,t):me(e,t)}}function Ce(e,t,a,s,r,o){var l=intval(domData(o,"peer")),c=domData(o,"action"),d=domData(o,"sid"),u=geByClass1("_im_dialog_"+l,t),g=intval(domData(o,"spam"));switch(c){case"restore":u&&e.set(n.restoreDialog.bind(null,l,d,g)).then(()=>{addClass(u,"_im_dialog"),removeClass(u,"nim-dialog_deleted"),_e(u,e.get().tabs[l],e,t,!1),s().updateMenu(e)});break;case"spam":var m=`${getLang("mail_im_dialog_marked_spam")}\n        <button type="button" class="nim-dialog--daction nim-dialog--daction_last _im_dialog_daction"\n          data-action="restore"\n          data-spam="1"\n          data-sid="${d}" data-peer="${l}">\n            ${getLang("mail_restore")}\n        </button>`;if(u){var _=geByClass1("_dialog_body",u);val(_,m),Object(n.spamDialog)(l,d,e.get())}break;case"block":(Object(i.isCommunityInterface)(e)?Object(i.showBlacklistBox)(l,e):Object(i.showBlacklistBoxUser)(l,e)).once("success",(function(){e.set(n.flushHistory.bind(null,l)).then(()=>{a().restoreDialogs(e)})}))}cancelEvent(r)}function je(e,t){return e.map(e=>h.addMessageEvent([4].concat(e))).map(e=>extend({},t[e.peerId],{message:e}))}function Se(e){return{type:"empty",lang:e}}function Ee(e,t){var a=e.get().msg_local_ids_sort,n=a&&a[t.lastmsg];return void 0!==n?2e9+n:t.minor_sort_id}function we(e,t,a,i){var s=gpeByClass("_im_dialog",i,t),r=intval(domData(s,"peer"));return e.set(n.toggleDialogImportant.bind(null,r)),setTimeout((function(){Ie(e,t,a,i)}),100),cancelEvent(a),!1}function Te(e,t,a){var n=t.major_sort_id||0,s=a.major_sort_id||0,r=n!==s?s-n:Ee(e,a)-Ee(e,t);return r=Object(i.isReversedDialogs)(e)?-r:r}function Ie(e,t,a,n){Object(l.showTooltip)(n,{text:function(){var a=gpeByClass("_im_dialog",n,t),i=domData(a,"peer");return e.get().tabs[i].folders&h.FOLDER_IMPORTANT?getLang("mail_im_toggle_important_off"):getLang("mail_im_toggle_important")},black:1,zIndex:1,shift:[14,8],toup:Ue(e,n.getBoundingClientRect().top)})}function Me(e,t){var a=t.unread>0?getLang("mail_im_new_messages",t.unread):"",n=geByClass1("_im_unread_blind_label",e);val(n,a)}function Ae(e,t,a,i,r){var o=gpeByClass("_im_dialog",r,t),l=intval(domData(o,"peer")),c=e.get().tabs[l].lastmsg;return e.set(n.markDialogAnswered.bind(null,l,c)).then(()=>{_e(o,e.get().tabs[l],e,t),Object(s.isRecentSearchesActive)(e)||a().restoreDialogs(e)}),showDoneBox(getLang("mail_marked_as_answered"),{out:1e3}),cancelEvent(i),!1}function Le(e){var t=Object(s.isSearching)(e),a=e.get().searchOnlyMessages;return Object(i.isClassicInterface)(e)?{top:t&&!a?96:60,bottom:Object(i.isCommunityInterface)(e)?42:87}:{top:t&&!a?36:0,bottom:0}}function ke(e,t){e.hoverFirstElement($,Le(t))}function Pe(e){e.unhoverElements($)}function Ne(e,t,a){if(Object(s.doPopularSuggExist)(e)){t.pipeReplace(Promise.resolve([{type:"sep_popular"},{type:"popular_sugg"}])),t.toTop()}else a().cancelSearch(e),cancelStackFilter("im_search")}function De(e){var t=geByClass1("_im_dialog_star",e),a=geByClass1("_im_dialog_date",e);if(t&&a){var n=a.offsetWidth;t.style.right=15+n+14+"px"}}function xe(e,t){var a=t.get(),n=parseInt(domData(e,"peer")),r=Object(s.getTab)(a,n);if(a.is_peer_profile_enabled&&Object(i.isCommunityInterface)(a)&&r&&!Object(s.isChannelPeer)(r)&&!Object(s.isCommunityChat)(a,n)){var l=geByClass1("_im_dialog_peer_tags",e);if(r.ad_id||a.peer_profile_tags&&r.peer_tags){var c=r.peerTagsMaxWidth||0;if(!c){var u=geByClass1("_im_dialog_name_w",e).offsetWidth;c=340-(u+6+(r.verified?16:0)),t.set(e=>(e.tabs[n].peerTagsMaxWidth=c,Promise.resolve(e)))}!function(e,t,a,n){if(t<69)e.innerHTML="";else{e.style.maxWidth=t+"px";var i=a.get(),r=Object(s.getTab)(i,n),l=m(i,r);if(l.length){var c=d(g(l,t),2),u=c[0],_=c[1],p=u.reduce((e,t)=>(t.isAdTag?e+=getTemplate("sImPeerTagsAdTag",{ad_tag_text:t.adTagText,url:`ads?act=office&union_id=${r.ad_id}&utm_medium=community_messages_ad_tag&utm_source=dialog`,extra_class:r.has_ad_access?"PeerTagsItem--hasAdAccess":""}):e+=getTemplate("sImPeerTagsItem",{name:t.name,color:t.color}),e),""),h=_.length,b="+"+Object(o.getLang)("mail_im_peer_profile_extra_tags",h);h&&(p+=getTemplate("sImPeerTagsExtra",{text:b})),e.innerHTML=p}else e.innerHTML=""}}(l,c,t,n)}else l.innerHTML&&(l.innerHTML="")}}function Be(e,t){hasClass(t,"_im_dialog")&&(Object(i.isCommunityInterface)(e)&&De(t),xe(t,e))}function Re(e){checkEvent(e)||cancelEvent(e)}function Fe(e,t,a,r,o){return{selectPeer(t,a){for(var n=geByClass("_im_dialog",e),i=a.get().peer,s=0;s<n.length;s++){var r=n[s],o=intval(domData(r,"peer")),l=intval(domData(r,"msgid"));o===i&&(!Q(r)||t===l&&Q(r))?(addClass(r,"nim-dialog_selected"),addClass(r,"_im_dialog_selected")):hasClass(r,"_im_dialog_selected")&&(removeClass(r,"nim-dialog_selected"),removeClass(r,"_im_dialog_selected"))}},appendFastDialogs(t,n,r){removeClass(e.parentNode,"im-page--dialogs_with-mess"),a.saveScroll("list"),r?(a.reset(),Object(i.isPendingForward)(t)||Object(s.isRecentSearchesActive)(t)||!f(n)?Object(s.isRecentSearchesActive)(t)&&(f(n)&&(n=[{type:"clear_recent"}].concat(n)),Object(s.doPopularSuggExist)(t)&&(n=[{type:"sep_popular"},{type:"popular_sugg"}].concat(n))):n=[{type:"sep_btn_search_msg"},{type:"sep_conversations"}].concat(n),t.setState({searchOnlyMessages:!1}),a.pipeReplace(Promise.resolve(n)).then(()=>ke(a,t))):a.pipe(Promise.resolve(n)),Object(i.isClassicInterface)(t)&&!Object(i.isReservedPeer)(t.get().peer)||a.toTop()},deactivate(){a.deactivate()},activate(){a.activate()},hoverFirstDialog(e){ke(a,e)},hoverNextDialog(e){a.hoverNextElement($,z,Le(e))},hoverPrevDialog(e){a.hoverPrevElement($,z,Le(e))},unhoverDialogs:Pe.bind(a),selectHoveredDialog(t){var n=geByClass1("_im_dialog_hovered",e);n||(n=geByClass1("_im_dialog",e)),n&&Z(r,this,t,a,{},n)},appendSearch(t,n,i){var s=je(i,n);i.length>0?(addClass(e.parentNode,"im-page--dialogs_with-mess"),a.pipe(Promise.resolve([{type:"sep_messages"}].concat(s))).then(()=>ke(a,t))):(0===a.getCurrentElements().length&&a.pipeReplace(Promise.resolve([Se()])),removeClass(e.parentNode,"im-page--dialogs_with-mess"))},update(e){a.pipeReplace(Promise.resolve(He(e)))},updateDialog(t,a){var n=geByClass1("_im_dialog_"+t,e);n&&!Q(n)&&_e(n,Object(s.getTab)(a,t),a,e)},focusOnSelected(t){var n=t.get().peer;if(n){var i=geByClass1("_im_dialog_"+n,e);i?a.scrollTop(i.offsetTop-i.offsetHeight):a.toTop()}},restoreScroll(e){a.restoreScroll("list")||a.toTop()},forceScrollReinit(){var e=a.getScroller();e&&(e.style.overflowY="hidden",setTimeout(()=>e.style.overflowY="",0))},restoreDialogs:(t,n,s)=>(removeClass(e.parentNode,"im-page--dialogs_with-mess"),t.setState({searchOnlyMessages:!1}),0!==He(t).length||a.isLoading()||(n=!0),n&&a.reset(),s&&a.wipe(),a.pipeReplace(Promise.resolve(He(t))).then(()=>{if(n&&(!Object(i.isClassicInterface)(t)||!t.get().peer)){var e=function(e,t,a){return Object(i.isClassicInterface)(a)||t().toggleSettingsLoader(a,!0),e.checkMore(!Object(i.isClassicInterface)(a)).then(()=>{Object(i.isClassicInterface)(a)||t().toggleSettingsLoader(a,!1)})}(a,r,t);return a.toTop(),e}}).then(()=>Pe(a))),appendDialogs(t,n){removeClass(e.parentNode,"im-page--dialogs_with-mess"),n.forEach(a=>{var n=geByClass1("_im_dialog_"+a.peerId,e);n&&pe(n,a,t)}),Object(i.isPendingForward)(t)||Object(s.isRecentSearchesActive)(t)||!f(n)||(n=[{type:"sep_btn_search_msg"},{type:"sep_conversations"}].concat(n)),t.setState({searchOnlyMessages:!1}),a.isEmpty()&&0===n.length&&Object(i.isPendingForward)(t)&&(n=[Se(getLang("mail_im_search_empty_chats"))]),a.replacePreserveOrder(n)},updateCounter(t,a){var n=geByClass1("_im_dialog_"+a,e),r=Object(s.getTab)(t,a);if(n&&!Q(n)&&(Me(n,r),val(geByClass1("_im_dialog_unread_ct",n),Object(i.simplifyCounter)(r.unread)),toggleClass(n,"nim-dialog_unread",le(r)),toggleClass(n,"nim-dialog_unread-out",oe(t,r,be(r).flags)),toggleClass(n,"nim-dialog_unread-mentions",de(r)),toggleClass(n,"nim-dialog_unread-expiring",ue(r))),Object(s.isRecentSearchesActive)(t)){var o=geByClass1("_im_sugg_"+a,e);o&&(val(geByClass1("_sugg_unread_ct",o),Object(i.simplifyCounter)(r.unread)),toggleClass(o,"sugg-is_unread",r.unread>0))}},removeDialog(e,t){a.remove(t)},updateOnline(t,a){var n=geByClass1("_im_dialog_"+t,e);if(n){var i=a.get().tabs[t],s=geByClass1("_im_peer_online",n);Object(_.toggleOnline)(s,i.online)}},setDialogFailed(t,a,n){var i=geByClass1("_im_dialog_"+t,e);i&&(n.get().tabs[t].lastmsg===a&&(addClass(i,"nim-dialog_failed"),val(geByClass1("_im_dialog_unread_ct",i),"!")))},scrollUp(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];a.toTop(e,t),a.saveScroll("list",!0)},saveScroll(e){a.saveScroll("list",!0)},promoteDialog(n,i){var r=geByClass1("_im_dialog_"+i,e);r&&!Q(r)||!Object(s.isSearching)(n)?(a.pipeReplace(Promise.resolve(He(n)),void 0,!0).then(t=>{!inArray(i,t)&&r&&_e(r,Object(s.getTab)(n,i),n,e)}),t().updateTyping(i,n)):a.unsetScroll("list")},removeSelection(t){var n=t.get().peer.toString(),s=`._im_dialog_${n}.${z.join(".")}`,r=domQuery(s,e)[0];z.forEach(e=>removeClass(r,e)),Object(i.isClassicInterface)(t)||a.hoverElement(n,$,Le(t))},updateScroll(){a.updateScroll()},updateTyping(t,a){var n=geByClass1("_im_dialog_"+t,e);if(n&&!Q(n)&&!a.get().tabs[t].deletedDialog){var r=geByClass1("_im_dialog_typing",n),o=!Object(i.isClassicInterface)(a),l=Object(i.formatTyper)(Object(s.getTab)(a,t).activity,t,!Object(i.isChatPeer)(t),a.get(),1,o);val(r,l),toggleClass(n,"nim-dialog_typing",l)}},showInvitationBox(e,t){var a=()=>this.removeDialog(e,t),o=()=>Object(i.isClassicInterface)(e)&&r().updateMenu(e);return(Boolean(Object(s.getTab)(e,t))?Promise.resolve():e.set(n.loadPeer.bind(null,t,0,0,0))).then(()=>{var r=Object(s.getTab)(e,t);if(!Object(s.tabIsMessageRequestToChat)(r)){var l=h.changePeer(t,!1,!1,!1,"");return e.get().longpoll.push([l])}return Object(i.showInvitationBox)(e,{receiver_peer_id:t},n.leaveInvitation,!1,{updateList:a,updateMenu:o})})},updateStarPosition(){!function(e){geByClass("_im_dialog",e).forEach(e=>{De(e)})}(e)},renderPeerTags(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;a?xe(geByClass1("_im_dialog_"+a,e),t):function(e,t){var a=t.get();a.is_peer_profile_enabled&&Object(i.isCommunityInterface)(a)&&geByClass("_im_dialog",e).forEach(e=>{xe(e,t)})}(e,t)},unmount(){a.unmount(),Object(p.destroyModule)(o)}}}function He(e){var t=e.get(),a=t.active_tab,n=t.dialog_tabs[a],s=t.tabs,r=n.map(e=>s[""+e]).sort(Te.bind(null,e)),o=t.dialog_tab_cts.mr;if(a===y.FOLDER_MESSAGE_REQUEST&&r.unshift({type:"message_request_notice"}),!Object(i.isClassicInterface)(e))switch(a){case y.FOLDER_ALL:o>0&&r.unshift({type:"message_request_button_go"});break;case y.FOLDER_MESSAGE_REQUEST:r.unshift({type:"message_request_button_return"})}return r}function Ue(e,t){return t>(e.get().gid?220:150)||Object(s.isSearching)(e)}function Ge(e,t,a,r){var o=Object(p.createMutations)(Fe),c=o.callMutations,u=o.bindMutations,h=function(e,a){Object(l.showTooltip)(a,{text:()=>{if(Object(s.isRecentSearchesActive)(t))return getLang("mail_hide_from_recent");var e=Number(a.getAttribute("data-peer")),n=Object(s.getTab)(t,e),r=Object(s.tabIsMessageRequestToChat)(n);return Object(i.isChatPeer)(e)&&!r?Object(K.doesChatTabHaveFlag)(Object(s.getTab)(t,e),1024)?getLang("mail_unfollow_channel"):Object(s.isChatActive)(n)?getLang("mail_leave_chat"):getLang("mail_delete"):getLang("mail_delete")},black:1,[Object(i.isClassicInterface)(t)?"center":"needLeft"]:!0,shift:Object(i.isClassicInterface)(t)?[-4,10]:[0,10],toup:Ue(t,a.getBoundingClientRect().top),zIndex:1})},b=function(e,a){Object(l.showTooltip)(a,{text:getLang("mail_end_conversation"),black:1,center:!0,zIndex:1,shift:[1,4],toup:Ue(t,a.getBoundingClientRect().top)})},v=Ie.bind(null,t,e),f=we.bind(null,t,e),O=Ae.bind(null,t,e,c),y={idFn:e=>function(e,t){return t.message?t.message.messageId:Object(s.isSearching)(e)&&t.peerId?t.peerId+"cr":t.peerId||t.type}(t,e),hoverableFn:e=>hasClass(e,"_im_dialog"),renderFn:ye.bind(null,t),more:J.bind(null,t,c),onScroll:!!Object(i.isClassicInterface)(t)&&(()=>{(bodyNode.scrollTop||document.documentElement.scrollTop)<=0&&!layers.visible&&browser.safari?addClass(r,"im-page--header_static"):removeClass(r,"im-page--header_static")}),onRenderFn:Be.bind(null,t)},j=G(e,Object(C.default)({limit:40,offset:0,nativeScroll:!!Object(i.isClassicInterface)(t),height:64,elements:He(t)}),()=>y),S=Z.bind(null,a,c,t,j),E=X.bind(null,t,e,j),w=Ce.bind(null,t,e,c,a),T=fe.bind(null,a,t,e,j),I=Oe.bind(null,t,a),M=Object(p.createModule)({handlers:(r,o)=>{o(e,"click","_im_dialog_close",T),o(e,"click","_im_dialog_markre",O),o(e,"click","_im_dialog_star",f),o(e,"click","_im_dialog",S),o(e,"click",i.MESSAGE_SEARCH_CLASS,E),o(e,"mouseover","_im_dialog_close",h),o(e,"mouseover","_im_dialog_markre",b),o(e,"click",i.CLEAR_RECENT_CLASS,()=>{Object(n.resetRecentSearch)(cur.imDb),Ne(t,j,a)}),o(e,"click",i.TOGGLE_MR_TAB,I),o(e,"mouseover","_im_dialog_star",v),o(e,"click","_im_dialog_daction",w),o(e,"click","_im_peer_target",Re),Object(i.isCommunityInterface)(t)&&t.get().is_peer_profile_enabled&&o(e,"mouseover","_im_peer_tags_extra",e=>function(e,t){var a=e.target,n=gpeByClass("_im_dialog",a),i=parseInt(domData(n,"peer")),r=t.get(),o=Object(s.getTab)(r,i),c=o.peerTagsMaxWidth;if(c){var u=d(g(m(r,o),c),2)[1].reduce((e,t)=>e+=getTemplate("sImPeerTagsExtraTooltipItem",{name:t.name,color:t.color}),"");Object(l.showTooltip)(a,{text:u,center:!0,dir:"bottom",className:"PeerTagsExtraTooltip",hasover:!0})}}(e,t)),r(e,"mouseover",Object(_.throttle)(j.unhoverElements.bind(j,$),100))}});return u(e,c,j,a,M)}a("KKXr"),a("hhXQ");var qe=a("O8ze"),We=a("/eGY"),Ke=a("RQ7Z"),Ve=a("EasH"),Ye=a("ZxpX"),ze=a("Wu9C"),$e=a("ZoqV"),Xe=a("q1tI"),Qe=a.n(Xe),Je=a("i8i4"),Ze=a("MCfn"),et=(a("17x9"),a("gqqU")),tt=a("PjZB"),at=a("grKM"),nt=a("FEsp"),it=a("vRp6"),st=a("xGYt"),rt=a("NsuH"),ot=a("ThPM"),lt=a("7hRE"),ct=a("gdug"),dt=a("6krn"),ut=a("756/");function gt(){return(gt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function mt(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return _t(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _t(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _t(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function pt(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var ht=Xe.useEffect,bt=Xe.useState,vt=dt.default.getLang,ft=e=>{var t,a=e.searchValue,n=e.isLoading,r=e.convos,o=e.mode,l=e.selectedConvos,c=e.store,d=e.onSearchValueChange,u=e.onSearchInputKeydown,g=e.onConvoSelect,m=e.onListLoadMore,_=e.searchInputGetter,p=e.className,h=pt(e,["searchValue","isLoading","convos","mode","selectedConvos","store","onSearchValueChange","onSearchInputKeydown","onConvoSelect","onListLoadMore","searchInputGetter","className"]),b=Object(Ye.classNames)("ConvoPicker",p),v=Xe.createRef(),f=mt(bt(0),2),O=f[0],C=f[1],j=o||"default",S=e=>{e!==O&&(C(e),E(e))},E=e=>{if(t){var a=r[e].peerId,n=t.querySelector(`[data-id="${a}"]`);if(n){var i=n.offsetTop,s=t.scrollTop;if(i<s)t.scrollTop=i;else{var o=t.offsetHeight,l=i+n.offsetHeight;l>s+o&&(t.scrollTop=l-o)}}}};return ht(()=>{_&&_(v.current.element)},[]),Xe.createElement("div",gt({className:b,onMouseLeave:()=>C(-1)},h),Xe.createElement(at.BlockSearchInput,{value:a,onChange:d,onKeyDown:e=>{switch(e.which||e.keyCode){case y.ARROW_UP:S(Math.max(O-1,0)),e.preventDefault();break;case y.ARROW_DOWN:S(Math.min(O+1,r.length-1)),e.preventDefault();break;case y.ENTER:g(r[O].peerId),e.preventDefault()}u(e)},placeholder:vt("mail_top_search"),autoFocus:!0,key:"search",ref:v}),n&&Xe.createElement(nt.default,{className:"ConvoPicker__stub",key:"loading"},Xe.createElement(tt.default,null)),!n&&0===r.length&&Xe.createElement(nt.default,{className:"ConvoPicker__stub",key:"no-results"},vt("mail_im_search_empty_chats")),!n&&r.length>0&&Xe.createElement(it.default,{virtualized:!0,className:"ConvoPicker__results",loadMore:m,hasMore:!1,ref:e=>t=Je.findDOMNode(e),key:"results"},r.map((e,t)=>{var a=e.peerId,n=e.name,r=e.photo,o=e.online,d=Object(s.getTab)(c,a),u=((e,t,a,n,s)=>{var r=Object(i.isContactPeer)(t),o=(e||{}).online||s;switch(!0){case Array.isArray(n):return Xe.createElement(ot.default,{photos:n});case r:return Xe.createElement(ut.ConversationNoPhoto,{id:t,text:Object(i.getUserInitials)(a),size:"34",specificType:7});default:return Xe.createElement(lt.default,{isOnline:!!o,isMobile:!!ct.mobPlatforms[o],title:a,photo:n,onlineSize:"s"})}})(d,a,n,r,o),m=d&&Object(s.isCasperChatTab)(d)?`<span class="ConvoPicker__resultTitle ConvoPicker__resultTitle--casper">\n                    <span class="ConvoPicker__resultTitleText">\n                      ${n}\n                    </span>\n                  </span>`:n,_="radio"===j?Xe.createElement("span",{className:Object(Ye.classNames)("ConvoPicker__radio",{"ConvoPicker__radio--selected":l.includes(a)})}):"";return Xe.createElement(st.default,{key:a,"data-id":a,active:t===O,canBeHovered:!1,chevron:"default"===j,aside:_,onClick:()=>g(a),onMouseEnter:()=>C(t)},Xe.createElement(rt.default,{size:"34",title:m,photo:u,description:d&&Object(i.getChatMemberCount)(d)}))})))},Ot=a("DM26"),yt=a("rjmT");function Ct(){return(Ct=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function jt(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return St(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return St(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function St(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Et=Object(Ot.debouncedPromise)(n.searchHints,300),wt=dt.default.getLang;class Tt extends Xe.Component{constructor(e){var t;super(e),t=this,this.toggleMode=()=>{var e=this.props.store;if(Object(s.isCommunityInterface)(e)){var t=0===this.state.mode?1:0,a=0===t?n.searchImTopConv:n.searchTopConv;this.setState({value:"",mode:t,loading:!0,selected:null,found:[]},()=>a("",e.get()).then(e=>this.setSearchResults(this.filterResults(e))).then(()=>this.searchInput.focus()).catch(e=>console.error(e)))}},this.onChange=e=>{this.setState({value:e.target.value,loading:!0,error:null});var t=e.target.value;this.searchQuery!==t&&(this.searchQuery=t,this.onSearch(t))},this.filterResults=e=>{var t=Object(s.isCommunityInterface)(this.props.store)&&1===this.state.mode;return e.filter(e=>{var a=e.peerId;return!(t&&a<0)&&(!(t&&a>2e9&&!Object(K.doesChatTabHaveFlag)(e,1024))&&!(!t&&a>2e9&&Object(K.doesChatTabHaveFlag)(e,1024)))})},this.onSearch=e=>{var t=this.props.store,a=t.get(),i=Object(s.isCommunityInterface)(t)&&0===this.state.mode,r=i?n.searchImTopConv:n.searchTopConv;return 1===this.state.mode&&""===e?this.emptySearch().then(e=>{this.setSearchResults(this.filterResults(e))}):r(e,a).then(t=>{var n=t.map(e=>e.peerId);return t=this.filterResults(t),this.setSearchResults(t,!1,!t.length),e?Et(e,n,"all",{hidegid:i},a):Promise.resolve([])}).then(t=>{e===this.state.value&&this.setSearchResults(this.filterResults(t),!0)}).catch(()=>{})},this.emptySearch=()=>{var e=this.props.store,t=e.get(),a=t.dialog_tabs.all,i={},r={};return Object(n.searchTopConv)("",t).then(n=>(n.forEach(e=>{r[e.peerId]=e}),[t.peer].concat(a.filter(e=>e!=t.peer)).map(t=>{var a=Object(s.getTab)(e,t);return i[t]=!0,{name:r[t]&&r[t].name||a.tab,photo:r[t]&&r[t].photo||a.photo,data:a.data,peerId:t}}).concat(n.filter(e=>!i[e.peerId]))))},this.sendRecipient=e=>{var t=this.props.store,a=t.get();1===this.state.mode?(a.longpoll.push([Object(h.changePeer)(e,!1,!0,!0,"forward_messages_popup")]),Object(qe.statlogsForwardEvent)(t),Object(s.isCommunityInterface)(t)&&Object(qe.statlogsForwardFromCommunityEvent)(t,!1)):this.setState({selected:e,error:null},()=>{Emoji.focus(this.input)})},this.loadMore=()=>{},this.getSearchInputEl=e=>this.searchInput=e,this.setSearchResults=function(e,a){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t.unmounted)if(a){var i=e.filter(e=>!t.found[e.peerId]);i.forEach(e=>{t.found[e.peerId]=!0}),t.setState({found:[].concat(t.state.found,i),loading:n})}else t.found=e.reduce((e,t)=>(e[t.peerId]=!0,e),{}),t.setState({found:e,loading:n,activeElement:0})},this.getFormRef=e=>{this.form=e},this.getInputRef=e=>{this.input=e},this.getEmojiButtonRef=e=>{this.emojiButton=e},this.onEmojiButtonMouseOver=e=>{e.persist(),Emoji.show(this.emojiButton,e)},this.onEmojiButtonMouseOut=e=>{e.persist(),Emoji.hide(this.emojiButton,e)},this.send=()=>{var e=this.props.store,t=this.state.selected,a=Emoji.val(this.input).trim(),r=new yt.ImDraft({},0),o=e.get().pendingForward;if(t&&!Object(i.isMessageTooLong)(val)){this.setState({sending:!0});var l=Object(s.isCommunityInterface)(e)&&0===this.state.mode;l||r.addAttach("mail",o.msgIds.join(";"),o.object||null);var c={message:a,attaches:r.dData.attaches.map(e=>[e.type,e.id])||[]},d={hidegid:!0,external:{original_gid:e.get().id,fwd_group_msg_ids:l?o.msgIds.join(";"):void 0}};new Promise(a=>{Object(n.loadHashes)([t],{hidegid:!0},e.get()).then(e=>{var n=jt(e,1)[0];return a(n[t])})}).then(a=>e.set(n.sendMessage.bind(null,t,c,Ct({hash:a},d)))).then(()=>{Object(qe.statlogsForwardFromCommunityEvent)(e,!0),e.setState({pendingForward:null}),this.props.closePopup(),showDoneBox(wt("mail_send3"))}).catch(e=>{this.unmounted||this.setState({sending:!1},()=>{Object(Ve.showFastBox)(wt("mail_error"),e)})})}},this.onSearchKeyDown=e=>{27===e.keyCode&&this.state.value&&(this.searchInput.blur(),this.searchQuery="",this.setState({value:"",loading:!0,error:null},this.onSearch.bind(this,"")),e.stopPropagation())},this.onMessageInputKeyDown=e=>{27===e.keyCode&&(this.state.sending||(Emoji.val(this.input,""),this.setState({selected:null}),this.searchInput.focus()),e.stopPropagation())},this.state={value:"",found:[],mode:1,loading:!0,sending:!1,selected:null,activeElement:0},this.emptySearch().then(e=>{this.setSearchResults(this.filterResults(e))}).catch(e=>console.error(e))}componentDidMount(){this.props.updatePopup(),Emoji.init(this.input,{noStickers:!0,onSend:this.send}),this.input.addEventListener("keydown",this.onMessageInputKeyDown)}componentWillUnmount(){this.input.removeEventListener("keydown",this.onMessageInputKeyDown),this.unmounted=!0}render(){var e=this.props,t=e.store,a=e.closePopup,n=this.state,i=n.mode,r=n.loading,o=n.selected,l=n.found,c=n.sending,d=Object(Ye.classNames)("MessageForward",{"MessageForward--form":0===i&&!!o});return Xe.createElement("section",{className:d},Xe.createElement(et.default,{title:Xe.createElement(Xe.Fragment,null,Xe.createElement("span",{className:"MessageForward__title"},wt("mail_forward_messages")),Object(s.isCommunityInterface)(t)&&Xe.createElement("span",{className:"MessageForward__switch",onClick:this.toggleMode},wt(0===i?"mail_forward_to_community_messages":"mail_forward_to_im"))),onCloseClick:a}),Xe.createElement("div",{className:"MessageForward__content"},Xe.createElement(ft,{searchValue:this.state.value,isLoading:r,convos:l,mode:1===i?"default":"radio",selectedConvos:[o],store:t,onSearchValueChange:this.onChange,onSearchInputKeydown:this.onSearchKeyDown,onConvoSelect:this.sendRecipient,onListLoadMore:this.loadMore,searchInputGetter:this.getSearchInputEl,className:"MessageForward__convoPicker"}),Xe.createElement("footer",{className:"MessageForward__footer",ref:this.getFormRef,key:"footer"},Xe.createElement("div",{className:"MessageForward__form _emoji_field_wrap"},Xe.createElement("div",{className:"MessageForward__input",tabIndex:"0",contentEditable:!0,role:"textbox","aria-multiline":!0,ref:this.getInputRef,placeholder:wt("mail_im_enter_msg")}),Xe.createElement("div",{className:"MessageForward__emoji emoji_smile_wrap _emoji_wrap"},Xe.createElement("div",{ref:this.getEmojiButtonRef,className:"emoji_smile _emoji_btn",title:wt("global_emoji_hint"),onMouseOver:this.onEmojiButtonMouseOver,onMouseOut:this.onEmojiButtonMouseOut,onClick:this.onEmojiButtonClick},Xe.createElement("div",{className:"emoji_smile_icon_vector emoji_smile_icon"})))),c?Xe.createElement("div",{className:"MessageForward__send-spinner"},Xe.createElement(tt.default,null)):Xe.createElement("button",{className:"MessageForward__send",onClick:this.send}))))}}var It,Mt=Object(Ze.connect)(Tt);function At(){It&&It.hide()}function Lt(){It&&It.updateBoxCoords()}function kt(){return document.querySelector("#MessageForward")}function Pt(e){var t=document.querySelector("#box_layer_wrap"),a=document.querySelector("#box_loader"),n=isVisible(t);return{unmount(){var t=kt();t&&Je.unmountComponentAtNode(t),Object(p.destroyModule)(e)},showLoader(){boxRefreshCoords(a),show(a),n||show(t)},hideLoader(){hide(a),n||hide(t)}}}function Nt(e,t,a){var i=(0,Object(p.createMutations)(Pt).bindMutations)(Object(p.createModule)({handlers:(e,t)=>{}})),s={hideButtons:!0,bodyStyle:"padding: 0; background: none;",width:500,onShow(){!function(e){var t=kt();t&&Je.render(Xe.createElement(Ze.default,{value:e},Xe.createElement(Mt,{closePopup:At,updatePopup:Lt})),t)}(t),requestAnimationFrame(()=>It.updateBoxCoords())},onHideAttempt:()=>(t.set(n.prepareForward.bind(null,null)),i.unmount(),!0)};return i.showLoader(),Promise.resolve().then(e=>{i.hideLoader(),It=new MessageBox(s).content('<div id="MessageForward"></div>').show()}),i}var Dt=a("r7nW"),xt=a("0toi"),Bt=function(e){var t=e.icon,a=e.children,n=Object(Ye.classNames)("ContactIconRow__icon","ContactIconRow__icon--"+t);return Qe.a.createElement("div",{className:"ContactIconRow"},Qe.a.createElement("div",{className:n}),Qe.a.createElement("div",{className:"ContactIconRow__text"},a))},Rt=a("2zsc"),Ft=function(e){var t=e.contact,a=t.id+19e8;return Qe.a.createElement("div",{className:"ContactPopupContent"},Qe.a.createElement("header",{className:"ContactPopupContent__header"},Qe.a.createElement("div",{className:"ContactPopupContent__photo"},Qe.a.createElement(ut.ConversationNoPhoto,{text:Object(i.getUserInitials)(t.name),size:"80",id:a,specificType:7,key:t.id})),Qe.a.createElement("h3",{className:"ContactPopupContent__title"},Qe.a.createElement(Rt.default,null,Object(i.prepareContactName)(t.name))),Qe.a.createElement("div",{className:"ContactPopupContent__meta"},Object(dt.getLang)("mail_from_contacts_list"))),Qe.a.createElement("div",{className:"ContactPopupContent__info"},t.main_phone&&Qe.a.createElement(Bt,{icon:"phone"},Object(i.formatPhoneNumber)(t.main_phone)),t.emails[0]&&Qe.a.createElement(Bt,{icon:"mail"},Qe.a.createElement("a",{href:"mailto:"+t.emails[0]},t.emails[0]))),t.sync_date&&Qe.a.createElement("div",{className:"ContactPopupContent__info"},Qe.a.createElement(Bt,{icon:"sync"},t.sync_date)))},Ht=a("yAhi"),Ut=function(e){var t=e.getContactInfo,a=e.onClose,n=Qe.a.useState({kind:"loading"}),i=n[0],s=n[1];switch(Qe.a.useEffect((function(){var e=function(e){Object(_.showErrorBox)(e),s({kind:"failed"}),a()};t().then((function(t){t?s({kind:"loaded",contact:t}):e(Object(dt.getLang)("mail_contact_was_removed"))})).catch((function(){e(Object(dt.getLang)("global_error"))}))}),[]),i.kind){case"failed":return Qe.a.createElement(Qe.a.Fragment,null);case"loading":return Qe.a.createElement(Ht.default,null);case"loaded":return Qe.a.createElement(Dt.default,{onClose:a,className:"ContactPopup"},Qe.a.createElement(xt.default.Header,{title:Object(dt.getLang)("mail_contact"),onClose:a,appearance:"blue"}),Qe.a.createElement(Ft,{contact:i.contact}))}};function Gt(e,t,a){var n=qt();if(n){var i=t-19e8;Je.render(Xe.createElement(Ut,{store:e,onClose:a.closeContactPopup,getContactInfo:()=>function(e,t){return zt(e).then(e=>{var a=function(e,t){var a=e.get().contactsList;return a?a.find(e=>e.id===t):null}(e,t);return Promise.resolve(a)})}(e,i)}),n)}}function qt(){return document.querySelector("._im_contact_popup_container")}function Wt(e,t){return{unmount:()=>function(e,t){var a=qt();a&&Je.unmountComponentAtNode(a),Object(p.destroyModule)(e)}(e),closeContactPopup(){var e=qt();Je.unmountComponentAtNode(e)}}}var Kt="im-page--header-action_loading";function Vt(e,t,a){return!e.map(e=>{var n=Object(s.getMessage)(t,a,e);return Object(r.isImportant)(n)}).reduce((e,t)=>e&&t,!0)}function Yt(e,t){var a=t.get(),n=a.peer,i=a.tabs[n].pinned;return 1===e.length&&i&&e[0]===Object(s.parserMessage)(i).messageId}function zt(e){return e.get().contactsList?Promise.resolve(e):e.set(n.getContactsList)}function $t(e,t,a){var n=Object(o.getLang)("mail_selected_shorted",t.length);Zt({actions:!0},"im-page--chat-header"),val(geByClass1("im-page--selected-messages"),getTemplate("im_selected_messages",{label:n.replace("{count}",t.length),tip:Object(o.getLang)("mail_deselect_all")}));var r=Object(s.getTab)(a,a.get().peer),l=e.querySelector("._im_mess_actions"),c=Vt(t,a,a.get().peer),d=Yt(t,a),u=t.length>1,g=!u&&Object(i.isChatPeer)(r.peerId)&&Object(i.canPinMessage)(a,t[0]),m=Object(i.canForwardMessages)(a,t),_=e.querySelector('._im_page_action[data-action="respond"]'),p=e.querySelector('._im_page_action[data-action="forward"]'),h=Boolean(Object(s.tabIsOutgoingMessageRequest)(r)),b=Boolean(Object(s.tabIsMessageRequest)(r));l.className=Object(Ye.classNames)("im-page--mess-actions _im_mess_actions",{"im-page--mess-actions_important":!c,"im-page--mess-actions_pinned":d,"im-page--mess-actions_channel":Object(s.isChannelPeer)(r)&&!a.get().gid,"im-page--mess-actions_multiple-selection":u,"im-page--mess-actions_no-pin-btn":!g,"im-page--mess-actions_out-mr":h,"im-page--mess-actions_in-mr":b,"im-page--mess-actions_no-important-btn":!Object(i.canMarkImportant)(a,t)}),t.length>1?_.innerHTML=Object(o.getLang)("mail_forward_here"):_.innerHTML=Object(o.getLang)("mail_im_mark_reply"),m?(p.removeAttribute("disabled"),p.classList.remove("button_disabled")):(p.setAttribute("disabled","disabled"),p.classList.add("button_disabled")),u&&!m?(_.setAttribute("disabled","disabled"),_.classList.add("button_disabled")):(_.removeAttribute("disabled"),_.classList.remove("button_disabled"));var v=c?Object(o.getLang)("mail_im_toggle_important"):Object(o.getLang)("mail_im_toggle_important_off"),f=d?Object(o.getLang)("mail_unpin"):Object(o.getLang)("mail_pin");attr(geByClass1("im-page-action_star",e),"aria-label",v),attr(geByClass1("im-page-action_pin",e),"aria-label",f)}function Xt(e,t,a){var r=t.get(),o=r.peer,l=r.tabs[o],c=geByClass1("_im_chat_verified",e),d=geByClass1(i.PINNED_CONTAINER_CLASS,e),u=Object(i.isChatPeer)(o),g=u&&Object(s.isChannelPeer)(l),m=r.selectedMessages&&!!r.selectedMessages.length;c.tt=!1;var _=Object(i.renderPhotosFromTab)(t,l,!0),p=getTemplate("im_simple_link",{href:g?"/club"+-l.ownerId:l.href,content:getTemplate("im_peer_photo",{online_class:"",owner_photo:_,modifier_class:"nim-peer_smaller"})});val(geByClass1("im-page--aside-photo",e),p);var h=u&&Object(s.isChatActive)(l),b={muted:inArray(o,r.mutedPeers),verified:!!l.verified,chat:u,vkcomgroup:g,actions:m,derelict:u&&!h&&!g,pinned:!1};if(u){var v=Object(s.getPinnedMessage)(t),f=function(e){var t=Object(s.getPinnedMessage)(e);if(!t||Object(W.oCacheGet)(e,t.userId))return!1;return t.userId}(t);v&&Object(ze.isPinnedMessageVisibleInTab)(t,o)&&(f?t.set(n.loadChatMember.bind(null,{[o]:[f]})).then(Xt.bind(null,e,t,a)):b.pinned=!0)}Qt(t,l,e);var O=!l.top_banner&&d.innerHTML,y=!l.top_banner&&Jt(t,e,d),C=geByClass1("_im_page_peer_name",e);removeClass(C,i.DESELECT_ALL_CLASS),function(e,t,a){var n=a.length>0;geByClass("_im_header_icon",e).forEach(e=>{if("star"===e.dataset.type&&Object(i.isFoldersAvailable)(t)&&(toggleClass(e,"im-page--header-icon_shown",!n),toggleClass(e,"im-page--header-icon_star-active",Object(i.isImportant)(t))),"answer"===e.dataset.type&&Object(i.isFoldersAvailable)(t)&&toggleClass(e,"im-page--header-icon_shown",!n&&Object(i.isUnrespond)(t)),"search"===e.dataset.type&&!Object(i.isCommunityInterface)(t)){var a=t.get().peer,r=!n&&Object(i.isFullyLoadedTab)(t,a)&&Object(s.getTab)(t,a).offset&&!Object(i.isCommunityInterface)(t)&&(!Object(i.isCallToPeerAvailable)(t,a)||!Object(i.isClassicInterface)(t));toggleClass(e,"im-page--header-icon_shown",r)}})}(e,t,[]);var j=e.querySelector("._im_dialog_call_action_wrapper"),S=e.querySelector("._im_header_icon[data-type=call]");if(j&&j.classList.toggle("im-page--header-call-is-hidden",!Object(i.isCallToPeerAvailable)(t,o)||!!l.callInProgress),S&&(S.classList.toggle("im-page--header-icon_shown",Object(i.isCallToPeerAvailable)(t,o)&&!!l.callInProgress),S.classList.toggle("im-page--header-icon_call-active",!!l.callInProgress&&l.callInProgress.participants.count>0)),Object(i.isClassicInterface)(t)){var E=geByClass1("_im_page_back",e);attr(E,"href",`${Object(i.getBaseLink)(t)}?tab=${r.active_tab}`)}Zt(b,"im-page--chat-header"),Object(i.compensateHistoryHeightChange)(t,y,O,a)}function Qt(e,t,a){var n=Object(i.isChatPeer)(t.peerId),r=n&&Object(s.isChannelPeer)(t),l=n&&Object(s.isChatActive)(t),c=n&&Object(s.isCasperChatTab)(t),d=Object(i.isContactPeer)(t.peerId),u=t.name,g="";n?g=r?getTemplate("im_vkcomgroup_members",{name:Object(o.getLang)("mail_im_n_vkcomgroup_members",Object(i.getAliveMembersCount)(t))}):l?getTemplate("im_chat_members",{name:Object(o.getLang)("mail_im_n_chat_members",Object(i.getAliveMembersCount)(t))}):"":Object(i.isUserPeer)(t.peerId)&&(g=Object(i.getLastSeenTextInHeader)(e,t.peerId));var m=[];""===g&&m.push("im-page--title--1line"),c&&m.push("im-page--title--casper"),m=m.join(" ");var _=getTemplate("im_simple_name",{name:d?Object(i.prepareContactName)(t.name):t.tab,href:r?"/club"+-t.ownerId:t.href,name_attr:u,ads_union:t.ad_union_ids_attr,online:g,more_cls:m});val(geByClass1("im-page--title-wrapper",a),_)}function Jt(e,t,a){var n=Object(s.getPinnedMessage)(e),o=a||geByClass1(i.PINNED_CONTAINER_CLASS,t);if(removeClass(o,"im-page--pinned_with-bar"),n&&Object(r.isMoneyRequest)(n)){if(void 0===n.kludges.attach1_tr_amount)return;n.kludges.attach1_total_amount&&addClass(o,"im-page--pinned_with-bar")}var l=Object(i.renderPinnedMessage)(e);return val(o,l),!!l}function Zt(e,t){var a=geByClass1(t);Object.keys(e).forEach(n=>{toggleClass(a,`${t}_${n}`,!!e[n])})}function ea(e,t,a,i,s){e.set(n.removeMessagesWithRestore.bind(null,a,s,i)).then(t().removeMessagesRestore.bind(null,a,s,i)),Object(n.removeMessageSend)(a,s,null,i,e.get())}function ta(e,t,a,r,o){var l=e.get().selectedMessages,c=domData(o,"action"),d=e.get().peer,u=Object(s.getTab)(e,d),g=!0;if("star"!==c&&Object(s.tabIsOutgoingMessageRequest)(u))return na(e,t,a);switch(c){case"delete":var m=!(vk.id==d&&!e.get().gid)&&l.every(t=>Object(i.canMessageBeDeletedForAll)(e,Object(s.getMessage)(e,d,t)));if(m||l.length>1){g=!1;var _=Object(i.showMsgDeleteDialog)(d,l.length,m,i=>{na(e,t,a),_.hide(),cur.imDb.updateByKey("del_forall_checked",i),i?Object(n.removeMessageSend)(l,d,null,"deleteforall",e.get()):ea(e,t,l,c,d)})}else ea(e,t,l,c,d);break;case"spam":ea(e,t,l,c,d);break;case"forward":if(!Object(i.canForwardMessages)(e,l))return;Object(n.processFwd)(l,d,e).then(t=>e.set(n.prepareForward.bind(null,t))).then(()=>a().showForward(e)).catch(e=>console.error(e));break;case"star":var p=Vt(l,e,d);e.set(n.favMessage.bind(null,l,p,d)),e.get().longpoll.push(l.map(e=>({type:p?h.SET_FLAGS:h.RESET_FLAGS,messageId:e,peerId:d,flags:h.FLAG_IMPORTANT})));break;case"respond":var b=e.get(),v=1===l.length;Object(n.processFwd)(l,b.peer,e).then(t=>e.set(n.forwardMessages.bind(null,t,b.tfdraft,v))).then(()=>{t().respond(e,d)});break;case"pin":var f=Object(s.getLocalId)(e,l[0]);if(!Object(i.canPinMessage)(e,f))return;var O=Yt(l,e),y=O?n.unpinMessageOptimistic.bind(null,d):n.pinMessageOptimistic.bind(null,f,d),C=O?n.unpinMessage.bind(null,d):n.pinMessage.bind(null,f,d),j=ca.bind(null,t,d);e.set(n.checkChatMember.bind(null,e,f,d)).then(e=>e.set(y)).then(j).then(e=>e.set(C)).then(j)}g&&na(e,t,a)}function aa(e,t,a,r,l,c){var d=domData(c,"action"),u=r.querySelector("._im_dialog_action_wrapper ._ui_menu").parentNode,g=e.get().peer;switch(d){case n.CHAT_ACTION_CLEAR:var m=Object(s.getTab)(e,g),_=Object(i.showFlushChat)(m,g,()=>{Object(i.cleanHistory)(e,_,t,n.flushHistory,e.get().peer)});break;case n.CHAT_ACTION_MEDIA:showWiki({w:"history"+Object(i.convertPeerToUrl)(g)+"_photo"},null,{});break;case n.CHAT_ACTION_CALL_AUDIO:case n.CHAT_ACTION_CALL_VIDEO:Object(i.isCallToPeerAvailable)(e,g)&&Object(i.startCallFromIm)(e,g,d===n.CHAT_ACTION_CALL_VIDEO,[],i.CALL_ENTRY_POINT_HEADER);break;case n.CHAT_ACTION_SEARCH:t().showSearch(e);break;case n.CHAT_ACTION_BLOCK_NOTIFY:case n.CHAT_ACTION_BLOCK_COMMUNITY:e.set(n.toggleCommunityMessages.bind(null,!1,g)).then(()=>{e.get().longpoll.push([Object(h.resetPeer)()]),showDoneBox(Object(o.getLang)("mail_community_was_blocked"))});break;case n.CHAT_ACTION_ALLOW_COMMUNITY:e.set(n.toggleCommunityMessages.bind(null,!0,g)).then(()=>{a().changeActions(e)});break;case n.CHAT_ACTION_BLOCK:Object(i.showBlacklistBox)(g,e).once("success",t=>{t.delta&&(showDoneBox(t.msg),e.get().longpoll.push([Object(h.resetPeer)()]))});break;case n.CHAT_ACTION_LEAVE:var p=Object(i.showLeaveDialog)(e,g,a=>{var s=e.set(n.leaveChat.bind(null,g)).then(()=>e.set(n.unpinMessageOptimistic.bind(null,g)));a&&s.then(()=>Object(i.cleanHistory)(e,p,t,n.flushHistory,g)),p.hide(),e.get().longpoll.push([Object(h.resetPeer)()])});break;case n.CHAT_ACTION_UNREAD:var b=e.get();Object(n.markDialogUnread)(b.peer,b);break;case n.CHAT_ACTION_RETURN:e.set(n.returnToChat.bind(null,g)).then(e=>e.set(n.getPinnedMessage.bind(null,g))).then(t().updateChatTopic.bind(null,g)).catch(e=>{Object(Ve.showFastBox)(Object(o.getLang)("global_error"),e)});break;case n.CHAT_ACTION_MUTE:case n.CHAT_ACTION_UNMUTE:e.set(n.toggleMutePeer.bind(null,g,d===n.CHAT_ACTION_MUTE,-1)).then(t().updateState.bind(null,g));break;case n.CHAT_ACTION_INVITE:if(Object(i.isChatPeer)(g))Object(i.inviteUser)(e,g,t,n.setCreationType);else if(Object(i.isUserPeer)(g)){var v=e.get().tabs[g],f=[[g,v.tab]];e.set(n.setCreationType.bind(null,"chat",[])).then(()=>t().showCreation(e,f))}break;case n.CHAT_ACTION_PIN_HIDE:Object(ze.pinnedMessageHide)(e,Object(s.getPeer)(e),t);break;case n.CHAT_ACTION_PIN_UNHIDE:Object(ze.pinnedMessageUnHide)(e,Object(s.getPeer)(e),t);break;case n.CHAT_ACTION_UNPIN:Object(ze.pinnedMessageUnpin)(e,Object(s.getPeer)(e),t);break;case n.CHAT_ACTION_SETTINGS:a().showSettings(e)}uiActionsMenu.toggle(u,!1),t().cancelEditing()}function na(e,t,a){var i=e.get().selectedMessages;e.set(n.cleanSelected).then(a().changedMessageSelection).then(t().cleanSelection.bind(null,i))}function ia(e,t,a,n){var s,r,c=Object(i.isClassicInterface)(e);switch(domData(n,"type")){case"star":r=[4,6],s=()=>Object(i.isImportant)(e)?Object(o.getLang)("mail_im_toggle_important_off"):Object(o.getLang)("mail_im_toggle_important");break;case"answer":r=[4,6],s=Object(o.getLang)("mail_end_conversation");break;case"search":r=c?[5,6]:[4,-9],s=Object(o.getLang)("mail_search_in_peer")}Object(l.showTooltip)(n,{text:s||"",black:1,shift:r,forcetoup:!0,appendParentCls:c?"_im_dialog_actions":"_im_mess_actions"})}function sa(e,t,a){var n=Object(i.isClassicInterface)(e),s=domData(a.target,"action");"respond"!==s&&"forward"!==s&&Object(l.showTooltip)(a.target,{text:ra.bind(null,e,s)||"",black:1,shift:[2,n?-4:11],forcetodown:!0,appendParentCls:"_im_dialog_actions"})}function ra(e,t){var a=e.get(),n=a.selectedMessages,i=a.peer;switch(t){case"pin":return Yt(n,e)?Object(o.getLang)("mail_unpin"):Object(o.getLang)("mail_pin");case"star":return Vt(n,e,i)?Object(o.getLang)("mail_im_toggle_important"):Object(o.getLang)("mail_im_toggle_important_off");case"delete":return Object(o.getLang)("mail_delete");case"spam":return Object(o.getLang)("mail_im_mark_spam")}}function oa(e,t,a,r,l){var c=domData(l,"type"),d=e.get().peer;switch(c){case"star":e.set(n.toggleDialogImportant.bind(null,d)).then(()=>{setTimeout(()=>ia(e,0,0,l),40)});break;case"search":a().showSearch(e),window.tooltips&&tooltips.hide(l,{fasthide:!0});break;case"answer":var u=Object(s.getTab)(e,d);u&&(e.set(n.markDialogAnswered.bind(null,e.get().peer,u.lastmsg)),showDoneBox(Object(o.getLang)("mail_marked_as_answered"),{out:1e3}),e.get().longpoll.push([Object(h.resetPeer)()]));break;case"call":if(Object(i.isCallToPeerAvailable)(e,d)){var g=Object(s.getTab)(e,d).callInProgress;g&&Object(i.joinCallFromIm)(e,d,g.join_link,!1,i.CALL_ENTRY_POINT_JOIN_HEADER)}}}function la(e,t){var a=Number(t),n=Object(i.formatTimespan)(a,!0),s=Object(o.getLang)("mail_network_waiting").replace(/{timer}/gi,n);e.querySelector("._im_page_status").innerHTML=s}function ca(e,t,a){return e().updateChatTopic(t,a),a}function da(e,t,a,r){var l={};return{changeActions(t){var a=e.querySelector("._im_dialog_action_wrapper ._ui_menu"),i=geByClass1("_im_dialog_action_wrapper",e),s=t.get().curActions,r=Object.keys(s).map((e,t)=>{var a="";return 7!==n.ACTION_PRIORITIES[e]&&10!==n.ACTION_PRIORITIES[e]||0===t||(a='<div class="ui_actions_menu_sep"></div>'),a+getTemplate("sImUiActionMenuItem",{action:e,name:s[e].name,icon:s[e].icon,classes:"_im_action"})}).join("");0===Object.keys(s).length?addClass(i,Kt):(val(a,r),removeClass(i,Kt))},setNetworkWaitingStatus(t){l.interval&&clearInterval(l.interval),la(e,t),l.timeout=t,l.interval=setInterval(()=>{l.timeout>1?(l.timeout--,la(e,l.timeout)):(clearInterval(l.interval),l={})},1e3)},setNetworkReconnectingStatus(){var t,a;l.interval&&clearInterval(l.interval),l={},t=e.querySelector("._im_page_status"),a=Object(o.getLang)("mail_network_reconnecting"),t&&(t.innerHTML=a)},clearNetworkStatus(){l.interval&&clearInterval(l.interval),l={},e.querySelector("._im_page_status").innerHTML=""},showSettings(t){var a=t.get(),n=Object(s.getTab)(t,a.peer);Object(s.isChatActive)(n)&&Object($e.mount)(e,t,r)},showForward(e){Nt(0,e)},renderPeer(a){Xt(e,a,t)},reRenderPinned(t){var a=Object(s.getCurrentTab)(t);a&&a.pinned&&Jt(t,e)},reRenderTitle(t){var a=Object(s.getCurrentTab)(t);a&&Qt(t,a,e)},renderActions(t){var a=t.get().selectedMessages||[];a.length>0&&$t(e,a,t)},hideActions(t){if(!Object(i.isFullyLoadedTab)(t,t.get().peer)){geByClass("_im_header_icon",e).forEach(e=>{addClass(e,Kt)});var a=geByClass1("_im_dialog_action_wrapper",e);addClass(a,Kt);var n=geByClass1("_im_dialog_call_action_wrapper",e);addClass(n,Kt)}},showActions(t){if(Object(i.isFullyLoadedTab)(t,t.get().peer)){geByClass("_im_header_icon",e).forEach(e=>{removeClass(e,Kt)});var a=geByClass1("_im_dialog_action_wrapper",e);removeClass(a,Kt);var n=geByClass1("_im_dialog_call_action_wrapper",e);removeClass(n,Kt)}},changedMessageSelection(a){if(0!==a.get().peer){var n=a.get().selectedMessages||[];n.length>0?$t(e,n,a):Xt(e,a,t)}},updateLastSeen(t){!function(e,t){var a=e.get().peer,n=geByClass1("_im_page_peer_online",t);n&&Object(i.isUserPeer)(a)&&Object(s.getTab)(e,a)&&Object(i.applyInnerHtml)(n,Object(i.getLastSeenTextInHeader)(e,a))}(t,e)},deselectAll(e){na(e,t,r)},updateState(e){t().updateState.bind(null,e)},unmount(){Object(p.destroyModule)(a),cancelStackFilter("fowrward")}}}function ua(e,t,a){var s=Object(p.createMutations)(da),r=s.callMutations,o=s.bindMutations,l=ta.bind(null,t,a,r),c=aa.bind(null,t,a,r,e),d=na.bind(null,t,a,r),u=(e,a)=>Object(i.showVerifiedTooltip)(a,t.get().peer),g=ia.bind(null,t,e),m=sa.bind(null,t,e),_=oa.bind(null,t,e,a),b=()=>r().showSettings(t),v=a=>{var n=t.get().peer;Object(i.isContactPeer)(n)&&(!function(e,t,a,n){var i=(0,Object(p.createMutations)(Wt).bindMutations)(Object(p.createModule)({handlers:(e,t)=>{}}),e);Gt(e,t,i)}(t,n),cancelEvent(a)),!gpeByClass("im-page--chat-header_chat",a.target,e)||gpeByClass("im-page--chat-header_vkcomgroup",a.target,e)||checkEvent(a)||(b(),cancelEvent(a))},f=()=>function(e,t){var a=()=>{t&&(t.classList.remove("im-page--chat-header_reconnected"),t.removeEventListener("mouseleave",a))};t&&(t.classList.add("im-page--chat-header_reconnected"),t.addEventListener("mouseleave",a)),e.get().longpoll.abortWaiting()}(t,e),O=Object(p.createModule)({handlers:(a,n)=>{n(e,"click","_im_page_action",l),n(e,"click","_im_action",c),n(e,"click",i.DESELECT_ALL_CLASS,d),n(e,"mouseover","_im_chat_verified",u),n(e,"mouseover","_im_header_icon",g),n(e,"mouseover","_im_page_action",m),n(e,"click","_im_header_icon",_),n(e,"click","_im_header_link",v),n(e,"click","_im_page_peer_name",v),n(e,"click","_im_chat_members",b),n(e,"click","_im_page_reconnect",f),n(e,"click","_im_page_back",e=>{checkEvent(e)||(t.get().longpoll.push([Object(h.resetPeer)()]),cancelEvent(e))})}});return Object(i.isReservedPeer)(t.get().peer)||setTimeout(()=>{t.set(n.setActions).then(r().changeActions)}),o(e,a,O,r)}a("/8Fb");var ga,ma,_a,pa,ha,ba,va,fa,Oa,ya,Ca,ja,Sa,Ea,wa,Ta=a("ZVxX"),Ia=browser.msie&&intval(browser.version)<10?window.XDomainRequest:window.XMLHttpRequest;function Ma(e){var t=e%60;return parseInt(e/60)+":"+(t<10?"0":"")+t}var Aa=!1,La=!1,ka=100;function Pa(e){var t=e.get().peer;Object(i.isFullyLoadedTab)(e,t)&&!Object(i.isAnyMessageBeingEdited)(e)&&Date.now()-(Object(i.getTab)(e,t).lastTyping||0)>1e3*n.ACTIVITY_PERIOD&&e.set(n.sendRecordingAudio.bind(null,t))}function Na(e){if(!La){La=!0,Object(i.lockButton)(ba);var t={peer:Oa.get().peer,from_place:cur.docsChooseFrom,imhash:cur.docsChooseImHash,blockPersonal:cur.docsChooseBlockPersonal,mail_add:cur.docsChooseMailAdd};(function(e){return new Promise((t,a)=>{for(var n=new FormData,i=[],s=0;s<e.wave.length;s++)i.push(parseInt(31*e.wave[s]));n.append("waveform",JSON.stringify(i)),n.append("file",e.buffer,"voice_message."+function(e){var t=e.match(/.*\/(\w*).*/);switch(t[1]){case"mpeg":return"mp3";case"ogg":case"webm":case"wav":return t[1]}return""}(e.mimeType));var r=new Ia;r.onload=r.onerror=function(e){var n=e.currentTarget.response;200==this.status&&n.length>0&&"{"==n[0]?(n=JSON.parse(n),t(n)):a()},r.open("POST",wa.upload_url,!0),r.send(n)})})(e).then(e=>e.file?new Promise((a,n)=>{ajax.post("/docs.php",extend({act:"a_save_doc",from:"choose",from_place:t.from_place,imhash:t.imhash,blockPersonal:t.blockPersonal,mail_add:t.mail_add},e),{onDone:(e,n)=>{Fa(),ja([["doc",e+"_"+n,"audiomsg"]],{},t.peer),Ka(),a()},onFail:function(e){n(e)},progress:null})}):Promise.reject()).then(()=>{Object(i.unlockButton)(ba),La=!1}).catch(()=>{La=!1,Object(i.unlockButton)(ba),Object(Ve.showFastBox)(getLang("global_error"),getLang("mail_audio_message_upload_error"))})}}function Da(){Ea(),ma.innerHTML=Ma(Aa.duration),Aa.duration>=600&&Wa()}function xa(e){e.set(n.cancelRecording).then(Ga)}function Ba(){Ea(),stManager.add(["voice_message_player.js","speech.js"],(function(){Aa||(Aa=Speech.newRecorder(),addEvent(Aa,"progress",Da)),AudioMessagePlayer.detachPlayer(),AudioMessagePlayer.pauseGlobalMedia(),Aa.record().then(()=>{var e;e=Oa,wa.isRecording=!0,cancelStackPush("audio_message_cancel",xa.bind(null,e)),hideProgress(geByClass1("im-audio-message-send-wrapper",ga)),ma.innerHTML="0:00",addClass(ga,"im-audio-message_recording"),removeClass(ga,"im-audio-message_recorded"),function(){ga&&ga.classList&&ga.classList.remove("im-audio-message-input--hidden");geByClass1("_im_chat_input_parent",fa).classList.add("im-chat-input--hidden")}(),(Ca=Speech.createVisualization("wave",Aa.source,_a)).start();var t=_a.getBoundingClientRect();ka=(t.right-t.left)/3}).catch(e=>{AudioMessagePlayer.resumeGlobalMedia();var t=e.name;switch(e.name){case"DevicesNotFoundError":case"NotFoundError":case"NotAllowedError":t="mail_audio_message_device_error";break;case"PermissionDeniedError":case"PermissionDismissedError":t="mail_audio_message_permission_error";break;case"Unsupported":t="mail_audio_message_unsupported_error"}Object(Ve.showFastBox)(getLang("global_error"),getLang(t)),console.error(e)})}))}function Ra(){Aa&&Aa.stop(),Ca&&(Ca.destroy(),Ca=null)}function Fa(){wa.isRecording=!1,cancelStackFilter("audio_message_cancel")}function Ha(){Ua(),Na(Aa)}function Ua(){var e;AudioMessagePlayer.loaded&&AudioMessagePlayer.resumeGlobalMedia(),removeEvent(Aa,"finish",Ua),removeEvent(Aa,"finish",Ha),e=URL.createObjectURL(Aa.buffer),domData(ya,"duration",Aa.duration),domData(ya,"ogg",e),domData(ya,"mp3",e),geByClass1("audio-msg-track--duration",ya).innerHTML=Ma(Aa.duration),geByClass1("audio-msg-track--wave-wrapper",ya).innerHTML=AudioMessagePlayer.getWave(Aa.wave,ka),removeClass(ga,"im-audio-message_recording"),addClass(ga,"im-audio-message_recorded")}function Ga(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Fa(),AudioMessagePlayer.loaded&&(AudioMessagePlayer.resumeGlobalMedia(),AudioMessagePlayer.detachPlayer()),removeEvent(Aa,"finish",Ua),removeEvent(Aa,"finish",Ha),Ra(),Ka(),e&&Sa()}function qa(){Aa.isRecording?(addEvent(Aa,"finish",Ha),removeEvent(Aa,"finish",Ua),Ra()):Na(Aa)}function Wa(){addEvent(Aa,"finish",Ua),removeEvent(Aa,"finish",Ha),Ra()}function Ka(){removeClass(ga,"im-audio-message_recorded"),removeClass(ga,"im-audio-message_recording"),ga&&ga.classList&&ga.classList.add("im-audio-message-input--hidden"),geByClass1("_im_chat_input_parent",fa).classList.remove("im-chat-input--hidden")}function Va(){ge("audiomsg_record"),ya=ge("audiomsg_player"),fa=geByClass1("_im_chat_input_w"),ga=geByClass1("im-audio-message-input",fa),ma=geByClass1("audio-msg-track--duration",ga),_a=geByClass1("audio-msg-track--wave",ga),ha=geByClass1("im-audio-message--cancel-btn",ga),ba=geByClass1("_im_audio_send",ga),va=geByClass1("audio-msg-track--btn",ga),geByClass1("im-chat-input--text",fa);var e=geByClass1("im-chat-input--textarea",fa);addClass(e,"_voice_field_wrap"),addEvent(pa,"click",Ba),addEvent(ha,"click",Ga),addEvent(ba,"click",qa),addEvent(va,"click",Wa)}function Ya(){!function(){Aa&&removeEvent(Aa,"progress",Da);removeEvent(pa,"click",Ba),removeEvent(ha,"click",Ga),removeEvent(ba,"click",qa),removeEvent(va,"click",Wa)}(),ya=ga=ma=_a=pa=ha=ba=va=null}function za(e,t,a){return{cancelRecording:Ga,start:function(){Ba()},unmount(){Ga(!1),Ya()}}}function $a(e,t,a,s,r){return Oa=t,wa=t.get().audio_msg,Ea=Pa.bind(null,t),ja=a,Sa=r,Object(Ta.initFailBack)(),Object(i.getAvailableMicrophones)().then(e=>{var a=e.length>0;a?(Va(),s()):setCookie("remixvoice","0",7),t.set(n.setVoiceMessageAvail.bind(null,a))}).catch(e=>{throw setCookie("remixvoice","0",7),e}),(0,Object(p.createMutations)(za).bindMutations)(e,t,a)}var Xa=a("6aSF"),Qa=a("Ht+d"),Ja=a("N4ZS"),Za=a("Egk5");function en(){return(en=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function tn(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}class an extends Xe.Component{constructor(){super(...arguments),this.onLinkClick=e=>{var t=this.props.action.link;if(/^https:\/\/(.+\.)?vk\.com\/gifts580392144\?act=send&ref=[^&]+$/.test(t))return Object(Ve.showBox)("al_gifts.php",{act:"get_gift_box",mid:580392144,fr:0,ref:t.split("&ref=")[1]},{stat:["gifts.css","wide_dd.js","wide_dd.css"],dark:1}),Object(Za.cancelEvent)(e)},this.onButtonClick=()=>{var e=this.props,t=e.action,a=e.sendMessage,n=e.appHash,i=e.keyboardAuthorId;return Object(We.handleButtonClick)(t,a,n,i)}}render(){var e=this.props,t=e.action,a=(e.sendMessage,e.appHash,e.keyboardAuthorId,tn(e,["action","sendMessage","appHash","keyboardAuthorId"])),n=Object(We.getButtonAppearance)(this.props),i=Object(We.getButtonLabel)(this.props),s=t.type,r=Xe.createElement(Qa.default,en({wide:!0,overflow:!0},a,{type:t.type,appearance:n,className:"BotButton BotButton--"+s,onClick:this.onButtonClick}),Xe.createElement("span",{className:"BotButtonLabel Button--overflow",dangerouslySetInnerHTML:{__html:i}}));switch(t.type){case We.BUTTON_TYPE_OPEN_LINK:return this.wrapLinkButton(r);default:return r}}wrapLinkButton(e){var t=this.props.action,a=Object(Ja.wrapAwayIfExternal)(t.link,!0);return Xe.createElement("a",{href:a,className:"Keyboard__buttonWrapper",target:"_blank",rel:"nofollow noopener",onClick:this.onLinkClick},e)}}an.defaultProps={color:We.BUTTON_COLOR_DEFAULT};var nn=an;class sn extends Xe.Component{static getButtonWidth(e){return`calc(100% / ${e} - 10px)`}render(){var e=this.props.store,t=this.props.send,a=e.get(),n=Object(s.getCurrentKeyboard)(e),i=a.keyboard_app_hash;return n&&n.buttons?Xe.createElement("div",{className:Object(Ye.classNames)("Keyboard",{"Keyboard--hidden":n.hide})},Xe.createElement(Xa.default,{className:"Keyboard__scroll-wrapper"},Xe.createElement("div",{className:"Keyboard__container"},n.buttons.map((e,a)=>Xe.createElement("div",{key:"row-"+a,className:"Keyboard__row"},e.map((a,s)=>Xe.createElement("div",{className:"Keyboard__button",key:"cell-"+s,style:{width:sn.getButtonWidth(e.length)}},Xe.createElement(nn,{sendMessage:t,appHash:i,keyboardAuthorId:n.author_id,action:a.action,type:a.action.type,color:a.color})))))))):null}}var rn=Object(Ze.connect)(sn);function on(){return document.getElementById("_im_keyboard_container")}function ln(e,t,a){return{init(){return new Promise(e=>{this.isMounted=!0,function(e,t,a){var n=on();if(n){var i=Xe.createElement(Ze.default,{value:e},Xe.createElement(rn,{send:t}));Je.render(i,n,a)}}(t,a,e)})},toggle:(e,a,i)=>t.set(n.toggleKeyboard.bind(null,e,a,i)),unmount(){var t=on();t&&this.isMounted&&Je.unmountComponentAtNode(t),this.isMounted=!1,Object(p.destroyModule)(e)}}}var cn=a("LYnS"),dn=a("fD+e").default,un=a("m5nf").default,gn=a("m5nf"),mn=gn.MAIN,_n=gn.EDIT;function pn(e,t){return Object(cn.default)().reduce((function(t,a){return t.replace(new RegExp("({"+a.id+"})","gi"),a.process(e))}),t).replace(/&lt;br&gt;/gi,"<br>")}function hn(e,t,a,i,r){var o;return{closeSettingsPopup:function(){o&&o.hide()},showSettingsPopup:function(e){var a=this,n={hideButtons:!0,bodyStyle:"padding: 0; background: none;",width:500,onShow:function(){var n=document.getElementById("TemplatesSettings");n&&Je.render(Xe.createElement(Ze.default,{value:t},Xe.createElement(un,{popup:o,section:e,getTemplates:function(){return Object(s.getTemplates)(t)},saveTemplate:a.saveTemplate.bind(a),deleteTemplate:a.deleteTemplate.bind(a),closePopup:a.closeSettingsPopup.bind(a)})),n),requestAnimationFrame((function(){return o.updateBoxCoords()}))}};(o=new Ve.MessageBox(n).content('<div id="TemplatesSettings"></div>')).show()},applyTemplate:function(e){var a=Object(s.getTemplates)(t).find((function(t){return t.id===e}));Object(qe.statlogsCommunityTemplatesClickEvent)(),i(pn(t,Object(c.prepareToWriting)(a.text)))},getPreparedTemplates:function(){return Object(s.getTemplates)(t).map((function(e){return Object.assign({},e,{name:e.name,text:pn(t,e.text)})}))},saveTemplate:function(e){var a=Object(c.decodeHTMLEntities)(e.name),i=Object(c.decodeHTMLEntities)(e.text);return t.set(e.id?n.updateTemplate.bind(null,e.id,a,i):n.createTemplate.bind(null,a,i))},deleteTemplate:function(e){return t.set(n.deleteTemplate.bind(null,e))},isNeedRenderTemplates:function(){return!!Object(s.getPeer)(t)&&(!!Object(s.isCommunityInterface)(t)&&(!(Object(s.getPeer)(t)>2e9&&Object(K.doesChatTabHaveFlag)(Object(s.getCurrentTab)(t),1024))&&!Object(s.isCommunityChat)(t,Object(s.getPeer)(t))))},toggleImText:function(e){void 0===e&&(e=this.isNeedRenderTemplates()),r(e)},update:function(){this.toggleImText()},unmount:function(){this.toggleImText(!1)}}}function bn(e,t){return t.queues[e].currEv=!1,Promise.resolve(t)}function vn(e,t){var a=t.queues[e].currEv;return a?(t.queues[e].errored.push(a),bn(e,t)):Promise.resolve(t)}function fn(e,t,a){return a.queues[e]?(a.queues[e].errored=t?[]:a.queues[e].errored.concat(a.queues[e].evs),a.queues[e].evs=[],bn(e,a)):Promise.resolve(a)}function On(e,t,a,n){var i=n.get().queues[e];if(i&&!i.currEv&&i.evs.length>0&&!i.pause){var s=On.bind(null,e,t,a,n),r=i.evs.shift();i.currEv=r,t(e,r).then(()=>{n.get().opts.waitCommit||n.set(bn.bind(null,e))}).then(s).catch(t=>n.set(vn.bind(null,e)).then(()=>{a(e,function(e,t){var a=Sn(e,t.get()).errored;return a.length>0&&a[a.length-1]}(e,n),t)}).then(s))}}function yn(e,t,a){var n=a.queues[e];return n.errored.filter(e=>e.mess.messageId===t).forEach(e=>{e.failed=!1,n.evs.push(e)}),n.errored=n.errored.filter(e=>e.mess.messageId!==t),Promise.resolve(a)}function Cn(e){var t=Date.now();return Object.keys(e.queues).forEach(a=>jn(a,e,t,18e5)),Promise.resolve(e)}function jn(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=t.queues[e],s=[];return i.errored.forEach(e=>{e.ts>=a-n?(e.failed=!1,i.evs.push(e)):s.push(e)}),i.errored=s,Promise.resolve(t)}function Sn(e,t){return t.queues[e]||(t.queues[e]={evs:[],pause:!1,errored:[],currEv:!1}),t.queues[e]}function En(e,t,a){return Sn(e,a).pause=t,Promise.resolve(a)}function wn(e,t,a){return t.ts=Date.now(),Sn(e,a).evs.push(t),Promise.resolve(a)}function Tn(e){Object.keys(e.get().queues).forEach(t=>{e.set(vn.bind(null,t)),e.set(fn.bind(null,t,!1))})}function In(e,t,a){var n=Object(C.default)({queues:{},debug:a&&a.debug,opts:extend({},a)},a);return a&&a.store?(n.setState(function(e){for(var t={},a=Object.keys(e.queues),n=a.length,i=0;i<n;i++){var s=a[i],r=e.queues[s];(r.currEv||r.evs.length||r.errored.length)&&(t[s]=r)}return{queues:t,opts:e.opts}}(n.get())),Tn(n)):Tn(n),{pushMessage:(a,i)=>n.set(wn.bind(null,a,i)).then(n=>{On(a,e,t,n)}),resend(a){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return n.set(yn.bind(null,a,i)).then(()=>{var s=n.get().queues[a].evs.filter(e=>e.mess.messageId===i)[0];return On(a,e,t,n),s})},resendAll:()=>n.set(Cn).then(()=>{Object.keys(n.get().queues).forEach(a=>{On(a,e,t,n)})}),resendPeer:a=>n.set(jn.bind(null,a)).then(()=>{On(a,e,t,n)}),reset:a=>n.set(fn.bind(null,a,!0)).then(n=>{On(a,e,t,n)}),setErrored:(e,t)=>n.set(a=>(Sn(e,a).errored=t,Promise.resolve(a))),pause(e){n.set(En.bind(null,e,!0))},isPaused:e=>!!Sn(e,n.get()).pause,complete(a,i){var s=n.get();s.queues[a].currEv&&s.queues[a].currEv.rid===i&&n.set(bn.bind(null,a)).then(()=>{On(a,e,t,n)})},resume(a){n.set(En.bind(null,a,!1)).then(Object(Ot.pause)(.1)).then(()=>{On(a,e,t,n)})},inspectQueue(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!n.get().queues[e])return[];var a=n.get().queues[e];return(t&&a.currEv?[a.currEv]:[]).concat(a.evs.slice()).concat(a.errored.slice().map(e=>extend({},e,{failed:!0}))).sort((e,t)=>e.ts-t.ts)}}}var Mn=a("hOuX"),An=a("QGEU"),Ln=a("BJj/"),kn=(a("Oyvg"),a("rCUf")),Pn="jpg jpeg png gif heic heif".split(" "),Nn=["application/vnd.rn-realmedia-vbr","application/vnd.rn-realmedia"];function Dn(e){var t=Pn.slice(0,Pn.length);if("types"===e){for(var a=t.length,n=0;n<a;++n)t.push(t[n].toUpperCase());return"*."+t.join(";*.")}return"accept"===e?"."+Pn.join(",."):"mask"===e?Pn.join("|"):""}function xn(e,t,a){var n=void 0!==t.ind?t.ind:t,i=t.fileName?n+"_"+t.fileName:t;if(re("upload"+i+"_progress_wrap"),e().unchoose(i),!geByClass1("popup_box_container")){var s=Object(o.getLang)("mail_add_doc_error");"wrong_music_file"===a?s=Object(o.getLang)("mail_upload_music_fail"):"wrong_arch_file"===a||"wrong_arch_mp3_file"===a?s=Object(o.getLang)("mail_upload_arch_fail"):"photo"===Upload.options[n].file_name?s=Object(o.getLang)("mail_add_photo_error"):"video_file"===Upload.options[n].file_name&&(s=Object(o.getLang)("video_upload_error")),setTimeout(Object(Ve.showFastBox)({title:Object(o.getLang)("global_error")},s).hide,2e3)}topError("Upload failed",{dt:-1,type:102,url:(ge("file_uploader_form"+n)||{}).action}),Upload.embed(n)}function Bn(e){var t=void 0!==e.ind?e.ind:e,a=(e.fileName||e.filename||"").replace(/[&<>"']/g,""),n=a?t+"_"+a:e,i=ge("upload"+n+"_progress_wrap");return i&&hide(geByClass1("progress_x",i)),n}function Rn(e,t){if(!e().canAddMedia())return"none";if(!t.items||!t.items.length)return"media";var a="^("+Dn("mask")+")";return[].slice.call(t.items).every(e=>{var t=e.type.split("/");return new RegExp(a,"i").test(t[1])})?"photo":[].slice.call(t.items).every(e=>"video"===e.type.split("/")[0]||~Nn.indexOf(e.type))?"video":"doc"}function Fn(e){var t=geByClass1("_im_upload_dropbox"),a=geByClass1("im-page--chat-header").getBoundingClientRect(),n=geByClass1("im-chat-input").getBoundingClientRect();(a.width<10||n.bottom-a.bottom<10)&&(e="none"),t.style.top=a.bottom+"px",t.style.left=a.left+1+"px",t.style.width=a.width-2+"px",t.style.height=n.bottom-a.bottom+"px",t.setAttribute("data-mode",e),"none"!==e&&t.classList.add("im-dropbox--visible")}function Hn(){geByClass1("_im_upload_dropbox").classList.remove("im-dropbox--visible")}function Un(e,t,a){return{loaded:t,total:a,fileName:e.fileName?e.fileName.replace(/[&<>"']/g,""):void 0}}function Gn(e,t,a,n){"string"==typeof t&&t.indexOf("TERMINATED")>-1||(t=JSON.parse(t),Upload.onUploadError(e,t.error)),n().reHeight(a)}function qn(e,t,a,n,i){var s=t.get().upload_opts,r=geByClass1("_im_upload_photo",i),o=geByClass1("_im_drop_photo",i);return Upload.init(r,s.url,s.params,{accept:Dn("accept"),file_name:"photo",file_size_limit:26214400,file_types:Dn("types"),file_match:s.opts.ext_re,lang:s.opts.lang,multiple:1,multi_progress:1,max_files:10,chooseBox:1,clear:1,type:"photo",max_attempts:3,server:s.opts.server,error:s.opts.default_error,error_hash:s.opts.error_hash,dropbox:o,dragEl:bodyNode,onNoFilteredCallback(e){Upload.onFileApiSend(n,e)},onUploadStart(e,t){delete cur.notStarted,this.onUploadProgress(e,0,0)},onUploadComplete(e,n){var i=window.parseJSON(n);i.photos?function(e,t,a,n){var i=Bn(e);ajax.post("al_photos.php",extend({act:"choose_uploaded"},t),{onDone:function(e,t){n().choose("photo",e,extend(t,{upload_ind:i}))},onFail:xn.bind(null,n,e)})}(e,i,0,a):Gn(e,n,t,a)},onUploadProgress(e,t,n){var i=void 0!==e.ind?e.ind:e;a().progress("photo",i,Un(e,t,n))},onUploadError(e,t){statlogsValueEvent("upload_photo_fails",1,s.opts.server,t),xn(a,e,t)},onDragEnter(e){var t=geByClass1("im-audio-message_recording");e.dataTransfer&&!t&&Fn(Rn(a,e.dataTransfer))},onDragOut(){Hn()},onDrop(){Hn()}})}function Wn(e,t,a,n){var i=t.get().upload_doc_opts,s=geByClass1("_im_upload_doc",n),r=geByClass1("_im_drop_doc",n);return Upload.init(s,i.url,i.params,{file_name:"file",file_size_limit:1024*(parseInt(i.file_size_limit_in_MB)||2048)*1024,file_types:"*.*;",lang:i.opts.lang,multiple:1,multi_progress:1,max_files:10,chooseBox:1,clear:1,type:"doc",max_attempts:3,server:i.opts.server,error:i.opts.default_error,error_hash:i.opts.error_hash,dropbox:r,dragEl:bodyNode,onUploadStart(e,t){delete cur.notStarted,this.onUploadProgress(e,0,0)},onUploadComplete(e,n){var s=window.parseJSON(n);s.file?function(e,t,a,n){var i=Bn(e),s={act:"a_save_doc",blockPersonal:1,from:"choose",mail_add:1};a.opts.imhash&&(s=extend(s,{from_place:"from_gim",imhash:a.opts.imhash})),ajax.post("docs.php",extend(s,t),{onDone:function(e,t,a){n().choose("doc",e+"_"+t,extend(a,{upload_ind:i}))},onFail:xn.bind(null,n,e)})}(e,s,i,a):Gn(e,n,t,a)},onUploadProgress(e,t,n){var i=void 0!==e.ind?e.ind:e;a().progress("doc",i,Un(e,t,n))},onUploadError(e,t){statlogsValueEvent("upload_doc_fails",1,i.opts.server,t),xn(a,e,t)}})}function Kn(e,t,a){removeEvent(bodyNode,"dragover dragenter");var i=geByClass1("_im_upload_dropbox"),s=Wn(0,t,a,i),r=function(e,t,a,i,s){var r=t.get().upload_video_params;if(r){var o=geByClass1("_im_upload_video",s),l=geByClass1("_im_drop_video",s);return r.options.visible_dropbox=!1,Object(kn.getUploadModule)(o,l,r,null,{onUploadStart:function(e,t){delete cur.notStarted,this.onUploadProgress(e,0,0)},onUploadComplete:function(e,i){var s=window.parseJSON(i);s.video_id?Object(kn.onVideoUploaded)(e,s,t.get().textMediaSelector,(e,a)=>{var i=document.querySelector('[data-video="'+a+'"]'),s=e.editable.sizes.x[0]||e.thumb;if(i&&s){i.style.backgroundImage=`url(${s})`;var r=gpeByClass("_im_mess",i);"im"===cur.module&&r&&Object(n.updateVideoThumb)(t,r)}}):Gn(e,i,t,a)},onUploadProgress:function(e,t,n){var i=void 0!==e.ind?e.ind:e;a().progress("video",i,Un(e,t,n))},onUploadError:function(e,t){statlogsValueEvent("upload_video_fails",1,r.options.server,t),xn(a,e,t)},onNoFilteredCallback:function(e){Upload.onFileApiSend(i,e)},onDragEnter:function(e){var t=geByClass1("im-audio-message_recording");e.dataTransfer&&!t&&Fn(Rn(a,e.dataTransfer))},onDragOut:function(){Hn()},onDrop:function(){Hn()}})}}(0,t,a,s,i),l=qn(0,t,a,r,i);cur.lang.attachments_limit=t.get().upload_opts.opts.lang.max_files_warning;var c=Object(p.createModule)({handlers:e=>{var t=ge("im_full_upload");e(t,"change",(function n(i){if(window.Upload&&i.target.files){if(a().canAddMedia()){var s=Array.from(i.target.files),d=s.filter(e=>Upload.checkFileType(e.name,Dn("types"))),u=s.filter(e=>Upload.checkFileType(e.name,Object(kn.getUploadVideoExtMasks)("types")));Upload.onFileApiSend(l,d),Upload.onFileApiSend(r,u)}else Object(Ve.showFastBox)(Object(o.getLang)("global_error"),Object(o.getLang)("global_error"));Object(p.destroyModule)(c);var g=t.cloneNode();g.value="",t.parentNode.replaceChild(g,t),e(t=g,"change",n)}}))}});return{paste(e){Upload.onFileApiSend(l,e)},unmount(){Object(p.destroyModule)(c),Upload.deinit(l),Upload.deinit(r),Upload.deinit(s)}}}var Vn=a("wSs/"),Yn=a("rudk"),zn=a("g1O2");function $n(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Xn(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Xn(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Xn(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function Qn(e,t){if(!e)return!1;window.tooltips&&tooltips.hide(e,t)}function Jn(e){return e.map(e=>({id:e[1],type:e[0],kind:e[2]||null}))}function Zn(e,t,a,n,s,r){var o=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];if(Mi(t,n))return Promise.resolve(!1);var l=oi(n);l.getBoundAttach(a.message)&&(a.message=""),a.share_url=l.getShareUrl(),a.cancelled_shares=l.getCancelledShares();var c=Object(Mn.random)(),d={peerId:t,messageId:"rid"+c,flags:h.FLAG_OUTBOUND,date:intval(Date.now()/1e3)-n.get().timeshift,subject:"",text:Object(i.replaceSpecialSymbols)(clean(a.message)).replace(/\n/gi,"<br>"),local:!0,kludges:{emoji:!0,from_admin:n.get().gid?vk.id:null},type:h.ADD_MESSAGE,attaches:Jn(a.attaches)};return a.rid=c,a.mess=d,e(t,a),n.get().longpoll.push([d]),o&&r().clearText(t,n),s().newMessage(n),Promise.resolve(!0)}function ei(e,t,a,n,i,s,r){var o=arguments.length>7&&void 0!==arguments[7]&&arguments[7];o||(o=e.get().peer);var l=oi(e),c=ti(l,r),d=c?l.dData.attaches.map(e=>[e.type,e.id]):[],u={message:"",attaches:[].concat(d,s)};r&&extend(u,r),ai(e,t,!1).then(()=>Zn(a,o,u,e,t,n,!1).then(a=>(c&&vi(e,i,t),Promise.resolve(a)))).catch(t=>{debugLog(t),ri(e,i)})}function ti(e,t){var a=e.dData,n=t&&t.sticker_referrer,i=n&&0===n.indexOf("suggestion"),s=t&&t.is_hintach_item;return(!a.txt.trim()||i||s)&&0===a.attaches.filter(e=>"reply"!==e.type).length}function ai(e,t,a){return e.get().tabs[e.get().peer].skipped>0?(t().loadingPeer(e),e.setState({no_moving_down:!0}),e.set(n.changePeer.bind(null,e.get().peer,!1,!1)).then(()=>e.set(n.loadPeer.bind(null,e.get().peer,!0,-1,!1))).then(()=>(t().changePeer(e,!1),e.setState({no_moving_down:!1}),a))):Promise.resolve(a)}function ni(e,t,a){var i=!!intval(domData(a,"val"));i!==cur.ctrl_submit&&(cur.ctrl_submit=i,e.set(n.changeSubmitSettings.bind(null,i)))}function ii(e,t,a,i){return!e.get().delayed_ts&&setTimeout(()=>{e.set(n.setDelayedMessage.bind(null,!1,!1)).then(()=>{a(...i)})},t)}function si(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(o.getLang)("mail_send_error"),t=Object(o.getLang)("global_error");Object(Ve.showFastBox)({title:t},e,Object(o.getLang)("mail_ok"),()=>{nav.reload({force:!0})})}function ri(e,t){document.activeElement&&document.activeElement.blur(),si();var a=geByClass1("_im_send",t);return e.set(n.toggleSendingAbility.bind(null,!0)).then(()=>{Object(i.lockButton)(a)})}function oi(e){return e.get().tfdraft||new yt.ImDraft}function li(e,t,a,r,o,l){var d=Object(s.getPeer)(e),u=Object(s.getCurrentKeyboard)(e)||{},g=u.one_time,m=void 0!==g&&g,p=geByClass1("_im_send",r);return Promise.resolve().then(()=>{if(Object(s.isSendingAvailable)(e)){if(Object(n.isAnythingLoading)(e.get())||!Object(i.isFullyLoadedTab)(e,e.get().peer)){var r=ii(e,2e3,li,Object(_.toArray)(arguments));return e.set(n.setDelayedMessage.bind(null,!0,r)).then(()=>{Object(i.lockButton)(p)})}return clearTimeout(e.get().delayed_ts),e.set(n.setDelayedMessage.bind(null,!1,!1)).then(()=>Object(i.unlockButton)(p)).then(ai.bind(null,e,t)).then(()=>{var n=l.keyboardAuthorId,s=l.action||{},r=s.attaches||[],u=Object(c.decodeHTMLEntities)(s.payload||""),g=Object(c.decodeHTMLEntities)(s.label||"");Object(i.isChatPeer)(d)&&(g=`@${Object(W.oCacheGet)(e,n).link.slice(1)} ${g}`);return Object(q.statlogsValueEvent)("message_send_from_keyboard",0,e.get().id,d,n),Zn(a,d,{message:g,attaches:r,payload:u},e,t,o,!1)}).then(()=>m?e.set(n.deleteKeyboard.bind(null,d)):Promise.resolve()).then(()=>o().fixKeyboard())}}).catch(t=>{debugLog(t),ri(e,r)})}function ci(e,t,a,r,l,c){var d=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[];return Promise.resolve().then(()=>{var u=geByClass1("_im_send",r);if(!Object(s.isSendingAvailable)(e))return!1;if(Object(n.isAnythingLoading)(e.get())||!Object(i.isFullyLoadedTab)(e,e.get().peer)){var g=ii(e,2e3,ci,Object(_.toArray)(arguments));return e.set(n.setDelayedMessage.bind(null,!0,g)).then(()=>{Object(i.lockButton)(u)})}clearTimeout(e.get().delayed_ts),l().saveText(e);var m=!1,p=oi(e),b=p.dData.attaches.map(e=>{if("poll"==e.type){var t=c.pollData();return t||(m=!0),[e.type,e.id,t]}return[e.type,e.id]}).concat(d);if(m)return!1;var v=e.set(n.setDelayedMessage.bind(null,!1,!1)).then(()=>{Object(i.unlockButton)(u)}),f=Object(s.getPeer)(e);return v.then(()=>{var n=p.dData.txt,s=t().getEditingMessage();if(s||n||b.length){if(s)return n||b.length&&!p.hasOnlyReplies(s)?Object(i.isMessageTooLong)(n)?void Object(Ve.showFastBox)(Object(o.getLang)("global_error"),Object(o.getLang)("mail_err_edit_too_long")):(t().cancelEditing(),void(Object(Vn.wasMessageReallyModified)(e,s,p)&&(Object(Vn.replaceMsgAfterEdit)(e,s,n,b,p.getShareUrl(),p.getCancelledShares()),t().sendEditMessage(e,s),e.get().longpoll.push([h.editMessageLocallyEvent(s)])))):void di(e,t,r,s.messageId);var c=Object(i.splitMessageToParts)(n,b).map(n=>Zn(a,f,{message:n.msgText||"",attaches:n.attaches||[]},e,t,l));return Promise.all(c)}}).then(ai.bind(null,e,t))}).catch(t=>{debugLog(t),ri(e,r)})}function di(e,t,a,i){var s=e.get(),r=s.peer,l=Object(Ve.showFastBox)({title:Object(o.getLang)("mail_dialog_msg_delete_title"),dark:1},Object(o.getLang)("mail_dialog_msg_delete_for_all"),Object(o.getLang)("mail_delete"),(function(e){Object(n.removeMessageSend)([i],r,null,"deleteforall",s),l.hide(),t().cancelEditing()}),Object(o.getLang)("global_cancel"),(function(){l.hide(),pi(geByClass1("_im_text",a))}))}function ui(e,t,a){return e.set(n.deliverMessage.bind(null,t,a,{}))}function gi(e,t,a,n){e.get().longpoll.push([h.failedMessage(t,a.mess,n)])}function mi(e,t,a,r,o,l,c,d,u){var g,m=Object(Ln.debounce)(Ai.bind(null,e,a),500);var _=Emoji.init(geByClass1("_im_text",t),{ttDiff:93,rPointer:!0,ref:"im",onSend:()=>Di(e,t).then(e=>e&&r([])),controlsCont:t,forceTxt:!e.get().editable,checkEditable:function(a,r){var o=e.get().peer,l=Emoji.val(r);Object(i.isReservedPeer)(o)||Mi(o,e)||oi(e).dData.txt==l||!l||function(e){var t=e.get().peer;Object(i.isFullyLoadedTab)(e,t)&&!Object(s.isAnyMessageBeingEdited)(e)&&Date.now()-(Object(s.getTab)(e,t).lastTyping||0)>1e3*n.ACTIVITY_PERIOD&&e.set(n.sendTyping.bind(null,t))}(e),xi(e,t,l),Ri(e,t,l),m(r);var c=t.offsetHeight;if(g&&g!==c){var u=d().updateScroll();d().scrollFix(e,e.get().peer,u)}g=c},onStickerSend:(e,t,a)=>o([["sticker",e,a]],{sticker_referrer:t}),onHintachSend:(e,t)=>l([[e,t]],{is_hintach_item:!0}),uploadActions:c,suggestionsConfig:e.get().suggestionsConfig,clearText:function(){u().clearText(e.get().peer,e)}});return Emoji.emojiLoadMore(_),e.setState({emojiOptId:_}),_}function _i(e,t,a){var n=Emoji.val(geByClass1("_im_text",t));Object(s.isAnyMessageBeingEdited)(e)&&""!==n||Di(e,t).then(t=>{var i=intval(domData(a.target,"tttype"));(2===i&&!0!==t||1===i&&!0===t||3!==i&&""===n)&&window.tooltips&&tooltips.destroy(a.target,{fasthide:!0});var r=oi(e).dData.attaches.length>0;if(Object(s.isAnyMessageBeingEdited)(e)&&""===n&&!r)return domData(a.target,"tttype",3),Object(l.showTooltip)(a.target,{text:Object(o.getLang)("mail_delete_for_all"),black:!0,force:3!==i,appendParentCls:"_im_chat_input_parent",shift:[-8,-10]});if(!0!==t)return domData(a.target,"tttype",1),Object(l.showTooltip)(a.target,{text:Object(o.getLang)("mail_added_audiomsg"),black:!0,force:1!==i,appendParentCls:"_im_chat_input_parent",shift:[-8,-10]});domData(a.target,"tttype",2);var c=e.get().ctrl_submit?1:0;return Object(l.showTooltip)(a.target,{text:getTemplate("ctrl_submit_hint",{enter_on:c?"":"on",ctrl_on:c?"on":""}),dir:"down",shift:[-28,-5],needLeft:!0,className:"im-chat-input--tt",hasover:!0,force:2!==i,showdt:700,zIndex:200,hidedt:700,appendParentCls:"_im_chat_input_parent",onCreate(){radioBtns.im_submit={els:Object(_.toArray)(geByClass("_im_submit_btn")),val:c}}})})}function pi(e){Emoji.focus(e,!0),setTimeout(Emoji.correctCaret.pbind(e),10)}function hi(e,t,a,n){var l=e.getFwdRaw(),c=t.querySelector("._im_media_fwd"),d=t.parentNode.querySelector("._im_replied_content");if(!(Object(s.getCurrentKeyboard)(n)||{}).hide&&l&&a.toggleKeyboard(!0),c.innerHTML="",d.innerHTML="",l){var u=function(e,t){if(e.get().isEditing){var a=Object(i.getNowEditingMessage)(e);return a&&Object(r.hasReply)(a)}return"reply"===t.type}(n,l),g=u?d:c,m=l.object;g.innerHTML=u?bi(m):function(e,t,a,n){if(a.object&&a.object.authorName){var s=Object(i.renderShortText)(0,"",n.text,!0,Object(Yn.convertKludgesToAttaches)(n.kludges,0));return getTemplate("im_attach_mess",{messages:s,text:n.authorName,date:getSmDate(n.date,e.get().timeshift),modifier:"im-fwd_msg"})}return getTemplate("im_attach_mess",{messages:Object(o.getLang)("mail_title_X_msgs",t.getFwdCount()),text:Object(o.getLang)("mail_im_fwd_msgs_title"),date:"",modifier:""})}(n,e,l,m)}}function bi(e){var t=Object(i.renderShortText)(0,"",e.text,!0,Object(Yn.convertKludgesToAttaches)(e.kludges,0));return getTemplate("im_replied_message",{authorName:e.authorName,text:t})}function vi(e,t,a){return e.set(n.forwardMessages.bind(null,null,oi(e),!1)).then(()=>{var n=t.querySelector("._im_media_fwd"),i=t.parentNode.querySelector("._im_replied_content"),s=document.querySelector("._im_chat_audio_input_parent ._im_replied_content");i&&i.children.length&&(i.innerHTML="",yi(e,a)),s&&s.children.length&&(s.innerHTML="",yi(e,a)),n&&n.children.length&&(n.innerHTML="",yi(e,a)),xi(e,t)})}function fi(e,t,a){var i=Object(s.getPeer)(e);e.set(n.acceptMessageRequest.bind(null,i)).then(()=>{Ni(e,i,t),a()}).catch(()=>si())}function Oi(e,t,a){var r=Object(s.getPeer)(e);e.set(n.rejectMessageRequest.bind(null,r)).then(()=>{Object(i.isClassicInterface)(e)&&t(e),a(e,r),r===e.get().peer&&e.get().longpoll.push([h.resetPeer()])}).catch(()=>si())}function yi(e,t){var a=t().updateScroll();t().scrollFix(e,e.get().peer,a)}function Ci(e,t,a,i){var s=e.get().peer,r=inArray(s,e.get().mutedPeers);e.set(n.toggleMutePeer.bind(null,s,!r,-1)).then(a().updateState.bind(null,s)),cancelEvent(i)}function ji(e,t,a,i){var s=e.get().peer;e.set(n.returnToChat.bind(null,s)).then(e=>e.set(n.getPinnedMessage.bind(null,s))).then(a().updateChatTopic.bind(null,s)),cancelEvent(i)}function Si(e,t,a,n,r,o,l,c){if("close"!==l&&"open"!==l&&"hide"!==l)throw new Error(`Action "${l}" not found`);var d=e.get(),u=Object(s.getCurrentKeyboard)(e);(Object(i.isCommunityInterface)(e)||!u||d.isEditing)&&(l="hide");var g="close"===l||"hide"===l,m=Promise.resolve();g||a.isMounted||(m=a.init());var _=!u&&"open"!==l;return m.then(()=>(toggleClass(t,"im-chat-input_open-keyboard",!g),toggleClass(t,"im-chat-input_close-keyboard",g&&"hide"!==l),toggleClass(n,"im_chat-input--keyboard-button_hidden","hide"===l),a.toggle(d.peer,g,o))).then(()=>{if(!_||c){var t=r().updateScroll();return r().scrollFix(e,d.peer,t)}})}function Ei(e,t){if(Object(s.isAnyMessageBeingEdited)(e))return!1;var a=e.get();if(Object(i.isCommunityInterface)(e))return!1;if(!Object(s.getCurrentTab)(e).moneyTransferAvail)return!1;if(Object(i.isCommunityPeer)(t))return a.moneyTransferCommAvail;if(Object(i.isUserPeer)(t)){var n=inArray(t,a.moneyTransferExcept);return t!=vk.id&&!n&&!Object(i.isContactPeer)(t)}return!1}function wi(e,t){return!Object(s.isAnyMessageBeingEdited)(e)&&(!!e.get().moneyRequestAvail&&(!!Object(s.getCurrentTab)(e).moneyRequestAvail&&(!(!Object(i.isCommunityPeer)(t)&&!Object(i.isChatPeer)(t))||!!Object(i.isUserPeer)(t)&&(t!=vk.id&&!Object(i.isContactPeer)(t)))))}function Ti(e,t,a,n,r,o,l,c,d,u,g,m,_,h,b,v){return{restoreKeyboard(){this.toggleKeyboard(!!(ls.get("is_keyboards_hide")||{})[Object(s.getPeer)(e)])},toggleKeyboard(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!Object(s.getCurrentKeyboard)(e).hide,a=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return Si(e,n,m,g,o,a,t?"close":"open")},initKeyboard(){if(!e.get().peer||!Object(s.getCurrentKeyboard)(e))return Promise.resolve();var t=!!(ls.get("is_keyboards_hide")||{})[Object(s.getPeer)(e)];return Si(e,n,m,g,o,!0,t?"close":"open")},fixKeyboard(){var t,a=Object(s.getCurrentKeyboard)(e);return t=a?a.hide?"close":"open":"hide",Si(e,n,m,g,o,!0,t,!0)},hideKeyboard:()=>Si(e,n,m,g,o,!1,"hide"),restoreDraft(e,r,l){t.chosenMedias.length>0&&(e.setState({removingMedias:!0}),t.unchooseMedia(),t.chosenMedias=[],e.setState({removingMedias:!1}));var c=e.get().peer,d={gift:Object(i.isGiftOptionAvailableForPeer)(e,c)&&!Object(s.isAnyMessageBeingEdited)(e),money:Object(i.isMoneyOptionAvailableForPeer)(e,c)&&!Object(s.isAnyMessageBeingEdited)(e),poll:Object(i.isChatPeer)(c)},u=geByClass1("ms_items_more",n);Object.entries(d).forEach(e=>{var t=$n(e,2),a=t[0],n=t[1],i=geByClass1("ms_item_"+a,u);toggleClass(i,"ms_item--hidden",!n)});var g={im:!0,fromId:-Object(s.getGroupId)(e)||vk.id,peer:c,moneyTransfer:{request:wi(e,c),send:Ei(e,c)}},m=e.get().emojiOptId;if(void 0===m?e.setState({suggestionsConfig:g}):Emoji.setSuggestionsConfig(m,g),Object(i.isReservedPeer)(c))return Promise.resolve();var _=oi(e);return Emoji.val(a)!==_.dData.txt?(!function(e,t){Emoji.val(e,clean(t)),pi(e)}(a,_.dData.txt),Ri(e,n,_.dData.txt)):pi(a),_.prepareObjects(e.get().gid,r&&r.messageId).then(()=>{if(!Ni(e,c,a)&&c==e.get().peer){for(var i=_.dData.attaches,s=0;s<i.length;s++)t.chooseMedia(i[s].type,i[s].id,i[s].object||{});if(hi(_,n,this,e),l){var r=o().updateScroll();o().scrollFix(e,c,r)}xi(e,n,_.dData.txt)}})},sendMessage(){r([])},sendMessageFromKeyboard(){for(var t=arguments.length,a=new Array(t),i=0;i<t;i++)a[i]=arguments[i];return li.call(null,e,o,h,n,...a)},choose(e,a,n){t.chooseMedia(e,a,n)},updateChosenMedia(e,a,n){t.updateChosenMedia(e,a,n)},canAddMedia:()=>!t.hasRestrictingAttach()&&!Mi(e.get().peer,e),isEmpty:e=>!trim(Emoji.val(a))&&!oi(e).hasAttaches(),unchoose(e){t.unchooseMedia(e)},attachCount:()=>t.attachCount(),progress(e,a,n){t.showMediaProgress(e,a,n)},updateState(e){this.restoreKeyboard(),Ni(e,e.get().peer,a)},focusOn(e){Emoji.editableFocus(a,!1,!0)},setDraft(e,t){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=Object(s.getTab)(e,e.get().peer);Object(K.doesChatTabHaveFlag)(n,1024)&&!e.get().gid||(_&&_.update(),e.setState({tfdraft:t}),t&&this.restoreDraft(e,o().getEditingMessage(),a))},clearText(e,i){oi(i).clear(),t.cancelCheckUrl(),t.unchooseMedia(),t.chosenMedias=[],Emoji.val(a,""),vi(i,n,o);var s=o().updateScroll();o().scrollFix(i,i.get().peer,s)},attachMessages(e,t){if(e.get().peer===t){hi(oi(e),n,this,e);var a=o().updateScroll();o().scrollFix(e,t,a),xi(e,n)}},detachMessages(t){var a=oi(e).getFwdRaw();if(a&&!!a.id.split(";").find(e=>Math.abs(e)===t.messageId))return vi(e,n,o).then(()=>{var t=o().updateScroll();o().scrollFix(e,e.get().peer,t)});return Promise.resolve()},cancelRecording(){u.cancelRecording()},reHeight(e){var t=o().updateScroll();o().scrollFix(e,e.get().peer,t)},isBlocked:()=>Mi(e.get().peer,e),toggleStickers(e,t){Emoji.toggleStickers(e.get().emojiOptId,!t)},saveText(e){oi(e).setText(Emoji.val(geByClass1("_im_text",n)))},resendAll(){b()},resendPeer(){v(e.get().peer)},unmount(){Object(p.destroyModule)(d),t.destroy(),c.unmount(),m.unmount(),_&&_.unmount(),Emoji.destroy(e.get().emojiOptId),u.unmount()}}}function Ii(e,t){return!!Object(i.isChatPeer)(e)&&t.get().tabs[e].data.kicked}function Mi(e,t){return Ii(e,t)||Object(s.getTab)(t,e)&&Object(s.getTab)(t,e).block_error>0||Object(i.isLocksAvailable)(t)&&Object(i.isPeerBlocked)(e,t)}function Ai(e,t,a){var n=e.get().peer,s=Emoji.val(a);Object(i.isReservedPeer)(n)||oi(e).dData.txt==s||Mi(n,e)||(t.checkMessageURLs(s,!0,2e3),oi(e).setText(s))}function Li(e){var t=oi(e).getFwdRaw();t&&window.showForwardBox({act:"a_show_forward_box",will_fwd:t.id,gid:e.get().gid})}function ki(e,t){e.disabled=!0,e.contentEditable="false",addClass(e,"im-chat-input--text_disabled"),addClass(t,"im-chat-input_error"),addClass(geByClass1("_im_page_history"),"is_tf_blocked")}function Pi(e,t){e.disabled=!1,e.contentEditable="true",removeClass(e,"im-chat-input--text_disabled"),removeClass(t,"im-chat-input_error"),removeClass(geByClass1("_im_page_history"),"is_tf_blocked")}function Ni(e,t,a){var n=gpeByClass("_im_chat_input_parent",a),r=geByClass1("_im_chat_input_error",n),l=Object(s.getTab)(e,t);if(Mi(t,e)){ki(a,n);var c=function(e,t,a){switch(a.block_error){case 7:case 5:return Object(o.getLang)("mail_peer_deleted");case 14:return Object(o.getLang)("mail_community_deleted");case 11:return Object(o.getLang)("mail_group_banned_messages");case 28:return Object(o.getLang)("mail_cant_send_messages_by_time");case 29:return Object(o.getLang)("mail_cant_send_messages_by_web_bot");case 4:case 6:case 9:case 19:case 20:case 13:return Object(i.isCommunityPeer)(t)?Object(o.getLang)("mail_send_privacy_community_error"):Object(o.getLang)("mail_send_privacy_error");case 23:var n=Object(W.oCacheGet)(e,t);return langSex(n.sex,Object(o.getLang)("mail_blacklist_user","raw")).replace("{user}",n.kick_name);case 12:return Object(o.getLang)("mail_cant_send_messages_to_community");case 16:return Object(o.getLang)("mail_chat_youre_kicked");case 26:return Object(o.getLang)("mail_chats_is_disabled");case 0:if(Ii(t,e))return Object(o.getLang)("mail_chat_youre_kicked");var s=e.get().block_states[t].name;return Object(o.getLang)("mail_community_answering").replace("{username}",s);default:return Object(o.getLang)("mail_send_privacy_error")}}(e,t,l);if(Object(s.isChannelPeer)(l)&&addClass(geByClass1("_im_page_history"),"is_channel"),Object(i.isFvkcomgroup)(e,t)&&!e.get().gid){addClass(n,"is-f-vkcomgroup");var d=inArray(t,e.get().mutedPeers);c=Object(s.isChatActive)(l)?getTemplate("sImPeerMuteUnmute",{text:d?Object(o.getLang)("mail_im_unmute"):Object(o.getLang)("mail_im_mute"),cls:d?"im-action_unmute":"im-action_mute"}):getTemplate("sImPeerReturnToChat",{text:Object(o.getLang)("mail_return_to_vkcomgroup")})}else removeClass(n,"is-f-vkcomgroup");return val(r,c),!0}return l&&Object(i.tabIsMessageRequest)(l)&&!Object(i.tabIsRejectedMessageRequest)(l)?(ki(a,n),addClass(n,"is-message_request"),val(r,getTemplate("sImPeerAcceptOrRejectMessageRequest",{cls_accept:"_mr_button_accept",cls_reject:"_mr_button_reject"})),!0):(n.classList.contains("is-message_request")&&(Pi(a,n),removeClass(n,"is-message_request"),val(r,"")),a.disabled&&(removeClass(n,"is-f-vkcomgroup"),removeClass(geByClass1("_im_page_history"),"is_channel"),Pi(a,n),removeClass(n,"is-message_request"),val(r,"")),!1)}function Di(e,t,a){return Object(i.isVoiceMessageAvailable)(e).then(n=>{if(!n&&!Object(s.isAnyMessageBeingEdited)(e))return!0;var r=null!=a?a:Emoji.val(geByClass1("_im_text",t));if(trim(r))return!Object(s.isAnyMessageBeingEdited)(e)||!Object(i.isMessageTooLong)(r);var o=oi(e),l=Object(i.getNowEditingMessage)(e);return o.hasAttaches()&&!o.hasOnlyReplies(l)})}function xi(e,t,a){var n=geByClass1("_im_send",t.parentNode);Qn(n,{fasthide:!0}),Di(e,t,a).then(t=>{if(Object(s.isAnyMessageBeingEdited)(e))toggleClass(n,"is_input_empty",!t),attr(n,"aria-label",Object(o.getLang)("mail_im_edit"));else{toggleClass(n,"im-send-btn_audio",!t),toggleClass(n,"im-send-btn_send",t),t&&removeClass(n,"im-send-btn_saudio");var a=t?Object(o.getLang)("mail_send2"):Object(o.getLang)("mail_added_audiomsg");attr(n,"aria-label",a)}})}function Bi(e){var t=geByClass1("MassMentionWarning",e);t.classList.contains("MassMentionWarning--hidden")||t.classList.add("MassMentionWarning--hidden")}function Ri(e,t,a){var n=Object(s.getCurrentTab)(e);if(n){if(!Object(i.isChatPeer)(n.peerId)||Object(s.isChannelPeer)(n))return Bi(t);var r=(a.match(y.RE_MASSMENTION)||[]).map(e=>e.slice(1));if(0===r.length)return Bi(t),void e.set(e=>(n.dontReopenWarningForCurrentMassMention=!1,Promise.resolve(e)));var l=geByClass1("MassMentionWarning",t),c=geByClass1("MassMentionWarning__title",l),d=geByClass1("MassMentionWarning__text",l),u=(e,t)=>{n.dontReopenWarningForCurrentMassMention||(c.innerHTML!==e&&(c.innerHTML=e),d.innerHTML!==t&&(d.innerHTML=t),l.classList.remove("MassMentionWarning--hidden"))},g=y.MASS_MENTION_ALIASES.all.some(e=>r.includes(e)),m=y.MASS_MENTION_ALIASES.online.some(e=>r.includes(e));switch(!0){case g&&n.membersCount>=11:return u(Object(o.getLang)("mail_im_mass_mention_warning_title"),Object(o.getLang)("mail_im_mass_mention_warning_many_people_mentioned_text",n.membersCount-1));case m&&n.membersCount>=30:return u(Object(o.getLang)("mail_im_mass_mention_warning_title"),Object(o.getLang)("mail_im_mass_mention_warning_maybe_many_people_mentioned_text"));default:return Bi(t)}}}function Fi(e,t,a,r,c){cur.share_timehash=t.get().share_timehash;var d=Object(p.createMutations)(Ti),u=d.callMutations,g=d.bindMutations,m=Kn(0,t,u),_=ui.bind(null,t);ls.remove("im_send_queue_2"+vk.id),ls.remove("im_send_queue_1"+vk.id);var b=In(_,gi.bind(null,t),{store:!0,key:"im_send_queue_"+vk.id,waitCommit:!0}),v=b.pushMessage,f=b.inspectQueue,O=b.resend,y=b.resendAll,C=b.resendPeer,j=b.setErrored,S=b.complete,E=ei.bind(null,t,c,v,u,e),w=ei.bind(null,t,c,v,u,e),T=Li.bind(null,t);hide(geByClass1("ms_items_more_helper",e));var I=t.get().mediaTypes||[["photo",Object(o.getLang)("mail_added_photo")],["video",Object(o.getLang)("profile_wall_video")],["audio",Object(o.getLang)("profile_wall_audio")],["doc",Object(o.getLang)("profile_wall_doc")],["map",Object(o.getLang)("profile_wall_map")],["gift",Object(o.getLang)("profile_wall_gift")]];(t.get().moneyTransferAvail||t.get().moneyRequestAvail)&&I.push(["money",Object(o.getLang)("profile_wall_money")]);var M=new MediaSelector(geByClass1("_im_media_selector",e),"_im_media_preview",I,{from:"message",maxShown:0,vectorIcon:!0,ignoreMobile:!0,onAddMediaChange:function(a,i,s,r){return a&&u().toggleKeyboard(!0),function(e,t,a,i,s,r,o,l,c){if(!t.get().removingMedias){if("album"===s||"page"===s||"mail"===s||"reply"===s)return!1;if("share"===s&&!o.title)return!1;var d,u;r&&"string"==typeof s?(l&&oi(t).addBindUrl(l,s,r),oi(t).addAttach(s,r,o)):(oi(t).syncWithSelector(c),"number"==typeof r&&c.chosenMedias[r]&&(d=c.chosenMedias[r],u=oi(t),("string"==typeof d[0]&&"string"==typeof d[1]&&d[1]||"string"==typeof d[0]&&"group"===d[0])&&u.dData.cancelled.push(`${d[0]},${d[1]}`)));var g=e().updateScroll();if(e().scrollFix(t,t.get().peer,g),t.get().delayed_message&&!Object(n.isAnythingLoading)(t.get()))return a([]),!1;xi(t,i)}}(c,t,A,e,a,i,s,r,M)},onMediaChange:function(){return function(e,t,a,n,i){if(!t.get().removingMedias){var s=i.getMedias().find(e=>"poll"===e[0]);s&&oi(t).addAttach(s[0],s[1],i.pollData(!0,!0)),xi(t,n)}}(0,t,0,e,M)},editable:1,onChangedSize:function(){var a,n,i=c().updateScroll();c().scrollFix(t,t.get().peer,i),a=e,n=ge("_im_media_preview").offsetHeight,toggleClass(a,"im-chat-input--overflowed",n>400)},sortable:1,teWidth:150,mail:1,teHeight:100,forceToUp:!0,toId:t.get().gid?-t.get().gid:void 0,blockPersonal:t.get().gid?1:0,docParams:t.get().gid?{imhash:t.get().upload_doc_opts.opts.imhash,from:"from_gim"}:{}}),A=ci.bind(null,t,c,v,e,u,M),L=_i.bind(null,t,e),k=geByClass1("_im_send",e),P=ei.bind(null,t,c,v,u,e),N=$a(e,t,P,()=>{addClass(k,"im-send-btn_audio"),removeClass(k,"im-send-btn_static")},()=>{u().restoreKeyboard()});!function(e,t){var a=geByClass1("_im_text",e),n=Object(Ot.promisify)(stManager.add);(window.Wall?Promise.resolve():n(["page.js"])).then((function(){Wall.initComposer(a,{lang:{introText:Object(o.getLang)("profile_mention_start_typing"),noResult:Object(o.getLang)("profile_mention_not_found")},toup:!0,getValue:()=>t.get().peer>2e9?(window.Emoji&&Emoji.editableVal||val)(a):"",onShow:()=>{addClass(e,"im_mention_shown");var t=data(a,"composer");if(t&&t.wdd&&t.wdd.shown){var n=0,i=!1,s=function(){t.ignoredTerm=t.curTerm,t.curTerm=!1,val(t.wddInput,""),Composer.toggleSelectList(t)};each(t.wdd.shown,(function(){this[0]&&(n++,"@"+t.curTerm==this[2]&&(i=!0))})),!n||i&&1==n?s():cancelStackPush("im_mention",s)}},onHide:()=>{removeClass(e,"im_mention_shown"),cancelStackFilter("im_mention")},searchKeys:[1,7,9],wddOpts:{}})}))}(e,t),t.get().textMediaSelector=M,t.set(n.initTextStore.bind(null,f,O,j,S));var D=geByClass1("_im_text",e);setTimeout(()=>{Object(s.getPeer)(t)&&u().setDraft(t,Object(s.getTabDraft)(Object(s.getCurrentTab)(t))),mi(t,e,M,A,E,w,m,c,u)},0);var x=vi.bind(null,t,e,c),B=fi.bind(null,t,D,()=>{var e=c().updateScroll();c().scrollFix(t,Object(s.getPeer)(t),e)}),R=Oi.bind(null,t,a,r),F=Ci.bind(null,t,e,c),H=ji.bind(null,t,e,c),U=ni.bind(null,t);Ni(t,t.get().peer,D);var G=e.querySelector("._im_keyboard_button"),q=function(e,t,a,n,i){return(0,Object(p.createMutations)(ln).bindMutations)(Object(p.createModule)({handlers:(e,t)=>{}}),t,n)}(0,t,0,li.bind(null,t,c,v,e,u)),W=Object(i.isCommunityInterface)(t)?function(e,t,a,n){var i=(0,Object(p.createMutations)(hn).bindMutations)(Object(p.createModule)({handlers:function(){}}),e,t,a,n);if("function"!=typeof i){i.toggleImText();var s=Xe.createElement(Ze.default,{value:e},Xe.createElement(dn,{getTemplates:i.getPreparedTemplates,applyTemplate:i.applyTemplate.bind(i),isNeededRendering:i.isNeedRenderTemplates,showSettingsPopup:i.showSettingsPopup.bind(i,mn),showCreatingTemplatePopup:i.showSettingsPopup.bind(i,_n)}));Je.render(s,t)}return i}(t,e.querySelector("._message_templates_container"),e=>Object(zn.setHTML)(D,e),t=>toggleClass(e,"im-chat-input--textarea_show-templates",t)):null,K=Object(p.createModule)({handlers:(a,i)=>{a(k,"click",()=>{Bi(e),Promise.resolve().then(()=>Di(t,e)).then(e=>{if(e||Object(s.isAnyMessageBeingEdited)(t))A([]);else{var a=oi(t);ti(a)&&function(e){var t=document.querySelector("._im_chat_audio_input_parent ._im_replied_content"),a=e.getFwdRaw();if(a){var n=a.object;t&&(t.innerHTML=bi(n))}else t.innerHTML=""}(a),Qn(k,{fasthide:!0}),N.start(),setTimeout(()=>removeClass(k,"im-send-btn_saudio"),300)}})}),a(k,"mouseover",L),a(D,"focus",()=>{t.get().longpoll.push([h.transitionEvent("message")]),cur.focused=t.get().peer}),a(D,"blur",()=>{var e=0===t.get().peer?"search":"default";t.get().longpoll.push([h.transitionEvent(e)]),cur.focused=!1}),a(G,"click",()=>u().toggleKeyboard(void 0)),a(G,"mouseover",()=>{Object(l.showTooltip)(G,{text(){var e=Object(s.getCurrentKeyboard)(t);return!e||e.hide?Object(o.getLang)("mail_show_keyboard"):Object(o.getLang)("mail_hide_keyboard")},black:!0,shift:[4,5]})}),a(geByClass1("MassMentionWarning__close"),"click",()=>{!function(e,t){Bi(t),e.set(e=>(Object(s.getCurrentTab)(e).dontReopenWarningForCurrentMassMention=!0,Promise.resolve(e)))}(t,e),pi(D)}),i(e.parentNode,"click","_im_peer_mute_unmute",F),i(e.parentNode,"click","_im_peer_return_to_chat",H),i(e.parentNode,"click","_im_remove_replied",x),i(e.parentNode,"click","_mr_button_accept",B),i(e.parentNode,"click","_mr_button_reject",R),i(e,"click","_im_fwd_close",x),i(e,"click","_im_will_fwd",T),i(e,"keydown","_im_text",e=>function(e,t,a,i){if(38===i.which&&a().isEmpty(e)&&!t().getEditingMessage()&&!Emoji.shown&&!Object(An.hasAccessibilityMode)()&&!Object(n.isAnythingLoading)(e.get())){var r=Object(Vn.findLastMessageToEdit)(e,Object(s.getCurrentTab)(e));r&&t().startEditing(Object(s.getMessage)(e,e.get().peer,r))}}(t,c,u,e)),i(bodyNode,"click","_im_submit_btn",U)}}),V=g(t,M,D,e,A,c,f,m,K,N,G,q,W,v,y,C);return V.initKeyboard(),V}function Hi(e,t,a,n,i,s){return{focus(e){uiSearch.focus(t),function(e,t,a,n){cancelStackPush("im_hist_search",Ki.bind(null,e,t,a,n))}(e,t,a,n)},changePeer(e,a){uiSearch.getFieldEl(t).value=a.get().tabs[e].searchText||""},search(){s({})},unmount(){Object(p.destroyModule)(i),cancelStackFilter("im_hist_search"),n.then(e=>e.destroy())}}}function Ui(e,t,a,i){e.set(n.setCurrentSearchDate.bind(null,e.get().peer,`${i.d}.${i.m}.${i.y}`)).then(qi.bind(null,e,t,a))}function Gi(e,t){e.then(e=>{triggerEvent(geByClass1("datepicker_control",t),"mousedown",!1,!0)})}function qi(e,t,a){var i=e.get().peer;uiSearch.showProgress(a),Object(n.searchMessagesInplace)(i,e.get()).then(n=>{uiSearch.hideProgress(a),t().insertSearch(n,e)}).catch(()=>{uiSearch.focus(a),uiSearch.hideProgress(a)})}function Wi(e,t,a,i,s,r){if("keyup"!==r.type||13==r.which){var o=clean(uiSearch.getFieldEl(t).value);e.set(n.setCurrentSearch.bind(null,o,e.get().peer)).then(s.bind(null,e,i,t))}}function Ki(e,t,a,i){cancelStackFilter("im_hist_search"),i.then(e=>{e.hide()}),e.set(n.cancelSearch.bind(null,e.get().peer)).then(()=>{uiSearch.getFieldEl(t).value="",a().cancelSearch(e)})}function Vi(e,t,a,i){a.then(e=>{e.hide()}),e.set(n.clearDate.bind(null,e.get().peer)).then(qi.bind(null,e,t,i))}function Yi(e,t,a){var n=geByClass1("_im_search_date_input",e),i=geByClass1("_im_search_history_input",e),s=function(e,t,a,n){var i='<td class="cal_clear" colspan="7"><button type="button" class="im_cal_clear_lnk _im_clear_date">'+getLang("wall_clear_date_filter")+"</button></td>";return new Promise(e=>{stManager.add(["ui_controls.js",window.jsc("web/datepicker.js"),"datepicker.css"],(function(){var t=new Datepicker(a,{width:140,resfmt:"plain",addRows:'<tr id="im_day_clear">'+i+"</tr>",addRowsM:'<tr id="im_month_clear">'+i+"</tr>",onUpdate:n,pastActive:!0,noFuture:!0});e(t)}))})}(0,0,n,Ui.bind(null,t,a,i)),r=Gi.bind(null,s,e),o=Wi.bind(null,t,i,n,a,Object(Ln.debounce)(qi,300)),l=Ki.bind(null,t,i,a,s),c=Vi.bind(null,t,a,s,i),d=Object(p.createModule)({handlers:(t,a)=>{t(geByClass1("_im_search_date",e),"click",r),t(uiSearch.getFieldEl(i),"keyup",o),t(geByClass1("_im_start_inplace_search",e),"click",o),t(geByClass1("_im_cancel_inplace_search",e),"click",l),a(e,"click","_im_clear_date",c)}});return Hi(0,i,a,s,d,o)}function zi(e,t,a,n,s){var r=Object(i.getHistoryTopIndent)(e);Object(l.showTooltip)(t,{shift:[a,10],black:1,className:"_im_history_tooltip "+n,appendParentCls:"_im_mess_stack",toup:t.getBoundingClientRect().top>r+37,text:s})}function $i(e,t,a){var i=gpeByClass("_im_mess",a),o=intval(domData(i,"msgid")),l=e.get().peer,c=Object(s.getMessage)(e,l,o),d=!Object(r.isImportant)(c);return e.get().longpoll.push([{peerId:l,messageId:o,type:d?h.SET_FLAGS:h.RESET_FLAGS,flags:h.FLAG_IMPORTANT}]),e.set(n.favMessage.bind(null,[o],d,l)),Xi(e,-10,t,a,!0),!1}function Xi(e,t,a,n,i){var o=domData(gpeByClass("_im_mess",n),"msgid"),l=Object(s.getMessage)(e,e.get().peer,o),c=getLang("mail_im_unmark_important"),d=getLang("mail_im_toggle_important"),u=Object(r.isImportant)(l)?c:d,g=u.length>16;i&&window.tooltips&&tooltips.destroy(n),zi(e,n,g?84:34,g?"im-star-tt_long":"im-star-tt",l?u:"")}function Qi(e,t,a,s){var r=e.get().peer,o=+domData(domClosest("im-mess",s.target),"msgid");if(Object(i.canForwardMessages)(e,[o]))return Object(qe.statlogsForwardFromChannel)(),Object(n.processFwd)([o],r,e).then(t=>e.set(n.prepareForward.bind(null,t))).then(()=>{Nt(0,e)}),!1}function Ji(e,t,a){var i=e.get().peer,s=+domData(domClosest("im-mess",a.target),"msgid");return Object(n.processFwd)([s],i,e).then(t=>e.set(n.forwardMessages.bind(null,t,e.get().tfdraft,!0))).then(()=>t().respond(e,i)),!1}function Zi(e,t,a,n){zi(e,n,18,"im-reply-tt",getLang("mail_im_mark_forward"))}function es(e,t,a,n){zi(e,n,18,"im-reply-tt",getLang("mail_im_reply"))}function ts(e,t,a,n){var i=intval(domData(gpeByClass("_im_mess",n),"msgid")),r=Object(s.getMessage)(e,e.get().peer,i);return r&&t().startEditing(r),!1}function as(e,t,a){zi(e,a,18,"im-edit-tt",getLang("mail_im_edit"))}function ns(e,t,a){var n=Xi.bind(null,t,0),s=$i.bind(null,t),r=Zi.bind(null,t,0),o=Qi.bind(null,t,e.querySelector("_im_dialog_actions"),a),l=es.bind(null,t,0),c=Ji.bind(null,t,a),d=as.bind(null,t),u=ts.bind(null,t,a),g=Object(p.createModule)({handlers:(t,a)=>{a(e,"click","_im_mess_fav",s),a(e,"mouseover","_im_mess_fav",n),a(e,"click","_im_mess_forward",o),a(e,"mouseover","_im_mess_forward",r),a(e,"click","_im_mess_reply",c),a(e,"mouseover","_im_mess_reply",l),a(e,"click","_im_mess_edit",u),a(e,"mouseover","_im_mess_edit",d)}});return function(e,t){return{markImportant(t,a,n){Object(i.updateStar)(t,a,e)},unmount(){Object(p.destroyModule)(t)}}}(e,g)}function is(e,t,a,r,o){if(!Object(n.isSearchingInplace)(e.get().peer,e.get())&&!(hasClass(o,i.FAILED_CLASS)||hasClass(o,i.SENDING_CLASS)||hasClass(o,"_im_mess_srv")||Object(i.checkSelectClick)(r,o)||Object(s.isAnyMessageBeingEdited)(e)||"A"===r.target.tagName||domClosest("_im_replied_message",r.target)||r.target.classList.contains("_im_retry_media")||r.target.closest("."+i.MESSAGE_KEYBOARD_BUTTON_CLASS))){var l,c,d=intval(domData(o,"msgid")),u=e.get().peer;if(!Object(i.isAlreadyDeleted)(e,u,d))l=r.shiftKey?Object(s.getMessageRangeFromSelection)(e,u,d):[d],e.set(n.addSelection.bind(null,l)).then(()=>{var n=Object(s.getSelectedMessages)(e),i=!1;l.forEach(e=>{var t=geByClass1("_im_mess_"+e,a);if(t){var s=inArray(e,n);i|=s,toggleClass(t,"im-mess_selected",s);var r=s?getLang("mail_deselect_message"):getLang("mail_select_message"),o=geByClass1("_im_mess_blind_label_select",t);attr(o,"aria-label",r)}}),i&&(window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()),t().changedMessageSelection(e)}).then(()=>{1!==e.get().selectedMessages.length||c?c&&c.hide():c=function(e){var t=e.get();if(t.pinnedMessagesPromo&&Object(i.isChatPeer)(t.peer)){var a=geByClass1("_mess-action-promo"),s=new ElementTooltip(a,{autoShow:!1,appendTo:a,content:getTemplate("im_pinned_messages_promo",{content:getLang("mail_pinned_messages_promo_tooltip")}),forceSide:"bottom",cls:"feature_intro_tt",width:260,onHide:function(){e.setState({pinnedMessagesPromo:!1}),Object(n.hidePromoTooltip)()}});return s.show(),s}}(e)})}}function ss(e,t,a){var n=is.bind(null,t,a,e),i=Object(p.createModule)({handlers:(t,a)=>{a(e,"click","_im_mess",n)}});return function(e,t){return{cleanSelection(t){t&&Array.isArray(t)&&t.length&&t.map(t=>geByClass1("_im_mess_"+t,e)).filter(e=>e).forEach(e=>removeClass(e,"im-mess_selected"))},unmount(){Object(p.destroyModule)(t)}}}(e,i)}function rs(e,t,a){var n=a.get(),i=n.observer,o=n.targets;o.length&&o.forEach(i.unobserve.bind(i));var l=function(e,t){var a=e.get().peer,n=Object(s.getTab)(e,a);return Object(s.isFullyLoadedTab)(e,a)?Object.keys(n.msgs).reduce((e,a)=>{var i=n.msgs[a],o=t||document;if(Object(r.isUnread)(n,Object(s.parserMessage)(i))){var l=o.querySelector("._im_mess_"+a);l&&e.push(l)}return e},[]):[]}(e,t);a.setState({targets:l}),l.length&&l.forEach(i.observe.bind(i))}var os=a("Syd7");var cs={onNewMessagesChunk:function(e){var t=geByClass("post");LongView.clearElemsCache&&LongView.clearElemsCache(),t.forEach(e=>LongView.register(e,"im"))},onHistoryScroll:function(e){LongView.onScroll(e,window.innerHeight)}};function ds(){return(ds=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function us(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return gs(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return gs(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function gs(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function ms(e,t,a,n){var i=e instanceof Array?e:geByClass("_im_bar_date",e),s=t.contHeight();cs.onNewMessagesChunk();var r=i.reduce((e,t)=>(e[domData(t,"date")]=[t.offsetTop+10,s,t],e),{}),o=!a&&n.barMap?n.barMap:{};return n.barMap=extend(o,r),n.barMapKeys=Object.keys(n.barMap).sort(),Promise.resolve(n)}function _s(e,t){return t.barMapKeys.forEach(a=>{t.barMap[a][0]-=e}),Promise.resolve(t)}function ps(e,t,a,n,s){var r=e.get().barMap[t],o=Object(i.isClassicInterface)(s)?68:20;return a-(r[0]+a-r[1])+n-o}function hs(e,t,a,n){return n.barTransition=n.barMap[t][2],a>0?(addClass(n.barMap[t][2],"im-page--date-bar-transition-inverse"),addClass(e,"im-page--date-bar-transition-inverse")):a<0&&(removeClass(n.barMap[t][2],"im-page--date-bar-transition-inverse"),removeClass(e,"im-page--date-bar-transition-inverse")),addClass(n.barMap[t][2],"im-page--date-bar-transition"),addClass(e,"im-page--date-bar-transition"),Promise.resolve(n)}function bs(e,t){return t.barTransition&&(removeClass(t.barTransition,"im-page--date-bar-transition"),t.barTransition=null),removeClass(e,"im-page--date-bar-transition"),Promise.resolve(t)}function vs(e,t,a,n,i){var s,r,o=e.get(),l=a-t;o.barMapKeys.forEach(t=>{var o=ps(e,t,a,n,i);if(o>=l){var c=s?ps(e,s,a,n,i):a;s=c>o?t:s}else if(o<l){var d=r?ps(e,r,a,n,i):0;r=o>d?t:r}});var c={};return[[r,"prev"],[s,"cur"]].forEach(t=>{var s=us(t,2),r=s[0],o=s[1];r&&(c[o+"Bar"]=function(e,t){var a=e.get().barMap[t][2];return{text:a.textContent,date:domData(a,"date")}}(e,r),c[o+"Left"]=ps(e,r,a,n,i)-l)}),c}function fs(e,t,a,s,r){var o=e.get(),l=Object(n.isEverythingLoaded)(o),c=t.get(),d=r.scrollTop(),u=c.lastTop?c.lastTop-d:0;c.lastTop=d;var g=Object(ze.isPinnedMessageVisibleInTab)(o,o.peer)?Object(i.getPinnedMessageHeight)(e):0,m=Object(n.isSearchingInplace)(o.peer,o)&&o.tabs[o.peer]&&o.tabs[o.peer].top_banner?50:0,_=(Object(i.isClassicInterface)(e)?68+g+m:0)-16,p=vs(t,d,r.contHeight(),_,e),h=p.prevBar,b=p.curBar,v=p.prevLeft,f="translateY(0px)",O=!1,y=!1,C=!1;b||l||(b=function(e){var t=geByClass1("_im_mess",e),a=domData(t,"ts");return t&&a?{text:getShortDate(intval(a),!1,!0,getLang("months_of","raw")),date:a}:null}(s)),b?O=b:y=!0,h&&b&&v>-32&&v<0&&(C=!0,y=!1,O=b,f=`translateY(${-32-v}px)`),O&&function(e,t){domData(e,"ts")!==t.date&&(e.innerHTML=t.text,domData(e,"ts",t.date),e.style.visibility="visible")}(a,O),C?t.set(hs.bind(null,a,h.date,u)):t.set(bs.bind(null,a)),f&&(a.style.transform=f),toggleClass(a,"im-page--top-date-bar_no-b",y)}function Os(e,t){var a=geByClass1("_im_top_date_bar",t),n={lastTop:!1,barMap:{},barMapKeys:[],isDisabled:!1},i=Object(C.default)(n),s=null,r=null,o=null,l=Object(Ln.debounce)(e=>{var a=i.get();Object.keys(a).length&&!a.isDisabled&&i.set(ms.bind(null,t,e,!1))},500);return{reset(n){i.get().isDisabled||i.set(ms.bind(null,t,n,!0)).then(fs(e,i,a,t,n))},disable(){i.setState(ds({},n,{isDisabled:!0}))},enable(){i.setState({isDisabled:!1})},heightIncreased(e,t){i.get().isDisabled||(l(t),i.set(_s.bind(null,e)))},parseMore(n,s){i.get().isDisabled||i.set(ms.bind(null,n,s,!1)).then(()=>{fs(e,i,a,t,s)})},toggle(e){i.get().isDisabled&&e||a.classList.toggle("im-page--top-date-bar--hidden",!e)},show(){i.get().isDisabled||(r=Date.now(),o||(addClass(t,"im-page--top-date-bar_visible"),o=setInterval((function(){Date.now()-r>2e3&&(removeClass(t,"im-page--top-date-bar_visible"),clearInterval(o),o=null)}),100)))},update(n){i.get().isDisabled||(s&&(clearTimeout(s),s=null),s=setTimeout((function(){fs(e,i,a,t,n)}),300),fs(e,i,a,t,n))},unmount(){s&&(clearTimeout(s),s=null),o&&(clearInterval(o),o=null),i.unmount()}}}var ys=a("bIHZ"),Cs=a("uytb"),js=a("S2bU"),Ss=a("t7n3"),Es=a("zxIV");function ws(){return(ws=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function Ts(e){return!e.children.length}function Is(e,t){var a=geByClass1("_im_dialog_actions",e);Object(Es.toggleClass)(a,"im-page--chat-header_top-banner",t)}function Ms(e,t){var a=geByClass1("_im_top_banner_hide",e);a&&window.tooltips&&tooltips.hide(a),Is(e,!1),t.innerHTML=""}function As(e,t,a){var n=t.participants,s=n.count>0?langNumeric(n.count,getLang("mail_im_n_chat_members","raw")):"";return Object(Ss.getTemplate)("sImCallBannerContent",{user_list:Object(i.renderCallUserList)(e,n.list),title:getLang("calls_group_call_banner_title"),desc:s,cls:a?"CallBanner--classic":""})}function Ls(e){var t=e.peerId;if(Object(i.isChatPeer)(e.peerId)&&!Object(s.isChatActive)(e))return!1;var a=e.callInProgress,n=cur.imDb.selectByKey("hiddenCallBanners");return n?!(!a||n[t]&&n[t]===a.join_link):!!a}function ks(e,t,a){var r=geByClass1("_im_top_banner",e),o=Object(p.createModule)({handlers:(o,c)=>{var d=geByClass1("_im_dialog_actions",e);c(e,"click","_im_top_banner_hide",()=>{var o=t.get().peer,l=Object(s.getTab)(t,o);Ls(l)?function(e){var t=e.peerId,a=e.callInProgress,n=cur.imDb.selectByKey("hiddenCallBanners")||{};cur.imDb.updateByKey("hiddenCallBanners",ws({},n,{[t]:a.join_link}))}(l):t.set(e=>Object(n.hideTopBannerAction)(o,e)),Ms(e,r);var c=!!Object(i.renderPinnedMessage)(t);Object(i.compensateHistoryHeightChange)(t,c,!0,a)}),c(e,"click","_im_top_banner_button",s=>{var o=function(e,t,a,s){var r=e.target,o=t.get().peer;if(r.classList.contains("_im_call_banner_join_btn")){var l=r.dataset.link;return Object(i.joinCallFromIm)(t,o,l,!1,i.CALL_ENTRY_POINT_JOIN_BANNER),!1}var c=r.dataset.payload;return c?(t.set(e=>Object(n.callbackTopBannerAction)(o,c,e)),Ms(a,s),!0):(r.classList.contains("_im_top_banner_button_gifts")&&(showBox("al_gifts.php",{act:"get_gift_box",mid:o,ref:"im_birthday_banner"},{stat:["gifts.css","wide_dd.js","wide_dd.css"],dark:1}),Object(q.statlogsValueEvent)("gifts_im_birthday_banner","click",o),e.originalEvent.preventDefault()),!1)}(s,t,e,r),l=!o,c=!!Object(i.renderPinnedMessage)(t)||!o;Object(i.compensateHistoryHeightChange)(t,c,l,a)}),c(d,"mouseover","_im_top_banner_hide",(e,t)=>{Object(l.showTooltip)(t,{text:getLang("mail_top_banner_hide"),black:1,shift:[8,4],appendEl:bodyNode})})}});return{renderPeer(t){var n=Object(s.getTab)(t,t.get().peer),o=n.top_banner,l=n.callInProgress,c=!Ts(r),d=Ls(n);!d&&!o||Object(s.isSearchShown)(t)?c&&Ms(e,r):(Is(e,!0),r.innerHTML=d?function(e,t){return Object(Ss.getTemplate)("im_top_banner",{text:As(e,t,Object(s.isClassicInterface)(e)),icon:"",buttons:[Object(Ss.getTemplate)("sImCallBannerButton",{call_link:t.join_link}),Object(Ss.getTemplate)("im_top_banner_hide_btn",{})].join(""),classes:"im-top-banner_call"})}(t,l):function(e){var t=e.icon?Object(Ss.getTemplate)("im_top_banner_icon",{icon:e.icon}):"",a=e.text;"employees_banner"===e.name&&(a=Object(js.replaceHyperLinks)(a,e=>Object(js.linksReplacer)(!1,e)),a=Object(js.replaceMentions)(a));var n=(e.buttons||[]).map(e=>{var t="";switch(e.layout){case"tertiary":t="im-top-banner--button-tertiary";break;case"secondary":t="secondary";break;default:t="blue_button"}switch(e.type){case"link":return Object(Ss.getTemplate)("im_top_banner_button_link",{link:e.link,text:e.text,css_class:t});case"gifts_link":return t+=" _im_top_banner_button_gifts",Object(Ss.getTemplate)("im_top_banner_button_link",{link:e.link,text:e.text,css_class:t});default:return Object(Ss.getTemplate)("im_top_banner_button",{callback_data:e.callback_data,text:e.text,css_class:t})}});return n=n.concat([Object(Ss.getTemplate)("im_top_banner_hide_btn",{})]),Object(Ss.getTemplate)("im_top_banner",{text:a,icon:t,buttons:n.join("")})}(o),o&&"birthday"===o.name&&Object(q.statlogsValueEvent)("gifts_im_birthday_banner","view",t.get().peer));var u=!Ts(r);Object(i.compensateHistoryHeightChange)(t,u,c,a)},unmount(){Object(p.destroyModule)(o)}}}var Ps=a("cGUQ");function Ns(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Ds(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Ds(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ds(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var xs="im-audio-message_recorded",Bs=!1,Rs={};function Fs(e){return e.get().isMassMentionsMessageAllowed}function Hs(e){var t=Object(s.getTab)(e,e.get().peer);return!!Object(s.getPinnedMessage)(e)||!(!t||!t.top_banner)}function Us(e,t){var a=Object(_.unpackStore)(e),n=Object(s.getTab)(a,t);return Object(i.isChatPeer)(t)&&Object(ze.isPinnedMessageVisibleInTab)(a,t)||!!n.top_banner&&!Object(s.isSearchShown)(t,a)}function Gs(e){return Object(i.getPinnedMessageHeight)(e)}function qs(e,t,a){var n=a||window.clientHeight();return Math.min(n-15,Math.max(0,e,742+t.offsetTop))}function Ws(e,t){var a=intval(domData(t.target,"msgid")),n=gpeByClass("_im_mess_"+a,t.target),i=geByClass1("_im_log_body",n),s=geByClass1("_im_mess_susp_cont",n);i.innerHTML=s.innerHTML}function Ks(e,t){return geByClass1("_im_mess_"+t,e)}function Vs(e,t,a){var n,s,r,o,l,c,d,u,g,m=geByClass1(e,t);o={onStartDrag:(e,t)=>{addClass(bodyNode,"cursor_ns_resize"),n=t,s=t},onDrop:()=>{removeClass(bodyNode,"cursor_ns_resize")},onDrag:(e,r)=>{var o=qs(s-n+r,t);Object(i.setClassicChatHeight)(o),a().fixHeight()}},d=function(e){l=void 0!==e.clientX?e.clientX:e.touches[0].clientX,c=void 0!==e.clientY?e.clientY:e.touches[0].clientY,o.onDrag&&o.onDrag.call(r,l,c)},u=function e(t){o.onDrop&&o.onDrop.call(r,l,c),removeEvent(document,"mouseup touchend mouseleave",e),removeEvent(document,"mousemove touchmove",d)},g=function(e){(1===e.which||e.touches&&e.touches[0])&&(addEvent(document,"mouseup touchend mouseleave",u),addEvent(document,"mousemove touchmove",d),l=void 0!==e.clientX?e.clientX:e.touches[0].clientX,c=void 0!==e.clientY?e.clientY:e.touches[0].clientY,o.onStartDrag&&o.onStartDrag.call(r,l,c),o.onDrag&&o.onDrag.call(r,l,c),cancelEvent(e))},(r=m).beginDragHandler=g,addEvent(r,"mousedown touchstart",g)}function Ys(e,t){var a;a=geByClass1(e,t),removeEvent(a,"mousedown touchstart",a.beginDragHandler)}function zs(e){e().hideError()}function $s(e,t,a,i,s){if(checkEvent(i))return!0;var r=Object(Ps.fromQueryString)(s.getAttribute("href")),o=intval(r.msgid);o&&e.set(n.changePeer.bind(null,e.get().peer,o,!1)).then(()=>lr(a,t,o,e)),cancelEvent(i)}function Xs(e,t,a){var i=Object(s.getTab)(t,a),r=Object(n.strHistory)(i.history);toggleClass(e,"im-page--history_empty-hist",!r)}function Qs(e,t,a,n){if(hasClass(a.target,"_im_mess_marker")){var s=a.target,r=Object(_.toArray)(geByClass(i.FAILED_CLASS,t));window.tooltips&&r.map(e=>geByClass1("_im_mess_marker",e)).filter(e=>e!==s).forEach(e=>tooltips.hide(e,{fasthide:!0}));var o=domData(n,"msgid");Object(l.showTooltip)(s,{content:getTemplate("im_failed_menu",{count:r.length,modifiers:Object(Ye.classNames)("im-settings_failed",{"im-settings_no_delete":o>0,"im-settings_single":1===r.length}),id:o}),className:"im-page--failed-tt",appendParentCls:"_chat_body_wrap",dir:"down",noZIndex:!0,shift:[12,8],hasover:!0,force:!0})}}function Js(e){return geByClass1("_im_peer_history",e)}function Zs(e,t){var a=t.contHeight(),n=e.scrollTop+(a-e.contHeight);t.scrollTop(n)}function er(e,t,a,r,o,l,c,d,u){var g=!(arguments.length>9&&void 0!==arguments[9])||arguments[9],m=arguments.length>10&&void 0!==arguments[10]&&arguments[10],_=(t.get().tabs||{})[a];o().hideError(),l.renderPeer(t),d.renderPeer(t),u.render(t);var p=Object(s.isCasperChat)(t,a);if(toggleClass(e,"im-page--history_casper",p),!t.get().tabHistoryNotChanged){l.reRenderTitle(t),Xs(e,t,a);var h=Object(n.strHistory)(_.history);if(h){var b=geByClass1("_im_peer_history",e);val(b,h)}else o().showEmptyScreen();getAudioPlayer().isPlaying()&&getAudioPlayer().updateCurrentPlaying(),Sr(t,r,e)}if(Object(n.isSearchingInplace)(a,t.get())?o().showSearch(t):o().cancelSearch(t,!1),c.changePeer(a,t),t.get().msgid)lr(r,e,t.get().msgid,t);else if(_.scrollBottom&&g){Zs(_,r);var v=Object(i.isMessagesVisible)(t,e,r),f=Ns(v,1),O=f[0];_.skipped||setTimeout(()=>{_.unread&&!O&&(ur(t,e,!0),gr(t,e,!0)),nr(t,r,e),ir(t,r,e)},100)}else or(r,e,o,t,m)||r.scrollBottom(-30);window.LazyLoad&&window.LazyLoad.scan(!!r.scroll&&r.scroll.scroller)}function tr(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=a||t.scrollTop(),s=t.scrollBottom(),r=t.contHeight(),o=e.get().peer;e.set(n.saveHistoryScroll.bind(null,o,i,s,r))}function ar(){return Ke.screenfull.isFullscreen}function nr(e,t,a){var n=Object(s.isGoToMentionVisible)(e),i=Object(s.isGoToEndVisible)(e),r=t.getScrollHeight()/4,o=t.scrollTop()>0;t.scrollBottom()>r&&(!i||n)&&o&&ur(e,a,!0,40)}function ir(e,t,a){if(Fs(e)){var n=t.getScrollHeight()/4,i=t.scrollTop()>0,r=Object(s.isGoToMentionVisible)(e);t.scrollBottom()>n&&!r&&i&&gr(e,a,!0,40)}}function sr(e,t,a,r,o,l,c,d){var u=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];if((e.get().history_init||(e.get().history_init=!0,!(d.scrollTop()>0)))&&!ar()){o.update(d),o.show();var g=e.get().peer;if(0!==g&&Object(i.isFullyLoadedTab)(e.get(),g)&&(cs.onHistoryScroll(d.scrollTop()),!layers.visible)){var m=Object(s.getTab)(e,g);m&&!m.skipped&&d.scrollBottom()>40?(nr(e,d,l),ir(e,d,l)):m.skipped||m.unread||(Ir(e,l),Mr(e,l));var _=Object(i.wrapLoading)(a);if(!Object(n.isSearchingInplace)(g,e.get())&&u&&r(d),!Bs&&(c<0||0===d.scrollBottom())&&d.scrollBottom()<1e3){if(Object(n.isSearchingInplace)(g,e.get()))return;if(m.skipped>0&&!e.get().no_moving_down){var p=gpeByClass("_im_page_history",l),h=e.get();Bs=!0;var b=e.set(n.loadLessHistory).then(t().loadHistory.bind(null,h.peer,{reversed:!0})).then(()=>{t().updateObserver(),Bs=!1,ur(e,p),gr(e,p),m.skipped||e.set(n.changePeer.bind(null,e.get().peer,!1,!1))});return yr(p,!0),void b.then(yr.bind(null,p,!1))}}if(!Bs&&d.scrollTop()<1e3){if(Object(n.isSearchingInplace)(g,e.get())){Bs=!0;var v=t().getSearchResulstModule();return v.isAll(e)?void(Bs=!1):void _(v.loadMore(e).then(a=>{Bs=!1,a&&(t().loadHistory(e.get().peer,{},e,a),r(d))}),"up")}var f=e.get();m.allShown||(Bs=!0,_(e.set(n.loadMoreHistory.bind(null,0,0)).then(t().loadHistory.bind(null,f.peer,{})).then(()=>{Bs=!1,r(d)}),"up"))}c<0&&xr(e,g,d.scrollBottom(),l,t),Object(n.videoAutoPlayHandler)()}}}function rr(e,t){if(!(window.curNotifier&&curNotifier.idle_manager&&curNotifier.idle_manager.is_idle))return e.set(n.readTillSpecificMessage.bind(null,t,e.get().peer))}function or(e,t,a,s,r){var o=geByClass1("_im_unread_bar_row",t);if(o){var l=s.get(),c=l.peer,d=o.getBoundingClientRect(),u=geByClass1("_im_chat_body_abs",t).getBoundingClientRect().top+20;Object(i.isClassicInterface)(s)&&(u+=47+(Us(l,c)?Gs(s):0));var g=e.scrollTop()-u+d.top;return e.scrollTop(g),tr(s,e,g),setTimeout(()=>{c===s.get().peer&&sr(s,a,Js(t),(function(){}),r,t,0,e)},80),function(e){var t=e.get().peer;if(!(window.curNotifier&&curNotifier.idle_manager&&curNotifier.idle_manager.is_idle)&&t)e.set(n.readLastMessages.bind(null,t))}(s),!0}return!1}function lr(e,t,a,n){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"top",r=Ks(t,a);if(r){var o=Object(i.isClassicInterface)(n),l=n.get().peer,c=o?window.clientHeight():geByClass1("_im_chat_body_abs",t).offsetHeight,d=r.offsetTop+domPN(r).offsetTop+domPN(domPN(r)).offsetTop+domPN(domPN(domPN(r))).offsetTop;o&&Us(n,l)&&(d-=Gs(n)),"top"===s?e.scrollTop(d-e.getScrollHeight()/2+c/2):e.scrollTop(d-e.getScrollHeight()+c/4),addClass(r,"im-mess_light"),setTimeout(()=>{removeClass(r,"im-mess_light")},2e3)}}function cr(e,t,a){a.updateLastSeen(e)}function dr(e,t,a,i,s,r){var o=domData(r,"action"),l=domData(r,"msgid"),c=geByClass1("_im_mess_marker",Ks(a,l)),d=Number(l)>0?"edit":"send",u=e.get().peer,g=Js(a);switch(o){case"resend":Object(qe.statlogsSendingRetry)("retry",d),t(s,r);break;case"resend_all":Object(qe.statlogsSendingRetry)("retry",d),i().resendPeer();break;case"delete":Object(qe.statlogsSendingRetry)("delete",d),e.set(n.removeFailed.bind(null,g,u,l));break;case"delete_all":Object(qe.statlogsSendingRetry)("delete",d),e.set(n.removeFailed.bind(null,g,u,void 0))}tooltips.hide(c,{fasthide:!0})}function ur(e,t,a){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=e.get(),o=r.peer;if(!Object(i.isReservedPeer)(o)){var l=e.get().tabs[o],c=(t||document).querySelector("._im_to_end"),d=!1;(a||l.skipped>0||l.unread>0)&&!Object(n.isSearchingInplace)(o,e.get())?(d=!0,mr(t,e),addClass(c,"im-navigation_shown")):Tr(c,!0),e.set(n.updateGoToEndVisibility.bind(null,[d,+s]))}}function gr(e,t,a){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(!Fs(e))return!1;var r=e.get(),o=r.peer;if(!Object(i.isReservedPeer)(o)){var l=e.get().tabs[o],c=(t||document).querySelector("._im_to_mention"),d=pr(e).length,u=!1;l.unread>0&&d>0&&!Object(n.isSearchingInplace)(o,e.get())?(u=!0,_r(t,e,d),addClass(c,"im-navigation_shown")):Tr(c,!0),e.set(n.updateGoToMentionVisibility.bind(null,[u,+s]))}}function mr(e,t){var a=t.get().peer,n=Object(s.getTab)(t,a);(e||document).querySelector("._im_to_end").querySelector("._im_to_end_label").innerHTML=Number(n.unread)>0?Object(Ss.formatCount)(n.unread):""}function _r(e,t,a){(e||document).querySelector("._im_to_mention").querySelector("._im_to_mention_label").innerHTML=a>0?Object(Ss.formatCount)(a):""}function pr(e){var t=e.get(),a=t.id,n=t.peer,i=Object(s.getTab)(e,n);if(!n||!i)return[];var o=i.msgs||{};return Object.values(o).filter(e=>!(!e||Array.isArray(e)||Object(r.isOut)(e)||!Object(r.isUnread)(i,e))&&Object(r.hasUserMentions)(e,a))}function hr(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(0===e.scrollTop()&&0===e.scrollBottom())return!1;var a=e.scrollBottom();return a<(t?30+t:30)}function br(e,t,a,n,i){var r=domData(i,"msgid"),o=e.get().peer,l=Object(s.getMessage)(e,o,r);l.type===h.EDIT_MESSAGE?(a().sendEditMessage(e,l),a().resendMessage(o,r)):e.get().imQueueResend(o,r).then(t=>{e.get().longpoll.push([Object(h.resendEvent)(o,t.mess)])})}function vr(e,t,a,s,r){var o=intval(domData(r,"peer")),l=intval(domData(gpeByClass("_im_mess",r),"msgid")),c=e.get().tabs[o].hash;return Object(n.restoreMessageSend)(l,o,c,e.get().gid),e.set(n.restoreMessage.bind(null,l,o)).then(i.restoreMessage.bind(null,l,o,Js(t))).then(()=>Sr(e,a,t)),!1}function fr(e,t){e().showCreation(t)}function Or(e,t){if(e){var a=e.querySelector("._im_to_end");toggleClass(a,"im-navigation_loading",t)}}function yr(e,t){if(e){var a=e.querySelector("._im_to_end");toggleClass(a,"im-navigation_loading",t)}}function Cr(e,t,a,o){var l=t.get().peer,c=Object(s.getTab)(t,l);if(Object(i.isFullyLoadedTab)(t,l)){var d=Object.keys(c.msgs).find(e=>{var t=c.msgs[e];return!Array.isArray(t)&&Object(r.isUnread)(c,t)});if(!c.skipped)return d?lr(o,a,d,t):o.scrollBottom(-30),ur(t,a),gr(t,a),xr(t,l,0,a,e),void Object(n.readTillSpecificMessage)(c.lastmsg,l,t.get());Or(a,!0),t.set(n.changePeer.bind(null,l,!1,!1)).then(()=>t.set(n.loadPeer.bind(null,l,!0,-1,!1))).then(()=>{Or(a,!1),e().changePeer(t,!1,!1)})}}function jr(e,t,a,i){var r=Object(s.getTab)(t,t.get().peer),o=pr(t),l=!!o.length&&o[0].messageId;if(!r.skipped)return l&&lr(i,a,l,t,"center"),ur(t,a,!0),gr(t,a),rr(t,l),void xr(t,t.get().peer,0,a,e);Or(a,!0),t.set(n.changePeer.bind(null,t.get().peer,!1,!1)).then(()=>t.set(n.loadPeer.bind(null,t.get().peer,!0,-1,!1))).then(()=>{Or(a,!1),e().changePeer(t,!1,!1),rr(t,l)})}function Sr(e,t,a){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(Object(i.isClassicInterface)(e)){var s=t.contHeight(),r=geByClass1("_im_chat_input_w",a),o=geByClass1("_im_chat_resize",a);if(!1!==(n=!1!==n?n:Object(i.getClassicChatHeight)())&&n>0){var l=window.clientHeight(),c=geByClass1("_im_chat_audio_input_parent",a),d=qs(n,a,l),u=hasClass(c,"im-audio-message_recording")||hasClass(c,xs),g=u?c:geByClass1("_im_chat_input_parent",a),m=d-g.offsetHeight;o.style.height=l-d-15+"px",setStyle(r,{top:m+"px",bottom:"auto"})}else o.style.height="0px",setStyle(r,{top:"auto",bottom:"0px"});var _=geByClass1("_im_peer_history_w",a);return setStyle(_,{borderBottomWidth:r.offsetHeight-15-1}),t.contHeight()-s}var p=t.getScrollHeight();t.update(!1,!0);var h=t.getScrollHeight();return p-h}function Er(e,t,a,n){var i=t.offsetHeight;n(),e.heightIncreased(t.offsetHeight-i,a)}function wr(e,t){var a=t.getBoundingClientRect().top;Object(l.showTooltip)(t,{className:"im-page--admin-tt",text:getLang("mail_only_admin_see"),appendParentCls:"_chat_body_wrap",shift:[20,5],dir:"auto",showdt:400,noZIndex:!0,toup:a>200})}function Tr(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];hasClass(e,"im-navigation_shown")&&(t&&addClass(e,"im-navigation_fast"),removeClass(e,"im-navigation_shown"),t&&(e.offsetHeight,removeClass(e,"im-navigation_fast")))}function Ir(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=t.querySelector("._im_to_end");e.set(n.updateGoToEndVisibility.bind(null,[!1,0])),Tr(i,a)}function Mr(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=t.querySelector("._im_to_mention");e.set(n.updateGoToMentionVisibility.bind(null,[!1,0])),Tr(i,a)}function Ar(e,t,a){Ke.screenfull.isFullscreen||0===t.get().peer||Object(i.isClassicInterface)(t)||e().restoreScroll(t,t.get().peer)}function Lr(e,t){var a=e.get(),o=a.peer,l=domClosest("_im_mess_srv",t.target),c=intval(domData(l,"msgid")),d=Object(s.getMessage)(e,o,c),u=d&&Object(r.isServiceMsg)(d)&&d.kludges.source_act;if(u===i.CHAT_PIN_MESSAGE||u===i.CHAT_UNPIN_MESSAGE){var g=l.querySelector(".im_srv_mess_link");if(g&&"A"!==g.tagName){var m=d.kludges.source_chat_local_id;if(!m||Rs[m])return;Rs[m]=Object(n.getMessageLocalId)(o,m,a).then(e=>{var t=Ns(e,1)[0];if(t){var a=`/im?sel=${Object(i.convertPeerToUrl)(o)}&msgid=${t}`,n=g.innerHTML;domReplaceEl(g,Object(i.serviceLink)(a,n,!0,"im_srv_mess_link")),delete Rs[m]}})}}}function kr(e,t,a){var n=e.get(),r=n.peer,o=a.target.href&&a.target.href.match(/msgid=([\d]+)/),l=o&&o[1];"A"!==a.target.tagName||!l||Object(i.isAlreadyDeleted)(e,r,l)||checkEvent(a)||(Object(s.getMessage)(e,r,l)?(e.setState({msgid:l}),Object(ys.updateLocation)({msgid:l}),t().focusOnMessage()):n.longpoll.push([Object(h.changePeer)(r,l)]));cancelEvent(a)}function Pr(e){var t=Object(s.getCurrentTab)(e);Object(i.isChatPeer)(t.peerId)&&(t.pinHideId=cur.imDb.select(Cs.PIN_HIDDEN_ID_OP,t.peerId))}function Nr(e,t,a,n,i){e.setState({isEditing:!1}),removeClass(n,"im-mess_is_editing"),removeClass(geByClass1("_im_page_history"),"is_msg_editing"),cancelStackFilter("cancel_edit"),a.setDraft(e,Object(s.getPeer)(e)?Object(s.getTabDraft)(Object(s.getCurrentTab)(e)):null),a.toggleStickers(e,!0),a.restoreKeyboard(),Dr(t)}function Dr(e){Object(_.toArray)(geByClass("_im_history_tooltip",e)).forEach(hide)}function xr(e,t,a,i,r){var o=Object(s.getTab)(e,t);if(!(Date.now()-(o.lastReset||0)<1e3)&&(o&&o.msgs&&o.history&&!Bs&&o.offset>300&&0==o.skipped&&a<50&&a>=0&&0===(e.get().selectedMessages||[]).length)){var l=Object.keys(o.msgs).filter(e=>e>0).sort((e,t)=>e-t).slice(0,-50),c=l.slice(-1)[0];e.mutate(n.resetTabAll.bind(null,t)),e.set(n.removeMessages.bind(null,l,t)).then(()=>r().removeStartingFromMessage(c,t,e))}}function Br(e,t,a,n){var s=n.target,r=domClosest("_im_replied_message",s),o=Number(r.getAttribute("data-msgid")),l=domClosest("im-mess",s),c=Number(l.getAttribute("data-msgid")),d=e.get().peer;o&&!Object(i.isAlreadyDeleted)(e,d,o)?(e.setState({msgid:o}),Object(ys.updateLocation)({msgid:o}),Object(i.focusOnMessage)(e,t().focusOnMessage,d,o)):c&&Object(i.showRepliedBox)(e,c,n)}function Rr(e){checkEvent(e)||cancelEvent(e)}function Fr(e,t){var a=domClosest("_im_mess",t);if(a){var i=Number(a.getAttribute("data-msgid")),o=e.get().peer,l=Object(s.getMessage)(e,o,i);i&&l&&!Object(r.isOut)(l)&&Object(n.markAudioMessageAsListened)(o,i,e.get())}}function Hr(e,t,a){var n=a.target.closest("."+i.MESSAGE_KEYBOARD_BUTTON_CLASS),s=a.target.closest("."+i.MESSAGE_STACK_CLASS);if(n){var r=t.get().keyboard_app_hash,o=e.sendMessageFromKeyboard.bind(null,()=>e),l=Object(We.getActionObjectFromElement)(n),c=s?s.dataset.peer:void 0;return Object(We.handleButtonClick)(l,o,r,c)}}function Ur(e,t){var a=e.get().peer,n=t.reduce((t,n)=>{if(n.isIntersecting){var i=+n.target.getAttribute("data-msgid"),o=Object(s.getMessage)(e,a,i);i&&o&&!Object(r.isOut)(o)&&t.push(i)}return t},[]);if(n.length){var i=Math.max(...n);rr(e,i)}}function Gr(e,t){var a=t.target.closest("._im-call-snippet"),n=a.closest("._im_mess_callsnippet"),s=a.dataset.type,r=a.dataset.participants,o=r&&r.split(",").reduce((t,a)=>(+a!==e.get().id&&Object(i.isUserPeer)(+a)&&t.push(+a),t),[]),l=+n.dataset.peer;Object(i.isCallToPeerAvailable)(e,l)&&Object(i.startCallFromIm)(e,l,"video"===s,o,i.CALL_ENTRY_POINT_SNIPPET)}function qr(e,t,a){Wr(e,t,a.target.closest("._im_mess_pinned"))}function Wr(e,t,a){var n=+a.dataset.msgid,r=Object(s.getMessage)(e,e.get().peer,n),o=Object(Vn.canMessageBeEdited)(e,r);o!==a.classList.contains("im-mess_editable")&&(a.classList.toggle("im-mess_editable",o),Object(i.updateMessageInCache)(e,t,a))}function Kr(e,t,a,o,l,c,d,u,g,m,b,v,f,y,C,j,S,E){var w,T=Object(_.throttle)((function(){a.smoothScroll(...arguments)}),300);return{fixKeyboard(){l.fixKeyboard()},removeUnpinnedMessageEditable(e,a){var n=t.querySelector("._im_mess_pinned:not(._im_mess_"+a);n&&(n.classList.remove("_im_mess_pinned"),Wr(e,t,n))},changePeer(e){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],d=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],g=e.get().peer;if(revertLastInlineVideo(t),0===g)return C.disable(),l.setDraft(e,null),function(e){addClass(e,"im-page--history_empty"),Js(e).innerHTML=""}(t);if(Object(i.isFullyLoadedTab)(e.get(),e.get().peer)){removeClass(t,"im-page--history_search"),e.set(n.dropSelection),o.changeActions(e),o.showActions(e);var m=e.get().prevPeer;removeClass(t,"im-page--history_loading"),toggleClass(t,"im-page--history_vkcomgroup",Object(i.isFvkcomgroup)(e,g)),r?l.setDraft(e,Object(s.getTabDraft)(Object(s.getCurrentTab)(e))):l.updateState(e),ur(e,t),gr(e,t),c().updateTyping(g,e),cr(e,0,o),Object(i.isReservedPeer)(m)&&!Object(i.isReservedPeer)(g)?function(e,t,a,n,i,s,r,o,l,c,d){removeClass(e,"im-page--history_empty"),er(e,t,a,n,i,s,r,o,l,c,d)}(t,e,g,a,c,o,u,j,E,d,C):Object(i.isReservedPeer)(m)||Object(i.isReservedPeer)(g)||er(t,e,g,a,c,o,u,j,E,d,C),Object(s.isCasperChat)(e,g)||(C.enable(),C.toggle(!0),C.reset(a)),Object(i.isReservedPeer)(g)||setTimeout(()=>{sr(e,c,Js(t),f,C,t,0,a)}),Object(i.ensureDomHasActions)(t)}},preparePeer(e){var a=Object(s.getPeer)(e);Pr(e),l.setDraft(e,Object(s.getTabDraft)(Object(s.getTab)(e,a)),!1),c().updateTyping(a,e),c().hideError(),o.renderPeer(e),j.renderPeer(e),o.hideActions(e),u.changePeer(a,e),cr(e,0,o),C.toggle(!1),Ir(e,t,!0),Mr(e,t,!0)},saveScroll:e=>tr(e,a),loadingPeer(e){Object(n.isAnythingLoading)(e.get())||(removeClass(t,"im-page--history_empty"),addClass(t,"im-page--history_loading"))},stopLoading(e){removeClass(t,"im-page--history_loading")},deselectDialog(e){d().removeSelection(e)},replaceMessageAttrs(e,a){Object(i.replaceMessageAttrs)(a.get(),Js(t),e)},cleanSelection(e){m.cleanSelection(e)},updateDialogFilters(e){d().updateDialogFilters(e)},getSearchResulstModule:()=>w,showSearchResults(e){e?(removeClass(t,"im-page--history_search-empty"),Js(t).innerHTML=e):(addClass(t,"im-page--history_search-empty"),Js(t).innerHTML=Object(i.renderEmptySearch)())},insertSearch(e,n){w||(o.deselectAll(n),w=O(t,n)),addClass(t,"im-page--history_search"),c().showSearchResults(e),Sr(n,a,t),a.scrollBottom(0),ur(n,t),gr(n,t),C.reset(a)},updateChatTopic(e,t){d().updateDialog(e,t),e===t.get().peer&&(o.renderPeer(t),o.renderActions(t),j.renderPeer(t))},updateActions(e){o.changeActions(e)},updateChatPhoto(e,n,s){if(Object(i.isPeerActive)(e.peerId,s.get())){o.renderPeer(s),j.renderPeer(s);var r=hr(a);Object(i.addChatPhotoToUpdate)(e,n,s.get(),Js(t)),r&&a.scrollBottom(-30)}},markImportant(e,a,n){Ks(t,e)&&(o.changedMessageSelection(n),g.markImportant(e,a,n))},isNewMessagesVisible:e=>function(e,t){return Object(s.getUnreadScrollBottom)(e)>=intval(t.scrollBottom())}(e,a),loadHistory(e,n,s){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=s.get();if(Object(i.isPeerActive)(e,o)){var l=r||o.tabs[e].historyToAppend;if(!l)return;var c=geByClass1("_im_peer_history",t),d=domFC(c),u=a.scrollBottom(),g=n.reversed?e=>c.appendChild(e):e=>c.insertBefore(e,d),m=0;n.reversed&&(m=c.offsetHeight);var _=sech(l),p=document.createDocumentFragment();_.forEach(e=>p.appendChild(e)),g(p),n.reversed&&C.heightIncreased(c.offsetHeight-m,a),n.reversed||a.scrollBottomFixSave(u),a.update(!1,!0);var h=_.filter(e=>hasClass(e,"_im_bar_date"));C.parseMore(h,a),Object(i.ensureDomHasActions)(t)}},sendMessage(e){0!==e.get().peer&&l.sendMessage()},editMessage(e,n){if(Object(i.isFullyLoadedTab)(e,n.peerId)&&Object(i.isPeerActive)(n.peerId,e.get())){if(!Ks(t,n.messageId))return;tr(e,a),Object(i.editAndReplaceMessage)(e.get(),n,t),Zs(Object(s.getTab)(e,n.peerId),a),o.reRenderPinned(e),C.reset(a)}},addMessage(e,o){if(!Object(n.isSearchingInplace)(o.peerId,e.get())&&Object(i.isFullyLoadedTab)(e,o.peerId)&&Object(i.isPeerActive)(o.peerId,e.get())){if(Ks(t,o.messageId))return;var l=Js(t);Er(C,l,a,()=>{var n=hr(a),d=geByClass1("_im_unread_bar_row",t),u=Ns(Object(i.isMessagesVisible)(e,t,a),2),g=u[0],m=u[1];Object(i.appendToHistory)(e.get(),o,l,!0,!0,!g&&!d),removeClass(t,"im-page--history_empty-hist");var _=Object(s.getTab)(e,e.get().peer),p=Object(r.isServiceMsg)(o)&&o.userId===vk.id,h=o.kludges&&o.kludges.source_act,b=p&&h!==i.CHAT_PIN_MESSAGE&&h!==i.CHAT_UNPIN_MESSAGE;_.skipped||g||!Object(r.isUnread)(_,o)||Object(r.isOut)(o)||(ur(e,t,!0,m),gr(e,t,!0,m)),(o.local||n||b)&&a.scrollBottom(0),c().updateTyping(o.peerId,e),mr(t,e),Dr(t)});var d=domPS(domLC(l));if(hasClass(d,"_im_bar_date")){var u=ce("div");u.innerHTML=d.outerHTML,C.parseMore(u,a)}c().hideError(),C.update(a),Object(n.updateMentions)(e.get()),xr(e,o.peerId,a.scrollBottom(),0,c),this.updateObserver()}},setMessageErrored(e,a,n,s){n&&"string"==typeof n&&c().showError(n),Object(i.setMessageError)(e,a,t)},markMessagesAsRead(e,a){e.get().peer===a.peerId&&Object(i.markMessagesAsRead)(e.get(),a.peerId,t)},compensateHistoryHeightChange(e){a.scrollTop(a.scrollTop()+e*Gs(v))},updateTyping(e,a){if(!Object(n.isSearchingInplace)(e,a.get())){var r=a.get();if(r.peer===e&&Object(i.isFullyLoadedTab)(r,e)){var o=Object(i.formatTyper)(Object(s.getTab)(a,e).activity,e,!1,r),l=geByClass1(i.TYPING_CLASS,t);if(l||o){if(!l){var d=geByClass1("_im_typer_c",t);val(d,getTemplate("im_typing",{cls:Object(i.isClassicInterface)(a)?"im-activity_classic":""})),l=geByClass1(i.TYPING_CLASS,t)}val(geByClass1("_im_typing_name",l),o);var u=Object(i.loadSummaryActivityType)(Object(s.getTab)(a,e).activity||{})===n.ACTIVITY_TYPE_RECORDING_AUDIO;l.setAttribute("data-activity-type",u?"recording":"typing"),o?(addClass(l,"im-page--typing_vis"),c().hideError()):removeClass(l,"im-page--typing_vis")}}}},scrollFix(e,t,n){C.heightIncreased(n,a),C.update(a),Object(i.isPeerActive)(t,e.get())&&hr(a,n)&&a.scrollBottom(-30)},goToEnd(){Cr(()=>this,v,t,a)},updateGoToEnd(e,n){var i=Object(s.getTab)(e,e.get().peer);i&&(i.skipped||i.unread)?ur(e,t):Ir(e,t,n),b(0,a,!1);var r=e.get().peer;setTimeout(()=>{e.get().peer===r&&tr(e,a)})},updateGoToMention(e,n){var i=Object(s.getTab)(e,e.get().peer),r=pr(e),o=r.length>0&&r[0].messageId;i&&o?gr(e,t):Mr(e,t,n),b(0,a,!1);var l=e.get().peer;setTimeout(()=>{e.get().peer===l&&tr(e,a)})},newMessage(e){d().newMessage(e),Ir(e,t,!0),Mr(e,t,!0)},scroll(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(0!==e.get().peer){var s=n?a.getScrollHeight():40;!0===i&&(s=a.contHeight()),s="up"===t?-s:s,n||i?T(s,()=>{b(s,a)}):(a.scrollTop(a.scrollTop()+s),b(s,a))}},showCreation(e,t){d().showCreation(e,t)},updateScroll:()=>Sr(v,a,t),toggleBarDate(e){C.toggle(e)},changedMessageSelection(e){o.changedMessageSelection(e)},updateOnline(e,t){Object(i.isTabLoaded)(t.get(),e)&&e===t.get().peer&&o.renderPeer(t)},isEmpty:e=>l.isEmpty(e),replaceAttachmentPlaceholders(e,n){if(Object(i.isPeerActive)(n.peerId,e.get()))Er(C,Js(t),a,()=>{var r=hr(a);Object(i.replaceAttaches)(t,n,e.get());var l=Object(s.getTab)(e,n.peerId);if(l.mediacontent[n.messageId].length>=3&&l.mediacontent[n.messageId][2].pinned){var c=Object(s.parserMessage)(l.pinned);c&&c.messageId==n.messageId&&(l.pinned=l.mediacontent[n.messageId][2].pinned,o.reRenderPinned(e))}r&&a.scrollBottom(0)}),C.update(a);else if(Object(r.isMoneyRequest)(n)){var l=Object(s.getTab)(e,n.peerId);if(l.mediacontent[n.messageId].length>=3&&l.mediacontent[n.messageId][2].pinned){var c=Object(s.parserMessage)(l.pinned);c&&c.messageId==n.messageId&&(l.pinned=l.mediacontent[n.messageId][2].pinned)}}},removeMessages(e,n,s){s.get().peer===n&&(Object(i.removeMessages)(e,Js(t)),Object(i.removeExpiredMessagesStub)(e,Js(t)),Sr(s,a,t),o.changedMessageSelection(s),this.updateObserver())},removeStartingFromMessage(e,n,s){if(s.get().peer===n){var r=Js(t),l=geByClass1("_im_mess_"+e,r);Object(i.removeStartingFromMessage)(l,r),Sr(s,a,t),o.changedMessageSelection(s)}},hideGoToEnd(e){Ir(v,t,e)},hideGoToMention(e){Mr(v,t,e)},removeMessagesRestore(e,a,n,s){s.get().peer===a&&Object(i.removeMessagesWithRestore)(e,a,n,Js(t))},removeExpiredFailedMessages(e){v.get().peer===e&&v.set(n.removeExpiredFailed.bind(null,Js(t),e))},handleMessageExpiration(e){Object(i.isFullyLoadedTab)(v.get(),e.peerId)&&(Object(i.replaceExpiredMessageWithPlaceholder)(v,t,e),Object(i.replaceExpiredRepliedMessageWithPlaceholder)(t,e),l.detachMessages(e))},updateState(e,t){d().updateState(e,t)},updateBanner(e){j.renderPeer(e)},updateHeader(e){o.renderPeer(e)},updateChat(e,t){e.get().peer===t&&(o.changeActions(e),o.renderPeer(e),o.renderActions(e),j.renderPeer(e),l.updateState(e),Object(n.updateMentions)(e.get()))},focustTxt(e){l.focusOn(e)},startSearch(e){c().showSearch(e),u.changePeer(e.get().peer,e),u.search()},showSearch(e){addClass(t,"im-page--hisory_search-open"),e.setState({searchShown:!0}),Hs(e)&&this.updateChatTopic(e.get().peer,e),this.cancelEditing(),setTimeout(()=>u.focus(e),10)},cancelSearch(e){var s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(e.get().searchShown&&(removeClass(t,"im-page--hisory_search-open"),removeClass(t,"im-page--history_search"),removeClass(t,"im-page--history_search-empty"),e.setState({searchShown:!1}),Hs(e)&&this.updateChatTopic(e.get().peer,e),o.changedMessageSelection(e)),s&&!Object(i.isReservedPeer)(e.get().peer)&&w){var r=e.get().tabs[e.get().peer],l=Object(n.strHistory)(r.history);l?Js(t).innerHTML=l:c().showEmptyScreen(),Sr(e,a,t),a.scrollBottom(0),e.get().msgid&&(lr(a,t,e.get().msgid,e),ur(e,t),gr(e,t)),f(a),C.reset(a)}w&&(w.unmount(),w=!1,Object(i.ensureDomHasActions)(t))},showEmptyScreen(){var e=geByClass1("_im_peer_history",t);addClass(t,"im-page--history_empty-hist");var a=Object(s.isCasperChat)(v,v.get().peer)?getTemplate("sImEmptyCasper"):getLang("mail_im_here_history");val(e,a)},updateHistory(e){0!==v.get().peer&&e(t)},focusOnMessage(){lr(a,t,v.get().msgid,v)},sendEditMessage(e,t){e.set(n.deliverEditedMessage.bind(null,Object(s.getTab)(e,t.peerId),t)).catch(a=>e.get().longpoll.push([Object(h.failedMessage)(t.peerId,t,a)]))},unmount(){Object(p.destroyModule)(e),a.destroy(),clearInterval(y),l.unmount(),o.unmount(),g.unmount(),m.unmount(),u.unmount(),C.unmount(),cancelStackFilter("forward"),Ys("_im_chat_resize_track",t),E.destroy()},removePeer(e,t){d().removePeer(e,t)},restoreScroll(e,t){var n=e.get().tabs[t];n.scrollBottom?Zs(n,a):a.scrollBottom(-30)},resendMessage(e,a){e===v.get().peer&&Object(i.startResendMessage)(e,a,t)},resendPeer(){l.resendPeer()},resendAll(){l.resendAll()},respond(e,t){l.attachMessages(e,t),l.focusOn(e);var n=Object(s.getTab)(e,t);n&&!n.skipped&&(a.scrollBottom(-30),f(a))},cancelRecording(){l.cancelRecording()},hideError(){geByClass1("_im_error",t).classList.remove("im-page--error--visible")},showError(e){var n=geByClass1("_im_error",t);n.innerHTML=e,n.classList.add("im-page--error--visible"),a.scrollBottom(-30)},startEditing(e){if(Object(n.isAnythingLoading)(v.get()))Object(i.showWaitUntilUploadedBox)();else{e=Object(s.parserMessage)(e);var a=Object(i.getNowEditingMessage)(v);if(!(l.isBlocked()||a&&a.messageId==e.messageId)){a&&this.cancelEditing(),Dr(t),v.get().searchShown&&this.cancelSearch(v);var r=Ks(t,e.messageId);r&&(this.cancelRecording(),function(e,t,a,n,i){e.setState({isEditing:!0}),a.saveText(e),addClass(n,"im-mess_is_editing"),addClass(geByClass1("_im_page_history"),"is_msg_editing"),cancelStackPush("cancel_edit",()=>Nr(e,t,a,n,i));var s=new yt.ImDraft;s.dData.txt=Object(Vn.convertEmojiHtmlToRegularText)(i.text),s.dData.attaches=Object(Yn.convertKludgesToAttaches)(i.kludges,i.messageId),a.toggleStickers(e,!1),a.setDraft(e,s),setTimeout(()=>a.focusOn(e),0)}(v,t,l,r,e),l.hideKeyboard(),o.deselectAll(v))}}},cancelEditing(){var e=Object(i.getNowEditingMessage)(v);e&&Nr(v,t,l,Ks(t,e.messageId))},messageKeyboardButtonClick:e=>Hr(l,v,e),getEditingMessage:()=>Object(i.getNowEditingMessage)(v),focusEditingMessage(){var e=Object(i.getNowEditingMessage)(v);e&&lr(a,t,e.messageId,v),l.focusOn(v)},setNetworkWaitingStatus(e){o.setNetworkWaitingStatus(e)},setNetworkReconnectingStatus(){o.setNetworkReconnectingStatus()},clearNetworkStatus(){o.clearNetworkStatus()},updateCasperMessageStatus(e){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(i.isFullyLoadedTab)(v.get(),e.peerId)&&v.set(n.updateCasperMessageExpiringStatus.bind(null,e,a)).then(()=>{v.get().peer===e.peerId&&Object(i.setCasperMessageExpiringStatusDOM)(t,a,e.messageId)})},updateObserver(){S.update()},renderPeerProfile(e){E.render(e)},destroyPeerProfile(){E.destroy()}}}function Vr(e,t,a,r,o){var c=geByClass1("_im_peer_history_w",e);Object(An.hasAccessibilityMode)()&&addClass(c,"history_a11y");var d,u,g,m=Object(p.createMutations)(Kr),b=m.callMutations,v=m.bindMutations,f=(d=tr.bind(null,t),u=Object(Ln.debounce)(d,100),g=Object(_.throttle)(d,100),e=>{u(e),g(e)}),O=Os(t,e),S=sr.bind(null,t,b,c,f,O,e),E=Object(j.createScroll)(geByClass1("_im_chat_body_abs",e),{onScroll:S,nativeScroll:Object(i.isClassicInterface)(t),shadows:!1}),w=Object(i.isClassicInterface)(t)?void 0:E.scroll.container,T=function(e,t,a){var n=Object(C.default)({observer:new IntersectionObserver(a,{root:t}),targets:[]});rs(e,t,n);var i=Object(p.createModule)({handlers:(e,t)=>{}});return{update(){rs(e,t,n)},unmount(){var e=n.get(),t=e.observer;e.targets.forEach(t.unobserve.bind(t)),Object(p.destroyModule)(i)}}}(t,w,Ur.bind(null,t));setTimeout((function(){var a=t.get().peer;if(a){if(Pr(t),(Object(s.getCurrentTab)(t).pinned||Object(s.getCurrentTab)(t).top_banner)&&(b().updateChatTopic(a,t),t.set(n.setActions),I.changeActions(t)),Object(s.getCurrentTab)(t).callInProgress&&b().updateBanner(t),t.get().msgid)lr(E,e,t.get().msgid,t);else if(!or(E,e,b,t,O)){E.scrollBottom(-30);var r=Object(s.getCurrentTab)(t);Object(i.isTabMarkedUnread)(r)&&t.set(e=>Object(n.markDialogRead)(r.peerId,e))}t.get().history_init=!1,Object(s.isCasperChat)(t,a)?O.disable():O.reset(E),ur(t,e),gr(t,e),sr(t,b,c,f,O,e,0,E),Object(i.ensureDomHasActions)(e),nav.objLoc.st&&(t.mutate(n.setInplaceSearch.bind(null,nav.objLoc.st,a)),b().startSearch(t))}else O.disable()}),15);var I=ua(geByClass1("_im_dialog_actions",e),t,b),M=Fi(geByClass1("_im_text_input",e),t,Object(i.isClassicInterface)(t)?r.updateMenu:void 0,(e,t)=>{a.removeDialog(e,t),a.restoreDialogs(e,!0)},b),A=Yi(geByClass1("_im_dialog_actions",e),t,b),L=ns(e,t,b),k=ss(e,t,()=>({changedMessageSelection:I.changedMessageSelection})),P=Object(os.mount)(c);Object(ze.mount)(e,t,b);var N=ks(e,t,()=>({hidePinned(){Object(ze.pinnedMessageHide)(t,t.get().peer,b,!1)},compensateHistoryHeightChange(e){b().compensateHistoryHeightChange(e)},showPinned(){Object(ze.pinnedMessageUnHide)(t,t.get().peer,b,!1)}}));Object(i.isReservedPeer)(t.get().peer)||t.set(n.restoreHistoryQueue.bind(null,t.get().peer)).then(()=>{Object(i.restoreQueue)(t.get().peer,t.get(),Js(e)),Xs(e,t,t.get().peer)}),AudioMessagePlayer.events.on("listened",Fr.bind(null,t)),Vs("_im_chat_resize_track",e,o);var D=br.bind(null,t,e,b),x=vr.bind(null,t,e,E),B=fr.bind(null,o,t),R=Cr.bind(null,b,t,e,E),F=jr.bind(null,b,t,e,E),H=Qs.bind(null,t,e),U=i.showEditTimeTooltip.bind(null,t),G=i.showMessageInfoTooltip.bind(null,t),q=dr.bind(null,t,D,e,b),W=$s.bind(null,t,e,E),K=Ar.bind(null,b,t,E),V=Lr.bind(null,t),Y=kr.bind(null,t,b),z=Br.bind(null,t,b,e),$=Hr.bind(null,M,t),X=zs.bind(null,b),Q=i.showCasperExpiringTooltip.bind(null,t,e),J=()=>showWiki({w:"expired_messages"}),Z=Gr.bind(null,t),ee=e=>function(e,t){var a=t.target.closest("._im_call_snippet_join_btn"),n=a.closest("._im_mess_callsnippet"),s=a.dataset.link,r=+n.dataset.peer;Object(i.isCallToPeerAvailable)(e,r)&&Object(i.joinCallFromIm)(e,r,s,!1,i.CALL_ENTRY_POINT_JOIN_SNIPPET)}(t,e),te=qr.bind(null,t,e),ae=Object(p.createModule)({handlers:(a,r)=>{r(e,"click",i.RESTORE_CLASS,x),r(e,"mouseover click",i.FAILED_CLASS,H),r(e,"mouseover","_im_edit_time",U),r(e,"mouseover","_im_page_info",G),r(e,"click","_im_mess_susp",Ws.bind(null,e)),r(e,"click","_im_failed_action",q),r(e,"click","_im_mess_link",W),r(e,"mouseover","_im_admin_name",wr),r(e,"mouseover","_im_mess_srv",V),r(e,"mouseover","im-mess-stack--bomb",Q),r(e,"mouseover","mem_pseudolink",e=>function(e,t){var a=e.target.dataset.mention,n=null;switch(!0){case y.MASS_MENTION_ALIASES.all.includes(a):n=getLang("mail_im_mention_all");break;case y.MASS_MENTION_ALIASES.online.includes(a):n=getLang("mail_im_mention_online")}n&&(window.tooltips&&window.tooltips.destroy(e.target),Object(l.showTooltip)(e.target,{shift:[0,5],center:!0,black:1,className:"im-mass-mention-tt",reverseOffset:!0,toup:e.target.getBoundingClientRect().top>Object(i.getHistoryTopIndent)(t)+37,text:n,noZIndex:!0}))}(e,t)),r(e,"mouseover","_im_mess_pinned",te),r(e,"click","im_srv_mess_link",Y),r(e,"click","_im_error",X),r(e,"click","_im_replied_message",z),r(e,"click","_im_replied_author_link",Rr),r(e,"click","_chat_invitation",(e,a)=>{if(checkEvent(e))return!0;if(!gpeByClass("wall_postlink_preview_btn",e.target)&&!hasClass(e.target,"wall_postlink_preview_btn"))return!0;var s=geByClass1("flat_button",a),r={invite_chat_id:domData(s,"inv-id"),invite_hash:domData(s,"hash")};Object(i.showInvitationBox)(t,r,n.leaveInvitation),cancelEvent(e)}),r(e,"click","_im_join_call_by_link",i.handleCallLinkClick),r(e,"click","_im_join_cancel",()=>t.get().longpoll.push([Object(h.resetPeer)()])),r(e,"click","_im_retry_media",e=>function(e,t,a){var r=e.get(),o=domClosest("_im_mess",a.target),l=domData(o,"msgid"),c=Object(s.getMessage)(r,r.peer,l),d=e=>t().replaceAttachmentPlaceholders(e,c);c&&(Object(qe.statlogsSendingRetry)("retry_attach"),e.set(n.addAttachmentsToStoreData.bind(null,c,[Object(i.renderMessageMedia)(e,c)])).then(d),e.set(n.loadMedia.bind(null,c)).then(d))}(t,b,e)),r(e,"click",i.MESSAGE_KEYBOARD_BUTTON_CLASS,$),r(e,"click","_im-call-snippet",Z),r(e,"click","_im_call_snippet_join_btn",ee),a(geByClass1("_im_peer_history_w",e),"mousemove",O.show),a(geByClass1("_im_start_new",e),"click",B),a(e.querySelector("._im_to_end"),"click",R),a(e.querySelector("._im_to_mention"),"click",F),a(geByClass1("_im_cancel_edit",e),"click",()=>(b().cancelEditing(),!1)),a(geByClass1("_im_edit_focus_cur",e),"click",()=>(b().focusEditingMessage(),!1)),Ke.screenfull.raw&&a(document,Ke.screenfull.raw.fullscreenchange,K),a(window,"im_goToMessage",e=>{var a=intval(e.msgid);if(a)return window.statlogsValueEvent("im_links_to_attachments",1,"to_message"),t.set(n.changePeer.bind(null,e.sel,a,!1)).then(()=>Object(i.focusOnMessage)(t,b().focusOnMessage,t.get().peer,a))}),r(e,"click","im-expired-message--in",J)}});curNotifier.recvClbks.pin_hide=[function(e){e.hide?Object(ze.pinnedMessageHide)(t,e.peer,b,!1):Object(ze.pinnedMessageUnHide)(t,e.peer,b,!1)}],window.showForwardBox=e=>function(e,t){Object(i.boxHandleMessagesLabelsTooltips)(showBox("al_im.php",t,{dark:1}),e)}(t,e);var ne=setInterval(cr.bind(null,t,e,I),1e4);return v(ae,e,E,I,M,b,o,A,L,k,S,t,f,ne,O,N,T,P)}function Yr(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return zr(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return zr(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function zr(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var $r=[],Xr=0,Qr=!1;function Jr(e){$r=$r.reduce((t,a)=>{var n=Yr(a,2),i=n[0],s=n[1];return s(e)?t:t.concat([[i,s]])},[])}function Zr(e,t){!1===Qr&&(Qr=!0,document.body.addEventListener("click",Jr,!0)),$r=$r.concat([[e,t]])}function eo(e){$r=$r.filter(t=>Yr(t,1)[0]!==e),0===Xr&&(document.body.removeEventListener("click",Jr,!0),Qr=!1)}function to(e,t){$r=$r.map(a=>{var n=Yr(a,2),i=n[0],s=n[1];return i===e?[e,t]:[i,s]})}function ao(e,t){return 0===t.length?t=>(e(t),!0):a=>{var n=t.reduce((e,t)=>e&&!domClosest(t,a.target),!0);return n&&e(a),n}}var no=a("XzvV"),io=a("enZq"),so=a("RdBX"),ro=a("xGYt").default,oo=function(e){var t=e.onClose,a=e.contacts,n=e.selectPeer,s=Qe.a.useState(""),r=s[0],o=s[1],l=Qe.a.useState(a),c=l[0],d=l[1],u=Object(Xe.useMemo)((function(){return new so.vkIndexer(a,(function(e){return[e.name,e.user&&e.user.full_name].filter(Boolean).join(" ")}))}),[a]);Qe.a.useEffect((function(){if(0!==r.length){var e=u.search(r);d(e)}else d(a)}),[r]);return Qe.a.createElement("div",{className:"ContactsListContent"},Qe.a.createElement(at.BlockSearchInput,{onChange:function(e){return t=e.target.value,void o(t);var t},placeholder:Object(dt.getLang)("mail_top_search"),autoFocus:!0,key:"search",value:r}),0===c.length?Qe.a.createElement(nt.default,{className:"ContactsListContent__stub",key:"no-results"},Object(dt.getLang)("mail_im_search_empty_contacts")):Qe.a.createElement(Xa.default,{className:"ContactsListContent__scroll"},Qe.a.createElement(io.default,{className:"ContactsListContent__list"},c.map((function(e){var a=e.user?e.user.user_id:19e8+e.id,s=Object(i.prepareContactName)(e.name);return Qe.a.createElement(ro,{key:e.id,onClick:function(){return function(e){n(e),t()}(a)},className:"ContactsListContent__contact"},Qe.a.createElement("div",{className:"ContactsListContent__contactAvatar"},e.user?Qe.a.createElement("img",{className:"ContactsListContent__contactAvatarImage",src:e.user.photo,alt:e.name}):Qe.a.createElement(ut.ConversationNoPhoto,{text:Object(i.getUserInitials)(e.name),size:"34",id:a,specificType:7,key:e.id})),Qe.a.createElement("div",{className:"ContactsListContent__contactName"},Qe.a.createElement(Rt.default,null,s)))})))))},lo=function(e){var t=e.onClose,a=e.selectPeer,n=e.getContactsList,i=Qe.a.useState({kind:"loading"}),s=i[0],r=i[1];switch(Qe.a.useEffect((function(){n().then((function(e){r({kind:"loaded",contactsList:e})})).catch((function(e){Object(_.showErrorBox)(Object(dt.getLang)("global_error")),r({kind:"failed",error:e}),t()}))}),[]),s.kind){case"failed":return Qe.a.createElement(Qe.a.Fragment,null);case"loading":return Qe.a.createElement(Ht.default,null);case"loaded":return Qe.a.createElement(Dt.default,{onClose:t,disableBodyScroll:!0,className:"ContactsList"},Qe.a.createElement(xt.default.Header,{title:Object(dt.getLang)("mail_contacts_list"),onClose:t,appearance:"blue"}),Qe.a.createElement("div",{className:"ContactsList__body"},Qe.a.createElement(oo,{contacts:s.contactsList,onClose:t,selectPeer:a})))}};function co(e,t){var a=uo();Je.render(Xe.createElement(lo,{onClose:t.closeContactList,getContactsList:()=>function(e){return zt(e).then(e=>{var t=e.get().contactsList;return Promise.resolve(t)})}(e),selectPeer:t=>function(e,t){e.get().longpoll.push([Object(h.changePeer)(t,!1,!0,!0,"")])}(e,t)}),a)}function uo(){var e=document.getElementById("_im_contacts_list");if(e)return e;var t=document.createElement("section");return t.setAttribute("id","_im_contacts_list"),document.body.appendChild(t),t}function go(e,t){return{unmount:()=>function(e,t){var a=uo();a&&Je.unmountComponentAtNode(a),Object(p.destroyModule)(e)}(e),closeContactList(){var e=uo();Je.unmountComponentAtNode(e)}}}function mo(e){var t=(0,Object(p.createMutations)(go).bindMutations)(Object(p.createModule)({handlers:(e,t)=>{}}),e);return co(e,t),t}function _o(){return(_o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function po(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return ho(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return ho(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ho(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var bo=Object(Ln.debounce)(q.statlogsProbValueEvent,1e3);function vo(e,t,a,i,r,o,l){var c=trim(o);if(Object(s.isSearchingValue)(e,c)){var d=()=>l.clearSearch(e,t);c?(e.setState({recentSearch:!1}),r.stop()):r.replaceOrAdd(d),cancelStackPush("im_search",d),c&&e.set(e=>Object(n.setCurrentSearch)(c,!1,e)).then(t),i.classList.add("im-page--dialogs-search_fill","_im_d_search"),Object(s.isCommunityInterface)(e)||l.showCancelControl()}else c||(r.stop(),e.set(e=>Object(n.setCurrentSearch)("",!1,e)).then(t),i.classList.remove("im-page--dialogs-search_fill","_im_d_search"),Object(s.isCommunityInterface)(e)||l.hideCancelControl())}function fo(e,t,a){return function(){var n=Object(s.getSearchText)(t);n===e&&a(...arguments)}}function Oo(e,t,a){var i=Object(s.getSearchText)(a);return bo(.01,"im_search_stat",1,"search_start"),Object(n.updateSearchQuery)(i),a.setState({recentSearch:!1}),e().toggleSettingsButton(a,!!i),i?(a.get().dialog_search_going=!0,function(e,t,a){var i=fo(e,a,e=>t().appendFastDialogs(a,e));return Object(n.searchTopConv)(e,a.get()).then(e=>(i(e),e))}(i,e,a).then(n=>{var s=n.map(e=>e.peerId);return t(i,e,s,a)}).then(()=>{a.get().dialog_search_going=!1}).catch(()=>{})):(e().restoreDialogs(a,!1,!0),Object(no.removeSearchPositionTracker)("messages"),Promise.resolve(!1))}function yo(e,t,a,s){var r=s.get(),o=fo(e,s,e=>t().appendDialogs(s,e)),l=fo(e,s,t().appendSearch);return Object(i.isPendingForward)(s)?Object(n.searchHints)(e,a,"all",{},r).then(o):Promise.all([Object(n.searchHints)(e,a,"all",{},r).then(o),Object(n.searchMessages)(e,r)]).then(e=>{var t=po(e,2),a=po(t[1],2),n=a[0],i=a[1];l(s,n,i,!0)})}function Co(e,t,a){var i=a.target;e.set(e=>Object(n.toggleCommunityMute)(t,e)).then(()=>{i.classList.toggle("im-page--gim-mute_muted",e.get().mute),t&&jo(e,{target:i})})}function jo(e,t){var a=t.target;return Object(l.showTooltip)(a,{text:()=>e.get().mute?Object(o.getLang)("mail_im_sound_off"):Object(o.getLang)("mail_im_sound_on"),black:1,shift:[13,9],appendCls:"js-im-page"})}function So(e,t,a,n,i,r,o,l,c){return{focusInput(){uiSearch.focus(n.parentNode)},hideCancelControl(){a.classList.remove("im-page--dialogs-header-controls_hidden"),t.classList.add("im-dialog-select_hidden"),t.classList.remove("im-dialog-select_rotated")},showCancelControl(){a.classList.add("im-page--dialogs-header-controls_hidden"),t.classList.add("im-dialog-select_rotated"),t.classList.remove("im-dialog-select_hidden")},setSearch(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2]?c:()=>{};n.value=t,vo(e,a,0,n,r,t,l())},clearSearch(e,t){cancelStackFilter("im_search"),Object(s.isCommunityInterface)(e)||l().hideCancelControl(),uiSearch.reset(n),e.setState({recentSearch:!1}),vo(e,t||(()=>{}),0,n,r,n.value,l())},unmount(){r.stop(),Object(p.destroyModule)(o),uiSearch.destroy(i),cancelStackFilter("im_search")}}}function Eo(e,t,a){var r=Object(p.createMutations)(So),c=r.callMutations,d=r.bindMutations,u=geByClass1("_im_dialogs_header_controls",e),g=geByClass1("_im_create_convo",e),m=geByClass1("_im_create_call",e),_=geByClass1("_im_search_cancel",e),b=ge("im_dialogs_search",e),v=geByClass1("_im_gim_mute",e),f=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return Xr++,{stop(){Xr--,eo(e)},replaceOrAdd(a){var n=$r.filter(t=>{var a=Yr(t,1)[0];return e===a}),i=ao(a,t);n.length>0?to(e,i):Zr(e,i)}}}("im_search",["_im_search_more","_im_create_convo","_im_create_call","_im_page_dcontent","_im_d_search","_im_dialog"]),O=Object(Ot.debouncedPromise)(yo,300),y=e=>Oo(a,O,e),C=e=>vo(t,y,0,b,f,e,c()),j=()=>c().clearSearch(t,y),S=geByClass1("_im_dialogs_search_input",e);uiSearch.init(S,{onChange:C}),b.value&&setTimeout(()=>C(b.value),0);var E=e=>{Object(l.showTooltip)(e.target,{text:Object(o.getLang)("mail_admin_av_time"),dir:geByClass1("_im_top_notice")||geByClass1("im-page--dialogs--group-status")?"down":"up",shift:[0,8]})},w=()=>{var e;e=0===t.get().peer||Object(i.isPendingForward)(t)?"search":"default",Object(s.isSearching)(t)||a().toggleSettingsButton(t,!1),t.get().longpoll.push([Object(h.transitionEvent)(e)])},T=()=>{Object(s.isSearching)(t)&&a().toggleSettingsButton(t,!0),function(e,t,a,r,o,l){if(!Object(s.isSearching)(e)){var c=cur.imDb.select(Cs.RECENT_SEARCH_OP);if(0!==c.length||Object(s.doPopularSuggExist)(e)){e.setState({recentSearch:!0}),vo(e,()=>{Object(s.isSearching)(e)||(r.stop(),o().toggleSettingsButton(e,!1),o().restoreDialogs(e,!1,!0))},0,a,r,"",l);var d=c.filter(t=>!Object(i.isTabLoadedWithMessage)(e.get(),t)),u=c.filter(t=>Object(i.isTabLoadedWithMessage)(e.get(),t)).reduce((t,a)=>(t[a]=Object(s.getTab)(e,a),t),{});e.get().topConvTree.then(t=>{var a=t.list.filter(e=>d.includes(e[0])).reduce((e,t)=>(e[t[0]]=Object(n.localIndexToDialog)(t),e),{}),i=_o({},a,{},u);return o().appendFastDialogs(e,c.map(e=>i[e])),a}).then(t=>Object(n.searchHints)(!1,Object.keys(t),!1,{},e.get())).then(t=>{o().appendDialogs(e,t)})}}}(t,0,b,f,a,c())},I=(e,a)=>{switch(a.dataset.action){case"contacts":mo(t);break;case"favorites":nav.go("/im?box=fav")}},M=Object(p.createModule)({handlers:(n,r)=>{n(_,"click",j),n(_,"mouseover",()=>function(e,t){return Object(l.showTooltip)(t,{appendEl:bodyNode,text:Object(o.getLang)("mail_cancel"),black:1,shift:[3,-1],appendCls:"js-im-page"})}(0,_)),n(g,"click",()=>a().showCreation(t)),n(m,"click",()=>Object(i.startCallFromIm)(t,null,!1,null,i.CALL_ENTRY_POINT_LIST)),r(e,"click","_im_search_more_action",I),n(geByClass1("_im_av_time",e),"mouseover",E),Object(s.isCommunityInterface)(t)&&(n(v,"click",e=>Co(t,!0,e)),n(v,"mouseover",e=>jo(t,e))),n(b,"click",T),n(b,"blur",w),n(b,"focus",()=>{t.get().longpoll.push([Object(h.transitionEvent)("search")])})}});return Object(s.isCommunityInterface)(t)&&Co(t,!1,{target:v}),d(e,_,u,b,S,f,M,c,y)}var wo=a("W9Tc");function To(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Io(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Io(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Io(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function Mo(e,t,a,s){if(!e.loading&&!e.all&&a.scrollTop+window.innerHeight-a.scrollHeight>-300){var r=geByClass1("_im_peer_history",t.bodyNode);e.loading=!0,Object(i.wrapLoading)(r)(Object(n.loadSpam)(e.offset,s.get().gid).then(t=>{var a=To(t,4),o=(a[0],a[1]),l=(a[2],a[3]);e.all=l.all,e.offset=l.offset,e.all?addClass(r,"im-important_all"):e.loading=!1,s.set(n.mergeTabs.bind(null,Object(i.tabFromIds)(l.msgs,l.hash)));var c=ce("div");c.innerHTML=o,r.appendChild(c),Object(i.ensureDomHasActions)(r)}),"bottom")}}function Ao(e,t){var a=t.get().selectedMessages,n=geByClass1("_im_spam_box",e.bodyNode),s=geByClass1("ui_tab_sel",e.bodyNode);if(a.length>0){var r=getLang("mail_selected",a.length);r=r.replace("{count}",a.length),val(s,r+`<button aria-label="${getLang("mail_deselect_all")}" type="button" class="im-deselect ${i.DESELECT_ALL_CLASS}"></button>`)}else val(s,getLang("mail_spam"));0===a.length?removeClass(n,"im-important-box_with-sel"):(addClass(n,"im-important-box_with-sel"),val(geByClass1("_im_spam_not_spam"),getLang("mail_im_mark_notspam",a.length)),val(geByClass1("_im_spam_spam"),getLang("mail_im_mark_delspam",a.length)))}function Lo(e,t,a){var i=e.get().selectedMessages;e.set(n.cleanSelected).then(a.cleanSelection.bind(null,i)).then(a=>Ao(t,e))}function ko(e,t,a,s){var r=gpeByClass("_im_mess",s,t);if(r){var o=intval(domData(r,"msgid"));r&&(Object(n.removeMessageSend)([o],0,e.get().tabs[0].hash,"undel",e.get()),Object(i.restoreMessage)(o,0,t))}}function Po(e,t,a){var s=e.get().selectedMessages;Object(n.removeMessageSend)(s,0,e.get().tabs[0].hash,"delete",e.get()),Object(i.removeMessagesWithRestore)(s,0,"delete",t),Lo(e,t,a)}function No(e,t,a){var s=e.get().selectedMessages;Object(n.removeMessageSend)(s,0,e.get().tabs[0].hash,"nospam",e.get()),s.map(e=>geByClass1("_im_mess_"+e)).filter(e=>e).forEach(e=>{var t=intval(domData(e,"peer")),a=intval(domData(e,"msgid"));val(e,Object(i.renderGoTo)(t,a)),addClass(e,"im-mess_light")}),Lo(e,t,a)}function Do(e,t,a,n,i){var s=gpeByClass("_im_mess",i,t.bodyNode),r=intval(domData(s,"peer")),o=intval(domData(s,"msgid"));return t.hide(),a().unmount(),e.get().longpoll.push([Object(h.changePeer)(r,o)]),Object(Za.stopEvent)(n),cancelEvent(n),!1}function xo(e,t,a,i){var s=Object(Ve.showFastBox)({title:getLang("mail_deleteall1"),dark:1,bodyStyle:"padding: 20px; line-height: 160%;"},getLang("mail_delete_all_spam"),getLang("mail_delete"),()=>{Object(n.flushSpam)(e,i).then(e=>{var t=To(e,2),a=(t[0],t[1]);showDoneBox(a)}),s.hide(),t.hide(),a().unmount()},getLang("mail_close"),()=>s.hide())}function Bo(e,t){return{unmount(){t.unmount(),Object(p.destroyModule)(e)}}}function Ro(e,t,a){var n=ge("box_layer_wrap"),s=Object(p.createMutations)(Bo),r=s.callMutations,o=s.bindMutations,l=Object(C.default)({peer:0,oCache:{},tabs:Object(i.tabFromIds)(a.msgs,a.hash),gid:t.get().gid}),c=Mo.bind(null,{all:a.all,loading:!1,offset:a.offset},e,n,l),d=ko.bind(null,l,e.bodyNode),u=Do.bind(null,t,e,r),g=xo.bind(null,a.hash,e,r,t.get().gid),m=ss(e.bodyNode,l,t=>({changedMessageSelection:Ao.bind(null,e)})),_=Po.bind(null,l,e.bodyNode,m),h=No.bind(null,l,e.bodyNode,m),b=Lo.bind(null,l,e,m);return Object(i.ensureDomHasActions)(e.bodyNode),o(Object(p.createModule)({handlers:(t,a)=>{t(n,"scroll",c),t(geByClass1("_im_spam_spam",e.bodyNode),"click",_),t(geByClass1("_im_spam_not_spam",e.bodyNode),"click",h),t(geByClass1("_im_spam_flush",e.bodyNode),"click",g),a(e.bodyNode,"click","_im_mess_restore",d),a(e.bodyNode,"click","_im_go_to",u),a(e.bodyNode,"click",i.DESELECT_ALL_CLASS,b)}}),m)}function Fo(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"im_settings",t={sound:ls.get("sound_notify_off")?getLang("mail_im_sound_off"):getLang("mail_im_sound_on")};return window.pushNotifier&&window.pushNotifier.loadEndpoint()||Object(wo.partConfigEnabled)("push_notifier")&&ls.get("im_ui_notify_off")?t.browser=getLang("mail_notification_settings"):t.browser=Uo()?getLang("mail_im_notifications_on"):getLang("mail_im_notifications_off"),getTemplate(e,t)}function Ho(e,t){Object(l.showTooltip)(t.target,{content:Fo("im_settings_pop"),dir:"down",shift:[220,9],hasover:!0,showdt:10})}function Uo(){return DesktopNotifications.supported()&&!DesktopNotifications.checkPermission()&&!ls.get("im_ui_notify_off")}function Go(e,t,a,n,s){var r=domData(s,"action"),o=gpeByClass("_im_settings_menu",s),l=hasClass(o,"_im_settings_popup")?"im_settings_pop":"im_settings";switch(r){case"spam":Object(i.showSpamLayer)(e,Ro,n);break;case"sound":ls.get("sound_notify_off")?ls.set("sound_notify_off",0):ls.set("sound_notify_off",1),o.outerHTML=Fo(l);break;case"browser":Uo()?(ls.set("im_ui_notify_off",1),o.outerHTML=Fo(l),Object(qe.statlogsBrowserNotificationsOff)()):DesktopNotifications.checkPermission()?DesktopNotifications.requestPermission(()=>{o.parentNode&&(o.outerHTML=Fo(l))}):Object(wo.partConfigEnabled)("push_notifier")?nav.go("/settings?act=notify"):(ls.set("im_ui_notify_off",0),o.outerHTML=Fo(l),Object(qe.statlogsBrowserNotificationsOn)())}}function qo(e,t,a){var r=Ho.bind(null,t),o=Go.bind(null,t,a,e),l=function(e,s){if(Object(i.showUnreadOnly)(t,a,n.changeDialogsTab)){var r=t.get().active_tab===y.FOLDER_UNREAD;val(s,getTemplate("im_filter",{filter:r?getLang("mail_to_all_dialogs"):getLang("mail_to_unread")}))}},c=Object(p.createModule)({handlers:(t,a)=>{a(e,"mouseover","_im_dialogs_cog_settings",r),a(e,"click","_im_settings_action",o),a(e,"click","_im_to_unread",l)}});return function(e,t){return{updateFilter(t){var a,n=t.get().active_tab===y.FOLDER_UNREAD,i=[];Object(s.isSearching)(t)&&i.push("im-page--dialogs-filter_hidden"),t.get().unread_cnt>0?a=n?getLang("mail_to_all_dialogs"):getLang("mail_to_unread"):(a=getLang("mail_all_dialogs"),i.push("im-page--dialogs-filter_disabled")),val(geByClass1("_im_to_unread",e),getTemplate("im_filter",{filter:a,cls:i.join(" ")}))},toggleButton(t,a){var n=geByClass1("im-page--dialogs-filter",e);toggleClass(n,"im-page--dialogs-filter_hidden",a)},toggleLoader(t,a){var n=geByClass1("_im_dialogs_cog_settings",e);toggleClass(n,"im-page--dialogs-settings_loading",a)},updateSettings(t){geByClass1("_im_settings_menu",e).outerHTML=Fo()},unmount(){Object(p.destroyModule)(t)}}}(e,c)}var Wo=a("iukX");function Ko(e,t){return t.selection||(t.selection=[]),t.selection.push(e),Promise.resolve(t)}function Vo(e){return e.selection=[],Promise.resolve(e)}function Yo(e,t){return t.selection=t.selection.filter(t=>t.id!==e),Promise.resolve(t)}function zo(e,t,a,n,i,s,r){var o=intval(domData(r,"peer"));tooltips.hide(r),t.set(Yo.bind(null,o)).then(s=>{Xo(e,n,t,i),a().selectionDeleted(t,o)})}function $o(e,t,a,i){e.set(n.setCurrentSearch.bind(null,a,!1)).then(t().onChange)}function Xo(e,t,a,n){var i=a.get().selection,s=uiSearch.getFieldEl(e);uiSearch.focus(e),i.length>0?attr(s,"placeholder",""):attr(s,"placeholder",unclean(Object(o.getLang)("mail_search_creation"))),t.innerHTML=i.map(e=>`<div class="token">\n      <div class="token_title">${e.name}</div>\n      <div data-peer="${e.id}" class="token_del _ui_multiselect_cancel"></div>\n    </div>`).join(""),toggleClass(e,"ui_multiselect_has_selection",i.length>0),domFC(e).scrollTop+=50,n()}function Qo(e,t){return Object(l.showTooltip)(t,{text:Object(o.getLang)("mail_create_chat_remove_user"),black:1,shift:[15,8],appendParentCls:"_wrap"})}function Jo(e,t,a){uiSearch.init(e,{onChange:$o.bind(null,t,a)});var n=uiSearch.getFieldEl(e),i=ce("div",{className:"_ui_multiselection ui_multiselect_cnt"});n&&n.parentNode.insertBefore(i,n);var s,r,o=(s=n,r=0,function(){var e=s.offsetWidth;setStyle(s,{width:1});var t=s.offsetLeft;r!==t?(r=t,e=s.parentNode.offsetWidth,setStyle(s,{width:Math.max(30,e-t-20)})):setStyle(s,{width:e})});t.set(Vo);var l=zo.bind(null,e,t,a,i,o),c=t=>{document.activeElement!==n&&uiSearch.focus(e)},d=Object(p.createModule)({handlers:(t,a)=>{a(e,"click","_ui_multiselect_cancel",l),a(e,"mouseover","_ui_multiselect_cancel",Qo),t(e,"click",c)}});return{addSelection:(a,n)=>t.set(Ko.bind(null,{id:a,name:n})).then(Xo.bind(null,e,i,t,o)),removeSelection:a=>t.set(Yo.bind(null,a)).then(Xo.bind(null,e,i,t,o)),resetSelection(){!function(e,t,a,n){e.set(Vo).then(Xo.bind(null,t,a,e,n))}(t,e,i,o)},focus(){uiSearch.focus(e)},save(){t.stash(),Xo(e,i,t,o)},restore(){t.pop(),Xo(e,i,t,o)},unmount(){uiSearch.destroy(e),Object(p.destroyModule)(d)}}}var Zo=a("v+DW"),el="_im_dialogs_creation_name",tl="_im_create_select",al=["im-creation--item_hovered"],nl=0;function il(e){!function(e){var t=e.querySelector("._im_creation_settings_modal_wrap"),a=sl.bind(null,t);Je.render(Xe.createElement(Dt.default,{onClose:a,className:"im-creation--modal-settings"},Xe.createElement(et.default,{title:Object(o.getLang)("mail_chat_creation_settings"),onCloseClick:a}),Xe.createElement(Wo.default,{flags:nl,back:a,isChatCreation:!0,onSave:rl,afterSave:ol.bind(null,t),onCancel:a})),t)}(e)}function sl(e){e&&Je.unmountComponentAtNode(e)}function rl(e){return nl=e,Promise.resolve()}function ol(e){sl(e)}function ll(e){return Object(l.showTooltip)(e,{text:Object(o.getLang)("mail_chat_creation_settings_icon_tooltip"),black:1,center:!0,zIndex:1e3,shift:[0,10]})}function cl(e,t,a,i,s,r){Object(n.toggleConversation)(!1),removeClass(t,"im-create_shown"),removeClass(t,"im-create_photo-attached"),setTimeout(ul.bind(null,t,!1),100),hl(r).map(e=>geByClass1("_im_dialog"+e)).forEach(e=>{removeClass(e,"olist_item_wrap_on")}),a().createCanceled(e),s.resetSelection(),"add_member"===e.get().creationType&&e.set(n.setCreationType.bind(null,"chat",[])),e.set(n.presetAvatar.bind(null,!1));var o=geByClass1("_im_avatar_img",t);gl(e,r,t),uiSearch.reset(geByClass1(el,t)),uiSearch.reset(geByClass1(tl,t)),o&&o.parentNode.removeChild(o),gl(e,r,t),cancelStackFilter("im_search");var l=0===e.get().peer?"search":"default";e.get().longpoll.push([Object(h.transitionEvent)(l)]),attr(t,"aria-hidden","true")}function dl(e,t,a){return t&&(a.current_create_peer_ids={},a.current_create_peers=[]),a.current_create_peer_ids||(a.current_create_peer_ids={}),a.current_create_peers||(a.current_create_peers=[]),e.forEach(e=>{e.then(e=>{e=e.filter(e=>!a.current_create_peer_ids[e.peerId]),a.current_create_peer_ids=e.reduce((e,t)=>(e[t.peerId]=!0,e),a.current_create_peer_ids),a.current_create_peers=a.current_create_peers.concat(e)})}),Promise.resolve(a)}function ul(e,t){toggleClass(e,"im-create_material",t)}function gl(e,t,a){var n=geByClass1("_im_confirm_creation",a),i=t.get().selection.length,s="add_member"===e.get().creationType,r=i>0,l=uiSearch.getFieldEl(geByClass1(el,a)).value.length>0,c=!r&&(s||!l),d=s?1===i?Object(o.getLang)("mail_append_chat"):Object(o.getLang)("mail_im_create_chat_with"):l||i>1?Object(o.getLang)("mail_im_create_chat"):Object(o.getLang)("mail_im_go_to_dialog");val(n,d),toggleClass(n,"button_disabled",c)}function ml(e,t,a,n,i,s,r){if(r){var o,l=intval(domData(r,"list-id")),c=hl(s),d=trim(r.textContent),u=geByClass1(tl,t),g=getSize(u)[1];inArray(l,c)?(o=n.removeSelection(l,d),removeClass(r,"olist_item_wrap_on")):(o=n.addSelection(l,d),addClass(r,"olist_item_wrap_on")),o.then(()=>{var e=g-getSize(u)[1],t=i.scrollTop();i.scrollTop(t-e)}),gl(e,s,t);var m=geByClass1(tl,t);uiSearch.reset(m)}}function _l(e,t){var a=hl(e),n=["_im_dialog","_im_dialog"+t.peerId,"im-creation--item"],i=[];return t.online&&i.push("online"),mobPlatforms[t.online]&&i.push("mobile"),inArray(t.peerId,a)&&n.push("olist_item_wrap_on"),getTemplate("im_owner_item",{owner_id:t.peerId,cls:" "+n.join(" "),photo:t.photo,name:t.name,link:t.href,img_cls:i.join(" ")})}function pl(e){return Object(s.getSearchText)(e)||!1}function hl(e){return e.get().selection.map(e=>e.id)}function bl(e,t,a){return e.then(e=>e.filter(e=>e.is_friend&&!inArray(e.peerId,a.get().creationFilter)))}function vl(e,t,a,i,s){var r,o,l=geByClass1(tl,e),c=Object(n.searchLocalHints)(i,t.get()),d=a.hoverFirstElement.bind(a,al,Sl(t));t.get().creation_shown_all=!1,a.reset(),a.pipe(bl(c,0,t),i),a.toTop(),i?(o=Object(n.searchTopConv)(i,t.get()),r=Object(n.searchHintsIndex)(i,[],"friends",t.get()),a.pipe(bl(r,0,t),i).then(d),a.pipe(bl(o,0,t),i).then(d)):(r=Promise.resolve([]),o=Promise.resolve([])),t.set(dl.bind(null,[c,o,r],!0)),uiSearch.showProgress(l),Promise.all([c,r,o]).then(()=>uiSearch.hideProgress(l))}function fl(e,t,a,i){var s=2e9+Math.round(rand(1e6,2e6));cur.recieveCropResult=a=>{cur.recieveCropResult=!1,curBox()&&curBox().hide(),e.set(n.presetAvatar.bind(null,a)),Object(n.getOwnerPhoto)(a,s).then(e=>{geByClass1("_im_create_avatar",t).appendChild(ce("img",{className:"im-chat-placeholder--img _im_avatar_img",src:e}))}),addClass(t,"im-create_photo-attached")},Page.ownerPhoto(s)}function Ol(e,t){geByClass1("_im_create_avatar",t).innerHTML="",e.set(n.presetAvatar.bind(null,!1)),removeClass(t,"im-create_photo-attached")}function yl(e,t,a,n,i,s){hl(t).map(e=>geByClass1("_im_dialog"+e)).forEach(e=>removeClass(e,"olist_item_wrap_on")),t.reset(),vl(a,e,n,!1,hl(t)),i.resetSelection(),cl(e,a,s,0,i,t)}function Cl(e,t,a,i,r,l,c){var d=hl(t),u=e.get(),g=geByClass1("_im_confirm_creation",a),m=uiSearch.getFieldEl(geByClass1(el,a)).value,_="add_member"===e.get().creationType,p=!_&&(m.length||d.length>1),b=geByClass1("_im_creation_show_history_input",a).checked;if(_)return e.set(n.addNewMember.bind(null,u.peer,d,b)).catch(e=>Object(Ve.showFastBox)(Object(o.getLang)("global_error"),e)),cl(e,a,l,0,r,t);if(Object(Zo.lockButton)(g),!p)return v(d[0]);function v(n){nl=0,yl(e,t,a,i,r,l),function(e,t,a,n,i,s){cl(e,t,a,0,i,s),e.get().longpoll.push([Object(h.changePeer)(n,!1,!1,!1,"create_conversation")])}(e,a,l,n,r,t),Object(Zo.unlockButton)(g),Object(s.isSearching)(e)?l().cancelSearch(e):l().restoreDialogs(e)}e.set(n.createChat.bind(null,u.next_chat_avatar,d,m,nl)).then(()=>v(u.next_peer)).catch(e=>{Object(Zo.unlockButton)(g),topMsg(Object(o.getLang)("global_unknown_error"),2,"#FFB4A3")})}function jl(e,t){return Object(l.showTooltip)(e,{text:Object(o.getLang)("mail_cancel"),black:1,zIndex:1e3,shift:[3,-2],appendCls:"js-im-page"})}function Sl(e,t){var a=t&&t.get().selection.length;return{top:-1,bottom:Object(i.isClassicInterface)(e)?a>0?69:0:-1}}function El(e,t,a){gl(e,t,a)}function wl(e,t,a,n,i,s,r,l){return{show(t){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t.setState({shown:!0}),ul(e,!0),cancelStackPush("im_create",r),addClass(e,"im-create_shown");var l=n.get().selection.reduce((e,t)=>(e[t.id]=!0,e),{});s&&s.forEach(t=>{if(!l[t[0]]){var a=e.querySelector("._im_dialog"+t[0]);i.addSelection(t[0],t[1]),a&&!a.classList.contains("olist_item_wrap_on")&&a.classList.add("olist_item_wrap_on")}}),function(e,t,a,n){toggleClass(e,"im-create_chat","chat"===n.get().creationType),toggleClass(e,"im-create_invite","add_member"===n.get().creationType);var i="chat"===n.get().creationType?Object(o.getLang)("mail_im_group_dialog"):Object(o.getLang)("mail_im_friends_tab"),s=geByClass1("_im_create_title",e);val(s,i),val(geByClass1("_im_confirm_creation",e),"add_member"===n.get().creationType?Object(o.getLang)("mail_im_create_chat_with"):Object(o.getLang)("mail_im_create_chat")),vl(e,n,t,!1,a.get().selection.map(e=>e.id))}(e,a,n,t),setTimeout(()=>{t.get().longpoll.push([Object(h.transitionEvent)("create")]),attr(e,"aria-hidden","false"),i.focus()},1)},focusSearch(e){i.focus()},confirmCreate(e){l()},hide(a){a.get().shown=!1,cl(a,e,t,0,i,n)},scroll(e){a.scrollPage(e,!0)},updateScroll(){a.updateScroll()},selectElement(t){ml(t,e,0,i,a,n,a.getHoveredElement())},hoverPrevElement(e){a.hoverPrevElement(al,null,Sl(e,n))},hoverNextElement(e){a.hoverNextElement(al,null,Sl(e,n))},unmount(){Object(p.destroyModule)(s),a.unmount(),i.unmount(),cancelStackFilter("im_create"),cur.recieveCropResult=void 0}}}function Tl(e,t,a){var i=Object(C.default)({selection:[]}),s=G(geByClass1("_im_create_list",e),Object(C.default)({offset:0,limit:100,elements:[],elCls:"_im_dialog"}),()=>({idFn:e=>intval(e.peerId),hoverableFn:e=>hasClass(e,"_im_dialog"),renderFn:_l.bind(null,i),more(e,a){var s;return t.get().shown?(t.get().creation_shown_all||!1!==pl(i)?s=Promise.resolve([]):(t.get().creation_shown_all=!0,s=Object(n.searchTopConv)(pl(i),t.get())),t.set(dl.bind(null,[s],!1)),bl(s,pl(i),t)):Promise.resolve(!1)},onClick(a,n){checkEvent(a)||(ml(t,e,0,l,s,i,n),cancelEvent(a))}}));t.get().creationQuery=!1,t.get().creationType="chat";var r=geByClass1(tl,e),o=Object(Ot.debouncedPromise)(a=>function(e,t,a,n){var i=n.get(),s=pl(i);i.selection.map(e=>e.id),a.unhoverElements(al),e.get().creationQuery=s,vl(t,e,a,s)}(t,e,s,a),300),l=Jo(r,i,()=>({selectionDeleted(a,n){gl(t,a,e),removeClass(geByClass1("_im_dialog"+n),"olist_item_wrap_on")},onChange:o})),c=cl.bind(null,t,e,a,"cross",l,i),d=fl.bind(null,t,e),u=Ol.bind(null,t,e),g=yl.bind(null,t,i,e,s,l,a),m=Cl.bind(null,t,i,e,s,l,a),h=El.bind(null,t,i,e),b=il.bind(null,e),v=geByClass1("_im_create_cancel",e),f=geByClass1(el,e),O=geByClass1("_im_creation_settings",e),y=f.querySelector(".ui_search_reset"),j=Object(p.createModule)({handlers:(t,a)=>{t(v,"click",c),t(v,"mouseover",jl.bind(null,v)),t(geByClass1("_im_create_avatar",e),"click",d),t(geByClass1("_im_create_remove_avatar",e),"click",u),t(geByClass1("_im_cancel_creation",e),"click",g),t(f,"change",h),t(f,"input",h),t(f,"paste",h),t(y,"click",h),t(geByClass1("_im_confirm_creation",e),"click",m),t(O,"click",b),t(O,"mouseenter",ll.bind(null,O)),t(e,"mouseover",Object(_.throttle)(s.unhoverElements.bind(s,al),100))}});return wl(e,a,s,i,l,j,c,m)}var Il,Ml=a("BxOC");!function(e){e.Online="online"}(Il||(Il={}));var Al=function(){function e(){var e=this;this.ADD_KEY_INTERVAL=25e3,this.RETRIES=5,this.retriesLeft=this.RETRIES,this.restart=function(){0!==e.retriesLeft&&(e.intervalId&&clearInterval(e.intervalId),e.retriesLeft--,Object(Ml.post)("al_im.php",{act:"a_messenger_queue_subscribe"}).then((function(e){return e[0]})).then((function(t){e.retriesLeft=e.RETRIES,e.subscription=t,e.intervalId=window.setInterval((function(){e.subscription&&window.Notifier.addKey(e.subscription,e.listen)}),e.ADD_KEY_INTERVAL)})).catch((function(){setTimeout(e.restart,e.ADD_KEY_INTERVAL)})))},this.subscribe=function(t){e.listener||(e.listener=t,e.restart())},this.unsubscribe=function(){e.listener=void 0,e.subscription=void 0,e.retriesLeft=e.RETRIES,e.intervalId&&clearInterval(e.intervalId)},this.listen=function(t,a){if(function(e){return void 0!==e.err}(a))e.restart();else if(e.subscription&&(e.subscription.ts=a.ts),e.listener)for(var n=0,i=a.events;n<i.length;n++){var s=i[n];e.listener(s)}}}return e.getInstance=function(){return this.instance||(this.instance=new e),this.instance},e}();function Ll(e,t){return t.state=e,Promise.resolve(t)}function kl(e,t,a,n,s){switch(t){case y.ARROW_UP:Object(i.isEditableFocused)()||(n.scroll(s,"up"),cancelEvent(a));break;case y.ARROW_DOWN:Object(i.isEditableFocused)()||(n.scroll(s,"down"),cancelEvent(a));break;case y.PAGE_UP:a.ctrlKey||Object(i.isClassicInterface)(s)||(n.scroll(s,"up",!0),cancelEvent(a));break;case y.PAGE_DOWN:a.ctrlKey||Object(i.isClassicInterface)(s)||(n.scroll(s,"down",!0),cancelEvent(a));break;case y.HOME:Object(i.isEditableFocused)()||(n.scroll(s,"up",!1,!0),cancelEvent(a));break;case y.END_KEY:Object(i.isEditableFocused)()||(n.scroll(s,"down",!1,!0),cancelEvent(a));break;case y.PRINTABLE:n.focustTxt(e)}}function Pl(e,t,a,n,s,r){var o=Object(C.default)({state:t||"default"});return{signal(t,l){if(!(cur.storyLayer||cur.articleEditorLayer||window.isArticleLayerOpen()))switch(o.get().state){case"default":return kl(o,t,l,n,e);case"fwd":case"search":return function(e,t,a,n,s,r){switch(t){case y.ARROW_DOWN:n.hoverNextDialog(r),cancelEvent(a);break;case y.ARROW_UP:n.hoverPrevDialog(r),cancelEvent(a);break;case y.ENTER:Object(i.isEditableFocused)()&&!gpeByClass("_im_dialogs_search_input",document.activeElement)||n.selectHoveredDialog(r);break;case y.PRINTABLE:s.focusInput()}}(0,t,l,a,s,e);case"create":return function(e,t,a,n,s){switch(t){case y.PAGE_UP:!a.ctrlKey&&Object(i.isClassicInterface)(s)&&(n.scroll("up"),cancelEvent(a));break;case y.PAGE_DOWN:!a.ctrlKey&&Object(i.isClassicInterface)(s)&&(n.scroll("down"),cancelEvent(a));break;case y.ARROW_DOWN:n.hoverNextElement(s);break;case y.ARROW_UP:n.hoverPrevElement(s);break;case y.ENTER:gpeByClass("_im_dialogs_creation_name",document.activeElement)?n.confirmCreate(s):gpeByClass("im-create--search",document.activeElement)&&n.selectElement(s);break;case y.PRINTABLE:n.focusSearch(s)}}(0,t,l,r,e);case"message":return function(e,t,a,n,i){switch(t){case y.HOME:case y.END_KEY:n.isEmpty(i)&&kl(e,t,a,n,i);break;case y.PAGE_UP:case y.PAGE_DOWN:kl(e,t,a,n,i)}}(o,t,l,n,e);default:throw new Error("Unknown state: "+o.get().state)}},transition:e=>o.set(Ll.bind(null,e))}}var Nl=a("nJdr"),Dl=a("V1Nw"),xl=a("ERyv");function Bl(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Rl(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Rl(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Rl(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var Fl={},Hl=Date.now();function Ul(e,t){var a=Math.floor(t.status/100);t.status&&e.stat&&(t.status>=500&&t.status<600&&statlogsValueEvent("im_longpoll",1,a+"0x",t.getResponseHeader("x-frontend")),Fl[a]=Fl[a]?Fl[a]+1:1,Date.now()-Hl>=3e4&&(Object.keys(Fl).forEach(e=>{statlogsValueEvent("im_longpoll",Fl[e],e+"0x",t.getResponseHeader("x-frontend"))}),Fl={},Hl=Date.now()))}function Gl(e,t){return Promise.resolve(extend({},t,{timeout:e<64?2*e:e}))}function ql(e,t){return Promise.resolve(extend({},t,{imTs:e}))}function Wl(e){e.set(e=>Promise.resolve(extend({},e,{stopped:!0}))).then(()=>{e.get().cancelToken()})}function Kl(e,t){return t.cancelToken=e,Promise.resolve(t)}function Vl(e,t){return t.pauses||(t.pauses=[]),t.pauses.push(e),Promise.resolve(t)}function Yl(e){return e.pauses||(e.pauses=[]),Object(_.lplog)("Aborting all pauses","error"),e.pauses.forEach(e=>e()),e.pauses=[],Promise.resolve(e)}function zl(e,t,a,i){var s=i.failed?Object(Ot.abortablePause)(4,e):{},r=s.abort,o=s.pause;switch(i.failed){case 1:return Object(_.lplog)("Old timestamp, init resync","error"),e.set(Vl.bind(null,r)),a([h.resyncEvent()]),e.set(n.loadLongPollTs).then(o).then($l.bind(null,e,t,a));case 2:return Object(_.lplog)("Key is incorrect","error"),e.set(Vl.bind(null,r)),e.set(n.loadLongPollKey).then(o).then($l.bind(null,e,t,a));case 3:throw Object(xl.imWeirdLog)("im_longpoll_force_reload",i,!1),nav.reload({force:!0}),new Error("ts is very wrong");default:return e.set(ql.bind(null,i.ts)).then(()=>i)}}function $l(e,t,a){if(e.get().stopped)return Promise.resolve({updates:[]});if(t())return Promise.reject(new Error("pause"));var n=e.get(),i=`${n.imUrl}/${n.imPart}`,s=Object(Ml.plaingetCancelable)(i,{act:"a_check",key:n.imKey,version:11,ts:n.imTs,wait:25,mode:n.mode}),r=s.request,o=s.cancel;return e.set(Kl.bind(null,o)).then(()=>r).then(t=>{var a=Bl(t,2),i=a[0],s=a[1];return s&&Ul(n,s),e.set(Gl.bind(null,1)),JSON.parse(i)}).catch(e=>{var t=Bl(e,2),a=(t[0],t[1]);return a&&Ul(n,a),Promise.reject(new Error(""))}).then(zl.bind(null,e,t,a))}function Xl(e){var t=e.id,a=e.gid,n=e.key,i=e.ts,s=e.url,r=e.lhost,o=e.lpstat,l=new EventEmitter,c=window.vk.lpConfig&&window.vk.lpConfig.enabled&&window.longpollTesting_onImEvents,d=In((function(e,t){return c&&window.longpollTesting_onImEvents(t),l.trigger("data",t),Promise.resolve({})})),u=d.pause,g=d.resume,m=d.pushMessage,p=d.isPaused,b=d.reset,v=Object(C.default)({id:t,gid:a,mode:202,timeout:1,imKey:n,imTs:i,imPart:s,imUrl:r,pause:!1,stat:o});return function e(t,a,n){t.get().stopped||(Object(_.lplog)("New request"),$l(t,n,a).then(e=>e.map(h.constructEvent)).then(e=>(Object(_.lplog)("Request success","success"),e)).then(a).catch(e=>{if(!t.get().stopped)return Object(_.lplog)("Error, waiting: "+(e.message||"no message (probably browser reset)"),"error"),t.set(Gl.bind(null,n()?2:t.get().timeout)).then(()=>{var e=Object(Ot.abortablePause)(t.get().timeout,t),a=e.abort,n=e.pause;return t.set(Vl.bind(null,a)).then(n)});Object(_.lplog)("Stopped longpoll")}).then(e.bind(null,t,a,n)))}(v,m.bind(null,"main"),p.bind(null,"main")),{onData:e=>l.on("data",e),offData:e=>l.off("data",e),abortWaiting:()=>v.set(Yl),stop:Wl.bind(null,v),pause:u.bind(null,"main"),resume:g.bind(null,"main"),reset:b.bind(null,"main"),push:e=>l.trigger("data",e),isEnabled:()=>!v.get().pause&&!v.get().stopped}}a("9AAn");var Ql=new Map,Jl=!1;function Zl(e){return e.queue||e.key}function ec(){Ql.forEach((e,t)=>{var a=e.onData,n=e.onUpdateKey,i=e.ts;(function(e){return!!window.curNotifier&&!curNotifier.addQueues[Zl(e)]})(t)&&Notifier.addKey(extend(t,{ts:i}),nc.bind(null,a,n,t))})}function tc(){Jl||(Jl=setInterval(ec,3e3))}function ac(e){!function(e){if(!window.curNotifier)return!1;delete curNotifier.addQueues[Zl(e)]}(e),Ql.delete(e),0===Ql.size&&(clearInterval(Jl),Jl=!1)}function nc(e,t,a,n,i){if(i.failed)return ac(a),void function(e,t,a,n){var i;switch(e){case 1:case 2:case 3:case 5:i=n(t,e);break;case 4:i=Object(Ot.pause)(1).then(()=>t);break;default:throw new Error("Unkonwn error from queue: "+e)}Object(Ot.pause)(3).then(()=>i).then(e=>{Ql.set(e,{onUpdateKey:n,onData:a,ts:e.ts}),ec(),tc()})}(i.err,a,e,t);Ql.set(a,{onData:e,onUpdateKey:t,ts:intval(i.ts)}),i.events.map(e=>e.split("<!>")).forEach(e)}function ic(e){var t=e.get().tabbedPeers.map(t=>e.get().tabs[t.peer]||e.get().mapped_index&&e.get().mapped_index[t.peer]).filter(e=>e).filter(e=>!e.deletedDialog).map(e=>({type:"peer",peer:e.peerId}));return t.length>0&&(t=[{type:"sep"}].concat(t)),t}function sc(e,t){if("sep"===t.type)return getTemplate("im_right_menu_sep",{});var a=`${Object(i.getBaseLink)(e)}?sel=${t.peer}&tab=${e.get().active_tab}`,n=Object(i.getBareTab)(t.peer,e),s=Object(i.isContactPeer)(t.peer)?Object(i.prepareContactName)(n.tab):n.tab,r="";switch(!0){case n.unread>0:r=n.unread;break;case Object(i.isTabMarkedUnread)(n):r=1}return s=getTemplate("im_right_menu_ct",{name:s,count:r}),getTemplate("im_right_menu_tpl",{href:a,label:s,peer:t.peer,attrs:`title="${stripHTML(n.tab)}"`,cls:n.unread>0?"im-right-menu--unread":""})}function rc(e,t,a,i){var s=gpeByClass("_im_peer_tab",i),r=intval(domData(s,"list-id")),o=e.get().tabbedPeers.filter(e=>e.peer!==r);return e.set(n.updateTabbedPeers.bind(null,o,!0)).then(()=>{if(oc(t,e),r===e.get().peer)e.get().longpoll.push([Object(h.resetPeer)()]);else if(0!==e.get().peer){var a=gpeByClass("_im_right_menu",i);uiRightMenu.hideSliding(a)}}),cancelEvent(a),!1}function oc(e,t){return e.pipeReplace(Promise.resolve(ic(t)))}function lc(e,t,a,n){return{updateMenu(t){!function(e,t){geByClass("_im_peer_tab",e).forEach(e=>{var a=Object(Ps.fromQueryString)(attr(e,"href").split("?")[1]);a.tab!==t.get().active_tab&&attr(e,"href",`${Object(i.getBaseLink)(t)}?sel=${a.sel}&tab=${t.get().active_tab}`)})}(e,t);var n=gpeByClass("_im_right_menu",e);oc(a,t).then(()=>{var e;(e=t.get().peer?ge("ui_rmenu_peer_"+t.get().peer):ge("ui_rmenu_"+t.get().active_tab))&&uiRightMenu.switchMenu(e,!0),uiRightMenu.hideProgress(n)})},updateName(e,t){var a=ge("ui_rmenu_peer_"+e);if(a){var n=geByClass1("_im_r_tx",a),i=t.get().tabs[e].tab;val(n,i)}},updateCounter(e,t){var a=ge("ui_rmenu_peer_"+t);if(a){var n=geByClass1("_im_r_ct",a),s=Object(i.getTab)(e,t),r="";switch(!0){case s.unread>0:r=s.unread;break;case Object(i.isTabMarkedUnread)(s):r=1}val(n,r),toggleClass(a,"im-right-menu--unread",s.unread>0||Object(i.isTabMarkedUnread)(s))}},unmount(){Object(p.destroyModule)(n),a.unmount()}}}function cc(e,t,a){1===a.which&&(e.get().peer&&e.get().longpoll.push([Object(h.resetPeer)()]),e.get().longpoll.push([Object(h.changeTab)(t)]),cancelEvent(a))}function dc(e,t,a){var n=G(e,Object(C.default)({limit:50,offset:0,noScroll:!0,elements:ic(t)}),()=>({idFn:e=>e.peer||"000",renderFn:sc.bind(null,t)})),i=rc.bind(null,t,n),s=Object(p.createModule)({handlers:(a,n)=>{n(e,"click","_im_r_cl",i),n(e,"click","_im_peer_tab",(e,a)=>{if(!checkEvent(e)){var n=intval(domData(a,"list-id"));Object(_.unpackStore)(t).longpoll.push([Object(h.changePeer)(n,!1,!0,!0)]),cancelEvent(e)}}),y.FOLDERS.forEach(n=>{a(geByClass1("_ui_item_"+n,e.parentNode),"mousedown",cc.bind(null,t,n))}),a(geByClass1("_im_contact_list_menu_item",e.parentNode),"click",()=>mo(t))}});return lc(e,0,n,s)}function uc(e){var t=e.get().tabs,a=e.get().peer,s=Object.keys(t).filter(t=>Object(i.isFullyLoadedTab)(e,t)&&intval(t)!==a).map(e=>t[e]);s.filter(e=>Date.now()-e.last_visited>54e6).forEach(t=>e.set(n.cleanTab.bind(null,t.peerId))),s.filter(t=>Object(i.isFullyLoadedTab)(e,t.peerId)&&"string"!=typeof t.history&&Date.now()-t.last_touched>72e5).forEach(t=>e.set(n.stringifyTab.bind(null,t.peerId)))}function gc(e){var t=setInterval(uc.bind(null,e),5e3);return{unmount(){clearInterval(t)}}}function mc(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return _c(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return _c(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _c(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function pc(e,t,a,s){if(!e.loading&&!e.all&&a.scrollTop+window.innerHeight-a.scrollHeight>-300){var r=geByClass1("_im_peer_history",t.bodyNode);e.loading=!0,Object(i.wrapLoading)(r)(Object(n.loadImportant)(e.offset).then(t=>{var a=mc(t,4),o=(a[0],a[1]),l=(a[2],a[3]);e.all=l.all,e.offset=l.offset,e.all?addClass(r,"im-important_all"):e.loading=!1,s.set(n.mergeTabs.bind(null,Object(i.tabFromIds)(l.msgs,l.hash)));var c=ce("div");c.innerHTML=o,r.appendChild(c),Object(i.ensureDomHasActions)(r)}),"bottom")}}function hc(e,t,a){for(var i=arguments.length,s=new Array(i>3?i-3:0),r=3;r<i;r++)s[r-3]=arguments[r];s.filter(e=>inArray(e.type,[h.SET_FLAGS,h.RESET_FLAGS,h.CHANGE_PEER])).forEach(i=>{if(i.type!==h.CHANGE_PEER){if(i.flags===h.FLAG_IMPORTANT){var s=i.type===h.SET_FLAGS;e.set(n.updateFavMessage.bind(null,[i.messageId],0,s)).then(a=>{t.markImportant(i.messageId,s,e)})}}else a.hide()})}function bc(e,t,a,n){var s=ge("box_layer_wrap"),r=t.get().longpoll,o=Object(C.default)({peer:0,longpoll:r,oCache:{},tabs:Object(i.tabFromIds)(n.msgs,n.hash)}),l=ns(e.bodyNode,o,()=>({})),c=O(e.bodyNode,t);Object(i.ensureDomHasActions)(e.bodyNode);var d=hc.bind(null,t,l,e);r.onData(d);var u=pc.bind(null,{all:!1,loading:n.all,offset:n.offset},e,s,o),g=Object(p.createModule)({handlers:(e,t)=>{e(s,"scroll",u)}});return{unmount(){Object(p.destroyModule)(g),c.unmount(),l.unmount(),r.offData(d)}}}function vc(e){return e.which||e.keyCode}function fc(e,t,a){!a||inArray(vc(a),y.UNPRINTABLE_KEYS)||Object(n.isSearchingInplace)(e.get().peer,e.get())||Object(i.isEditableFocused)()||a.ctrlKey||browser.mac&&a.metaKey||a.key&&1!==a.key.length||t.signal("printable",a)}function Oc(e,t,a){vc(a)===y.ENTER&&e.signal(vc(a),a)}function yc(e,t,a,n){var s=vc(n);if(!layers.visible){if(s>=49&&s<=57&&(n.ctrlKey||n.metaKey&&browser.mac)&&Object(i.isClassicInterface)(t))return function(e,t){var a=e.get().tabbedPeers[t];a&&e.get().longpoll.push([Object(h.changePeer)(a.peer,!1,!0,!0)])}(t,s-49),cancelEvent(n);inArray(s,y.UP_DOWN_CONTROLS)&&e.signal(s,n)}}function Cc(e,t){var a=browser.mozilla?"keydown":"keypress",n=Object(C.default)({signalTimer:!1}),i=fc.bind(null,e,t),s=yc.bind(null,t,e,n),r=Oc.bind(null,t,n),o=Object(p.createModule)({handlers:(e,t)=>{e(document,"keydown",s),e(document,"keyup",r),e(document,a,i)}});return{unmount(){Object(p.destroyModule)(o)}}}function jc(e,t){return-1===(e?e.indexOf(t):0)&&(e.push(t),!0)}function Sc(e,t){var a=e?e.indexOf(t):-1;return-1!==a&&(e.splice(a,1),!0)}function Ec(e,t,a,r,o,l){var c=Object(s.getTab)(e,t);switch(a){case h.MAIL_CHAT_UPDATE_TYPE_ADMIN_GRANTED:case h.MAIL_CHAT_UPDATE_TYPE_ADMIN_KICKED:return a===h.MAIL_CHAT_UPDATE_TYPE_ADMIN_GRANTED?jc(c.adminIds,r):Sc(c.adminIds,r),e.set(e=>Object(n.setCallAvailability)(t,e)).then(()=>{wc(e,t,o),Tc(e,t,o,l)}),!0;case h.MAIL_CHAT_UPDATE_TYPE_FLAGS_CHANGED:return c.data.flags=r,e.set(e=>Object(n.setCallAvailability)(t,e)).then(()=>{wc(e,t,o),Tc(e,t,o,l)}),!0;case h.MAIL_CHAT_UPDATE_TYPE_PINNED:delete c.pinHideId,cur.imDb.update(Cs.PIN_HIDDEN_ID_OP,[c.peerId,void 0]);var d=c&&c.pinned&&Object(i.parserMessage)(c.pinned).messageId;return o.removeUnpinnedMessageEditable(e,d),!1;case h.MAIL_CHAT_UPDATE_TYPE_USER_JOINED:var u=r===vk.id;return function(e,t,a){if(Object(i.isTabLoaded)(a.get(),e)){var r=Object(s.getTab)(a,e);jc(r.memberIds,t)&&r.membersCount++,-1===r.data.active.indexOf(t)&&r.data.active.push(t),t===vk.id&&(r.data.kicked=0,r.data.closed=0)}return a.set(a=>Object(n.loadChatMember)({[e]:[t]},a))}(t,r,e).then(()=>{if(u&&e.get().peer===t)return e.set(e=>Object(n.getPinnedMessage)(t,e))}).then(()=>Tc(e,t,o,l)).then(()=>{if(u&&e.get().peer===t)return Promise.all([e.set(e=>Object(n.getPeerActiveCallData)(t,e)),e.set(e=>Object(n.loadKeyboard)(t,e))])}).then(()=>(e.get().peer===t&&c.callInProgress&&(o.updateBanner(e),o.updateHeader(e)),o.fixKeyboard())),!0;case h.MAIL_CHAT_UPDATE_TYPE_USER_LEFT:case h.MAIL_CHAT_UPDATE_TYPE_USER_KICKED:return function(e,t,a,r,o){if(Object(i.isTabLoaded)(r.get(),e)){var l=Object(s.getTab)(r,e);Sc(l.memberIds,t)&&l.membersCount--,l.data.active=l.data.active.filter(e=>e!==t),t===vk.id&&(a?l.data.kicked=1:l.data.closed=1,r.set(t=>Object(n.removePeerActiveCallData)(e,t)))}return t===vk.id&&r.get().peer===e?(o.cancelEditing(),r.set(t=>Object(n.unpinMessageOptimistic)(e,t))):Promise.resolve()}(t,r,a===h.MAIL_CHAT_UPDATE_TYPE_USER_KICKED,e,o).then(()=>Tc(e,t,o,l)),e.get().id!==r&&(Object(s.getKeyboard)(e,t)||{}).author_id!==r||e.set(e=>Object(n.deleteKeyboard)(t,e)).then(()=>o.fixKeyboard()),!0;case h.MAIL_CHAT_UPDATE_TYPE_BANNER_CHANGED:return e.set(e=>Object(n.loadBanner)(t,e)).then(()=>o.updateBanner(e)),!0;case h.MAIL_CHAT_UPDATE_TYPE_KEYBOARD_CHANGED:case h.MAIL_CHAT_UPDATE_TYPE_MESSAGE_REQUEST_CHANGED:return!0;case h.MAIL_CHAT_UPDATE_TYPE_CALL_IN_PROGRESS_CHANGED:var g=r?e=>Object(n.getPeerActiveCallData)(t,e):e=>Object(n.removePeerActiveCallData)(t,e);return e.set(g).then(()=>{e.get().peer===t&&(o.updateBanner(e),o.updateHeader(e)),l.updateDialog(t,e)}),!0;default:return!1}}function wc(e,t,a){e.get().peer===t&&(Object(n.setActions)(e.get()),a.updateActions(e))}function Tc(e,t,a,i){e.get().peer===t&&(Object(n.setActions)(e.get()),a.updateChat(e,t),i.updateDialog(t,e))}var Ic=a("gF8j"),Mc=a("ambf");function Ac(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return Lc(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Lc(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Lc(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function kc(e,t,a,r,o){var l=o.reduce((e,t)=>(e[t.peerId]||(e[t.peerId]=[]),e[t.peerId].push(t.messageId),e),{});Object.keys(l).forEach(o=>{var c=l[o],d=Object(s.getTab)(e,o),u=d&&!d.offset,g=d&&d.inplaceSearch&&!!d.searchOffset;e.set(n.removeMessages.bind(null,c,o)).then(()=>e.set(n.removeMessagesMarkDeleted.bind(null,c,o))).then(()=>{if(e.get().peer===+o&&Object(i.isFullyLoadedTab)(e.get(),o)){var a=Object(s.getTab)(e,o);t.removeMessages(c,+o,e);var r=a.inplaceSearch;if(!a.offset&&!u&&(Object(n.setActions)(e.get()),t.updateActions(e),r||t.showEmptyScreen()),r&&g&&!a.searchOffset&&(t.showSearchResults(),browser.safari)){var l=geByClass1("_im_peer_history_w");l.style.display="none",setTimeout(()=>l.style.display="",0)}}}).then(()=>{var i=Object(s.getTab)(e,o),l=i&&c.some(e=>e>=i.lastmsg),d=i&&c.filter(e=>e>i.in_up_to);l?Object(n.loadActualLastMessage)(e,+o).then(()=>{a.promoteDialog(e,o),r&&r.updateCounter(e,o),t.updateGoToEnd(e,!0),t.updateGoToMention(e,!0)}):d&&Object(n.removeUnreadDeletedMsgsFromTab)(o,d,e.get()).then(()=>a.updateDialog(o,e))})})}function Pc(e,t){"spam"===t?Object(i.showSpamLayer)(e,Ro,{}):"fav"===t&&Object(i.showFavvedBox)(e,{},bc,{})}function Nc(e,t,a,s,r){e.forEach(e=>{switch(e.kludges.source_act){case i.CHAT_PHOTO_REMOVE:case i.CHAT_PHOTO_UPDATE:!function(e,t,a,i){t.set(n.updateChatPhoto.bind(null,e)).then(()=>{var n=e.kludges.source_act;a.updateDialog(e.peerId,t),i.updateChatPhoto(e,n,t)})}(e,t,a,s)}})}function Dc(e,t){var a=e.get().longpoll.push.bind(null,[h.resetPeer()]),n=()=>{var i=e.get().selectedMessages;i&&i.length?(e.setState({selectedMessages:[]}).then(()=>{t.changedMessageSelection(e),t.cleanSelection(i)}),setTimeout(()=>cancelStackPush("im_peer",n),0)):a()};cancelStackPush("im_peer",n)}function xc(e){var t=e.attaches.filter(e=>"sticker"!==e.type&&"call"!==e.type);return Object(r.isServiceMsg)(e)||0===t.length}function Bc(e,t,a){addClass(a,"im-page_history-show"),t.loadingPeer(e)}function Rc(e,t){var a=function(e,t){var a=document.querySelector("._im_aside_notice"),n=Object(i.isCommunityInterface)(e)?236:120;return n+=10,n+=a?a.offsetHeight:0,Math.floor((t.offsetHeight-n)/32)}(e,t);if(e.get().tabbedPeers.length>a){var s=e.get().tabbedPeers.filter(t=>{var a=t.peer;return intval(a)!==e.get().peer}).map(t=>{var a=t.peer;return e.get().tabs[a]}).sort((e,t)=>t.last_touched-e.last_touched),r=[];0!==e.get().peer&&r.push(e.get().tabs[e.get().peer]);var o=r.concat(s).slice(a).map(e=>e.peerId),l=e.get().tabbedPeers.filter(e=>!inArray(e.peer,o));return e.set(n.updateTabbedPeers.bind(null,l,!0))}return Promise.resolve(e)}function Fc(){for(var e=curBox();e;)e.hide(),e=curBox()}function Hc(e,t,a,r,o,l,c,d,u){e.get().audio_msg.isRecording&&e.set(n.cancelRecording).then(()=>{r.cancelRecording()}),AudioMessagePlayer.detachPlayer(),Object(s.isAnyMessageBeingEdited)(e)&&r.cancelEditing(),Object(s.isSearching)(e)&&t.cancelSearch&&(o.clearSearch(e),a.restoreDialogs(e),u().toggleSettingsButton(e,!1)),Uc(e,d,u),Bc(e,r,l);var g=e.get().peer;Object(n.updateMentions)(e.get()),Object(n.videoAutoPlayHandler)(),Object(i.isFullyLoadedTab)(e,t.peerId)&&(t.msgid&&!Object(s.getMessage)(e,t.peerId,t.msgid)||!t.msgid&&!Object(s.getMessage)(e,t.peerId,Object(s.getTab)(e,t.peerId).lastmsg)||Object(s.getTab)(e,t.peerId).skipped)&&e.mutate(e=>Object(s.makeTabNotFullyLoaded)(e,t.peerId));var m=e.set(n.changePeer.bind(null,t.peerId,t.msgid,t.entryPoint)).then(e=>{var a=e.get(),i=n.loadPeer.bind(null,t.peerId,!1,t.msgid,!1,a);return a.tabs[t.peerId]?Promise.resolve(a):e.set(i)}).then(()=>{a.selectPeer(t.msgid,e),function(e,t){Object(i.isPendingForward)(e)&&(cancelStackFilter("forward"),e.set(n.forwardMessages.bind(null,e.get().pendingForward,Object(s.getTabDraft)(Object(s.getTab)(e,t)),!1)))}(e,e.get().peer),window.tooltips&&tooltips.hideAll(),Fc(),r.preparePeer(e),Dc(e,r),Object(i.isClassicInterface)(e)&&(a.deactivate(),Rc(e,l).then(()=>c.updateMenu(e)),Object(i.updateMessageRequestsCounterInDOM)(e))});return(m=t.msgid?m.then(()=>e.set(n.selectPeerOnMessage.bind(null,t.peerId===g,g))):m.then(()=>e.set(n.selectPeer.bind(null,!0)))).then(()=>e.set(n.prepareCasperMessagesFromMessages.bind(null,t.peerId))).then(()=>{if(e.get().peer===t.peerId){if(t.forward){var a=e.get().tabs[e.get().peer];!a.scrollBottom&&a.unread?e.set(n.readLastMessages.bind(null,e.get().peer)).then(()=>e.set(n.setActions)).then(()=>r.updateActions(e)):!a.unread&&Object(s.isTabMarkedUnread)(a)&&e.set(e=>Object(n.markDialogRead)(t.peerId,e))}Object(i.isClassicInterface)(e)&&c.updateMenu(e),r.changePeer(e,!1),r.updateTyping(t.peerId,e),r.removeExpiredFailedMessages(t.peerId),Object(n.updateMentions)(e.get())}}).catch(e=>Object(xl.imWeirdCatch)("applyNewPeer",e))}function Uc(e,t,a){t&&e.get().shown&&(t.hide(e),a().createCanceled(e))}function Gc(e,t,a){Object(s.isSearching)(e)&&(t.clearSearch(e),a.restoreDialogs(e))}function qc(e,t,a,s,r,o,l){Object(i.isClassicInterface)(e)&&(r.saveScroll(e),o.saveScroll(e)),s.showCancelControl(),addClass(l,"im-page_creating"),e.setState({isCreating:!0}),a&&a.show(e,t),Object(i.isClassicInterface)(e)&&(setStyle(l,{height:Xc(l,e).page}),setTimeout((function(){addClass(l,"im-page_cropped")}),200)),Object(n.toggleConversation)(!0)}function Wc(e,t,a,n){Object(i.isTabLoaded)(e.get(),n)&&(t.updateTyping(n,e),a.updateTyping(n,e))}function Kc(e,t,a,s,r){s.activityType||(s.activityType=r);var o=e=>Wc(e,t,a,s.peerId);Object(i.isSelfMessage)(s.peerId,e.get().gid)||(e.set(n.setActivity.bind(null,s,r)).then(o),e.set(n.waitActivity.bind(null,s,r)).then(o))}function Vc(e,t){t?e.classList.add("im-page_reconnecting"):e.classList.remove("im-page_reconnecting")}function Yc(e,t,a){var i=null;if(a.kludges.keyboard&&!a.kludges.keyboard.inline){var o=Object.assign(a.kludges.keyboard,{author_id:a.userId});i=e.set(n.setKeyboard.bind(null,a.peerId,o))}else{var l=Object(s.getKeyboard)(e,a.peerId);l&&l.one_time&&l.author_id!==Object(r.getAuthorId)(e,a)&&(i=e.set(n.deleteKeyboard.bind(null,a.peerId)))}a.peerId===Object(s.getPeer)(e)&&i&&i.then(t.fixKeyboard)}function zc(e,t,a,o,l,c,d,u,g,m,_,b,v,f,O,C,j,S,E,w,T){var I=!1;return{changePeer(e,a){t.selectPeer(e,a)},cancelSearch(e){Gc(e,o,t)},loadingPeer(e){Bc(e,a,l)},restoreDialogs(e,a,n){t.restoreDialogs(e,a,n)},toggleSettingsButton(e,t){_.toggleButton(e,t)},focusSearch(e){o.focusInput()},appendSearch(e,a,n,i){t.appendSearch(e,a,n,i)},appendDialogs(e,a){t.appendDialogs(e,a)},showCreation(e,n){qc(e,n,m,o,t,a,l)},updateState(e,n){t.updateDialog(e,n),n.get().peer===e&&a.updateChat(n,e)},appendFastDialogs(e,a){t.appendFastDialogs(e,a,!0)},createCanceled(e){o.hideCancelControl(),Object(i.isClassicInterface)(e)?(setStyle(l,{height:"auto"}),removeClass(l,"im-page_cropped"),setTimeout(()=>o.focusInput(),0),0===e.get().peer?t.restoreScroll(e):a.restoreScroll(e,e.get().peer)):setTimeout(()=>{0===e.get().peer?o.focusInput():a.focustTxt(e)},0),removeClass(l,"im-page_creating"),e.setState({isCreating:!1})},updateMenu(e){C&&C.updateMenu(e)},goToHistoryEnd(){a.goToEnd()},updateDialog(e,a){t.updateDialog(e,a)},focusTxt(e){a.focustTxt(e)},resync(e){Object(s.isSearching)(e)&&o.clearSearch(e),t.restoreDialogs(e,!0,!0).then(()=>{Object(i.isClassicInterface)(e)||t.focusOnSelected(e)}),m&&m.hide(e),Object(i.isCommunityInterface)(e)&&e.get().tabbedPeers.forEach(t=>{var a=t.peer;C.updateCounter(e,a)}),Object(i.isClassicInterface)(e)&&(e.get().tabbedPeers.forEach(t=>{var a=t.peer;C.updateCounter(e,a),C.updateName(a,e)}),Object(i.updateMessageRequestsCounterInDOM)(e)),a.cleanSelection(e.get().selectedMessages||[]),a.cancelSearch(e,!0),Object(i.isReservedPeer)(e.get().peer)||a.changePeer(e,!1);var n=e.get().gid?"l_mgid"+e.get().gid:"msg";handlePageCount(n,e.get().unread_cnt)},toggleSettingsLoader(e,t){_.toggleLoader(e,t)},onUserActions(e,t){if(!Object(n.isSearchingInplace)(e.get().peer,e.get())){var r=e.get(),o=r.peer;if(Object(i.isFullyLoadedTab)(r,o))if(!c.is_idle)if(Object(s.countUnread)(e.get().peer,e.get())>0)!r.tabs[o].skipped&&a.isNewMessagesVisible(e)&&(a.hideGoToEnd(!0),a.hideGoToMention(!0),e.set(n.readLastMessages.bind(null,o)).then(()=>e.set(n.setActions)).then(()=>a.updateActions(e)))}},removeSelection(e){t.removeSelection(e),o.focusInput()},route(e,s,r,c){if(void 0!==e[0])return!0;e.box&&(e={box:e.box});var d=!1;return!!(e.mr||e.invite_chat_id&&r.invite_hash)||(c&&c.params&&"left_nav"===c.params._ref&&void 0===e.sel&&t.scrollUp(!0,!0),Object.keys(e).sort().forEach(e=>{switch(e){case"sel":r.q||(d=!0);var u=r.sel?Object(i.unUrlPeer)(r.sel):0,_=c.back;0===u?b.get().longpoll.push([h.resetPeer(!1,_)]):u!==b.get().peer&&b.get().longpoll.push([h.changePeer(u,r.msgid||!1)]);break;case"invite_chat_id":case"invite_hash":!function(e){e.set(n.leaveInvitation).then(()=>{e.get().longpoll.push([h.resetPeer(!1,!1)])})}(b);break;case"tab":Uc(b,m,g),d=!0;var p=r.tab||y.FOLDER_ALL;b.get().longpoll.push([h.changeTab(p)]);break;case"act":r.act&&"create"===r.act?qc(b,[],m,o,t,a,l):function(e,t,a,n){a&&a.hide(e,t)}(b,[],m);break;case"st":r.st&&r.sel?(curBox()&&curBox().hide(),b.mutate(n.setInplaceSearch.bind(null,unescape(r.st),r.sel)),a.startSearch(b)):(b.mutate(n.cancelSearch.bind(null,s.sel)),a.cancelSearch(b,!0));break;case"q":r.q?(curBox()&&curBox().hide(),o.setSearch(b,r.q,!0)):o.clearSearch(b);break;case"box":Pc(b,r.box)}}),r.msgid&&(b.get().msgid=r.msgid,a.focusOnMessage()),Object(i.isClassicInterface)(b)&&void 0===e.sel&&C.updateMenu(b),d&&Gc(b,o,t),!1)},updateDialogFilters(e){Object(s.isSearching)(e)||t.restoreDialogs(e),_.updateFilter(e)},removePeer(e,a){t.removeDialog(e,a),t.saveScroll(e),e.get().peer===a&&e.get().longpoll.push([h.resetPeer()]),Object(i.isClassicInterface)(e)&&C.updateMenu(e)},newMessage(e){Object(i.isClassicInterface)(e)||t.scrollUp(!0)},onQueueEvent(e,s){switch(s.entity_type){case Il.Online:e.set(e=>Object(n.updateOnline)(s.data.user_id,!!s.data.online&&s.data.platform,s.data.last_seen,e)).then(e=>{Object(i.isTabLoaded)(e.get(),s.data.user_id)&&(t.updateOnline(s.data.user_id,e),a.updateOnline(s.data.user_id,e))})}},onEvents(e,p){var b=function(e){for(var t=!1,a=e.length-1;a>=0;a--)e[a].type!==h.UNREAD_COUNT||t?e[a].type===h.UNREAD_COUNT&&e.splice(a,1):t=!0;return e}(p.filter(e=>e.type!==h.ADD_MESSAGE||!(e.flags&h.FLAG_STEALTH))),f=p.filter(r.isServiceMsg),O=p.filter(e=>e.type===h.ADD_MESSAGE);Nc(f,e,t,a);var j=Object(n.checkNewPeople)(f,O,e),S=Promise.resolve();j.shouldLoad&&(S=e.set(n.loadNewPeople.bind(null,j,d))),S.then(()=>{b.forEach(d=>{switch(d.type){case h.ADD_MESSAGE:var p=Object(s.getTab)(e,d.peerId),b=!p||!p.msgs||0===p.msgs.length,f=Object(i.getMessageStoreStatus)(d,e.get()),O=Object(s.isCommunityBlocked)(e,d.peerId),j=p&&!p.offset;switch(Yc(e,a,d),Object(r.isCasperMessage)(d)&&Mc.casperMessagesStore.add(d),f){case i.MSG_NEW:e.set(n.addMessage.bind(null,d)),Rc(e,l),function(e,t){var a=e.get().tabs[t.peerId],i=e.get().active_tab;return i===y.FOLDER_ALL||Object(n.filterFromTab)(i)(a)}(e,d)&&(Object(s.tabIsMessageRequest)(p)||(d.flags&h.FLAG_OUTBOUND||e.set(n.updateFavAndTitle.bind(null,d.peerId,!0)),function(e,t){var a=t.flags&h.FLAG_OUTBOUND,n=inArray(t.peerId,e.get().mutedPeers),s=t.flags&h.FLAG_DELETED,r=e.get().gid;if(!a&&!n&&!s){var o,l,c=function(e,t){return t<2e9&&e&&!e.match(/^\s*(Re(\(\d*\))?\:)?\s*\.\.\.\s*$/)}(t.subject,t.peerId)||"",d=(c?c+" ":"")+t.text||"",u=t.userId,g=t.peerId,m=e.get().tabs[g];if(t.kludges&&t.kludges.source_act&&(d=stripHTML(Object(i.renderServiceMsg)(e,t,m,!1))),(!e.get().notify_msg&&!Object(i.isChatPeer)(g)||r&&!e.get().mute)&&window.Notifier&&Notifier.playSound({author_id:g}),!Object(i.isChatPeer)(g))return;d=trim(replaceEntities(stripHTML(d.replace(/<br>/g,"\n").replace(/<\*>.*$/,"")))),d=Object(js.replaceMentions)(d,(e,t,a,n,i)=>i),Object(i.isChatPeer)(g)?(o=Object(W.oCacheGet)(e,u).name,m.tab&&(o+=" » "+m.tab),l=Object(W.oCacheGet)(e,u).photo):(o=m.tab,l=m.photo);var _=t.attaches[0];if(_&&"mail"===_.type)d+="\n["+getLang("mail_added_msgs")+"]";else if(_){var p="doc"===_.type&&"graffiti"===_.kind?"graffiti":_.type;d+="\n["+getLang("mail_added_"+p)+"]"}o=trim(replaceEntities(stripHTML((o||"").replace("&nbsp;"," ")))),window.Notifier&&Notifier.proxyIm({id:t.messageId,text:d,author_id:g,title:o,author_photo:l})}}(e,d)),t.updateTyping(d.peerId,e),Object(s.isSearching)(e)?t.updateDialog(d.peerId,e):t.promoteDialog(e,d.peerId));var S=Object(s.isCommunityBlocked)(e,d.peerId),E=p&&!p.offset;(O&&!S||j&&!E)&&a.updateActions(e),Object(i.isClassicInterface)(e)?(C.updateCounter(e,d.peerId),C.updateMenu(e)):_.updateFilter(e),e.set(n.updateActivity.bind(null,d)).then(Wc.bind(null,e,a,t,d.peerId)),a.addMessage(e,d),xc(d)||!Object(i.isFullyLoadedTab)(e,d.peerId)||d.local||e.set(n.loadMedia.bind(null,d)).then(e=>{a.replaceAttachmentPlaceholders(e,d),Object(n.videoAutoPlayHandler)()}),Object(qe.statlogsSendingTimeStart)(e,d,"send","opt_to_lp");break;case i.MSG_LOCAL_DUPLICATE:xc(d)||e.set(n.loadMedia.bind(null,d)).then(e=>{a.replaceAttachmentPlaceholders(e,d)}),e.set(n.replaceMessage.bind(null,d)),a.replaceMessageAttrs(d,e),t.updateDialog(d.peerId,e),d.randomId&&Object(qe.statlogsSendingTimeEnd)(e,d,"send","opt_to_lp");break;case i.MSG_DUPLICATE:Object(s.isSearching)(e)||t.promoteDialog(e,d.peerId)}Object(s.tabIsMessageRequest)(p)&&Object(i.checkMessageRequestsTab)(e,t.update),p&&b&&p.peerId===Object(s.getPeer)(e)&&w();break;case h.EDIT_MESSAGE:case h.REPLACE_MESSAGE:e.set(n.editMessage.bind(null,d)).then(e=>{if(Yc(e,a,d),d.kludges.is_expired)return Object(i.removeExpiredMessageIfNeed)(d,a.handleMessageExpiration),void t.updateDialog(d.peerId,e);t.updateDialog(d.peerId,e),a.updateTyping(d.peerId,e),a.editMessage(e,d),xc(d)||!Object(i.isFullyLoadedTab)(e,d.peerId)||d.local||e.set(n.loadMedia.bind(null,d)).then(e=>a.replaceAttachmentPlaceholders(e,d))});break;case h.INVALIDATE_MESSAGE:Object(n.reloadMessage)(d.messageId,e.get()).then(t=>{var a=h.addMessageEvent([4].concat(t));return e.set(e=>Object(n.editMessage)(a,e)).then(()=>a)}).then(s=>{a.editMessage(e,s),t.updateDialog(s.peerId,e),!xc(s)&&Object(i.isFullyLoadedTab)(e,s.peerId)&&e.set(e=>Object(n.loadMedia)(s,e)).then(e=>a.replaceAttachmentPlaceholders(e,s))});break;case h.READ_INBOUND:e.set(n.markInboundMessagesAsRead.bind(null,d)).then(e=>{t.updateCounter(e,d.peerId),a.updateGoToEnd(e,!0),a.updateGoToMention(e,!0),a.updateObserver(),Object(i.isClassicInterface)(e)&&C.updateCounter(e,d.peerId),Object(s.isSearching)(e)||t.restoreDialogs(e),_.updateFilter(e)});break;case h.READ_OUTBOUND:e.set(n.markOutboundMessagesAsRead.bind(null,d)).then(e=>{t.updateCounter(e,d.peerId),a.markMessagesAsRead(e,d)});break;case h.UNREAD_COUNT:e.set(n.updateUnreadCount.bind(null,d.count)).then(()=>{var t=e.get().gid?"l_mgid"+e.get().gid:"msg";handlePageCount(t,d.count),_.updateFilter(e),Object(i.isClassicInterface)(e)&&e.get().tabbedPeers.forEach(t=>{var a=t.peer;C.updateCounter(e,a)})});break;case h.SET_FLAGS:case h.REPLACE_FLAGS:case h.RESET_FLAGS:if(!(d.flags&h.FLAG_DELETED||d.flags&h.FLAG_SPAM)||d.type!==h.SET_FLAGS||Object(i.isAlreadyDeleted)(e,d.peerId,d.messageId)||e.get().blockedFlagUpdates[d.peerId]||u(d),d.flags===h.FLAG_IMPORTANT){var T=d.type===h.SET_FLAGS;e.set(n.updateImportant.bind(null,T?1:-1,d.messageId)),e.set(n.updateFavMessage.bind(null,[d.messageId],d.peerId,T)).then(()=>{a.markImportant(d.messageId,T,e)})}break;case h.RECORDING_AUDIO:Kc(e,a,t,d,n.ACTIVITY_TYPE_RECORDING_AUDIO);break;case h.TYPING:Kc(e,a,t,d,n.ACTIVITY_TYPE_TYPING);break;case h.NOTIFY_SETTINGS_CHANGED:!function(e,t,a,i){e.set(n.setMutedPeer.bind(null,a,i)).then(t().updateState.bind(null,a))}(e,g,d.peerId,!d.sound);break;case h.RESYNC:e.get().longpoll.pause(),e.set(n.resync).then(g().resync).then(()=>e.get().longpoll.resume());break;case h.TRANSITION:v.transition(d.state);break;case h.RESET_PEER:if(d.removeActivePeer){var M=e.get().tabbedPeers.filter(t=>{var a=t.peer,n=t.type;return a!==e.get().peer&&"perm"===n});e.setState({tabbedPeers:M})}!function(e,t,a,r){e.set(n.cancelRecording).then(()=>{a.cancelRecording()}),AudioMessagePlayer.detachPlayer(),t.removeSelection(e),removeClass(r,"im-page_history-show"),t.updateStarPosition(),a.stopLoading(),a.destroyPeerProfile(),Object(s.isAnyMessageBeingEdited)(e)&&a.cancelEditing();var o=e.get().peer;e.set(n.changePeer.bind(null,0,!1,!1)).then(()=>{window.tooltips&&window.tooltips.hideAll(),Fc(),Object(i.isClassicInterface)(e)&&t.activate(),a.changePeer(e),Object(i.isClassicInterface)(e)&&t.restoreScroll(e),setTimeout(()=>{e.get().longpoll.push([h.transitionEvent("search")])},13),Object(i.isLocksAvailable)(e)&&Object(i.isPeerBlockedByMe)(o,e)&&e.set(n.releaseBlock.bind(null,o))})}(e,t,a,l),e.get().peerProfileTagsChanged?e.setState({peerProfileTagsChanged:!1}).then(()=>t.renderPeerTags(e)):t.renderPeerTags(e,e.get().prevPeer),d.cancelSearch&&Gc(e,o,t),Object(i.isClassicInterface)(e)&&C.updateMenu(e),o.focusInput();break;case h.CHANGE_TAB:Object(s.isSearching)(e)&&o.clearSearch(e),Object(i.changeTab)(d.tab,e,g,n.changeDialogsTab).then(e=>{_.updateFilter(e)});break;case h.RESET_DIRECTORIES:case h.SET_DIRECTORIES:case h.REPLACE_DIRECTORIES:var A=d.type,L=d.peerId,k=d.mask;if(k===h.FOLDER_HAS_BANNER)break;var P=k===h.FOLDER_AD_TAG;e.set(n.updateFolderState.bind(null,L,k,A,d.local,P)).then(e=>{Object(s.isSearching)(e)||A===h.RESET_DIRECTORIES&&k===y.FOLDER_MASKS[y.FOLDER_IMPORTANT]||A===h.RESET_DIRECTORIES&&k===y.FOLDER_MASKS[y.FOLDER_MESSAGE_REQUEST]||A===h.SET_DIRECTORIES&&k===y.FOLDER_MASKS[y.FOLDER_MESSAGE_REQUEST_REJECTED]||A===h.REPLACE_DIRECTORIES||t.restoreDialogs(e),t.updateDialog(L,e),Object(i.isClassicInterface)(e)&&C.updateCounter(e,L),e.get().peer===L&&a.changedMessageSelection(e)});break;case h.DELETE_DIALOG:e.set(n.deletedDialog.bind(null,d.peerId,Promise.resolve([]))).then(()=>{g().removePeer(e,d.peerId),g().updateDialogFilters(e)});break;case h.CHANGE_PEER:Hc(e,d,t,a,o,l,C,m,g);break;case h.MUTEX:var N={[d.peerId]:d},D=Object(i.isPeerBlocked)(d.peerId,e);e.set(n.updateBlockStates.bind(null,N)).then(()=>{t.updateDialog(d.peerId,e);var n=Object(i.isPeerBlocked)(d.peerId,e);Object(i.isFullyLoadedTab)(e.get(),d.peerId)&&D!==n&&a.updateChat(e,d.peerId)});break;case h.FAILED_MESSAGE:e.set(n.setMessageErrored.bind(null,d.peer,d.message)).then(()=>{a.setMessageErrored(d.peer,d.message,d.error,e),t.setDialogFailed(d.peer,d.message.messageId,e)});break;case h.RESEND:var x=d.message.messageId;e.set(n.resendMessage.bind(null,d.peerId,x,d.message)).then(()=>{a.resendMessage(d.peerId,x),t.promoteDialog(e,d.peerId)});break;case h.CONVERSATION_UPDATED:if(Object(s.isMessageRequestChangedEvent)(d)){var B=Promise.resolve(),R=Object(s.getCurrentTab)(e);switch(d.updateType){case h.MAIL_CHAT_UPDATE_TYPE_CONTACT_CONVERTED:R&&R.peerId===d.updateArg&&e.get().longpoll.push([h.changePeer(d.peerId)]),B=e.set(n.deletedDialog.bind(null,d.updateArg,Promise.resolve([]))).then(()=>{g().removePeer(e,d.updateArg),g().updateDialogFilters(e)});break;case h.MAIL_CHAT_UPDATE_TYPE_MESSAGE_REQUEST_CHANGED:B.then(()=>e.set(n.updateMessageRequestsCounter.bind(null,d))).then(()=>{Object(i.updateMessageRequestsCounterInDOM)(e),Object(i.checkMessageRequestsTab)(e,t.update),d.updateArg===h.MESSAGE_REQUEST_STATUS_ACCEPTED&&Object(i.isClassicInterface)(e)&&C.updateMenu(e)})}}else{if(Object(i.isTabLoaded)(e.get(),d.peerId))Ec(e,d.peerId,d.updateType,d.updateArg,a,t)||g().reloadChatInfo(d.peerId)}break;case h.WAITING_FOR_RECONNECT:setTimeout(()=>{Vc(l,!0),a.setNetworkWaitingStatus(d.timeout-1)},1e3);break;case h.RECONNECTING:Vc(l,!0),a.setNetworkReconnectingStatus();break;case h.RECONNECTED:Vc(l,!1),setTimeout(a.clearNetworkStatus,0),browser.chrome&&!Object(i.isClassicInterface)(e)&&e.get().peer&&(c.is_idle?I||(c.once("unidle",()=>{I=!1,t.forceScrollReinit()}),I=!0):t.forceScrollReinit())}})})},updateHistory:e=>a.updateHistory(e),reloadChatInfo(e){Object(i.isTabLoaded)(b.get(),e)&&b.set(n.loadChatInfo.bind(null,e)).then(()=>function(e,t,a,s,r){s.updateChatTopic(t,e),Object(i.isClassicInterface)(e)&&r.updateName(t,e),e.get().peer==t&&(Object(n.setActions)(e.get()),s.updateActions(e))}(b,e,0,a,C))},cancelRecording:()=>b.set(n.cancelRecording).then(()=>a.cancelRecording()),fixHeight(){w()},unmount(){Object(p.destroyModule)(e),clearInterval(b.get().update_title_to),c.stop(),Al.getInstance().unsubscribe(),T(),Mc.casperMessagesStore.destroy(),t.unmount();var s=window.devicePixelRatio>=2?"_2x":"";setFavIcon("/images/icons/favicons/fav_logo"+s+".ico"),a.unmount(),o.unmount(),cancelStackFilter("im_peer"),_.unmount(),m&&m.unmount(),C&&C.unmount(),j&&j(),f&&f(),Object(i.isLocksAvailable)(b)&&b.get().peer&&b.set(n.releaseBlock.bind(null,b.get().peer)),S.unmount(),C&&C.unmount(),E.unmount(),clearInterval(O),cur.imDb.unmount(),cur.imDb=!1}}}function $c(e,t,a,s){var r=t.get();Object(i.isReservedPeer)(r.peer)||e().onUserActions(t,s),r.update_old_title&&t.set(n.updateFavAndTitle.bind(null,!1,!1))}function Xc(e,t){var a=ge("page_header"),n=geByClass1("_im_page_history",e),s=window.clientHeight()-a.offsetHeight-30-2,r=Object(i.isClassicInterface)(t)?250:400,o={page:Math.max(s,r)};if(Object(i.isClassicInterface)(t)){var l=Object(i.getClassicChatHeight)();l=l>0?Math.min(l-a.offsetHeight-30-2,s):s;var c=hasClass(n,"im-page--history_empty-hist")?l:s;o.history=Math.max(l,r),o.chat=Math.max(c,r)}return o}function Qc(e,t,a,s,r){var o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],l=arguments.length>6&&void 0!==arguments[6]&&arguments[6];if(!Object(_.isFullScreen)()){var c=Xc(e,t);if(setStyle(e,{minHeight:c.page}),Object(i.isClassicInterface)(t)&&(void 0===t.get().chatResizeInitialized&&t.set(n.initializeChatResize),setStyle(e,{height:t.get().isCreating?c.page:"auto"}),setStyle(geByClass1("_im_page_dialogs",e),{minHeight:c.page,position:"static",top:0}),setStyle(geByClass1("_im_page_history",e),{minHeight:c.history,position:"relative",top:0}),setStyle(geByClass1("_im_chat_body_abs",e),{minHeight:c.chat,height:c.chat,position:"relative",top:0})),browser.safari&&l&&"function"==typeof l&&l(),s&&s.updateScroll(),r&&r.updateScroll(),a){var d=a.updateScroll();a.scrollFix(t,t.get().peer,d)}o&&setTimeout(()=>Qc(e,t,a,s,r,!1),100)}}function Jc(e,t){e.get().resendAllOnOnline&&t()}function Zc(){!function(e){var t="safari-repaint";e.forEach((function(e){hasClass(e,t)&&removeClass(e,t),addClass(e,t)})),setTimeout((function(){e.forEach((function(e){removeClass(e,t)}))}),100)}([geByClass1("_im_dialog_actions"),geByClass1("_im_chat_input_w"),ge("side_bar"),geByClass1("_im_right_menu"),geByClass1("_im_dialogs_settings"),geByClass1("_im_dialogs_search")])}function ed(e){var t,a,s,r=e.get();return Object(i.isLocksAvailable)(e)?(t=r.mutex_key,a=function(e){r.longpoll.push([h.mutexEvent(e)])},s=function(e,t){return Object(n.getMutexQueue)(r.gid).then(e=>Ac(e,1)[0])},Notifier.addKey(t,nc.bind(null,a,s,t)),Ql.set(t,{onData:a,onUpdateKey:s,ts:t.ts}),tc(),{stop:ac.bind(null,t)}).stop:null}function td(e,t){var a,r=t.get(),o=window.devicePixelRatio>=2?"_2x":"";setFavIcon("/images/icons/favicons/fav_im"+o+".ico"),Qc(e,t,!1,!1,!1,!0),Object(qe.statlogsBrowserNotificationsUser)();var l=Object(p.createMutations)(zc),c=l.callMutations,d=l.bindMutations,u=r.useFcLongpoll&&vk.lpConfig.enabled&&Notifier.getLpInstance&&Notifier.getLpInstance(),g=u?Notifier.getLpInstance():t.get().gid?function(e){Object(xl.imWeirdLog)("im_start_longpoll_group",{},!1);var t=Object(Dl.createLongpollEventsQueue)(e.ts,e=>{n.trigger("data",e)}),a=Object(Nl.createLongpoll)(e,t.onLp),n=new window.EventEmitter;return{onData:e=>n.on("data",e),offData:e=>n.off("data",e),push:e=>n.trigger("data",e),pause:t.pause.bind(t),resume:t.resume.bind(t),abortWaiting:a.abortWaiting.bind(a),onLp:t.onLp.bind(t),stop:a.stopConnection.bind(a),isEnabled:()=>!(!a||a.isStopped())}}(r.lpConfig):Xl(r);function m(){for(var e=arguments.length,a=new Array(e),n=0;n<e;n++)a[n]=arguments[n];c().onEvents(t,a)}g.onData(m),Al.getInstance().subscribe(e=>c().onQueueEvent(t,e)),u&&Object(xl.imWeirdLog)("im_use_fc_longpoll",{},!1);var h=geByClass1("_im_dialogs_search",e),b=geByClass1("_im_dialogs_settings",e),v=Ge(geByClass1("_im_page_dcontent",e),t,c,h);v.updateStarPosition(),v.renderPeerTags(t);var f,O,y=Eo(h,t,c),C=qo(b,t,c),S=gc(t);(cur.imDb=Object(Cs.mount)(t.get().gid?-t.get().gid:vk.id),t.set(n.preloadSearchIndex.bind(null,cur.imDb)),Object(i.isClassicInterface)(t)&&C.updateSettings(t),Object(i.isClassicInterface)(t))&&(f=dc(geByClass1("_im_ui_peers_list",e.parentNode),t),O=function(e,t,a,n){if(browser.mobile)return!1;var i=[t,a,geByClass1("_im_chat_input_w",n),geByClass1("_im_dialog_actions",n)],s=null,r=hasClass(e,"im-page--header_static"),o=ge("im-group-online-disabled-notice");function l(){var t=Object(j.getNativeOption)("scrollLeft"),a=hasClass(e,"im-page--header_static"),n=[];s!==t?n=i.slice().concat([e]):a!==r&&(n=[e]),s=t,r=a,n.length>0&&n.forEach(n=>{var i=e===n&&a?0:-t;setStyle(n,{[cssTransformProp]:0===i?"unset":"translateX("+i+"px)"})})}return o&&i.push(o),i=i.concat(geByClass("_im_aside_notice"),geByClass("_im_aside_promo_block")),addEvent(window,"scroll",l),l(),()=>{removeEvent(window,"scroll",l)}}(h,b,geByClass1("_im_right_menu",e.parentNode),e));Object(i.isClassicInterface)(t)&&r.peer&&v.deactivate(),r.gid||(a=Tl(geByClass1("_im_dialogs_creation",e),t,c));var E=Vr(geByClass1("_im_page_history",e),t,v,f,c),w=r.isCreating,T=w?"create":0===r.peer?"search":"default";w&&a.show(t,[]);var I=Pl(t,T,v,E,y,a),M=Cc(t,I);E.renderPeerProfile(t),E.updateScroll();var A=$c.bind(null,c,t,I);r.peer&&t.set(n.prepareCasperMessagesFromMessages.bind(null,r.peer)),Object(i.isReservedPeer)(r.peer)||setTimeout(()=>Dc(t,E),10);var L=new Ic.default({id:"im",element:document,focusElement:window,triggerEvents:"mouseover mousedown keypress"}),k=Object(Ln.debounce)(Zc,300),P=Qc.bind(null,e,t,E,v,a,!1,k),N=Jc.bind(null,t,E.resendAll);t.setState({longpoll:g}),t.set(n.setExecStack.bind(null,[])),L.on("unidle",(function(){g.abortWaiting(),A()})),L.start(),nav.objLoc.box&&(Pc(t,nav.objLoc.box),Object(ys.updateLocation)({box:null})),nav.objLoc.mr&&Object(i.isChatPeer)(Number(nav.objLoc.mr))&&v.showInvitationBox(t,nav.objLoc.mr);var D,x=ed(t);if(Object(i.isLocksAvailable)(t)&&(D=setInterval(i.blockLatencyCompensation.bind(null,t,r.longpoll),2e3)),t.get().invitation&&Object(i.showInvitationBox)(t,t.get().invitation,n.leaveInvitation),Object(i.isClassicInterface)(t)&&Object(s.existsIncomingMessageRequest)(t)){var B=document.getElementById("ui_rmenu_mr");B&&B.classList.remove("unshown")}var R=Object(_.throttleAccumulate)(kc.bind(null,t,E,v,f),200),F=i.hideTopNotice.bind(null,t),H=i.hideAsideNotice.bind(null,t);return Mc.casperMessagesStore.subscribe(e=>function(e,t,a,n,i){var r=i.type,o=i.message;switch(r){case Mc.EXPIRING:return t.updateCasperMessageStatus(o);case Mc.EXPIRING_SOON:return t.updateCasperMessageStatus(o,!0);case Mc.EXPIRED:Object(s.isCasperChat)(e,o.peerId)?n(o):(t.handleMessageExpiration(o),a.updateDialog(o.peerId,e))}}(t,E,v,R,e)),Mc.casperMessagesStore.setTimeshift(r.timeshift),d(Object(p.createModule)({handlers:(t,a)=>{t(document,"mousemove mousedown keypress",A),t(window,"resize",P),t(window,"online",N),a(e,"click",i.HIDE_TOP_NOTICE_CLASS,F),a(gpeByClass("_im-page-wrap",e),"click",i.HIDE_ASIDE_NOTICE_CLASS,H),a(gpeByClass("_im-page-wrap",e),"click",i.HIDE_ASIDE_PROMO_BLOCK_CLASS,i.hideAsidePromoBlock),a(gpeByClass("_im-page-wrap",e),"click",i.INSTALL_VKADMIN_LINK,i.installVKAdminApp),browser.safari&&t(document,"visibilitychange",Zc)}}),v,E,y,e,L,g,R,c,a,C,t,I,x,D,f,O,S,M,P,(function(){u?g.offData(m):g.stop()}))}var ad,nd;function id(e){var t=ge("page_header"),a=window.clientHeight()-t.offsetHeight-30-2;setStyle(e,{height:Math.max(a,400)})}function sd(e){var t=Object(i.formatTimespan)(Math.floor(Math.max(e,0)/1e3),!0);return t?getLang("mail_sick_timer").replace(/{timer}/gi,t):""}function rd(){nav.reload({force:!0})}function od(e){return{unmount(){clearInterval(nd),clearTimeout(ad),Object(p.destroyModule)(e)}}}function ld(e,t,a){id(e);var n,i,s=(0,Object(p.createMutations)(od).bindMutations)(Object(p.createModule)({handlers:(t,a)=>{t(e.querySelector("._im_sick_reload"),"click",rd),t(window,"resize",id.bind(null,e))}})),r=(n=localStorage.getItem("im_sick_timer"),i=n?Math.min(2*parseInt(n),6e5):5e3,localStorage.setItem("im_sick_timer",i),i),o=e.querySelector("._im_sick_timer"),l=+new Date;return o.innerHTML=sd(r),nd=setInterval(()=>{o.innerHTML=sd(l+r-new Date)},500),ad=setTimeout(rd,r),s}var cd=a("f4YT"),dd=a.n(cd),ud=function(){return(ud=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var i in t=arguments[a])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};window.IM={init:function(e){var t,a;if(window.imwl=e.imwl,Object(xl.startLoggingAllUnhandled)(),Object(Ss.addTemplates)(dd.a),window.cur.lang.dont_attach=Object(o.getLang)("mail_dont_add_media"),e.failed)return ld(Object(Es.geByClass1)("im-sick",Object(Es.ge)("page_body")));localStorage.removeItem("im_sick_timer"),window.cur.ctrl_submit=e.ctrl_submit,window.cur.module="im",window.cur.mutedPeers=e.mutedPeers,window.cur.gid=e.gid,window.cur.peer=e.peer,window.cur.options={blacklist_hash:e.thash};var s=-10800-60*(new Date).getTimezoneOffset(),r=e.timeshift,l=ud(ud({},e),{owners:void 0,tabbedPeers:(e.tabbedPeersArray||[]).map((function(e){return{peer:e,type:"perm"}})),blockedFlagUpdates:{},msgid:Object(Ss.intval)(window.nav.objLoc.msgid),timeshift:r-s,oCache:{},ref_id:window.nav.objLoc.ref,ref_source:window.nav.objLoc.ref_source}),c=Object(C.default)(l);null===(t=e.owners)||void 0===t||t.forEach((function(e){return Object(W.oCacheAdd)(c,e)})),Object(i.normalizeTabsGotFromServer)(c,c.get().tabs),window.cur.imClassicInterface=Object(i.isClassicInterface)(c);var d=td(Object(Es.geByClass1)("js-im-page",Object(Es.ge)("page_body")),c);Object(n.updateMentions)(c.get()),e.group_calls_feature_tt_hash&&Object(i.showGroupCallsOnboardingBox)(c.get(),e.group_calls_feature_tt_hash),window.IMBRIDGE={chatPhotoSaved:function(e){window.curBox()&&window.curBox().hide();var t=(e||{})[1];return t?(window.cur.pvShown&&window.layers.fullhide(!0,!0),"im"!=window.cur.module||c.get().peer!=t?window.nav.go("/im?sel=c"+(t-2e9)):void 0):window.nav.reload()},syncHistory:function(){c.set((function(e){return Object(n.syncHistory)(e)})).then((function(){}),(function(){}))},activateTab:function(e){c.get().gid||c.get().longpoll.push([Object(h.changePeer)(Object(Ss.intval)(e),!1,!1,!0)])}};var u=!1;window.cur.nav.push((function(){var e;return!!u||((null===(e=c.get().audio_msg)||void 0===e?void 0:e.isRecording)&&d.cancelRecording(),window.AudioMessagePlayer.detachPlayer(),d.route.apply(null,arguments))})),null===(a=window.cur.destroy)||void 0===a||a.push((function(){if(u)return!0;d.unmount(),window.IMBRIDGE=void 0,c.unmount(),window.store=void 0,u=!0,e=!1,c=!1,d=!1,Object(xl.stopLoggingAllUnhandled)()}))}};try{window.stManager.done("imn.js")}catch(e){}},ZVxX:function(e,t,a){"use strict";a.r(t),a.d(t,"initFailBack",(function(){return n}));a("VRzm"),a("Btvt");function n(){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||window.MediaDevices&&window.MediaDevices.getUserMedia;e&&!navigator.mediaDevices&&(navigator.mediaDevices=navigator.mediaDevices||{}),navigator.mediaDevices&&(navigator.mediaDevices.getUserMedia||(navigator.mediaDevices.getUserMedia=function(t){return new Promise((function(a,n){e?e.call(navigator,t,a,n):n(new Error("NotSupported"))}))}),navigator.mediaDevices.enumerateDevices||(navigator.mediaDevices.enumerateDevices=function(){return new Promise((function(e,t){if(MediaStreamTrack&&MediaStreamTrack.getSources){var a={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources((function(t){e(t.map((function(e){return{label:e.label,kind:a[e.kind],deviceId:e.id,groupId:""}})))}))}t(new Error("NotSupported"))}))})),window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext&&(window.AudioContext.prototype.createScriptProcessor=window.AudioContext.prototype.createScriptProcessor||window.AudioContext.prototype.createJavaScriptNode)}},ZoqV:function(e,t,a){"use strict";a.r(t),a.d(t,"mount",(function(){return pe}));var n=a("ofcU"),i=a("q1tI"),s=a("i8i4"),r=(a("HEwt"),a("a1Th"),a("rGqo"),a("rE2o"),a("ioFf"),a("OEbY"),a("VRzm"),a("Btvt"),a("P13b")),o=a("vT4u"),l=a("f01n"),c=a("6krn"),d=a("aong"),u=a("gqqU"),g=a("Ht+d"),m=(a("pIFo"),a("ZxpX")),_=a("dt/K"),p=a("WDXI"),h=a("Ya1X"),b=a("lJdi"),v=a("ERyv"),f=c.default.getLang;class O extends i.PureComponent{constructor(e){super(e),this.onSaveTitle=e=>{var t=this.props.store,a=t.get(),n=e.value.trim().replace("\n","");n&&n!==unclean(this.props.title)&&(this.setState({titleChanged:!1}),t.set(o.updateChatTopic.bind(null,a.peer,n)))},this.onChangeTitle=e=>{if(this.state.title!==e.target.value){var t=e.target.value.replace("\n","");this.setState({title:t,titleChanged:unclean(this.props.title)!==t})}},this.onValidateTitle=e=>!!e.trim().replace("\n",""),this.onCancelTitle=()=>{this.setState({title:unclean(this.props.title),titleChanged:!1})},this.onSaveDescription=e=>{},this.onPhotoUpload=()=>{var e=this.props.store,t=e.get().peer;Object(b.canChangeTitle)(e)&&(cur.recieveCropResult=void 0,Page.ownerPhoto(t,{gid:e.get().gid}))},this.onPhotoRemove=()=>{var e=this.props.store,t=e.get().peer;Object(b.canChangeTitle)(e)&&e.set(o.removeChatPhoto.bind(null,t)).then(()=>e.set(o.getChatDetails.bind(null,t))).catch(e=>Object(v.imWeirdCatch)("onPhotoRemove",e))},this.state={title:unclean(e.title),titleChanged:!1}}getCasperInfo(){var e=f("mail_casper_chat_info");return i.createElement(i.Fragment,null,f("mail_casper_chat_label"),i.createElement(_.default,{text:e,position:"t",appearance:"light",maxWidth:280,marginTop:-6},i.createElement(h.default,{"aria-label":e,className:"ChatSettingsInfo__casperHint"})))}render(){var e=this.props,t=e.store,a=e.photo,n=e.title,s=e.description,r=e.grid,o=e.meta,l=e.isDefaultPhotoOwner,c=void 0!==l&&l,d=e.isCasper,u=void 0!==d&&d,g=unclean(n),h=Object(b.canChangeTitle)(t),v=Object(m.classNames)("ChatSettingsInfo",{"ChatSettingsInfo--editable":h}),O=Object(m.classNames)("ChatSettingsInfo__title",{"ChatSettingsInfo__title-service":64&this.props.flags});return i.createElement("div",{className:v},i.createElement("header",{className:"ChatSettingsInfo__header"},i.createElement("div",{className:"ChatSettingsInfo__photo"},i.createElement("div",{className:"ChatSettingsInfo__attach nim-peer nim-peer_larger","data-tip":f("mail_settings_photo"),onClick:this.onPhotoUpload},a?i.createElement("img",{src:a,width:"80",height:"80",alt:g,className:"ChatSettingsInfo__photoSelf"}):i.createElement("div",{className:"nim-peer--photo-w"},i.createElement("div",{className:"ChatSettingsInfo__photoGrid nim-peer--photo",dangerouslySetInnerHTML:{__html:r}}))),a&&h&&!c&&i.createElement(_.default,{text:f("mail_settings_remove_photo"),position:"t",align:"left"},i.createElement("button",{onClick:this.onPhotoRemove,className:"ChatSettingsInfo__photoRemove"}))),i.createElement("h3",{className:O},h?i.createElement(p.default,{value:this.state.title,changed:this.state.titleChanged,useEnter:!0,onSave:this.onSaveTitle,onChange:this.onChangeTitle,onCancel:this.onCancelTitle,validate:this.onValidateTitle}):g),i.createElement("div",{className:"ChatSettingsInfo__meta"},i.createElement("span",{className:"ChatSettingsInfo__metaItem"},o),u&&i.createElement("span",{className:"ChatSettingsInfo__metaItem"},this.getCasperInfo()))),s&&i.createElement("div",{className:"ChatSettingsInfo__description"},h?i.createElement(p.default,{value:s,onSave:this.onSaveDescription}):s))}}a("KKXr");var y=a("dLHM"),C=a("XTb9"),j=a("BN/X"),S=a("giDR"),E=c.default.getLang;class w extends i.Component{constructor(e){super(e),this.onCopy=()=>{this.input&&(elfocus(this.input,0,this.input.value.length),document.execCommand("copy"),this.setState({copied:!0}))},this.onBlinkTextHide=()=>{this.setState({copied:!1})},this.getInputRef=e=>{e&&e.element&&(this.input=e.element)},this.state={copied:!1}}componentDidMount(){this.input&&elfocus(this.input,0,this.input.value.length)}render(){var e=this.props,t=e.onReset,a=e.invitationLinks,n=e.store,s=E("mail_invite_link_reset_explainer").split("{reset_link}"),o=!Object(r.isFvkcomgroup)(n,n.get().peer),l=a.linkWithHistory,c=a.linkWithoutHistory,d=this.props.isInvitationLinkWithHistory?l:c;return i.createElement("div",{className:"ChatSettingsInvitationLink"},this.props.reseted&&i.createElement("div",{className:"ChatSettingsInvitationLink__reseted"},E("mail_invite_link_reseted_explainer")),i.createElement("p",null,E("mail_invite_link_explainer")),i.createElement("div",{className:"ChatSettingsInvitationLink__switch"},i.createElement(S.default,{children:E("mail_im_chat_add_members_show_history"),checked:this.props.isInvitationLinkWithHistory,onChange:this.props.onLinkHistoryOptionToggle})),i.createElement("div",{className:"ChatSettingsInvitationLink__main"},i.createElement(y.default,{ref:this.getInputRef,readOnly:"readonly",className:"ChatSettingsInvitationLink__input",value:d}),i.createElement(g.default,{onClick:this.onCopy},E("mail_get_invite_link_copy")),i.createElement(C.default,{className:"ChatSettingsInvitationLink__copied",shown:this.state.copied,callback:this.onBlinkTextHide},E("mail_invite_link_copied"))),o&&i.createElement("p",null,s[0],i.createElement(j.default,{className:"ChatSettingsInvitationLink__reset",onClick:t},E("mail_invite_reset_link")),s[1]))}}var T=a("oziD"),I=a("hIV1"),M=c.default.getLang;class A extends i.Component{constructor(e){super(e),this.onConfirm=()=>{this.state.loading||(this.setState({loading:!0}),this.props.onConfirm().then(()=>{this.setState({loading:!1}),this.props.onCancel()}).catch(()=>this.setState({loading:!1})))},this.state={}}render(){return i.createElement("div",{className:"ChatSettingsResetInvitationLink"},i.createElement("div",{className:"ChatSettingsResetInvitationLink__text",dangerouslySetInnerHTML:{__html:M("mail_chat_reset_link_warning")}}),i.createElement(I.default,{alignment:"right"},i.createElement(g.default,{appearance:"tertiary",onClick:this.props.onCancel},M("global_cancel")),i.createElement(T.default,{onClick:this.onConfirm,loading:this.state.loading},M("mail_chat_reset_link_confirm"))))}}a("91GP");var L=a("enZq"),k=a("xGYt"),P=a("NsuH"),N=a("aFGQ"),D=a("+tmx"),x=a("/cSr"),B=a("rHUl"),R=c.default.getLang,F=()=>[{label:R("mail_settings_time_one_hour"),value:D.HOUR},{label:R("mail_settings_time_eight_hours"),value:8*D.HOUR},{label:R("mail_settings_time_day"),value:D.DAY},{label:R("mail_settings_time_week"),value:D.WEEK},{label:R("mail_settings_time_forever"),value:-1}];class H extends i.Component{constructor(e){super(e),this.onCopyInviteLink=e=>{this.input&&(this.input.focus(),this.input.select(),document.execCommand("copy"),this.setState({copied:!0})),e.preventDefault(),e.stopPropagation()},this.onBlinkTextHide=()=>{this.setState({copied:!1})},this.getHiddenInput=e=>{this.input=e},this.onDisabledSettingsChange=e=>{var t=e.selected.value,a=t>0?Math.floor((Date.now()+t)/1e3):t,n=0!==a;this.setState({push_disabled_until:a,push_disabled:n,disabledPlaceholder:this.getDisabledPlaceholder(a)},()=>{this.props.onUpdateNotificationSettings(n,Math.floor(t/1e3)).then(()=>{this.props.afterDisableUntilUpdated()})})},this.onMentionSettingsChange=e=>{var t=e.selected.value;this.setState({mentions_push_disabled:t},()=>{this.props.onUpdateMentionNotificationSettings(t).then(()=>{this.props.afterNotificationSettingsUpdated()})})},this.onShowInviteLink=()=>{Object(b.canChangeInviteLink)(this.props.store)&&this.props.showInvitationLink()};var t=this.getPushSettingsFromProps(e),a=t.push_disabled_until,n=a>0?+new Date(a):a;this.state=Object.assign({pushDisabled:a,disabledPlaceholder:this.getDisabledPlaceholder(n),copied:!1},t)}getPushSettingsFromProps(e){var t=e.store.get();return t.tabs[t.peer].notifications}getPushDisabledFromProps(e){var t=e.store.get();return t.tabs[t.peer].notifications.push_disabled}getDisabledPlaceholder(e){if(!e||0===e)return R("mail_settings_configure");if(-1===e)return R("mail_settings_time_forever");var t=getShortDateWithTime(e,0,!1);return`${R("mail_settings_until")} ${t}`}getDisabledOptions(){return this.state.push_disabled_until?[].concat(F(),[{label:R("mail_settings_time_cancel"),value:0}]):F()}render(){var e=this.props,t=e.store,a=e.flagsUpdated,n=e.notificationSettingsUpdated,s=e.disableUntilUpdated,o=e.onHideStatus,l=e.invitationLinks,c=e.isInvitationLinkWithHistory,d=t.get(),u=d.tabs[d.peer],g=Object(r.isFvkcomgroup)(d,d.peer),_=Object(B.isCommunityChat)(d,d.peer),p=u.inviteLinks&&Object(b.canSeeInviteLink)(t)||Object(b.canChangeInviteLink)(t),h=l||u.inviteLinks,v=h&&(c?h.linkWithHistory:h.linkWithoutHistory),f=Object(b.canSeeSettingsItem)(t,d.peer,d.id),O=Object(m.classNames)("ChatSettingsMenu",{"ChatSettingsMenu--copied":this.state.copied}),y=d.isMassMentionsMessageAllowed,S=R(c?"mail_get_invite_link_copy_with_history":"mail_get_invite_link_copy_without_history");return i.createElement("div",{className:"ChatSettings__pane"},_&&i.createElement(L.default,{className:O},i.createElement(k.default,{onClick:e=>nav.go(u.owner.link,e),chevron:!0,className:"ChatSettingsMenu__owner"},i.createElement(P.default,{size:"28",title:u.owner.title,photo:u.owner.photo,href:u.owner.link,description:u.owner.description}))),i.createElement(L.default,{className:O},i.createElement(k.default,{onClick:this.props.showAttachments,chevron:!0},i.createElement(x.default,{type:"attach",backgroundColor:"blue"}),R("mail_im_show_media_history"))),i.createElement(L.default,{className:O},y&&i.createElement(i.Fragment,null,i.createElement(k.default,{selectable:!1,chevron:!1,aside:i.createElement(i.Fragment,null,i.createElement(C.default,{shown:n,callback:o},R("global_changes_saved_short")),i.createElement(N.default,{className:"ChatSettingsMenu__select",onChange:this.onMentionSettingsChange,options:[{label:R("mail_settings_mentions_all"),value:0},{label:R("mail_settings_mentions_except"),value:1},{label:R("mail_settings_mentions_disable"),value:2}],value:this.state.mentions_push_disabled}))},i.createElement(x.default,{type:"mention",backgroundColor:"blue"}),R("mail_settings_mentions")),i.createElement(k.default,{selectable:!1,aside:i.createElement(i.Fragment,null,i.createElement(C.default,{shown:s,callback:o},R("global_changes_saved_short")),i.createElement(N.default,{className:"ChatSettingsMenu__select",onChange:this.onDisabledSettingsChange,options:this.getDisabledOptions(),placeholder:this.state.disabledPlaceholder}))},i.createElement(x.default,{type:"notice",backgroundColor:"red"}),R("mail_settings_notices"))),(p||f)&&i.createElement(i.Fragment,null,p&&i.createElement(k.default,{onClick:this.onShowInviteLink,chevron:Object(b.canChangeInviteLink)(t)},i.createElement(x.default,{type:"link",backgroundColor:"green"}),R(g?"mail_vkcomgroup_invite_link":"mail_chat_invite_link"),v&&i.createElement("span",{className:"ChatSettingsMenu__invite"},i.createElement("span",{className:"ChatSettingsMenu__hidden"},i.createElement("input",{type:"text",readOnly:!0,value:v,ref:this.getHiddenInput})),i.createElement(C.default,{className:"ChatSettingsMenu__copied",shown:this.state.copied,callback:this.onBlinkTextHide},R("mail_invite_link_copied")),i.createElement(j.default,{className:"ChatSettingsMenu__copy",onClick:this.onCopyInviteLink},S))),f&&i.createElement(k.default,{onClick:this.props.showSettings,chevron:!0,aside:i.createElement(C.default,{shown:a,callback:o},R("global_changes_saved"))},i.createElement(x.default,{type:"gear",backgroundColor:"gray"}),R("mail_settings_options")))))}}a("OG14"),a("Vd3H");var U=a("ZO95"),G=a("As6E"),q=c.default.getLang;class W extends i.Component{constructor(){super(...arguments),this.toggleAdmin=()=>{var e=this.props,t=e.store,a=e.mid,n=e.adminMap,i=t.get().peer,s=!n[a];t.set(o.toggleAdminOptimisticly.bind(null,i,a,s)),t.set(o.toggleAdmin.bind(null,i,a,s))},this.kick=()=>{var e=this.props.store,t=e.get().peer,a=this.props.mid;e.set(o.kickUserOptimisticly.bind(null,t,a)),e.set(o.kickUser.bind(null,t,a)).catch(e=>{Object(v.imWeirdCatch)("ChatSettingsMemberEdit.kick",e)})},this.cancelMessageRequest=()=>{var e=this.props.store,t=e.get().peer,a=this.props.mid;e.set(o.cancelMessageRequest.bind(null,t,a)).catch(e=>{Object(v.imWeirdCatch)("ChatSettingsMemberEdit.cancel",e)})},this.changeAccess=e=>{var t=this.props.store,a=t.get().peer,n=this.props.mid;t.set(o.changeCommunityAccess.bind(null,a,n,!e)).catch(e=>{Object(v.imWeirdCatch)("ChatSettingsMemberEdit.changeAccess",e)})}}getMemberRole(e,t){var a=this.props.storeData,n=a.peer;return t===a.tabs[n].ownerId?q("mail_settings_owner"):e[t]?q("mail_settings_admin"):null}getActions(e){var t=this.props,a=t.store,n=t.mid,i=Object(d.unpackStore)(a),s=i.id,r=i.peer,o=s===n,l=[],c=Object(B.isCommunityChat)(a,r);if(o)return c&&Object(B.isCommunityInterface)(a)?[]:[{text:q("mail_leave_chat"),onClick:this.props.onLeave}];if(Object(b.canAddAdmin)(a,n)&&l.push({text:e[n]?q("mail_chat_remove_admin"):q("mail_settings_appoint_admin"),onClick:this.toggleAdmin}),Object(b.canKickUser)(a,n)&&l.push({text:q("mail_settings_kick"),onClick:this.kick}),Object(B.isCommunityPeer)(n)&&!e[n]){var u=Object(b.canSeeAllMessages)(a,a.get().peer,n),g=u?"mail_settings_community_mentions_only":"mail_settings_community_full_access";l.push({text:q(g),onClick:this.changeAccess.bind(this,u)})}return l}render(){var e=this.props,t=e.adminMap,a=e.storeData,n=e.mid,s=e.isContact,r=a.id,o=!!t[r],l=this.getMemberRole(t,n),c=r===n,d=o&&this.getActions(t);return s?i.createElement(_.default,{text:q("mail_cancel_invitation"),position:"t",align:"right"},i.createElement("span",{onClick:this.cancelMessageRequest,className:"ChatSettingsMembersEdit__kick"})):i.createElement(i.Fragment,null,l&&i.createElement("span",{className:"ChatSettingsMembersEdit__role"},l),d&&d.length>0&&i.createElement(G.default,{position:"b",align:"right",trigger:"hover",marginTop:-8,marginLeft:1,data:this.getActions(t)},i.createElement("span",{className:"ChatSettingsMembersEdit__actions"})),!o&&!c&&Object(b.canKickUser)(a,n)&&i.createElement(_.default,{text:q("mail_settings_kick"),position:"t",align:"right"},i.createElement("span",{onClick:this.kick,className:"ChatSettingsMembersEdit__kick"})),!o&&c&&i.createElement(_.default,{text:q("mail_leave_chat"),position:"t",align:"right"},i.createElement("span",{onClick:this.props.onLeave,className:"ChatSettingsMembersEdit__kick"})))}}var K=a("756/"),V={appendParentCls:"ChatSettingsWrapper"},Y=c.default.getLang,z={all:"allShowMore",admins:"adminsShowMore",invitedByMRShowMore:"invitedByMRShowMore"};class $ extends i.Component{constructor(e){super(e),this.onToggleSearch=()=>{this.state.showSearch?this.setState({showSearch:!1,searchQuery:""}):(this.setState({showSearch:!0}),requestAnimationFrame(()=>{this.searchInput.focus()}))},this.onSearchChange=e=>{e.target.value!==this.state.searchQuery&&this.setState({searchQuery:e.target.value})},this.onShowMore=()=>{var e=z[this.state.current];this.state[e]&&this.setState({[e]:!1})},this.onTabClick=(e,t)=>{e.preventDefault(),this.state.current!==t&&this.setState({current:t})},this.handleDocumentClick=e=>{!this.state.showSearch||this.state.searchQuery||e.target.closest(".ChatSettingsMembersWidget__search")||e.target.closest(".ChatSettingsMembersWidget__searchIcon")||this.setState({showSearch:!1})},this.onKeydown=e=>{this.state.showSearch&&27===e.keyCode&&(this.searchInput.blur(),this.setState({showSearch:!1,searchQuery:""}),e.preventDefault(),e.stopPropagation())},this.getInviter=e=>{if(this.invitersCache[e])return this.invitersCache[e];var t=this.props.store.get(),a=t.peer,n=t.tabs[a],i=n.inviters;if(!i[e])return"";var s=Object(r.getChatMembersByIds)(t,[i[e][0]])[0],o=getSmDate(i[e][2],t.timeshift,!0);if(Object(b.isUserOwnerInChat)(n,e))return this.invitersCache[e]=Y("mail_settings_owner"),Y("mail_settings_owner");if(!s)return this.invitersCache[e]=o,o;var l=langSex(i[e][1],Y("mail_chat_member_invited_by_X","raw")).replace(/{inviter}/,replaceEntities(s.name))+" "+o;return this.invitersCache[e]=l,l},this.isAddMemberWidgetShown=()=>{var e=this.props.store,t=Object(d.unpackStore)(e),a=t.id,n=t.peer,i=this.state,s=i.current,r=i.showSearch,o=i.searchQuery;return"all"===s&&!(r&&""!==o)&&Object(b.canInviteUser)(e,n,a)},this.searchInputRef=e=>{this.searchInput=e};var t=e.store.get(),a=this.getMembers(t),n=this.getAdmins(t),i=this.getInvitedByMessageRequests(t);this.state={showSearch:!1,searchQuery:"",current:"all",all:a,allShowMore:a.length>50,admins:n,adminsShowMore:n.length>50,invitedByMR:i,invitedByMRShowMore:i.length>50},this.membersMap=a.reduce((e,t)=>(e[t]=!0,e),{}),this.searchIndexPromise=this.getSearchIndex(a).then(e=>{this.searchIndex=e}),this.invitersCache={}}componentWillReceiveProps(e){var t=e.store.get(),a=this.getMembers(t),n=this.getAdmins(t),i=this.getInvitedByMessageRequests(t),s={removes:[],additions:[]},r=a.reduce((e,t)=>(e[t]=!0,e),{});a.forEach(e=>{this.membersMap[e]||s.additions.push(e)}),Object.keys(this.membersMap).forEach(e=>{r[e]||s.removes.push(e)}),(s.removes.length||s.additions.length)&&(this.updateSearchIndex(t,s),this.membersMap=r);var o={all:a,allShowMore:this.state.allShowMore&&a.length>50,admins:n,adminsShowMore:this.state.adminsShowMore&&n.length>50,invitedByMR:i,invitedByMRShowMore:this.state.invitedByMRShowMore&&i.length>50};o.current=o[this.state.current].length>0?this.state.current:"all",this.setState(o)}getMembers(e){var t=e.peer,a=e.tabs[t],n=-1!==(a.memberIds||[]).indexOf(a.ownerId),i=(a.adminIds||[]).reduce((e,t)=>(e[t]=!0,e),{});return(n?[a.ownerId]:[]).concat((a.adminIds||[]).filter(e=>e!==a.ownerId),(a.memberIds||[]).filter(e=>e!==a.ownerId&&!i[e]))}getAdmins(e){var t=e.peer,a=e.tabs[t];return(-1!==(a.memberIds||[]).indexOf(a.ownerId)?[a.ownerId]:[]).concat((a.adminIds||[]).filter(e=>e!==a.ownerId))}getInvitedByMessageRequests(e){var t=e.peer;return e.tabs[t].invitedByMessageRequest.sort((function(e,t){return e.date-t.date}))}getInvitedByMessageRequestList(e){return e.map(e=>({isContact:!0,id:e.id,photo:"/images/contact_icon.svg",name:e.name,date:e.date}))}getCurrentList(){var e=this.props.store,t=this.state,a=t.current,n=t.showSearch,i=t.searchQuery,s=t.invitedByMR;if(n&&i&&this.searchIndex){var o=this.getInvitedByMessageRequestList(s.filter(e=>!!e.name.toLowerCase().trim().split(/\s+/).find(e=>0===e.indexOf(i.toLowerCase()))));return this.searchIndex.search(i).concat(o)}var l=this.state[a],c="invitedByMR"===a?this.getInvitedByMessageRequestList(l):Object(r.getChatMembersByIds)(e.get(),l);return this.state[a+"ShowMore"]?c.slice(0,50):c}getSearchIndex(e){var t=window.vkIndexer,a=Object(r.getChatMembersByIds)(this.props.store.get(),e);return this.membersMap=a.reduce((e,t)=>(e[t.id]=!0,e),{}),new Promise((e,n)=>{var i=new t(a,e=>e.name,()=>{e(i)})})}updateSearchIndex(e,t){var a=Object(r.getChatMembersByIds)(e,t.removes),n=Object(r.getChatMembersByIds)(e,t.additions);(this.searchIndex?Promise.resolve(this.searchIndex):this.searchIndexPromise).then(e=>{a.forEach(t=>{e.remove(t)}),n.forEach(t=>{e.add(t)})})}componentDidMount(){this.searchInput.addEventListener("keydown",this.onKeydown)}componentWillUnmount(){this.searchInput.removeEventListener("keydown",this.onKeydown)}render(){var e=this.props,t=e.store,a=e.membersCount,n=e.membersAdded,s=e.onHideStatus,o=this.state,l=o.current,c=o.showSearch,d=o.searchQuery,u=o.admins,g=o.invitedByMR,_=t.get(),p=_.peer,h=_.tabs[p],b=this.getCurrentList(),v=this.isAddMemberWidgetShown()?["add"].concat(b):b,f=this.state[z[l]],O=h.membersLastSeen,y={"ChatSettingsMembersWidget--search":!!c},j=h.adminIds.reduce((e,t)=>(e[t]=!0,e),{});return i.createElement("div",{className:Object(m.classNames)("ChatSettingsMembersWidget",y)},i.createElement("header",{className:"ChatSettingsMembersWidget__header"},i.createElement("input",{placeholder:Y("mail_members_search"),className:"ChatSettingsMembersWidget__search",onChange:this.onSearchChange,onInput:this.onSearchChange,onPaste:this.onSearchChange,value:this.state.searchQuery,ref:this.searchInputRef}),i.createElement("button",{className:"ChatSettingsMembersWidget__searchIcon",onClick:this.onToggleSearch}),i.createElement(U.default,{className:"ChatSettingsMembersWidget__tabs",onTabClick:this.onTabClick},i.createElement("span",{key:"all"},Y("mail_settings_everyone")+" ",i.createElement("span",{className:"Tabs__desc"},Object(r.getAliveMembersCount)(h))),u.length>0&&i.createElement("span",{key:"admins"},Y("mail_settings_admins")+" ",i.createElement("span",{className:"Tabs__desc"},u.length)),g.length>0&&i.createElement("span",{key:"invitedByMR"},Y("mail_invited_members")+" ",i.createElement("span",{className:"Tabs__desc"},g.length)))),i.createElement("div",{className:"ChatSettingsMembersWidget__list"},i.createElement(L.default,{border:!1},v.length>0&&v.map(e=>{if("add"===e)return i.createElement(k.default,{selectable:!1,border:!1,key:"add",onClick:this.props.showMembersSettings,aside:i.createElement(C.default,{className:"ChatSettingsMembersWidget__blink",shown:n,callback:s},langNumeric(a||0,Y("mail_settings_members_added","raw")))},i.createElement("span",{className:"ChatSettingsMembersWidget__add"},i.createElement("span",null,Y("mail_settings_add_members"))));var o=this.getInviter(e.id),l=e.isContact,c=e.covid_status?e.name+`<span class="ChatSettingsMembersWidget__covidStatus">${e.covid_status}</span>`:e.name,d="";return O&&O[e.id]?d=Object(r.getLastSeenText)(_,e.id,O[e.id],V):l&&(d=Object(r.getMessageRequestDateText)(e.date,t.get().timeshift)),i.createElement(k.default,{selectable:!1,border:!1,aside:i.createElement(W,{adminMap:j,store:t,storeData:_,mid:e.id,onLeave:this.props.onLeave,isContact:l}),key:e.id},i.createElement(P.default,{photo:l?i.createElement(K.ConversationNoPhoto,{id:p,text:Object(r.getUserInitials)(e.name),size:"xxxs",specificType:7}):e.photo,title:c,description:i.createElement("span",{title:o,dangerouslySetInnerHTML:{__html:d}}),href:e.link}))}),!v.length&&c&&d&&i.createElement("div",{className:"ChatSettingsMembersWidget__empty"},Y("mail_settings_not_found")),!(c&&d)&&f&&i.createElement("div",{className:"ChatSettingsMembersWidget__more",onClick:this.onShowMore},Y("mail_settings_show_all_members")))))}}var X=a("FABD"),Q=a("0Rlc"),J=a("EasH"),Z=a("DM26"),ee=c.default.getLang,te=()=>{};class ae extends i.Component{constructor(e){super(e),this.onChange=e=>{var t=this.props.store.get(),a=e.target.value;Object(o.searchLocalHints)(a,t).then(e=>(this.setSearchResults({},!1,a,e),a?(this.isSearching=!0,this.serverSearch(a,e.map(e=>e.peerId))):Promise.resolve([]))).then(this.appendSearchResults).catch(()=>{})},this.serverSearch=Object(Z.debouncedPromise)((e,t)=>{var a=this.props.store;return Object(o.searchHints)(e,t,"friends",a.get())},300),this.onRemoveToken=e=>new Promise(t=>{var a=this.state.selected.filter(t=>t!==e);this.selected=a.reduce((e,t)=>(e[t]=!0,e),{}),this.setState({selected:a},t)}),this.onSelect=e=>new Promise(t=>{var a=this.selected[e]?this.state.selected.filter(t=>t!==e):[].concat(this.state.selected,e).filter((e,t,a)=>a.indexOf(e)===t);this.selected=a.reduce((e,t)=>(e[t]=!0,e),{}),this.resetSearch({selected:a,value:""},t)}),this.onShowHistoryToggle=()=>{this.setState({isShowHistoryChecked:!this.state.isShowHistoryChecked})},this.onAddPeople=()=>{var e=this.props.store,t=e.get().peer,a=this.state.selected.map(e=>parseInt(e)),n=this.state.isShowHistoryChecked;this.setState({loading:!0}),e.set(o.addNewMember.bind(null,t,a,n)).then(()=>e.set(o.getChatDetails.bind(null,t)).then(()=>{this.selected={},this.resetSearch({selected:[],loading:!1},()=>{this.props.afterSave(a.length)})})).catch(e=>{this.selected={},this.resetSearch({selected:[],loading:!1}),Object(J.showFastBox)(ee("global_error"),e)})},this.setSearchResults=(e,t,a,n)=>{var i=this.props.store.get(),s=Object(B.getTab)(i,i.peer),r=[];n.forEach(e=>{this.data[e.peerId]||(this.data[e.peerId]=e),-1===s.memberIds.indexOf(e.peerId)&&r.push(e.peerId)}),this.setState(Object.assign({},e,{found:r,value:a}),t||te)},this.appendSearchResults=e=>{var t=this.props.store.get(),a=Object(B.getTab)(t,t.peer),n=this.state.found;e.forEach(e=>{this.data[e.peerId]||(this.data[e.peerId]=e),-1===a.memberIds.indexOf(e.peerId)&&-1===n.indexOf(e.peerId)&&n.push(e.peerId)}),this.isSearching=!1,this.setState({found:n})},this.state={selected:[],value:"",loading:!1,found:[],isShowHistoryChecked:!0},this.data={},this.selected={}}resetSearch(e,t){return Object(o.searchLocalHints)("",this.props.store.get()).then(this.setSearchResults.bind(this,e,t,""))}componentDidMount(){this.resetSearch()}render(){var e=Object.keys(this.state.selected).length;return i.createElement("div",{className:"ChatSettingsMembers"},i.createElement(X.default,{className:"ChatSettingsMembers__multiSelect",tokens:this.state.selected.map(e=>({text:unclean(this.data[e].name),id:e})),removeTokenPlaceholder:ee("mail_create_chat_remove_user"),onRemoveToken:this.onRemoveToken,placeholder:ee("mail_search_creation"),value:this.state.value,onChange:this.onChange,onSelect:this.onSelect,useInfiniteScroll:!1,hasMore:!1,virtualized:!1,loadMore:()=>{},notFoundText:ee("mail_not_found"),autoFocus:!0,isSearching:this.isSearching},this.state.found.map(e=>i.createElement("div",{className:Object(m.classNames)("ChatSettingsMembers__entity",{"ChatSettingsMembers__entity--selected":this.selected[e]}),key:e,"data-id":e},i.createElement(P.default,{size:"34",title:this.data[e].name,photo:this.data[e].photo})))),i.createElement(I.default,{alignment:"right",className:"ChatSettingsMembers__submitArea"},i.createElement(Q.default,{checked:this.state.isShowHistoryChecked,onChange:this.onShowHistoryToggle,className:"ChatSettingsMembers__showHistory"},ee("mail_im_chat_add_members_show_history")),i.createElement(T.default,{disabled:0===e,onClick:this.onAddPeople,loading:this.state.loading,className:"ChatSettingsMembers__confirm"},ee(e<2?"mail_append_chat":"mail_im_create_chat_with"))))}}var ne=a("iukX");function ie(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var a=[],n=!0,i=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(n=(r=o.next()).done)&&(a.push(r.value),!t||a.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw s}}return a}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return se(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return se(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function se(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}var re,oe=c.default.getLang;class le extends i.Component{constructor(e){super(e),this.showInvitationLink=()=>{var e=this.props.store,t=Object(d.unpackStore)(e),a=t.peer;return this.setState({invitationLoading:!0}),Object(o.getInviteLink)(a-2e9,t).then(e=>{var t=ie(e,1)[0];this.setState({section:2,invitationLoading:!1,invitationLinks:t})})},this.onUpdateNotificationSettings=(e,t)=>{var a=this.props,n=a.store,i=a.parentMutations,s=n.get().peer;return n.set(o.toggleMutePeer.bind(null,s,e,t)).then(i().updateState.bind(null,s))},this.onUpdateMentionNotificationSettings=e=>{var t=this.props,a=t.store,n=t.parentMutations,i=a.get().peer;return a.set(o.toggleMuteMentionsPeer.bind(null,i,e)).then(n().updateState.bind(null,i))},this.onUpdateFlags=e=>{var t=this.props.store.get(),a=t.peer,n=t.hasOwnProperty("onUpdateFlags")?t.onUpdateFlags.bind(null,a,e):e=>Promise.resolve(e);return Object(o.updateFlags)(a,e,t).then(n)},this.afterFlagsUpdated=()=>{this.go(0,()=>this.setBlinkStatus({flagsUpdated:!0}))},this.afterMembersAdded=e=>{this.go(0,()=>this.setBlinkStatus({membersAdded:!0,membersCount:e}))},this.afterNotificationSettingsUpdated=()=>{this.setBlinkStatus({notificationSettingsUpdated:!0})},this.afterDisableUntilUpdated=()=>{this.setBlinkStatus({disableUntilUpdated:!0})},this.setBlinkStatus=e=>{this.timers.push(setTimeout(()=>this.setState(e),300))},this.onHideStatus=()=>{this.setState({membersAdded:!1,flagsUpdated:!1,notificationSettingsUpdated:!1,disableUntilUpdated:!1})},this.onLeave=()=>{var e=this.props,t=e.store,a=e.closePopup,n=t.get().peer,i=Object(r.isFvkcomgroup)(t,n),s=Object(J.showFastBox)({title:oe(i?"mail_leave_channel":"mail_chat_leave_title"),dark:1},oe(i?"mail_vkcomgroup_leave_confirm":"mail_chat_leave_confirm"),oe(i?"mail_leave_channel":"mail_leave_chat"),(function(){t.set(o.unpinMessageOptimistic.bind(null,n)),t.set(o.leaveChat.bind(null,n)),s.hide(),a(),t.get().longpoll.push([Object(l.resetPeer)()])}),oe("global_cancel"),(function(){s.hide()}))},this.onChatClose=()=>{var e=this.props,t=e.store,a=e.closePopup,n=t.get().peer,i=Object(B.getTab)(t,n).data.flags,s=i&b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE?i&~b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE:i|b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE,o=Object(J.showFastBox)({title:oe("global_warning"),dark:1},oe("mail_chat_close_confirm"),oe("mail_close_chat"),()=>{this.onUpdateFlags(s).then(()=>{o.hide(),a(),Object(r.isCommunityInterface)(t)||t.get().longpoll.push([Object(l.resetPeer)()])})},oe("global_cancel"),(function(){o.hide()}))},this.onChatRestore=()=>{var e=this.props,t=e.store,a=e.closePopup,n=t.get().peer,i=Object(B.getTab)(t,n).data.flags,s=i&b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE?i&~b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE:i|b.MAIL_CHAT_FLAG_DENY_ANYONE_TO_WRITE;this.onUpdateFlags(s).then(a)},this.onResetLink=()=>{var e=this.props.store,t=Object(d.unpackStore)(e),a=t.peer;return Object(o.resetInviteLink)(a,t).then(e=>{var t=ie(e,1)[0];this.setState({invitationLinksReseted:!0,invitationLinks:t})})},this.onShowAttachments=()=>{var e=Object(B.getPeer)(this.props.store);this.props.closePopup(),window.showWiki({w:"history"+Object(r.convertPeerToUrl)(e)+"_photo"},null,{})},this.onLinkHistoryOptionToggle=()=>{var e=Object(B.getPeer)(this.props.store);this.setState(e=>({isInvitationLinkWithHistory:!e.isInvitationLinkWithHistory}),()=>{this.props.updateHistoryLinkState(e,this.state.isInvitationLinkWithHistory)})},this.state={section:0,invitationLinks:null,invitationLinksReseted:!1,isInvitationLinkWithHistory:this.props.isLinkWithHistorySelected,membersAdded:!1,flagsUpdated:!1,notificationSettingsUpdated:!1,disableUntilUpdated:!1},this.timers=[]}go(e,t){this.setState({section:e},()=>{this.props.updatePopup(),t&&t()})}getPopupTitle(){switch(this.state.section){case 1:return oe("mail_settings_add_members");case 2:case 3:return oe("mail_chat_invite_link");case 6:return oe("mail_settings_options");default:return oe("mail_settings_title")}}componentWillReceiveProps(e){var t=e.store.get(),a=t.peer,n=t.tabs[a];n.photoLarge||n.photoGrid||this.resync||(this.resync=!0,e.store.set(o.getChatDetails.bind(null,a)).then(()=>{this.resync=!0}))}componentDidMount(){this.props.updatePopup()}componentWillUnmount(){this.timers.forEach(clearTimeout)}render(){var e=this.props,t=e.store,a=e.closePopup,n=t.get(),s=n.peer,o=n.tabs[s],l=Object(r.isFvkcomgroup)(t,s),c=Object(B.isCasperChat)(t,s),d=Object(B.isCommunityChat)(t,s),m=!l&&!d||!t.get().gid,_=Object(b.canCloseChat)(t,s,n.id),p=Object(B.isClosedChat)(t,s),h=n.isChatTypeEditAllowed,v=oe(l?"mail_im_n_vkcomgroup_members":"mail_im_n_chat_members",Object(r.getAliveMembersCount)(o));return i.createElement("section",{className:"ChatSettings"},i.createElement(u.default,{title:this.getPopupTitle(),back:0!==this.state.section?oe("global_back"):void 0,onCloseClick:a,onBackClick:()=>this.go(0)}),0===this.state.section&&i.createElement("div",{className:"ChatSettings__content"},i.createElement(O,{store:t,photo:o.photoLarge,grid:o.photoGrid,title:o.name,flags:o.data.flags,isDefaultPhotoOwner:o.isDefaultPhotoOwner,isCasper:c,meta:v,description:""}),i.createElement(H,{store:t,showMembersSettings:()=>this.go(1),showAttachments:this.onShowAttachments,showInvitationLink:this.showInvitationLink,isInvitationLinkWithHistory:this.state.isInvitationLinkWithHistory,invitationLinks:this.state.invitationLinks,showSettings:()=>this.go(6),notificationSettingsUpdated:this.state.notificationSettingsUpdated,disableUntilUpdated:this.state.disableUntilUpdated,flagsUpdated:this.state.flagsUpdated,onHideStatus:this.onHideStatus,onUpdateNotificationSettings:this.onUpdateNotificationSettings,onUpdateMentionNotificationSettings:this.onUpdateMentionNotificationSettings,afterNotificationSettingsUpdated:this.afterNotificationSettingsUpdated,afterDisableUntilUpdated:this.afterDisableUntilUpdated}),l?null:i.createElement("div",{className:"ChatSettings__pane"},i.createElement($,{store:t,onLeave:this.onLeave,showMembersSettings:()=>this.go(1),membersAdded:this.state.membersAdded,onHideStatus:this.onHideStatus,membersCount:this.state.membersCount})),m&&i.createElement("div",{className:"ChatSettings__pane"},i.createElement(g.default,{appearance:["link","mobile"],className:"ChatSettings__criticalAction ChatSettings__leave",onClick:this.onLeave},oe(l?"mail_leave_channel":"mail_settings_leave"))),_&&!p&&i.createElement("div",{className:"ChatSettings__pane"},i.createElement(g.default,{appearance:["link","mobile"],className:"ChatSettings__criticalAction ChatSettings__close",onClick:this.onChatClose},oe("mail_settings_close"))),_&&p&&i.createElement("div",{className:"ChatSettings__pane"},i.createElement(g.default,{appearance:["link","mobile"],className:"ChatSettings__criticalAction ChatSettings__restore",onClick:this.onChatRestore},oe("mail_settings_restore")))),1===this.state.section&&i.createElement(ae,{store:t,afterSave:this.afterMembersAdded}),6===this.state.section&&i.createElement(ne.default,{isChatTypeEditAllowed:h,flags:o.data.flags,isCasperChatTab:c,isCommunityChat:d,allowedUpdateFlags:o.allowedUpdateFlags,back:()=>this.go(0),onSave:this.onUpdateFlags,afterSave:this.afterFlagsUpdated}),2===this.state.section&&i.createElement(w,{store:t,onReset:()=>this.go(3),onLinkHistoryOptionToggle:this.onLinkHistoryOptionToggle,reseted:this.state.invitationLinksReseted,isInvitationLinkWithHistory:this.state.isInvitationLinkWithHistory,invitationLinks:this.state.invitationLinks}),3===this.state.section&&i.createElement(A,{onConfirm:this.onResetLink,onCancel:()=>this.go(2)}))}}function ce(e,t){var a=ls.get("im_chats_no_invite_link_history")||[],n=e-2e9,i=t?a.filter(e=>e!==n):a.concat(n);ls.set("im_chats_no_invite_link_history",i)}function de(e,t){var a=me(),n=function(e){var t=Object(B.getPeer)(e)-2e9;return!(ls.get("im_chats_no_invite_link_history")||[]).includes(t)}(e);a&&s.render(i.createElement(le,{store:e,closePopup:ue.bind(null,e),updatePopup:ge,isLinkWithHistorySelected:n,updateHistoryLinkState:ce,parentMutations:t}),a)}function ue(e){re&&re.hide();var t=e.get();t.hasOwnProperty("onClose")&&t.onClose()}function ge(){re&&re.updateBoxCoords()}function me(){return document.querySelector("#ChatSettings")}function _e(e){var t=document.querySelector("#box_layer_wrap"),a=document.querySelector("#box_loader"),i=isVisible(t);return{unmount(){var t=me();t&&s.unmountComponentAtNode(t),Object(n.destroyModule)(e)},showLoader(){boxRefreshCoords(a),show(a),i||show(t)},hideLoader(){hide(a),i||hide(t)}}}function pe(e,t,a){var i=Object(n.createMutations)(_e).bindMutations,s=t.get(),r=Object(n.createModule)({handlers:(e,t)=>{}}),l=s.peer,c=i(r);var u=function(e,t){t.get().peer===l?function(e,t){var a=Object(B.getTab)(e,e.get().peer);a&&a.data&&Object(B.isChatActive)(a)?de(e,t):ue(e)}(t,a):e.unmount()}.bind(null,c),g={hideButtons:!0,bodyStyle:"padding: 0; background: none;",width:560,onShow(){de(t,a),t.subscribe(u),requestAnimationFrame(()=>re.updateBoxCoords())},onHideAttempt:()=>(t.unsubscribe(u),c.unmount(),!0)};return c.showLoader(),t.set(o.getChatDetails.bind(null,l)).then(e=>{c.hideLoader();var t=Object(d.unpackStore)(e).peer;t&&t===l?re=new MessageBox(g).content('<div id="ChatSettings" class="ChatSettingsWrapper"></div>').show():c.unmount()}),c}},bP5l:function(e,t,a){"use strict";a.r(t),a.d(t,"lpLogFc",(function(){return s})),a.d(t,"longpollTestingOnFcEvents",(function(){return g})),a.d(t,"longpollTestingOnImEvents",(function(){return m}));var n=a("ERyv"),i=function(){for(var e=0,t=0,a=arguments.length;t<a;t++)e+=arguments[t].length;var n=Array(e),i=0;for(t=0;t<a;t++)for(var s=arguments[t],r=0,o=s.length;r<o;r++,i++)n[i]=s[r];return n};function s(e,t){for(var a=[],n=2;n<arguments.length;n++)a[n-2]=arguments[n];if(window.vk.lpConfig.debug){var s="background: "+e+"; color: white",r=new Date,o=function(e){return e<10?"0"+e.toString():e.toString()};console.log.apply(console,i(["%c "+r.getHours()+":"+o(r.getMinutes())+":"+o(r.getSeconds())+":"+r.getMilliseconds()+" "+t+" ",s],a))}}function r(){return window.lpBufferFc||(window.lpBufferFc=[]),window.lpBufferFc}function o(){return window.lpBufferIm||(window.lpBufferIm=[]),window.lpBufferIm}function l(e,t){window.lpWeird||(window.lpWeird=[]),window.lpWeird.push({msg:e,ev:t,is_master:window.curNotifier.is_server}),setTimeout(c,1e4)}function c(){window.lpWeird&&window.lpWeird.length&&(Object(n.imWeirdLog)("fc_im_differ",{diff:window.lpWeird},!1),window.lpWeird=[])}function d(){return"im"===window.cur.module&&window.store&&window.store.get().longpoll&&!window.store.get().stopped}function u(){var e;d()&&(o().forEach((function(e){!r().find((function(t){return e.ev===t.ev}))&&e.time<Date.now()-1e3&&!e.warned&&(e.warned=!0,s("red","im not fc",e.ev),Object(n.isWeirdLogging)()&&l("im not fc",e.ev))})),r().forEach((function(e){var t=o().find((function(t){return t.ev===e.ev}));t&&t.warned&&!e.warned&&(e.warned=!0,s("red","now fc like im",e.ev),Object(n.isWeirdLogging)()&&l("now fc like im",e.ev))}))),e=Date.now()-3e4,window.lpBufferFc=r().filter((function(t){return t.time>e})),window.lpBufferIm=o().filter((function(t){return t.time>e}))}function g(e){var t;d()&&((t=r()).push.apply(t,e.map((function(e){return{time:Date.now(),ev:JSON.stringify(e),warned:!1}}))),setTimeout(u,0)),s.apply(void 0,i(["green","fc"],e))}function m(e){var t;d()&&((t=o()).push.apply(t,e.map((function(e){return{time:Date.now(),ev:JSON.stringify(e),warned:!1}}))),setTimeout(u,1100)),s.apply(void 0,i(["blue","im"],e))}window.longpollTestingOnImEvents=m},clTp:function(e,t,a){"use strict";function n(e){var t=e.getBoundingClientRect(),a=document.body,n=document.documentElement,i=window.pageYOffset||n.scrollTop||a.scrollTop,s=window.pageXOffset||n.scrollLeft||a.scrollLeft,r=n.clientTop||a.clientTop||0,o=n.clientLeft||a.clientLeft||0;return{top:Math.round(t.top+i-r),left:Math.round(t.left+s-o),width:e.offsetWidth,height:e.offsetHeight}}a.r(t),a.d(t,"default",(function(){return n}))},f4YT:function(e,t){e.exports={im_img_prebody:'<div class="im-prebody"> <img alt="" src="%photo%" /> </div>',im_admin_link:' (<a href="%href%" class="_im_admin_name" target="_blank">%name%</a>)',im_right_menu_tpl:'<a id="ui_rmenu_peer_%peer%" href="%href%" class="_im_peer_tab ui_rmenu_item %cls%"%attrs%>\n  <span>%label%</span>\n</a>',im_right_menu_sep:'<div class="ui_rmenu_sep"></div>',im_right_menu_ct:'<span class="ui_rmenu_count im-right-menu--count _im_r_ct">%count%</span> <button type="button" class="im-right-menu--close _im_r_cl"></button><span class="im-right-menu--text _im_r_tx">%name%</span>',im_dialogs_link_img:'<a href="%href%" class="_im_peer_target _online_reader" target="_blank"><div class="im_grid">%photo%</div></a>',im_dialogs_link:'<a href="%href%" class="_im_peer_target _online_reader" target="_blank">%photo%</a>',im_peer_photo:'<div class="nim-peer %online_class% %modifier_class%"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo"> %owner_photo% </div> </div> </div>',im_contact_avatar:' <div class="nim-peer--contact-avatar nim-peer--contact-avatar_%size%">%name%</div>',im_owner_item:'<a href="%link%" class="olist_item_wrap%cls%" id="olist_item_wrap%owner_id%" >\n  <div class="olist_item clear_fix">\n    <div class="olist_item_photo_wrap %img_cls%">\n      <img class="olist_item_photo" src="%photo%"/>\n    </div>\n    <div class="olist_item_name">%name%</div>\n    <div class="olist_checkbox"></div>\n  </div>\n</a>',im_simple_name:function(){return'<div class="im-page--title %more_cls%"> <span class="im-page--title-main" title="%name_attr%" %ads_union%> <span class="im-page--title-main-in"> <a href="%href%" target="_blank" class="im-page--title-main-inner _im_page_peer_name">%name%</a> <span class="im-page--title-main-verified _im_chat_verified"></span> </span> </span> <span class="im-page--title-meta _im_page_peer_online">%online%</span> <span class="im-page--title-status _im_page_status"></span> <button class="im-page--title-reconnect _im_page_reconnect">'+getLang("mail_network_reconnect")+"</button> </div>"},im_simple_link:'<a href="%href%" class="_im_header_link" target="_blank">%content%</a>',im_selected_messages:'<span class="im-page--selected-messages-count">%label%</span> <button aria-label="%tip%" type="button" class="im-page--selected-messages-remove"></button>',im_topic:"<div class='im-topic %cls%'>%topic%</div>",im_stack_date:' <a href="%link%" class="_im_mess_link" >%date%</a>',im_dialogs_none:'<li data-list-id="002300" class="im-page--dialogs-empty"> %msg%</li>',im_dialogs_message_requests_button:'<li class="im-page--dialogs-message-requests-button _im_toggle_mr_tab" data-list-id="%list_id%"> %msg%</li>',im_dialogs_message_requests_notice:'<li class="im-page--dialogs-message-requests-notice-w" data-list-id="message_request_notice"> <div class="im-page--dialogs-message-requests-notice"> %msg% </div> </li>',im_filter:'<a class="im-page--dialogs-filter %cls%">%filter%</a>',im_drow_prebody:'<span class="nim-dialog--who">%prebody%</span> <span class="nim-dialog--inner-text">%body%</span>',im_attach_mess:' <div class="im-fwd %modifier%"> <span class="im-fwd--title"> <span class="im-fwd--title-name">%text%</span> <span class="im-fwd--date">%date%</span></span> <span class="im-fwd--close _im_fwd_close"></span> <div rel="button" tab-index="0" type="button" class="im-fwd--messages _im_will_fwd">%messages%</div> </div>',im_preloader:'<div class="im-preloader %cls%"> %preloader%</div>',im_service_row:'<ul class="ui_clean_list"> <li class="im-mess im-mess_srv _im_mess _im_mess_srv _im_mess_%message_id%" data-msgid="%message_id%" data-from="%from_id%" data-ts="%date%"> <div class="im-mess--text">%text%</div> </li> </ul>',im_chat_members:'<button type="button" class="_im_chat_members im-page--members">%name%</button>',im_vkcomgroup_members:'<span class="im-page--members im-page--members--nohover">%name%</span>',im_mess_stack:'<div class="im-mess-stack _im_mess_stack %cls%" data-peer="%peerId%" data-admin="%admin%"> <div class="im-mess-stack--photo"> <div class="nim-peer nim-peer_small fl_l"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo"> <a target="_blank" class="im_grid" href="%href%"><img alt="%name%" src="%photo%" /></a> </div> </div> </div> </div> <div class="im-mess-stack--content"> <div class="im-mess-stack--info"> <div class="im-mess-stack--pname"> %stack_name% <span class="im-mess-stack--tools">%messageMeta%</span> </div> </div> <ul class="ui_clean_list im-mess-stack--mess _im_stack_messages"> %messages% </ul> </div> </div>',im_mess_stack_name:'<a href="%link%" class="im-mess-stack--lnk%class%" title="" target="_blank">%name%</a>',im_message_media:'<div class="_im_msg_%type%%messageId%" class="wall_module">%attaches%</div>%text%',im_dialog_media:'<span class="nim-dialog--preview nim-dialog--preview-attach">%name%</span>',im_typing:'<div class="im-page--typing _im_typing"> <div class="im-activity %cls%"><div class="pr im-activity--icon"><div class="pr_bt"></div><div class="pr_bt"></div><div class="pr_bt"></div></div><span class="_im_typing_name">&nbsp;</span></div> </div>',ctrl_submit_hint:function(){return'<div class="reply_submit_hint_wrap" >\n  <div class="reply_submit_hint_title">'+getLang("wall_reply_submit_settings")+'</div>\n  <div class="reply_submit_hint_opts" id="">\n    <div class="radiobtn %enter_on% _im_submit_btn" data-val="0" onclick="radiobtn(this, 0, \'im_submit\'); "><div class="radiobtn_label">'+getLang("wall_reply_submit_settings_1")+'</div></div>\n    <div class="radiobtn %ctrl_on% _im_submit_btn" data-val="1" onclick="radiobtn(this, 1, \'im_submit\'); "><div class="radiobtn_label">'+getLang("wall_reply_submit_settings_2")+"</div></div>\n  </div>\n</div>"},im_day_bar:'<h5 class="im-page--history-new-bar im-page--history-new-bar_days _im_bar_date %day_class%" data-date="%date%"><span>%day%</span></h5>',im_mess_bar:function(){return'<h4 class="im-page--history-new-bar _im_unread_bar_row"><span>'+getLang("mail_new_unread_msgs")+"</span></h4>"},im_replied_message:'<div class="im-replied"> <div class="im-replied--photo-wrapper"></div> <div class="im-replied--content"> <div class="im-replied--author"> <span class="im-replied--author-link">%authorName%</span> </div> <div class="im-replied--text">%text%</div> </div> </div>',im_drow:function(){return'<li data-list-id="%peer%" class="nim-dialog _im_dialog _im_dialog_%peer% %is_unread% %is_unread_out% %is_selected% %more%" data-peer="%peer%" data-msgid="%msg_id%"> <div class="nim-dialog--photo"> <div class="nim-peer %is_online% _im_peer_online"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo _im_dialog_photo"> %photo% </div> </div> </div> </div> <div class="nim-dialog--content"> <div class="nim-dialog--cw"> <span role="link" class="blind_label" aria-label="'+getLang("mail_im_to_multidialog")+': %tab_name%"></span> <div class="nim-dialog--date _im_dialog_date">%date%</div> <button type="button" class="nim-dialog--close _im_dialog_close" data-peer="%peer%"></button> <button type="button" class="nim-dialog--markre _im_dialog_markre"></button> <div class="nim-dialog--name"> <span class="nim-dialog--name-w _im_dialog_name_w" aria-hidden="true"> %user_link% </span> <span class="nim-dialog--verfifed _im_dialog_verified"></span> <span class="nim-dialog--casper _im_dialog_casper" aria-label="'+getLang("mail_casper_chat_label")+'" role="img" ></span> <span class="nim-dialog--mute"></span> <button type="button" class="nim-dialog--star _im_dialog_star"></button> <div class="nim-dialog--peer-tags _im_dialog_peer_tags PeerTags"></div> </div> <div class="nim-dialog--text-preview"> <span class="nim-dialog--preview _dialog_body" tabindex="0">%body%</span> <span class="nim-dialog--typing _im_dialog_typing"></span><span class="nim-dialog--typer-el"></span> </div> <div class="nim-dialog--unread_container"> <div class="nim-dialog--unread-badge_mention nim-dialog--unread-badge" aria-label="'+getLang("mail_mention_badge_label")+'" role="img"></div> <div class="nim-dialog--unread-badge_bomb nim-dialog--unread-badge" aria-label="'+getLang("mail_expiring_message_badge_label")+'" role="img"></div> <label class="blind_label _im_unread_blind_label">%unread_message_string%</label> <div class="nim-dialog--unread _im_dialog_unread_ct" aria-hidden="true">%unread%</div> </div> </div> </div> </li>'},im_conversation_search_row:function(){return'<li data-list-id="%peer%" class="nim-dialog nim-conversation-search-row _im_dialog _im_dialog_%peer% %is_unread% %is_selected% %more%" data-peer="%peer%" data-msgid="%msg_id%"> <div class="nim-dialog--photo"> <div class="nim-peer nim-peer_search %is_online% _im_peer_online"> <div class="nim-peer--photo-w"> <div class="nim-peer--photo _im_dialog_photo"> %photo% </div> </div> </div> </div> <div class="nim-dialog--content"> <div class="nim-dialog--cw"> <span role="link" class="blind_label" aria-label="'+getLang("mail_im_to_multidialog")+': %tab_name%"></span> <button type="button" class="nim-dialog--close _im_dialog_close" data-peer="%peer%"></button> <div class="nim-dialog--name"> <span class="nim-dialog--name-w" aria-hidden="true"> %user_link% </span> <span class="nim-dialog--casper _im_dialog_casper" aria-label="'+getLang("mail_casper_chat_label")+'"></span> </div> <div class="nim-dialog--unread_container"> <div class="nim-dialog--unread-badge_mention nim-dialog--unread-badge" aria-label="'+getLang("mail_mention_badge_label")+'" role="img"></div> <div class="nim-dialog--unread-badge_bomb nim-dialog--unread-badge" aria-label="'+getLang("mail_expiring_message_badge_label")+'" role="img"></div> <div class="nim-dialog--unread _im_dialog_unread_ct" aria-hidden="true">%unread%</div> </div> </div> </div> </li>'},im_delete_actions:function(){return'<span class="nim-dialog--who">%text%</span> <button class="nim-dialog--daction ui_bullet _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="restore" type="button">'+getLang("mail_restore")+'</button> <button class="nim-dialog--daction ui_bullet _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="spam" type="button">'+getLang("mail_im_mark_spam")+'</button> <button class="nim-dialog--daction nim-dialog--daction_last _im_dialog_daction" data-sid=%spam_id% data-peer="%peer%" data-action="block" type="button">'+getLang("mail_user_black_list")+"</button>"},im_chat_change_topic:function(){return'<div class="im_change_topic_wrap clear_fix"> <div class="im_change_topic_label fl_l ta_r">'+getLang("mail_chat_topic_change_label")+'</div> <div class="im_change_topic_labeled fl_l"> <input class="text _im_chat_topic_change_input" value="%value%"/> </div> </div>'},im_msg_row:function(){return'<li class="im-mess %cls% _im_mess_noa _im_mess_%msg_id%" aria-hidden="%aria_hidden%" data-ts="%ts%" data-msgid="%msg_id%" data-peer="%from_id%"> <div class="im-mess--text wall_module _im_log_body">%text%</div> <span tabindex="0" role="link" aria-label="'+getLang("mail_select_message")+'" class="blind_label im-mess--blind-select _im_mess_blind_label_select"></span> <span class="blind_label im-mess--blind-read _im_mess_blind_unread_marker" %unread_params%></span> <span class="im-mess--marker _im_mess_marker" %marker_params%></span> </li>'},sImHistoryRowActions:function(){return'<div class="im-mess--actions"> <span role="link" aria-label="'+getLang("mail_im_mark_forward")+'" class="im-mess--forward _im_mess_forward"></span> <span role="link" aria-label="'+getLang("mail_im_reply")+'" class="im-mess--reply _im_mess_reply"></span> <span role="link" aria-label="'+getLang("mail_im_edit")+'" class="im-mess--edit _im_mess_edit"></span> <span role="link" aria-label="'+getLang("mail_important_message")+'" class="im-mess--fav _im_mess_fav"></span> </div> <div class="im-mess--check fl_l"></div>'},im_wrap_mobile:'<b class="mob_onl %class%" %attrs% onmouseover="mobileOnlineTip(this, {%params%})"></b>',im_pinned_message:'<div class="im-page-pinned _im_pinned_message"> <button class="im-page-pinned--hide _im_pin_hide"></button> <div class="im-page-pinned--meta"> <a href="%link%" target="_blank" class="im-page-pinned--name">%name%</a> <span class="im-page-pinned--date">%date%</span> </div> <div class="im-page-pinned--content">%content%</div> </div>',im_pinned_message_media:'<span class="im-page-pinned--media">%text%</span>',im_pinned_message_media_bar:'<div class="im-page-pinned--media-bar">\n  <div class="im-page-pinned--media-bar_progress" style="width: %percent%%;"></div>\n</div>',im_pinned_messages_promo:'<div class="im-page--mess-actions-promo-content">%content%</div>',im_retry_link:function(){return'<button class="im-page--retry _im_retry_media">'+getLang("mail_retry")+"</button>"},sImLblWasEdited:function(){return" <span class='im-mess--lbl-was-edited _im_edit_time' data-time='%update_time%'>"+getLang("mail_was_edited_short")+"</span>"},sImLblWasSourceInfo:function(){return" <span class='im-mess--lbl-was-edited _im_page_info' data-info='%source%'>"+getLang("mail_was_source_short")+"</span>"},im_top_banner:'<div class="im-top-banner %classes%">\n  %icon%\n  <div class="im-top-banner--text">%text%</div>\n  <div class="im-top-banner--buttons">%buttons%</div>\n</div>',im_top_banner_icon:'<div class="im-top-banner--icon">\n  <img src="%icon%" alt=""/>\n</div>',im_top_banner_button_link:'<a href="%link%" target="_blank" class="_im_top_banner_button im-top-banner--button %css_class% flat_button button_small">%text%</a>',im_top_banner_button:'<button class="_im_top_banner_button im-top-banner--button %css_class% flat_button button_small" data-payload="%callback_data%">%text%</button>',im_top_banner_hide_btn:'<button class="im-top-banner--button im-top-banner--button_hide _im_top_banner_hide"></button>',im_calls_link:'<button class="im_srv_lnk_light _fc_call_link">%text%</button>',sImPeerMuteUnmute:'<a href="#" class="_im_peer_mute_unmute ui_actions_menu_item im-action nohover %cls%">%text%</a>',sImPeerAcceptOrRejectMessageRequest:function(){return"<p>"+getLang("mail_message_request_user_notice")+'</p> <p> <button type="button" class="flat_button %cls_accept%">'+getLang("mail_message_request_accept")+'</button> <button type="button" class="flat_button secondary %cls_reject%">'+getLang("mail_message_request_reject")+"</button> </p>"},sImPeerReturnToChat:'<a href="#" class="_im_peer_return_to_chat">%text%</a>',sImCallSnippet:'<article class="CallSnippet %classes%" %attributes%> <div class="CallSnippet__users">%user_list%</div> <div class="CallSnippet__content"> <h3 class="CallSnippet__title">%title%</h3> <div class="CallSnippet__desc">%description%</div> </div> %button%</article>',sImMessageKeyboard:'<div class="MessageKeyboard">%content%</div>',sImMessageKeyboardRow:'<div class="MessageKeyboard__row">%content%</div>',sImMessageKeyboardButton:' <span class="MessageKeyboard__cell"> <%tagName% class="MessageKeyboard__button MessageKeyboard__button--%modifier% Button Button--size-s Button--%appearance% _im_mess_btn" %attributes% > <span class="MessageKeyboard__label">%label%</span> </%tagName%> </span>',sImBomb:'<span class="im-mess-stack--bomb %classnames%"></span>',sImEmptyCasper:function(){return' <div class="im-page--casper-empty"> '+getLang("mail_im_empty_casper_chat")+" </div>"},sImExpiredMessagePlaceholder:' <div class="im-expired-message _im_expired_message %id_classes%" data-count="%count%"> <a href="/im?w=expired_messages" target="_blank" class="im-expired-message--in"> <span class="im-expired-message--inner">%text%</span> </a> </div>',sImGiftLabel:' <span class="im-mess-stack--gift">%content%</span>',sImMoneyTransferLabel:' <span class="im-mess-stack--money-transfer">%content%</span>',sImUiActionMenuItem:'<a tabindex="0" role="link" class="ui_actions_menu_item im-action im-action_%icon% %classes%" data-action="%action%"> %name%</a>',sImPeerTagsItem:' <div class="PeerTagsItem" style="background-color: %color%;">%name%</div>',sImPeerTagsAdTag:function(){return' <div class="PeerTagsItem PeerTagsItem--adTag %extra_class%"> <a href="%url%" target="_blank" class="PeerTagsItem__adTagLink"> <span class="PeerTagsItem__adTagText">%ad_tag_text%</span> </a> <button onclick="return showFastBox(\''+getLang("mail_ad_tag_no_access_box_title")+"', '"+getLang("mail_ad_tag_no_access_box_text")+'\');" class="PeerTagsItem__adTagAlert"> <span class="PeerTagsItem__adTagText">%ad_tag_text%</span> </button> </div>'},sImPeerTagsExtra:' <div class="PeerTagsItem PeerTagsItem--extra _im_peer_tags_extra">%text%</div>',sImPeerTagsExtraTooltipItem:' <div class="PeerTagsExtraTooltipItem"> <span class="PeerTagsExtraTooltipItem__color" style="background-color: %color%"></span> <span class="PeerTagsExtraTooltipItem__name">%name%</span> </div>',sImCallUser:'<img src="%url%" alt="%name%" class="CallUsers__user">',sImCallUsers:'<div class="CallUsers"> <svg xmlns="http://www.w3.org/2000/svg" class="CallUsers__hidden"> <defs> <clipPath id="user-frame"> <path d="M12 0a12 12 0 11-7.97 20.97C5.89 18.47 7 15.37 7 12c0-3.36-1.1-6.47-2.97-8.97A11.95 11.95 0 0112 0z"/> </clipPath> </defs> </svg> <figure class="CallUsers__list"> %users% </figure> </div>',sImCallBannerContent:'<article class="CallBanner %cls%"> <div class="CallBanner__users">%user_list%</div> <div class="CallBanner__content"> <h3 class="CallBanner__title">%title%</h3> <div class="CallBanner__desc">%desc%</div> </div> </article>',sImCallBannerButton:function(){return'<button class="_im_top_banner_button _im_call_banner_join_btn im-top-banner--button flat_button button_small secondary" data-link="%call_link%">'+getLang("mail_join_chat")+"</button>"}}},"fD+e":function(e,t,a){"use strict";a.r(t),a.d(t,"TemplatesDropDown",(function(){return d}));var n=a("q1tI"),i=(a("17x9"),a("6aSF")),s=a("6krn"),r=a("MCfn"),o=a("BN/X"),l=a("ZxpX"),c=s.default.getLang;class d extends n.Component{constructor(){super(...arguments),this.elementOnClick=(e,t)=>{t.preventDefault(),t.stopPropagation(),this.props.applyTemplate(e),this.toggleDropdown(!1)},this.toggleDropdown=e=>{this.setState({isShowDropDown:e})},this.state={isShowDropDown:!1}}render(){var e=this.props,t=e.getTemplates,a=e.showSettingsPopup,s=e.showCreatingTemplatePopup,r=e.isNeededRendering,d=this.state.isShowDropDown;if(!r())return null;var u=t();return n.createElement("div",{className:"TemplatesDropDown",onMouseOver:this.toggleDropdown.bind(this,!0),onMouseOut:this.toggleDropdown.bind(this,!1)},n.createElement("div",{className:Object(l.classNames)("TemplatesDropDown__wrapper",{"TemplatesDropDown__wrapper--show":d}),"aria-hidden":d},n.createElement("div",{className:"TemplatesDropDown__container"},n.createElement(i.default,{className:"TemplatesDropDown__scroll-wrapper"},n.createElement("div",null," ",n.createElement("header",{className:"TemplatesDropDown__header"},n.createElement("h2",{className:"TemplatesDropDown__title"},c("mail_community_templates")),n.createElement("a",{role:"button",className:"TemplatesDropDown__setting-button",onClick:a},c("mail_settings_configure"))),u.length?n.createElement("ul",{className:"TemplatesDropDown__list"},u.map(e=>n.createElement("li",{key:e.id,className:"TemplatesDropDown__item",onMouseDown:this.elementOnClick.bind(null,e.id)},n.createElement("h3",{className:"TemplatesDropDown__item-name",dangerouslySetInnerHTML:{__html:e.name}}),n.createElement("div",{className:"TemplatesDropDown__item-content",dangerouslySetInnerHTML:{__html:e.text}})))):n.createElement("div",{className:"TemplatesDropDown__not-found-container"},n.createElement("span",null,c("mail_community_templates_not_found")),n.createElement(o.default,{onClick:s},c("mail_add_community_template"))))))),n.createElement("button",{className:"TemplatesDropDown__icon"}))}}t.default=Object(r.connect)(d)},g1O2:function(e,t,a){"use strict";a.r(t),a.d(t,"setHTML",(function(){return r}));a("91GP"),a("ioFf"),a("rGqo"),a("Btvt");var n=a("q1tI");a("17x9");function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}function r(e,t){var a=!!window.getSelection&&window.getSelection(),n=!1;if(a&&a.rangeCount){var i=a.getRangeAt(0);n=i.commonAncestorContainer?i.commonAncestorContainer:i.parentElement?i.parentElement():i.item(0)}for(var s=n;s&&s!=e;)s=s.parentNode;s||Emoji.editableFocus(e,!1,!0),Emoji.insertHTML(t)}class o extends n.Component{constructor(){super(...arguments),this.onChange=()=>{this.props.onChange&&this.props.onChange(Emoji.val(this.container))},this.containerRef=n.createRef(),this.state={value:this.props.initialValue}}componentDidMount(){if(this.container=this.containerRef.current,this.container&&!this.isMount){this.isMount=!0;var e=this.props.initialValue;Emoji.val(this.container,Emoji.emojiToHTML(e)),Emoji.init(this.container,{noStickers:!0,onSend:()=>{},ctrlSend:()=>!0,onChange:this.onChange,noLineBreaks:!this.props.isMultiLine})}}componentWillUnmount(){this.container&&this.isMount&&(this.isMount=!1)}render(){var e=this.props,t=e.tabIndex,a=e.isMultiLine,r=(e.initialValue,s(e,["tabIndex","isMultiLine","initialValue"]));return n.createElement("div",i({role:"textbox",ref:this.containerRef,tabIndex:t,contentEditable:!0,"aria-multiline":a},r))}}o.defaultProps={isMultiLine:!1,tabIndex:0,initialValue:""},t.default=o},gF8j:function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return r})),a.d(t,"getVisibilityState",(function(){return c})),a.d(t,"getVisiblityEvent",(function(){return d}));var n=a("uQjJ"),i=a("PU8N"),s=browser.iphone||browser.ipad||browser.ipod;function r(e){this.started=!1,this.is_idle=!0,this.activeTimeStart=null,this.cbActiveB=this.cbActive.bind(this),this.cbInactiveB=this.cbInactive.bind(this),this.onVisiblityChange=this.onVisiblityChange.bind(this),this.opts=extend({triggerEvents:"mousemove keydown",onIdleCb:function(){},onUnIdleCb:function(){},focusElement:e.element,element:null,idleTimeout:3e4},e)}function o(e,t,a){Object(i.isMvk)()?window.addEvent(e,t,a,{passive:!0}):window.addEvent(e,t,a)}function l(e,t,a){Object(i.isMvk)()?window.removeEvent(e,t,a,{passive:!0}):window.removeEvent(e,t,a)}function c(){return document.visibilityState||document.webkitVisibilityState}function d(){var e="visibilitychange";return document.visibilityState||(document.webkitVisibilityState?e+="webkit":e=""),e}extend(r.prototype,n.default.prototype),extend(r.prototype,{stop:function(){this.started=!1,l(this.opts.element,this.opts.triggerEvents,this.cbActiveB),Object(i.isMvk)()&&this._isTopLevel()&&d()&&l(document,d(),this.onVisiblityChange),Object(i.isMvk)()&&s||(l(this.opts.focusElement,"focus",this.cbActiveB),l(this.opts.focusElement,"blur",this.cbInactiveB)),clearTimeout(this.setIdleTo),clearTimeout(this.checkIdleCbTo),clearTimeout(this.sendCbTO),this.is_idle=!0,this.opts.parentManager&&this.opts.parentManager.off("idle",this.cbInactiveB)},idle:function(e){this.is_idle=!0,e||this.opts.onIdleCb(),this.emit("idle")},unidle:function(e){this.is_idle=!1,e||this.opts.onUnIdleCb(),this.emit("unidle")},start:function(){this.started=!0,!Object(i.isMvk)()&&browser.mobile||(this.is_idle=!this._isFocused(),this.opts.parentManager&&this.opts.parentManager.on("idle",this.cbInactiveB),Object(i.isMvk)()&&this._isTopLevel()&&d()&&o(document,d(),this.onVisiblityChange),Object(i.isMvk)()&&s||(o(this.opts.focusElement,"focus",this.cbActiveB),o(this.opts.focusElement,"blur",this.cbInactiveB)),clearTimeout(this.checkIdleCbTo),this.checkIdleCb(),this.checkIdleCbTo=setTimeout(this.checkIdleCb.bind(this),this.opts.idleTimeout))},checkIdleCb:function(){this.started&&(o(this.opts.element,this.opts.triggerEvents,this.cbActiveB),clearTimeout(this.setIdleTo),this.setIdleTo=setTimeout(this.cbInactiveB,this.opts.idleTimeout))},cbActive:function(){this.started&&(this.activeTimeStart=(new Date).getTime(),clearTimeout(this.setIdleTo),this.is_idle&&(this.is_idle=!1,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout(function(){this.emit("unidle"),this.opts.onUnIdleCb&&this.opts.onUnIdleCb()}.bind(this),100)),l(this.opts.element,this.opts.triggerEvents,this.cbActiveB),clearTimeout(this.checkIdleCbTo),this.checkIdleCbTo=setTimeout(this.checkIdleCb.bind(this),this.opts.idleTimeout))},cbInactive:function(){this.started&&(this.activeTimeStart=null,this.is_idle||(this.is_idle=!0,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout(function(){this.emit("idle"),this.opts.onIdleCb&&this.opts.onIdleCb()}.bind(this),100)),clearTimeout(this.checkIdleCbTo),l(this.opts.element,this.opts.triggerEvents,this.cbActiveB),o(this.opts.element,this.opts.triggerEvents,this.cbActiveB),this.checkIdleCbTo=setTimeout(this.checkIdleCb,this.opts.idleTimeout))},getActiveTime(){return!this.is_idle&&this.activeTimeStart?(new Date).getTime()-this.activeTimeStart:0},onVisiblityChange(){"visible"===c()?this.cbActiveB():this.cbInactiveB()},_isTopLevel(){var e=this.opts.focusElement;return e===window||e===document},_isFocused(){var e=this.opts.focusElement;if(this._isTopLevel()){var t=c();return"string"==typeof t&&"visible"===t}return document.activeElement===e}})},hOuX:function(e,t,a){"use strict";a.r(t),a.d(t,"MAX_SAFE_INTEGER",(function(){return n})),a.d(t,"MAX_INTERGER",(function(){return i})),a.d(t,"random",(function(){return s}));a("tuSo");var n=9007199254740991,i=2147483647;function s(){try{if(window.crypto){var e=new Int32Array(1);return crypto.getRandomValues(e),Math.abs(e.reduce((e,t)=>e+t))}}catch(e){}return intval(rand(0,i).toFixed(0))}},iukX:function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return v}));a("OEbY");var n=a("q1tI"),i=a("6krn"),s=a("enZq"),r=a("xGYt"),o=a("aFGQ"),l=a("Ht+d"),c=a("oziD"),d=a("hIV1"),u=a("/cSr"),g=(a("17x9"),a("ZxpX")),m=149946368,_=0;class p extends n.Component{constructor(e){super(e),this.selectPreset=(e,t)=>{var a=3===this.state.selectedPresetId&&null!==this.state.customFlags;this.setState(e=>({selectedPresetId:t,customFlags:a?this.props.flags:e.customFlags})),this.props.onSelectPreset(e)};var t=this.props.flags===m?2:this.props.flags===_?1:3;this.state={customFlags:3===t?this.props.flags:null,selectedPresetId:t}}componentWillReceiveProps(e){![_,m].includes(e.flags)&&this.setState({customFlags:e.flags,selectedPresetId:3})}render(){var e=this.state.customFlags?this.state.customFlags:this.props.flags,t=this.state.selectedPresetId,a=[{id:1,title:Object(i.getLang)("mail_chat_creation_preset_regular"),icon:"regular",flags:_},{id:2,title:Object(i.getLang)("mail_chat_creation_preset_closed"),icon:"closed",flags:m},{id:3,title:Object(i.getLang)("mail_chat_creation_preset_custom"),icon:"custom",flags:e}];return n.createElement("div",{className:"ChatSettingsPresetPanel"},a.map((e,a)=>n.createElement("div",{className:Object(g.classNames)("ChatSettingsPresetPanel__preset",{"ChatSettingsPresetPanel__preset--selected":e.id===t}),onClick:this.selectPreset.bind(null,e.flags,e.id),key:a},n.createElement("div",{className:Object(g.classNames)("ChatSettingsPresetPanel__presetIcon","ChatSettingsPresetPanel__presetIcon--"+e.icon)}),n.createElement("div",{className:"ChatSettingsPresetPanel__presetTitle"},e.title))))}}var h=a("lJdi"),b=i.default.getLang;class v extends n.Component{constructor(e){super(e),this.onChange=e=>{var t=e.name,a=e.selected.value;this.setState(e=>({flags:a?e.flags&~t^a:e.flags&~t}))},this.onCancel=()=>{this.setState({flags:this.props.flags}),this.props.back()},this.onSave=()=>{this.state.loading||(this.setState({loading:!0}),this.props.onSave(this.state.flags).then(()=>{this.setState({loading:!1},this.props.afterSave)}).catch(e=>{this.setState({loading:!1,flags:this.props.flags})}))},this.setFlags=e=>{this.setState({flags:e})},this.isAllowed=e=>{var t=this.props.allowedUpdateFlags;return!t||t.includes(e)},this.state={flags:e.flags,loading:!1}}render(){var e=this.state.flags,t=this.props,a=t.isChatTypeEditAllowed,i=t.isCasperChatTab,g=t.isCommunityChat,m=function(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return[!g&&{value:e,label:b("mail_settings_only_owner")},{value:t,label:b(g?"mail_settings_only_admins":"mail_settings_owner_and_admins")},{value:a,label:b("mail_settings_all_members")}].filter(Boolean)};return n.createElement("div",{className:"ChatSettingsOptions"},this.props.isChatCreation&&n.createElement(p,{flags:e,onSelectPreset:this.setFlags}),n.createElement(s.default,null,(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_INVITE)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_INVITE))&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_INVITE+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_INVITE,options:m(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_INVITE,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_INVITE),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_INVITE|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_INVITE)})},n.createElement(u.default,{type:"plus",backgroundColor:"green"}),b("mail_settings_can_invite")),(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CHANGE_TITLE)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CHANGE_TITLE))&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CHANGE_TITLE+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CHANGE_TITLE,options:m(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CHANGE_TITLE,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CHANGE_TITLE),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CHANGE_TITLE|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CHANGE_TITLE)})},n.createElement(u.default,{type:"pencil",backgroundColor:"blue"}),b("mail_settings_can_edit_info")),(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_PIN)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_PIN))&&!i&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_PIN+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_PIN,options:m(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_PIN,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_PIN),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_PIN|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_PIN)})},n.createElement(u.default,{type:"pin",backgroundColor:"blue"}),b("mail_settings_can_pin")),(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_MASS_MENTION)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_MASS_MENTION))&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_MASS_MENTION+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_MASS_MENTION,options:m(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_MASS_MENTION,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_MASS_MENTION),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_MASS_MENTION|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_MASS_MENTION)})},n.createElement(u.default,{type:"mention",backgroundColor:"blue"}),b("mail_settings_can_use_mass_mention")),(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_SEE_INVITE_LINK)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_SEE_INVITE_LINK))&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_SEE_INVITE_LINK+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_SEE_INVITE_LINK,options:m(0,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_SEE_INVITE_LINK,h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_SEE_INVITE_LINK),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_SEE_INVITE_LINK|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_SEE_INVITE_LINK)})},n.createElement(u.default,{type:"link",backgroundColor:"blue"}),b("mail_settings_can_see_invitation_link")),(this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CALL)||this.isAllowed(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CALL))&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CALL+h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CALL,options:m(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CALL,h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CALL),value:e&(h.MAIL_CHAT_FLAG_ONLY_OWNER_CAN_CALL|h.MAIL_CHAT_FLAG_ONLY_ADMINS_CAN_CALL)})},n.createElement(u.default,{type:"call",backgroundColor:"green"}),b("mail_settings_can_start_group_call")),this.isAllowed(h.MAIL_CHAT_FLAG_ADMINS_CAN_ADD_ADMINS)&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__longselect",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_ADMINS_CAN_ADD_ADMINS,options:[{value:0,label:b("mail_settings_only_owner")},{value:h.MAIL_CHAT_FLAG_ADMINS_CAN_ADD_ADMINS,label:b("mail_settings_owner_and_admins")}],value:e&h.MAIL_CHAT_FLAG_ADMINS_CAN_ADD_ADMINS})},n.createElement(u.default,{type:"user",backgroundColor:"green"}),b("mail_settings_admins_can_add_admins")),this.isAllowed(h.MAIL_CHAT_FLAG_SERVICE_CHAT)&&a&&n.createElement(r.default,{selectable:!1,aside:n.createElement(o.default,{className:"ChatSettingsOptions__select",onChange:this.onChange,name:h.MAIL_CHAT_FLAG_SERVICE_CHAT,options:[{value:0,label:b("mail_settings_service_simple")},{value:h.MAIL_CHAT_FLAG_SERVICE_CHAT,label:b("mail_settings_service_service")}],value:e&h.MAIL_CHAT_FLAG_SERVICE_CHAT})},n.createElement(u.default,{type:"gear",backgroundColor:"gray"}),b("mail_settings_service"))),n.createElement(d.default,{alignment:"right",className:"ChatSettingsOptions__submitArena"},n.createElement(l.default,{appearance:"tertiary",onClick:this.onCancel},b("global_cancel")),n.createElement(c.default,{onClick:this.onSave,loading:this.state.loading},b("global_save"))))}}},m5nf:function(e,t,a){"use strict";a.r(t),a.d(t,"MAIN",(function(){return p})),a.d(t,"EDIT",(function(){return h}));a("pIFo"),a("91GP"),a("VRzm"),a("Btvt");var n=a("q1tI"),i=(a("17x9"),a("6krn")),s=a("gqqU"),r=a("MCfn"),o=a("Ht+d"),l=a("6aSF"),c=a("BN/X"),d=a("g1O2"),u=a("LYnS"),g=a("vT4u"),m=a("nAFc"),_=a("EasH"),p="main",h="edit";class b extends n.Component{constructor(){super(...arguments),this.setEditableMessage=e=>{var t=e.id,a=e.name,n=e.text;return new Promise(e=>this.setState({editableMessage:{id:t,name:a,text:n}},e))},this.onChangeEditableMessage=(e,t)=>this.setEditableMessage(Object.assign({},this.state.editableMessage,{[e]:Object(m.escape)(t)})),this.deleteTemplate=e=>Promise.resolve().then(()=>this.state.section!==p?this.go(p):Promise.resolve()).then(()=>this.props.store.set(g.deleteTemplate.bind(null,e))).catch(()=>{Object(_.showFastBox)(Object(i.getLang)("mail_error"),Object(i.getLang)("mail_community_templates_delete_error"))}),this.saveTemplate=e=>{e.preventDefault();var t=this.state.editableMessage,a=t.name,n=t.text;a.length>200||a.length<2||a.length>2e3||n.length<5?Object(_.showFastBox)(Object(i.getLang)("mail_error"),Object(i.getLang)("mail_form_is_filled_in_incorrectly")):this.props.saveTemplate(t).catch(()=>{Object(_.showFastBox)(Object(i.getLang)("mail_error"),Object(i.getLang)("mail_community_templates_save_error"))}).then(()=>this.go(p))},this.addHint=(e,t)=>{t.preventDefault();var a=this.state.editableMessage,n=a.id,i=void 0===n?null:n,s=a.name,r=a.text;return Object(d.setHTML)(this.textarea,`{${e.id}}`),this.setEditableMessage({id:i,name:s,text:`${r}{${e.id}} `})},this.getTextAreaRef=e=>{this.textarea=(e||{}).container},this.state={section:this.props.section,editableMessage:{id:null,name:"",text:""}}}go(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=t.id,n=void 0===a?null:a,i=t.name,s=void 0===i?"":i,r=t.text,o=void 0===r?"":r;return new Promise(t=>{this.state.section!==e?this.setState({section:e,editableMessage:{id:n,name:s,text:o}},()=>{this.props.popup.updateBoxCoords(),t()}):t()})}render(){var e=this.props,t=e.getTemplates,a=e.closePopup,r=this.state,g=r.section,m=r.editableMessage,_=t();return n.createElement("section",{className:"TemplatesSettings"},n.createElement(s.default,{title:n.createElement("span",{className:"TemplatesSettings__title"},g===p&&Object(i.getLang)("mail_community_templates"),g===h&&Object(i.getLang)("mail_add_community_template")),onCloseClick:a}),n.createElement("main",{className:"TemplatesSettings__content"},g===p&&(_.length?n.createElement(l.default,{className:"TemplatesSettings__scroll-wrapper"},n.createElement("div",{className:"TemplatesSettings__list"},_.map(e=>n.createElement("section",{key:e.id,className:"TemplatesSettings__item"},n.createElement("h3",{className:"TemplatesSettings__item-name",dangerouslySetInnerHTML:{__html:e.name}}),n.createElement("div",{className:"TemplatesSettings__item-content",dangerouslySetInnerHTML:{__html:e.text}}),n.createElement("div",{className:"TemplatesSettings__buttons-row"},n.createElement(c.default,{onClick:()=>this.go(h,e),className:"TemplatesSettings__item-button"},Object(i.getLang)("mail_settings_edit")),n.createElement("span",{className:"TemplatesSettings__buttons-splitter","aria-hidden":"true"}," ","·"," "),n.createElement(c.default,{onClick:this.deleteTemplate.bind(null,e.id),className:"TemplatesSettings__item-button"},Object(i.getLang)("mail_delete"))))))):n.createElement("div",{className:"TemplatesSettings__not-found-container"},n.createElement("span",null,Object(i.getLang)("mail_community_templates_not_found")),n.createElement(c.default,{onClick:()=>this.go(h)},Object(i.getLang)("mail_add_community_template")))),g===h&&n.createElement("form",{className:"TemplatesSettings__form",id:"create_template_form",onSubmit:this.saveTemplate},n.createElement("div",{className:"TemplatesSettings__form-row"},n.createElement("label",{className:"TemplatesSettings__label",htmlFor:"name"},Object(i.getLang)("mail_name"),":"),n.createElement("div",{className:"TemplatesSettings__input-container"},n.createElement(d.default,{id:"name",type:"text",initialValue:m.name,className:"TemplatesSettings__input",onChange:this.onChangeEditableMessage.bind(null,"name")}),n.createElement("span",{className:"TemplatesSettings__notice"},Object(i.getLang)("mail_community_templates_input_size").replace("{min}",2).replace("{max}","200")))),n.createElement("div",{className:"TemplatesSettings__form-row"},n.createElement("label",{className:"TemplatesSettings__label",htmlFor:"text"},Object(i.getLang)("mail_text"),":"),n.createElement("div",{className:"TemplatesSettings__input-container"},n.createElement(d.default,{id:"text",name:"text",isMultiLine:!0,ref:this.getTextAreaRef,initialValue:m.text,className:"TemplatesSettings__textarea",onChange:this.onChangeEditableMessage.bind(null,"text")}),n.createElement("span",{className:"TemplatesSettings__notice"},Object(i.getLang)("mail_community_templates_input_size").replace("{min}",5).replace("{max}","2 000")))),n.createElement("div",{className:"TemplatesSettings__form-row"},n.createElement("label",{className:"TemplatesSettings__label"},Object(i.getLang)("mail_hints"),":"),n.createElement("div",{className:"TemplatesSettings__input-container"},Object(u.default)().map(e=>n.createElement(o.default,{type:"button",onMouseDown:this.addHint.bind(null,e),appearance:"secondary",className:"TemplatesSettings__hint",key:e.id},e.label)))))),n.createElement("footer",{className:"TemplatesSettings__footer"},g===p&&n.createElement(n.Fragment,null,n.createElement(c.default,{onClick:()=>this.go(h)},Object(i.getLang)("mail_add_community_template")),n.createElement(o.default,{onClick:a},Object(i.getLang)("mail_close"))),g===h&&n.createElement(n.Fragment,null,n.createElement("div",null,m.id&&n.createElement(c.default,{onClick:this.deleteTemplate.bind(null,m.id)},Object(i.getLang)("mail_delete_community_template"))),n.createElement("div",null,n.createElement(o.default,{appearance:"tertiary",onClick:()=>this.go(p)},Object(i.getLang)("mail_cancel")),n.createElement(o.default,{onClick:this.saveTemplate,form:"create_template_form",type:"submit"},Object(i.getLang)("mail_save"))))))}}b.defaultProps={section:p},t.default=Object(r.connect)(b)},nJdr:function(e,t,a){"use strict";a.r(t),a.d(t,"createLongpoll",(function(){return h}));var n=a("DM26"),i=a("BxOC"),s=a("f01n"),r=function(){return(r=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var i in t=arguments[a])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function o(e,t){e.waitAbortFns.push(t)}function l(e){if(e.isStoppedFn())return Promise.resolve({ts:0,updates:[]});var t=Object(i.plaingetCancelable)(e.url,{act:"a_check",key:e.key,version:e.version,ts:e.ts,wait:25,mode:e.mode}),a=t.request,s=t.cancel;return e.stopFn=s,window.lpDebug={startedAt:Date.now(),finishedAt:null,error:!1,request:a,cancel:s},a.then((function(t){var a=t[0],n=t[1];return window.lpDebug&&(window.lpDebug=r(r({},window.lpDebug),{finishedAt:Date.now(),request:null,cancel:null})),e.onData(e,n),e.waitTimeout=2,JSON.parse(a)})).catch((function(t){var a=t[1];return window.lpDebug&&(window.lpDebug=r(r({},window.lpDebug),{finishedAt:Date.now(),error:!0,request:null,cancel:null})),e.onData(e,a),Promise.reject(new Error(""))})).then((function(t){return function(e,t){var a=t.failed?Object(n.abortablePause)(4,null):{abort:function(){},pause:function(){return Promise.resolve()}},i=a.abort,s=a.pause;switch(t.failed){case 1:return o(e,i),e.onHistoryLost(e,t).then((function(){return e.onResult({ts:t.ts,updates:[[-1]]})})).then(s).then((function(){return l(e)}));case 2:return o(e,i),e.onKeyExpired(e,t).then((function(t){var a=t[0],n=t[1],i=t[2],s=t[3];return e.onResult({ts:+s,updates:[[-2,a,n+"/"+i],[-1]]})})).then(s).then((function(){return l(e)}));case 3:return e.onLpBroken(e,t);default:return Promise.resolve(t)}}(e,t)}))}function c(e){e.isStoppedFn()||l(e).then(e.onResult.bind(e)).then((function(){return e.isReconnecting&&d(e,-5)})).catch((function(t){return function(e,t){if(e.isStoppedFn())return;e.onRequestError(t),e.waitTimeout=Math.min(60,2*e.waitTimeout),d(e,-3);var a=Object(n.abortablePause)(e.waitTimeout,null),i=a.abort,s=a.pause;return o(e,i),s().then((function(){return d(e,-4)}))}(e,t)})).then((function(){return c(e)}))}function d(e,t){e.isReconnecting=-4===t,e.onResult({ts:e.ts,updates:[[t,e.waitTimeout]]})}function u(e){return e||function(){}}function g(e){return e?function(){for(var t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];return Promise.resolve(e.apply(void 0,t))}:function(){return Promise.reject()}}var m=a("bP5l"),_=a("vT4u"),p=a("XzvV");function h(e,t){return function(e,t){var a=!!e.stopped,n={id:e.id,key:e.key,ts:e.ts,url:e.url,lpstat:e.lpstat||0,version:e.version||11,mode:202,waitTimeout:2,waitAbortFns:[],isReconnecting:!1,isStoppedFn:function(){return a},onResult:function(e){e.ts&&r(n.ts,e.ts,e.updates.map(s.constructEvent))},onData:u(t.onData),onRequestError:u(t.onRequestError),onHistoryLost:g(t.onHistoryLost),onKeyExpired:g(t.onKeyExpired),onLpBroken:g(t.onHistoryLost)},i=t.onEvents;function r(e,t,a){n.ts=t;for(var r=0;r<a.length;++r)a[r].type===s.REFRESH_LP_KEY&&(n.key=a[r].key||"",n.url=a[r].url||"");i(e,t,a)}var o={options:n,isStopped:function(){return a},stopConnection:function(){a=!0,n.stopFn&&n.stopFn(),n.stopFn=void 0,document.removeEventListener("resume",l),this.abortWaiting()},reinitConnection:function(){this.stopConnection(),document.addEventListener("resume",l),d(n,-4),a=!1,c(n)},abortWaiting:function(){n.waitAbortFns.forEach((function(e){return e()})),n.waitAbortFns=[],n.waitTimeout=2},onLp:r};function l(){o.abortWaiting()}return document.addEventListener("resume",l),c(n),o}(e,{onEvents:t,onData:f,onRequestError:O,onHistoryLost:y,onKeyExpired:C,onLpBroken:j})}var b={},v=Date.now();function f(e,t){if(t&&t.status&&e.lpstat){var a=t.status.toString();t.status>=500&&t.status<600&&Object(p.statlogsValueEvent)("fc_longpoll",1,a,t.getResponseHeader("x-frontend")||""),b[a]=a in b?b[a]+1:1,Date.now()-v>=3e4&&(Object.keys(b).forEach((function(e){Object(p.statlogsValueEvent)("fc_longpoll",b[e],e,t.getResponseHeader("x-frontend")||"")})),b={},v=Date.now())}}function O(e){Object(m.lpLogFc)("red","LP error",e.message||"no message (probably browser reset)")}function y(e,t){Object(m.lpLogFc)("red","LP failed: old timestamp; resync, next ts",t.ts)}function C(e){return Object(m.lpLogFc)("red","LP failed: key is incorrect; refresh key"),Object(i.post)(_.CONTROLLER,{act:"a_get_key",uid:e.id,gid:e.id<0?-e.id:0},1e3)}function j(){throw window.nav.reload({force:!0}),new Error("ts is very wrong")}},rCUf:function(e,t,a){"use strict";a.r(t),a.d(t,"getUploadVideoExtMasks",(function(){return s})),a.d(t,"getUploadModule",(function(){return o})),a.d(t,"onVideoUploaded",(function(){return l}));a("91GP"),a("pIFo");var n=a("EasH"),i=a("8h6g");function s(e){var t=i.VIDEO_UPLOAD_EXTS.slice(0,i.VIDEO_UPLOAD_EXTS.length);if("types"===e){for(var a=t.length,n=0;n<a;++n)t.push(t[n].toUpperCase());return"*."+t.join(";*.")}return"accept"===e?"."+i.VIDEO_UPLOAD_EXTS.join(",."):""}function r(e){if(!cur.leaving){var t=getLang("video_upload_changed"),a=!1;if(each(window.cur.videoUploaders,(e,t)=>{Upload.isSomethingUploading(t)&&(a=!0)}),1===e){if(!a)return!0;var i=Object(n.showFastBox)({title:getLang("global_warning"),dark:!0},t,getLang("global_continue"),(function(){cur.leaving=!0,i.hide(),cur.onContinueCb&&cur.onContinueCb()}),getLang("global_cancel"),(function(){i.hide(),nav.objLoc.section="upload",nav.setLoc(nav.objLoc)}));return!1}return a?winToUtf(t.replace(/<\/?b>/g,"").replace(/<br\s*\/?>/g,"\n")):void 0}}function o(e,t,a,o,c){if(a){o=o||cur,(c=c||{}).onUploadStart||(c.onUploadStart=e=>{boxQueue.hideLast(),cur.nav.push((function(e,t,a){if(!1===r(1))return cur.onContinueCb=nav.go.pbind(a),!1})),cur.prevBefUnload=window.onbeforeunload,window.onbeforeunload=r,c.onUploadProgress(e,0,0),Wall.showEditPost&&Wall.showEditPost(),c.onUploadStartDone&&c.onUploadStartDone()}),c.onUploadComplete||(c.onUploadComplete=(e,t)=>{var a=window.parseJSON(t);a.video_id?l(e,a,o):"string"==typeof t&&t.indexOf("TERMINATED")>-1||Upload.onUploadError(e);c.onUploadCompleteDone&&c.onUploadCompleteDone(),setTimeout(()=>{c.onUploadAllCompleteDone&&!window.Upload.isSomethingUploading(e.ind)&&c.onUploadAllCompleteDone()})}),c.onUploadProgress||(c.onUploadProgress=(e,t,a)=>{var n=void 0!==e.ind?e.ind:e;show("_im_media_preview"),o.showMediaProgress&&o.showMediaProgress("video",n,function(e,t,a){return{loaded:t,total:a,fileName:e.fileName?e.fileName.replace(/[&<>"']/g,""):void 0}}(e,t,a))}),c.onUploadError||(c.onUploadError=(e,t)=>{statlogsValueEvent("upload_video_fails",1,a.options.server,t),function(e){var t=void 0!==e.ind?e.ind:e,a=e.fileName?t+"_"+e.fileName:e;if(re("upload"+a+"_progress_wrap"),!geByClass1("popup_box_container")){var i=getLang("video_upload_error");setTimeout(Object(n.showFastBox)({title:getLang("global_error")},i).hide,2e3)}topError("Upload failed",{dt:-1,type:102,url:(ge("file_uploader_form"+t)||{}).action}),Upload.embed(t)}(e)}),cur.maxFiles=(cur.chooseParams||{}).maxFiles||10;var d=cur.maxFiles-(cur.savedVideos||[]).length,u=browser.safari?"":"video/*,"+s("accept");a.lang&&(cur.lang=extend(cur.lang||{},a.lang));var g={accept:u,file_input:null,file_name:"video_file",file_size_limit:1024*(a.options.file_size_limit_in_GB||i.VIDEO_UPLOAD_MAX_FILE_SIZE_IN_GB)*1024*1024,file_types_description:"Video files",file_types:s("types"),chooseBox:1,chunked:1,chunkSize:i.VIDEO_UPLOAD_CHUNK_SIZE,clear:1,dragEl:t===boxLayerWrap?boxLayerWrap:bodyNode,dropbox:t,from:a.vars.from,lang:a.lang,max_attempts:3,max_files:d,multiple:1,multi_progress:1,requestOptionsForFile:!0,type:"video",visibleDropbox:!a.options.hasOwnProperty("visible_dropbox")||a.options.visible_dropbox},m=Upload.init(e,"",{},Object.assign(g,c));return window.cur.videoUploaders||(window.cur.videoUploaders=[]),window.cur.videoUploaders.push(m),m}}function l(e,t,a,i){a=a||cur;var s=void 0!==e.ind?e.ind:e,r=(e.fileName||e.filename||"").replace(/[&<>"']/g,""),o=r?s+"_"+r:e,l=t.owner_id+"_"+t.video_id,c=ge("upload"+o+"_progress_wrap");c&&hide(geByClass1("progress_x",c)),ajax.post("al_video.php?act=a_videos_attach_info",{videos:l},{onDone:e=>{a.chooseMedia("video",l,extend(e[l],{upload_ind:o,upload_new:!0}));var s=t.owner_id,r=t.video_id,c=t.video_hash,d=0,u=()=>{ajax.post("al_video.php?act=encode_progress",{oid:s,vid:r,hash:c,need_thumb:1},{onDone:t=>{var c,d=!0;if(t){if(t.error)return c=getLang("video_upload_encode_error"),void setTimeout(Object(n.showFastBox)({title:getLang("global_error")},c).hide,2e3);t.thumb&&(d=!1,ajax.post("al_video.php",{act:"a_video_photo_sizes",oid:s,vid:r},{onDone:t=>{a.hasChosenMedia("video",l)?a.updateChosenMedia("video",l,extend(t,{upload_ind:o,upload_new:!0})):i&&i(e,l)}}))}d&&a.hasChosenMedia("video",l)&&setTimeout(u,1e3)},onFail:()=>{++d<3&&setTimeout(u,2e3*d)}})};u()}})}t.default={getUploadModule:(e,t,a,n,i)=>o(e,t,a,n,i),initModalVideoUploader(){var e=cur.videoUploadParams,t=ge("choose_video_upload");return!!t&&(this.initDragEvents(),o(t,boxLayerWrap,e))},initDragEvents(){var e,t=e=>{cur.dragTimeout&&(clearTimeout(cur.dragTimeout),delete cur.dragTimeout);var t=ge("video_choose_upload_area_wrap");if(!hasClass(t,"video_choose_upload_area_enter")){addClass(t,"video_choose_upload_area_enter");var a=ge("video_choose_wrap"),n=getXY(a)[1],i=getSize(t)[1];return hide("video_choose_wrap"),setStyle(t,"height",scrollGetY()+window.clientHeight()-n+i),cancelEvent(e)}},a=e=>cancelEvent(e),n=e=>{if(a(),e.dataTransfer.files.length&&Upload.checkFilesSizes(window.videoInlineUploader,e.dataTransfer.files))return window.Upload&&Upload.checked&&Upload.checked[window.videoInlineUploader]&&Upload.onFileApiSend(window.videoInlineUploader,e.dataTransfer.files),cancelEvent(e)},i=()=>{addEvent(boxLayerWrap,"dragenter dragover",t),addEvent(boxLayerWrap,"dragleave",a),addEvent(boxLayerWrap,"drop",n)};i();var s=null===(e=curBox().getOptions())||void 0===e?void 0:e.onHide;setTimeout(curBox().setOptions.pbind({onHide:()=>{if(removeEvent(boxLayerWrap,"dragenter dragover",t),removeEvent(boxLayerWrap,"dragleave",a),removeEvent(boxLayerWrap,"drop",n),"function"==typeof s)return s()},onShow:()=>{i()}}),0)}}}});